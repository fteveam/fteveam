{"version":3,"sources":["../../src/common/accountInfo.ts","../../src/common/lodash.ts","../../src/common/logger.ts"],"sourcesContent":["import { AccountInfo, Commitment, Connection, PublicKey } from \"@solana/web3.js\";\n\nimport { chunkArray } from \"./lodash\";\nimport { createLogger } from \"./logger\";\n\ninterface MultipleAccountsJsonRpcResponse {\n  jsonrpc: string;\n  id: string;\n  error?: {\n    code: number;\n    message: string;\n  };\n  result: {\n    context: { slot: number };\n    value: { data: Array<string>; executable: boolean; lamports: number; owner: string; rentEpoch: number }[];\n  };\n}\n\nexport interface GetMultipleAccountsInfoConfig {\n  batchRequest?: boolean;\n  commitment?: Commitment;\n}\n\nconst logger = createLogger(\"Raydium_accountInfo_util\");\n\nexport async function getMultipleAccountsInfo(\n  connection: Connection,\n  publicKeys: PublicKey[],\n  config?: GetMultipleAccountsInfoConfig,\n): Promise<(AccountInfo<Buffer> | null)[]> {\n  const { batchRequest, commitment } = {\n    batchRequest: false,\n    ...config,\n  };\n\n  const chunkedKeys = chunkArray(publicKeys, 100);\n  let results: (AccountInfo<Buffer> | null)[][] = new Array(chunkedKeys.length).fill([]);\n\n  if (batchRequest) {\n    const batch = chunkedKeys.map((keys) => {\n      const args = connection._buildArgs([keys.map((key) => key.toBase58())], commitment, \"base64\");\n      return {\n        methodName: \"getMultipleAccounts\",\n        args,\n      };\n    });\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    const unsafeResponse: MultipleAccountsJsonRpcResponse[] = await connection._rpcBatchRequest(batch);\n    results = unsafeResponse.map((unsafeRes: MultipleAccountsJsonRpcResponse) => {\n      if (unsafeRes.error)\n        logger.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${unsafeRes.error.message}`);\n\n      return unsafeRes.result.value.map((accountInfo) => {\n        if (accountInfo) {\n          const { data, executable, lamports, owner, rentEpoch } = accountInfo;\n\n          if (data.length !== 2 && data[1] !== \"base64\") logger.logWithError(`info must be base64 encoded, RPC_ERROR`);\n\n          return {\n            data: Buffer.from(data[0], \"base64\"),\n            executable,\n            lamports,\n            owner: new PublicKey(owner),\n            rentEpoch,\n          };\n        }\n        return null;\n      });\n    });\n  } else {\n    try {\n      results = (await Promise.all(\n        chunkedKeys.map((keys) => connection.getMultipleAccountsInfo(keys, commitment)),\n      )) as (AccountInfo<Buffer> | null)[][];\n    } catch (error) {\n      if (error instanceof Error) {\n        logger.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${error.message}`);\n      }\n    }\n  }\n\n  return results.flat();\n}\n\nexport async function getMultipleAccountsInfoWithCustomFlags<T extends { pubkey: PublicKey }>(\n  connection: Connection,\n  publicKeysWithCustomFlag: T[],\n  config?: GetMultipleAccountsInfoConfig,\n): Promise<({ accountInfo: AccountInfo<Buffer> | null } & T)[]> {\n  const multipleAccountsInfo = await getMultipleAccountsInfo(\n    connection,\n    publicKeysWithCustomFlag.map((o) => o.pubkey),\n    config,\n  );\n\n  return publicKeysWithCustomFlag.map((o, idx) => ({ ...o, accountInfo: multipleAccountsInfo[idx] }));\n}\n","/**\n * https://youmightnotneed.com/lodash/\n */\n\nexport function chunkArray<T>(arr: T[], chunkSize = 1, cache: T[][] = []): T[][] {\n  const tmp = [...arr];\n  if (chunkSize <= 0) return cache;\n  while (tmp.length) cache.push(tmp.splice(0, chunkSize));\n  return cache;\n}\n\nexport function intersection<T>(arr: T[], ...args: T[][]): T[] {\n  return arr.filter((item) => args.every((arr) => arr.includes(item)));\n}\n\nexport function xor<T>(arr: T[], ...args: T[][]): T[] {\n  return arr.filter((item) => args.every((arr) => !arr.includes(item)));\n}\n\nexport function uniq<T>(arr: T[]): T[] {\n  return [...new Set(arr)];\n}\n","import { get, set } from \"lodash\";\nimport pino, { LevelWithSilent, Logger } from \"pino\";\nimport pretty from \"pino-pretty\";\n\nexport type ModuleName = \"Common.Api\";\n\nconst moduleLoggers: { [key in ModuleName]?: Logger } = {};\n\nconst moduleLevels: { [key in ModuleName]?: LevelWithSilent } = {};\n\nconst stream = pretty({\n  colorize: true,\n  levelFirst: true,\n  translateTime: \"SYS:yyyymmdd HH:MM:ss.l\",\n});\nconst globalLogger = pino({ base: null, level: \"silent\" }, stream);\n\nexport interface LoggerInstance extends Logger {\n  logWithError: (...args: any) => void;\n}\n\nexport function createLogger(moduleName: string): LoggerInstance {\n  let logger = get(moduleLoggers, moduleName);\n\n  if (!logger) {\n    // default level is silent\n    const level = get(moduleLevels, moduleName);\n\n    logger = globalLogger.child({ name: moduleName }, { level });\n    set(moduleLoggers, moduleName, logger);\n  }\n\n  logger.logWithError = (...args): void => {\n    const msg = args.map((arg) => (typeof arg === \"object\" ? JSON.stringify(arg) : arg)).join(\", \");\n    // logger.error(msg);\n    throw new Error(msg);\n  };\n\n  return logger;\n}\n\nexport function setLoggerLevel(moduleName: ModuleName, level: LevelWithSilent): void {\n  set(moduleLevels, moduleName, level);\n\n  const logger = get(moduleLoggers, moduleName);\n  if (logger) logger.level = level;\n}\n"],"mappings":"6aAAA,4CCIO,WAAuB,EAAU,EAAY,EAAG,EAAe,CAAC,EAAU,CAC/E,GAAM,GAAM,CAAC,GAAG,CAAG,EACnB,GAAI,GAAa,EAAG,MAAO,GAC3B,KAAO,EAAI,QAAQ,EAAM,KAAK,EAAI,OAAO,EAAG,CAAS,CAAC,EACtD,MAAO,EACT,CCTA,sCACA,oBACA,2BAIA,GAAM,GAAkD,CAAC,EAEnD,EAA0D,CAAC,EAE3D,EAAS,EAAO,CACpB,SAAU,GACV,WAAY,GACZ,cAAe,yBACjB,CAAC,EACK,EAAe,EAAK,CAAE,KAAM,KAAM,MAAO,QAAS,EAAG,CAAM,EAM1D,WAAsB,EAAoC,CAC/D,GAAI,GAAS,EAAI,EAAe,CAAU,EAE1C,GAAI,CAAC,EAAQ,CAEX,GAAM,GAAQ,EAAI,EAAc,CAAU,EAE1C,EAAS,EAAa,MAAM,CAAE,KAAM,CAAW,EAAG,CAAE,OAAM,CAAC,EAC3D,EAAI,EAAe,EAAY,CAAM,CACvC,CAEA,SAAO,aAAe,IAAI,IAAe,CACvC,GAAM,GAAM,EAAK,IAAI,AAAC,GAAS,MAAO,IAAQ,SAAW,KAAK,UAAU,CAAG,EAAI,CAAI,EAAE,KAAK,IAAI,EAE9F,KAAM,IAAI,OAAM,CAAG,CACrB,EAEO,CACT,CFhBA,GAAM,GAAS,EAAa,0BAA0B,EAEtD,iBACE,EACA,EACA,EACyC,CACzC,GAAM,CAAE,eAAc,cAAe,GACnC,aAAc,IACX,GAGC,EAAc,EAAW,EAAY,GAAG,EAC1C,EAA4C,GAAI,OAAM,EAAY,MAAM,EAAE,KAAK,CAAC,CAAC,EAErF,GAAI,EAAc,CAChB,GAAM,GAAQ,EAAY,IAAI,AAAC,GAAS,CACtC,GAAM,GAAO,EAAW,WAAW,CAAC,EAAK,IAAI,AAAC,GAAQ,EAAI,SAAS,CAAC,CAAC,EAAG,EAAY,QAAQ,EAC5F,MAAO,CACL,WAAY,sBACZ,MACF,CACF,CAAC,EAID,EAAU,AADgD,MAAM,GAAW,iBAAiB,CAAK,GACxE,IAAI,AAAC,GACxB,GAAU,OACZ,EAAO,aAAa,wDAAwD,EAAU,MAAM,SAAS,EAEhG,EAAU,OAAO,MAAM,IAAI,AAAC,GAAgB,CACjD,GAAI,EAAa,CACf,GAAM,CAAE,OAAM,aAAY,WAAU,QAAO,aAAc,EAEzD,MAAI,GAAK,SAAW,GAAK,EAAK,KAAO,UAAU,EAAO,aAAa,wCAAwC,EAEpG,CACL,KAAM,OAAO,KAAK,EAAK,GAAI,QAAQ,EACnC,aACA,WACA,MAAO,GAAI,GAAU,CAAK,EAC1B,WACF,CACF,CACA,MAAO,KACT,CAAC,EACF,CACH,KACE,IAAI,CACF,EAAW,KAAM,SAAQ,IACvB,EAAY,IAAI,AAAC,GAAS,EAAW,wBAAwB,EAAM,CAAU,CAAC,CAChF,CACF,OAAS,EAAP,CACA,AAAI,YAAiB,QACnB,EAAO,aAAa,wDAAwD,EAAM,SAAS,CAE/F,CAGF,MAAO,GAAQ,KAAK,CACtB,CAEA,kBACE,EACA,EACA,EAC8D,CAC9D,GAAM,GAAuB,KAAM,GACjC,EACA,EAAyB,IAAI,AAAC,GAAM,EAAE,MAAM,EAC5C,CACF,EAEA,MAAO,GAAyB,IAAI,CAAC,EAAG,IAAS,OAAK,GAAL,CAAQ,YAAa,EAAqB,EAAK,EAAE,CACpG","names":[]}