var v=Object.create;var y=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var E=Object.getPrototypeOf,C=Object.prototype.hasOwnProperty;var K=(e,t)=>{for(var n in t)y(e,n,{get:t[n],enumerable:!0})},P=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of k(t))!C.call(e,s)&&s!==n&&y(e,s,{get:()=>t[s],enumerable:!(r=B(t,s))||r.enumerable});return e};var I=(e,t,n)=>(n=e!=null?v(E(e)):{},P(t||!e||!e.__esModule?y(n,"default",{value:e,enumerable:!0}):n,e)),M=e=>P(y({},"__esModule",{value:!0}),e);var j={};K(j,{TxBuilder:()=>T,findProgramAddress:()=>_,forecastTransactionSize:()=>R,getRecentBlockHash:()=>x,parseSimulateLogToJson:()=>H,parseSimulateValue:()=>J,simulateMultipleInstruction:()=>z});module.exports=M(j);var a=require("@solana/web3.js");var p=require("lodash"),A=I(require("pino")),b=I(require("pino-pretty")),S={},D={},$=(0,b.default)({colorize:!0,levelFirst:!0,translateTime:"SYS:yyyymmdd HH:MM:ss.l"}),O=(0,A.default)({base:null,level:"silent"},$);function L(e){let t=(0,p.get)(S,e);if(!t){let n=(0,p.get)(D,e);t=O.child({name:e},{level:n}),(0,p.set)(S,e,t)}return t.logWithError=(...n)=>{let r=n.map(s=>typeof s=="object"?JSON.stringify(s):s).join(", ");throw new Error(r)},t}var l=L("Raydium_txTool"),T=class{constructor(t){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=t.connection,this.feePayer=t.feePayer,this.signAllTransactions=t.signAllTransactions,this.owner=t.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:t=[],endInstructions:n=[],signers:r=[]}){return this.instructions.push(...t),this.endInstructions.push(...n),this.signers.push(...r),this}build(t){let n=new a.Transaction;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,{transaction:n,signers:this.signers,execute:async()=>{var s;let r=await x(this.connection);if(n.recentBlockhash=r,(s=this.owner)!=null&&s.isKeyPair)return(0,a.sendAndConfirmTransaction)(this.connection,n,this.signers);if(this.signAllTransactions){this.signers.length&&n.partialSign(...this.signers);let o=await this.signAllTransactions([n]);return await this.connection.sendRawTransaction(o[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:t||{}}}buildMultiTx(t){let{extraPreBuildData:n=[],extInfo:r}=t,{transaction:s}=this.build(r),o=n.filter(i=>i.transaction.instructions.length>0),f=[...o.map(i=>i.transaction),s],c=[...o.map(i=>i.signers),this.signers];return{transactions:f,signers:c,execute:async()=>{var d;let i=await x(this.connection);if((d=this.owner)!=null&&d.isKeyPair)return await Promise.all(f.map(async(g,u)=>(g.recentBlockhash=i,await(0,a.sendAndConfirmTransaction)(this.connection,g,c[u]))));if(this.signAllTransactions){let g=f.map((h,m)=>(h.recentBlockhash=i,c[m].length&&h.partialSign(...c[m]),h)),u=await this.signAllTransactions(g),w=[];for(let h=0;h<u.length;h+=1){let m=await this.connection.sendRawTransaction(u[h].serialize(),{skipPreflight:!0});w.push(m)}return w}throw new Error("please connect wallet first")},extInfo:r||{}}}};async function x(e){var t,n;try{return((n=await((t=e.getLatestBlockhash)==null?void 0:t.call(e)))==null?void 0:n.blockhash)||(await e.getRecentBlockhash()).blockhash}catch{return(await e.getRecentBlockhash()).blockhash}}function R(e,t){e.length<1&&l.logWithError(`no instructions provided: ${e.toString()}`),t.length<1&&l.logWithError(`no signers provided:, ${t.toString()}`);let n=new a.Transaction;n.recentBlockhash="11111111111111111111111111111111",n.feePayer=t[0],n.add(...e);let r=n.compileMessage().serialize();return t.length+t.length*64+r.length}async function z(e,t,n){let r=new a.PublicKey("RaydiumSimuLateTransaction11111111111111111"),s=[],o=new a.Transaction;o.feePayer=r;for(let i of t)R([...o.instructions,i],[r])>a.PACKET_DATA_SIZE&&(s.push(o),o=new a.Transaction,o.feePayer=r),o.add(i);o.instructions.length>0&&s.push(o);let f=[];try{f=await Promise.all(s.map(i=>e.simulateTransaction(i)))}catch(i){i instanceof Error&&l.logWithError(`failed to simulate for instructions, RPC_ERROR, ${i.message}`)}let c=[];for(let i of f){let{value:d}=i;if(l.debug(`simulate result: ${JSON.stringify(i)}`),d.logs){let g=d.logs.filter(u=>u&&u.includes(n));l.debug(`filteredLog: ${JSON.stringify(c)}`),g.length||l.logWithError(` "simulate log not match keyword, keyword: ${n}`),c.push(...g)}}return c}function H(e,t){let n=e.match(/{["\w:,]+}/g);return!n||n.length!==1?l.logWithError(`simulate log fail to match json, keyword: ${t}`):n[0]}function J(e,t){let r=new RegExp(`"${t}":(\\d+)`,"g").exec(e);return!r||r.length!==2?l.logWithError(`simulate log fail to match key", key: ${t}`):r[1]}async function _(e,t){let[n,r]=await a.PublicKey.findProgramAddress(e,t);return{publicKey:n,nonce:r}}0&&(module.exports={TxBuilder,findProgramAddress,forecastTransactionSize,getRecentBlockHash,parseSimulateLogToJson,parseSimulateValue,simulateMultipleInstruction});
//# sourceMappingURL=txTool.js.map