var dn=Object.create;var be=Object.defineProperty,mn=Object.defineProperties,ln=Object.getOwnPropertyDescriptor,pn=Object.getOwnPropertyDescriptors,fn=Object.getOwnPropertyNames,Gt=Object.getOwnPropertySymbols,gn=Object.getPrototypeOf,Yt=Object.prototype.hasOwnProperty,yn=Object.prototype.propertyIsEnumerable;var Ht=(t,e,r)=>e in t?be(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,R=(t,e)=>{for(var r in e||(e={}))Yt.call(e,r)&&Ht(t,r,e[r]);if(Gt)for(var r of Gt(e))yn.call(e,r)&&Ht(t,r,e[r]);return t},E=(t,e)=>mn(t,pn(e));var bn=(t,e)=>{for(var r in e)be(t,r,{get:e[r],enumerable:!0})},$t=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of fn(e))!Yt.call(t,o)&&o!==r&&be(t,o,{get:()=>e[o],enumerable:!(n=ln(e,o))||n.enumerable});return t};var W=(t,e,r)=>(r=t!=null?dn(gn(t)):{},$t(e||!t||!t.__esModule?be(r,"default",{value:t,enumerable:!0}):r,t)),wn=t=>$t(be({},"__esModule",{value:!0}),t);var Zn={};bn(Zn,{default:()=>Je});module.exports=wn(Zn);var Q=require("@solana/spl-token"),P=require("@solana/web3.js"),$e=W(require("bn.js"));var we=require("lodash"),Qe=W(require("dayjs")),zt=W(require("dayjs/plugin/utc"));Qe.default.extend(zt.default);var Ze=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return(0,Qe.default)().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let r=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(r)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Jt={},hn={};function _(t){let e=(0,we.get)(Jt,t);if(!e){let r=(0,we.get)(hn,t);e=new Ze({name:t,logLevel:r}),(0,we.set)(Jt,t,e)}return e}var lr=require("@solana/web3.js"),pr=W(require("bn.js"));var or=W(require("big.js")),ke=W(require("bn.js"));var I=W(require("bn.js"));var De=_("Raydium_bignumber");var he=new I.default(0),ne=new I.default(1),no=new I.default(2),oo=new I.default(3),io=new I.default(5),oe=new I.default(10),Qt=new I.default(100),ao=new I.default(1e3),so=new I.default(1e4),Xt=9007199254740991;function x(t){if(t instanceof I.default)return t;if(typeof t=="string"){if(t.match(/^-?[0-9]+$/))return new I.default(t);De.logWithError(`invalid BigNumberish string: ${t}`)}return typeof t=="number"?(t%1&&De.logWithError(`BigNumberish number underflow: ${t}`),(t>=Xt||t<=-Xt)&&De.logWithError(`BigNumberish number overflow: ${t}`),new I.default(String(t))):typeof t=="bigint"?new I.default(t.toString()):(De.logWithError(`invalid BigNumberish value: ${t}`),new I.default(0))}function et(t){return oe.pow(x(t))}function ce(t){var u;if(t===void 0)return{denominator:"1",numerator:"0"};if(t instanceof I.default)return{numerator:t.toString(),denominator:"1"};if(t instanceof g)return{denominator:t.denominator.toString(),numerator:t.numerator.toString()};let e=String(t),[,r="",n="",o=""]=(u=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?u:[],i="1"+"0".repeat(o.length),s=r+(n==="0"?"":n)+o||"0";return{denominator:i,numerator:s,sign:r,int:n,dec:o}}function Pn(t){var n;let[,e="",r=""]=(n=t.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?n:[];return`${e}${r}`}function Ve(t,e=0){return t instanceof I.default?t:new I.default(Pn(re(t).mul(oe.pow(new I.default(String(e))))))}function re(t){if(t instanceof $)return new g(t.numerator,t.denominator);if(t instanceof q)return t.adjusted;if(t instanceof V)try{return re(t.toExact())}catch{return new g(he)}if(t instanceof g)return t;let e=String(t),r=ce(e);return new g(r.numerator,r.denominator)}function Ee(t,e){let{numerator:r,denominator:n}=ce(t);return new $(new I.default(r),new I.default(n).mul(e!=null&&e.alreadyDecimaled?new I.default(100):new I.default(1)))}function er(t,e){if(t==null||e==null)return;let r=re(t),n=re(e);return r.mul(n)}function Zt(t){let e=new G({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),r=Ve(er(t,10**e.decimals));return new V(e,r)}function Pe(t,e){return Zt(!e||!t?0:er(t,e))}var tr=W(require("toformat")),xn=tr.default,xe=xn;var Te=W(require("big.js")),rr=W(require("decimal.js-light"));var ve=_("module/fraction"),tt=xe(Te.default),Se=xe(rr.default),Sn={[0]:Se.ROUND_DOWN,[1]:Se.ROUND_HALF_UP,[2]:Se.ROUND_UP},kn={[0]:Te.default.roundDown,[1]:Te.default.roundHalfUp,[2]:Te.default.roundUp},g=class{constructor(e,r=ne){this.numerator=x(e),this.denominator=x(r)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new g(this.denominator,this.numerator)}add(e){let r=e instanceof g?e:new g(x(e));return this.denominator.eq(r.denominator)?new g(this.numerator.add(r.numerator),this.denominator):new g(this.numerator.mul(r.denominator).add(r.numerator.mul(this.denominator)),this.denominator.mul(r.denominator))}sub(e){let r=e instanceof g?e:new g(x(e));return this.denominator.eq(r.denominator)?new g(this.numerator.sub(r.numerator),this.denominator):new g(this.numerator.mul(r.denominator).sub(r.numerator.mul(this.denominator)),this.denominator.mul(r.denominator))}mul(e){let r=e instanceof g?e:new g(x(e));return new g(this.numerator.mul(r.numerator),this.denominator.mul(r.denominator))}div(e){let r=e instanceof g?e:new g(x(e));return new g(this.numerator.mul(r.denominator),this.denominator.mul(r.numerator))}toSignificant(e,r={groupSeparator:""},n=1){Number.isInteger(e)||ve.logWithError(`${e} is not an integer.`),e<=0&&ve.logWithError(`${e} is not positive.`),Se.set({precision:e+1,rounding:Sn[n]});let o=new Se(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),r)}toFixed(e,r={groupSeparator:""},n=1){return Number.isInteger(e)||ve.logWithError(`${e} is not an integer.`),e<0&&ve.logWithError(`${e} is negative.`),tt.DP=e,tt.RM=kn[n]||1,new tt(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,r)}isZero(){return this.numerator.isZero()}};var Ln=_("Raydium_amount"),nr=xe(or.default);function In(t,e){let r="0",n="0";if(t.includes(".")){let o=t.split(".");o.length===2?([r,n]=o,n=n.padEnd(e,"0")):Ln.logWithError(`invalid number string, num: ${t}`)}else r=t;return[r,n.slice(0,e)||n]}var V=class extends g{constructor(r,n,o=!0,i){let s=new ke.default(0),u=oe.pow(new ke.default(r.decimals));if(o)s=x(n);else{let a=new ke.default(0),d=new ke.default(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[p,y]=In(n.toString(),r.decimals);a=x(p),d=x(y)}a=a.mul(u),s=a.add(d)}super(s,u);this.logger=_(i||"Amount"),this.token=r}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(r){return this.token.equals(r.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(r.raw)}lt(r){return this.token.equals(r.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(r.raw)}add(r){return this.token.equals(r.token)||this.logger.logWithError("add token not equals"),new V(this.token,this.raw.add(r.raw))}subtract(r){return this.token.equals(r.token)||this.logger.logWithError("sub token not equals"),new V(this.token,this.raw.sub(r.raw))}toSignificant(r=this.token.decimals,n,o=0){return super.toSignificant(r,n,o)}toFixed(r=this.token.decimals,n,o=0){return r>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(r,n,o)}toExact(r={groupSeparator:""}){return nr.DP=this.token.decimals,new nr(this.numerator.toString()).div(this.denominator.toString()).toFormat(r)}};var ir=require("@solana/web3.js"),ar={symbol:"SOL",name:"Solana",decimals:9},O={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},Lo={isQuantumSOL:!0,isLp:!1,official:!0,mint:new ir.PublicKey(O.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};var Oe=require("@solana/web3.js");var ur=require("@solana/spl-token"),N=require("@solana/web3.js");function c({pubkey:t,isSigner:e=!1,isWritable:r=!0}){return{pubkey:t,isWritable:r,isSigner:e}}var We=[c({pubkey:ur.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:N.SystemProgram.programId,isWritable:!1}),c({pubkey:N.SYSVAR_RENT_PUBKEY,isWritable:!1})];function J({publicKey:t,transformSol:e}){if(t instanceof N.PublicKey)return e&&t.equals(v)?sr:t;if(e&&t===v.toBase58())return sr;if(typeof t=="string")try{return new N.PublicKey(t)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}function cr(t){try{return new N.PublicKey(t)}catch{return t}}var dr=new N.PublicKey("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Bo=new N.PublicKey("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Ro=new N.PublicKey("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Fo=new N.PublicKey("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),_o=new N.PublicKey("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),No=new N.PublicKey("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Ko=new N.PublicKey("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Mo=new N.PublicKey("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Do=new N.PublicKey("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Vo=new N.PublicKey("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Eo=new N.PublicKey("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),sr=new N.PublicKey("So11111111111111111111111111111111111111112"),v=N.PublicKey.default;var rt=class{constructor({mint:e,decimals:r,symbol:n="UNKNOWN",name:o="UNKNOWN",skipMint:i=!1}){if(e===v.toBase58()||e instanceof Oe.PublicKey&&v.equals(e)){this.decimals=O.decimals,this.symbol=O.symbol,this.name=O.name,this.mint=new Oe.PublicKey(O.mint);return}this.decimals=r,this.symbol=n,this.name=o,this.mint=i?Oe.PublicKey.default:J({publicKey:e})}equals(e){return this===e?!0:this.mint.equals(e.mint)}},G=rt;G.WSOL=new rt(O);var ot=class{constructor({decimals:e,symbol:r="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=r,this.name=n}equals(e){return this===e}},nt=ot;nt.SOL=new ot(ar);var mr=new g(Qt),$=class extends g{toSignificant(e=5,r,n){return this.mul(mr).toSignificant(e,r,n)}toFixed(e=2,r,n){return this.mul(mr).toFixed(e,r,n)}};var An=_("Raydium_price"),q=class extends g{constructor(r){let{baseToken:n,quoteToken:o,numerator:i,denominator:s}=r;super(i,s);this.baseToken=n,this.quoteToken=o,this.scalar=new g(et(n.decimals),et(o.decimals))}get raw(){return new g(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new q({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(r){this.quoteToken!==r.baseToken&&An.logWithError("mul token not equals");let n=super.mul(r);return new q({baseToken:this.baseToken,quoteToken:r.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(r=this.quoteToken.decimals,n,o){return this.adjusted.toSignificant(r,n,o)}toFixed(r=this.quoteToken.decimals,n,o){return this.adjusted.toFixed(r,n,o)}};var Bn=[G,V,lr.PublicKey,g,pr.default,q,$];function Rn(t){return typeof t=="object"&&t!==null&&!Bn.some(e=>typeof e=="object"&&t instanceof e)}function Le(t){return typeof t=="string"?cr(t):Array.isArray(t)?t.map(e=>Le(e)):Rn(t)?Object.fromEntries(Object.entries(t).map(([e,r])=>[e,Le(r)])):t}var X=require("@solana/web3.js");var hi=_("Raydium_txTool"),Ce=class{constructor(e){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:e=[],endInstructions:r=[],signers:n=[]}){return this.instructions.push(...e),this.endInstructions.push(...r),this.signers.push(...n),this}build(e){let r=new X.Transaction;return this.allInstructions.length&&r.add(...this.allInstructions),r.feePayer=this.feePayer,{transaction:r,signers:this.signers,execute:async()=>{var o;let n=await fr(this.connection);if(r.recentBlockhash=n,(o=this.owner)!=null&&o.isKeyPair)return(0,X.sendAndConfirmTransaction)(this.connection,r,this.signers);if(this.signAllTransactions){this.signers.length&&r.partialSign(...this.signers);let i=await this.signAllTransactions([r]);return await this.connection.sendRawTransaction(i[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:r=[],extInfo:n}=e,{transaction:o}=this.build(n),i=r.filter(a=>a.transaction.instructions.length>0),s=[...i.map(a=>a.transaction),o],u=[...i.map(a=>a.signers),this.signers];return{transactions:s,signers:u,execute:async()=>{var d;let a=await fr(this.connection);if((d=this.owner)!=null&&d.isKeyPair)return await Promise.all(s.map(async(p,y)=>(p.recentBlockhash=a,await(0,X.sendAndConfirmTransaction)(this.connection,p,u[y]))));if(this.signAllTransactions){let p=s.map((f,b)=>(f.recentBlockhash=a,u[b].length&&f.partialSign(...u[b]),f)),y=await this.signAllTransactions(p),S=[];for(let f=0;f<y.length;f+=1){let b=await this.connection.sendRawTransaction(y[f].serialize(),{skipPreflight:!0});S.push(b)}return S}throw new Error("please connect wallet first")},extInfo:n||{}}}};async function fr(t){var e,r;try{return((r=await((e=t.getLatestBlockhash)==null?void 0:e.call(t)))==null?void 0:r.blockhash)||(await t.getRecentBlockhash()).blockhash}catch{return(await t.getRecentBlockhash()).blockhash}}async function Ue(t,e){let[r,n]=await X.PublicKey.findProgramAddress(t,e);return{publicKey:r,nonce:n}}function gr(t,e=1,r=[]){let n=[...t];if(e<=0)return r;for(;n.length;)r.push(n.splice(0,e));return r}var yr=require("@solana/web3.js");var it=_("Raydium_accountInfo_util");async function Fn(t,e,r){let{batchRequest:n,commitment:o}=R({batchRequest:!1},r),i=gr(e,100),s=new Array(i.length).fill([]);if(n){let u=i.map(d=>{let p=t._buildArgs([d.map(y=>y.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:p}});s=(await t._rpcBatchRequest(u)).map(d=>(d.error&&it.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(p=>{if(p){let{data:y,executable:S,lamports:f,owner:b,rentEpoch:A}=p;return y.length!==2&&y[1]!=="base64"&&it.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(y[0],"base64"),executable:S,lamports:f,owner:new yr.PublicKey(b),rentEpoch:A}}return null})))}else try{s=await Promise.all(i.map(u=>t.getMultipleAccountsInfo(u,o)))}catch(u){u instanceof Error&&it.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return s.flat()}async function br(t,e,r){let n=await Fn(t,e.map(o=>o.pubkey),r);return e.map((o,i)=>E(R({},o),{accountInfo:n[i]}))}function Z(t){if(t instanceof $)return new g(t.numerator,t.denominator);if(t instanceof q)return t.adjusted;if(t instanceof V)try{return Z(t.toExact())}catch{return new g(he)}if(t instanceof g)return t;let e=String(t),r=ce(e);return new g(r.numerator,r.denominator)}function _n(t,e){if(t==null||e==null)return!1;let r=Z(t),n=Z(e);return r.sub(n).numerator.gt(he)}function Nn(t,e){if(t==null||e==null)return!1;let r=Z(t),n=Z(e);return r.sub(n).numerator.eq(he)}function wr(t,e){if(t==null||e==null)return;let r=Z(t),n=Z(e);return r.sub(n)}function qe(t){return t==null?!1:!Nn(t,0)}function hr(t,e){return _n(e,t)?e:t}var Pr=t=>typeof t=="number",xr=t=>t?new Date(t):new Date,Kn=t=>xr(t).getTime();function Ie(t,e,r){let n=Pr(e)?e*((r==null?void 0:r.unit)==="s"?1e3:1):e;return new Date(t).getTime()<=n}function de(t,e,r){let n=Pr(e)?e*((r==null?void 0:r.unit)==="s"?1e3:1):e;return new Date(t).getTime()>n}function at(t,e){let n=Kn(t)+(e.days?e.days*24*60*60*1e3:0)+(e.hours?e.hours*60*60*1e3:0)+(e.minutes?e.minutes*60*1e3:0)+(e.seconds?e.seconds*1e3:0)+(e.milliseconds?e.milliseconds:0);return xr(n)}var ie=require("@solana/spl-token"),pe=require("@solana/web3.js"),Lr=W(require("bn.js"));var kr=require("@solana/web3.js"),me=W(require("bn.js"));var l=require("@solana/buffer-layout"),st=l.Layout,Tr=l.Structure;var ut=l.UInt;var Sr=l.seq;var Ae=l.blob;var je=class extends st{constructor(r,n,o){super(r,o);this.blob=Ae(r),this.signed=n}decode(r,n=0){let o=new me.default(this.blob.decode(r,n),10,"le");return this.signed?o.fromTwos(this.span*8).clone():o}encode(r,n,o=0){return typeof r=="number"&&(r=new me.default(r)),this.signed&&(r=r.toTwos(this.span*8)),this.blob.encode(r.toArrayLike(Buffer,"le",this.span),n,o)}};function H(t){return new ut(1,t)}function Ge(t){return new ut(4,t)}function m(t){return new je(8,!1,t)}function z(t){return new je(16,!1,t)}var ct=class extends st{constructor(r,n,o,i){super(r.span,i);this.layout=r,this.decoder=n,this.encoder=o}decode(r,n){return this.decoder(this.layout.decode(r,n))}encode(r,n,o){return this.layout.encode(this.encoder(r),n,o)}getSpan(r,n){return this.layout.getSpan(r,n)}};function T(t){return new ct(Ae(32),e=>new kr.PublicKey(e),e=>e.toBuffer(),t)}var dt=class extends Tr{decode(e,r){return super.decode(e,r)}};function M(t,e,r){return new dt(t,e,r)}function C(t,e,r){let n,o=typeof e=="number"?e:(0,me.isBN)(e)?e.toNumber():new Proxy(e,{get(i,s){if(!n){let u=Reflect.get(i,"count");n=(0,me.isBN)(u)?u.toNumber():u,Reflect.set(i,"count",n)}return Reflect.get(i,s)},set(i,s,u){return s==="count"&&(n=u),Reflect.set(i,s,u)}});return Sr(t,o,r)}var le=M([T("mint"),T("owner"),m("amount"),Ge("delegateOption"),T("delegate"),H("state"),Ge("isNativeOption"),m("isNative"),m("delegatedAmount"),Ge("closeAuthorityOption"),T("closeAuthority")]);function Mn(t){let{mint:e,tokenAccount:r,owner:n}=t;return(0,ie.createInitializeAccountInstruction)(r,e,n)}function Dn(t){let{tokenAccount:e,payer:r,multiSigners:n=[],owner:o}=t;return(0,ie.createCloseAccountInstruction)(e,r,o,n)}async function mt(t){let{connection:e,amount:r,commitment:n,payer:o,owner:i,skipCloseAccount:s}=t,u=await e.getMinimumBalanceForRentExemption(le.span,n),a=x(r).add(new Lr.default(u)),d=pe.Keypair.generate();return{signers:[d],instructions:[pe.SystemProgram.createAccount({fromPubkey:o,newAccountPubkey:d.publicKey,lamports:a.toNumber(),space:le.span,programId:ie.TOKEN_PROGRAM_ID}),Mn({mint:new pe.PublicKey(O.mint),tokenAccount:d.publicKey,owner:i})],endInstructions:s?[]:[Dn({tokenAccount:d.publicKey,payer:o,owner:i})]}}var lt=(...t)=>t.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Be=class{constructor({scope:e,moduleName:r}){this.disabled=!1;this.scope=e,this.logger=_(r)}createTxBuilder(e){return this.scope.checkOwner(),new Ce({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(lt(e))}logInfo(...e){this.logger.info(lt(e))}logAndCreateError(...e){let r=lt(e);throw new Error(r)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};var fe=require("@solana/web3.js");var pt=M([H("instruction")]),ft=M([H("instruction")]),Vn=M([m("rewardState"),m("rewardOpenTime"),m("rewardEndTime"),m("rewardLastUpdateTime"),m("totalReward"),m("totalRewardEmissioned"),m("rewardClaimed"),m("rewardPerSecond"),z("accRewardPerShare"),T("rewardVault"),T("rewardMint"),T("rewardSender"),m("rewardType"),C(m(),15,"padding")]),En=M([m("state"),m("nonce"),T("lpVault"),T("rewardVault"),T(),T(),m(),m(),m("totalReward"),z("perShareReward"),m("lastSlot"),m("perSlotReward")]),vn=M([m("state"),m("nonce"),T("lpVault"),T("rewardVaultA"),m("totalRewardA"),z("perShareRewardA"),m("perSlotRewardA"),H("option"),T("rewardVaultB"),Ae(7),m("totalRewardB"),z("perShareRewardB"),m("perSlotRewardB"),m("lastSlot"),T()]),Wn=M([m(),m("state"),m("nonce"),m("validRewardTokenNum"),z("rewardMultiplier"),m("rewardPeriodMax"),m("rewardPeriodMin"),m("rewardPeriodExtend"),T("lpMint"),T("lpVault"),C(Vn,5,"rewardInfos"),T("creator"),T(),C(m(),32,"padding")]),Ir=new Proxy(En,{get(t,e,r){return e==="decode"?(...n)=>{let o=t.decode(...n);return E(R({},o),{version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]})}:Reflect.get(t,e,r)}}),Ar=new Proxy(vn,{get(t,e,r){return e==="decode"?(...n)=>{let o=t.decode(...n);return E(R({},o),{version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]})}:Reflect.get(t,e,r)}}),Re=new Proxy(Wn,{get(t,e,r){return e==="decode"?(...n)=>{let o=t.decode(...n);return E(R({},o),{version:6,rewardInfos:o.rewardInfos.map(i=>{var s;return E(R({},i),{rewardType:((s=Object.entries(He).find(u=>String(u[1])===i.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(t,e,r)}}),On=M([m("isSet"),m("rewardPerSecond"),m("rewardOpenTime"),m("rewardEndTime"),m("rewardType")]),gt=M([H("instruction"),m("nonce"),C(On,5,"rewardTimeInfo")]),yt=M([H("instruction"),m("rewardReopenTime"),m("rewardEndTime"),m("rewardPerSecond")]),bt=M([H("instruction"),m("isSet"),m("rewardPerSecond"),m("rewardOpenTime"),m("rewardEndTime")]),Ta=M([m("state"),T("id"),T("owner"),m("deposited"),C(m(),1,"rewardDebts")]),Br=M([m("state"),T("id"),T("owner"),m("deposited"),C(z(),1,"rewardDebts"),C(m(),17)]),Sa=M([m("state"),T("id"),T("owner"),m("deposited"),C(m(),2,"rewardDebts")]),Rr=M([m("state"),T("id"),T("owner"),m("deposited"),C(z(),2,"rewardDebts"),C(m(),17)]),Fr=M([m(),m("state"),T("id"),T("owner"),m("deposited"),C(z(),5,"rewardDebts"),C(m(),16)]),Fe=M([H("instruction"),m("amount")]);var _r=_("Raydium_farm_config"),Nr="EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q",Cn=new fe.PublicKey(Nr),Kr="9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z",Un=new fe.PublicKey(Kr),Mr="FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG",qn=new fe.PublicKey(Mr),Dr={[Nr]:3,[Kr]:5,[Mr]:6},Vr={3:Cn,5:Un,6:qn},Er=new fe.PublicKey("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),vr=new fe.PublicKey("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),Wr={3:Ir,5:Ar,6:Re},Or={3:Br,5:Rr,6:Fr},wt=t=>[3,5,6].indexOf(t)!==-1,jn={3:10,5:11,6:1},Cr=t=>{let e=jn[t];return e||_r.logWithError("invalid deposit farm version"),e},Gn={3:11,5:12,6:2},Ur=t=>{let e=Gn[t];return e||_r.logWithError("invalid withdraw farm version"),e},qr=t=>{var s;let{version:e,rewardInfos:r,rewardTokenAccountsPublicKeys:n}=t,o=`rewardInfo:${JSON.stringify(r)}, rewardAccount:${JSON.stringify(n)}`,i={3:()=>{if(r.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(r.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||r.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}};return(s=i[e])==null?void 0:s.call(i)},He={"Standard SPL":0,"Option tokens":1};var ae=require("@solana/web3.js"),jr=W(require("bn.js"));var Hn=_("Raydium_farm_instruction");async function Gr(t){let{version:e,id:r,ledger:n,programId:o,owner:i}=t,s={3:9,5:10}[e];s||Hn.logWithError(`invalid farm pool version: ${e}`);let u=Buffer.alloc(pt.span);pt.encode({instruction:s},u);let a=[c({pubkey:r}),c({pubkey:n}),c({pubkey:i,isWritable:!1}),c({pubkey:ae.SystemProgram.programId,isWritable:!1}),c({pubkey:ae.SYSVAR_RENT_PUBKEY,isWritable:!1})];return new ae.TransactionInstruction({programId:o,keys:a,data:u})}function Hr(t){var n;let e=Buffer.alloc(gt.span);gt.encode({instruction:0,nonce:new jr.default(t.nonce),rewardTimeInfo:t.rewardInfoConfig},e);let r=[...We,c({pubkey:t.farmKeyPair.publicKey}),c({pubkey:t.farmAuthority,isWritable:!1}),c({pubkey:t.lpVault}),c({pubkey:t.lpMint,isWritable:!1}),c({pubkey:t.lockVault}),c({pubkey:t.lockMint,isWritable:!1}),c({pubkey:(n=t.lockUserAccount)!=null?n:v}),c({pubkey:t.owner,isWritable:!1,isSigner:!0})];for(let o of t.rewardInfo)r.push(c({pubkey:o.rewardMint,isWritable:!1}),c({pubkey:o.rewardVault}),c({pubkey:o.userRewardToken}));return new ae.TransactionInstruction({programId:t.programId,keys:r,data:e})}var D=W(require("bn.js"));var _e=_("Raydium.farm.util");async function Ye({programId:t,poolId:e,mint:r,type:n}){let{publicKey:o}=await Ue([e.toBuffer(),r.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],t);return o}function Yn(t){let r=J({publicKey:t}).toBase58();return Dr[r]}async function ht({programId:t,poolId:e,owner:r}){let{publicKey:n}=await Ue([e.toBuffer(),r.toBuffer(),Buffer.from(Yn(t)===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],t);return n}var Yr=async({programId:t,poolId:e})=>await Ue([e.toBuffer()],t);function $r(t){return Vr[t]}function Jr(t){return{isSet:new D.default(1),rewardPerSecond:x(t.rewardPerSecond),rewardOpenTime:x(t.rewardOpenTime),rewardEndTime:x(t.rewardEndTime),rewardType:x(t.rewardType)}}function Pt(t){return x(t.rewardEndTime).sub(x(t.rewardOpenTime)).mul(x(t.rewardPerSecond))}function $n(t){let e=Or[t];return e||_e.logWithError("invalid version",t),e}function Jn(t){let e=Wr[t];return e||_e.logWithError("invalid version",t),e}function zn(t,e,r,n){if(t.version===3||t.version===5){if(t.lastSlot.gte(new D.default(r)))return t;let o=new D.default(r).sub(t.lastSlot);t.lastSlot=new D.default(r);for(let i of t.rewardInfos){if(e.amount.eq(new D.default(0)))continue;let s=i.perSlotReward.mul(o);i.perShareReward=i.perShareReward.add(s.mul(new D.default(10).pow(new D.default(t.version===3?9:15))).div(e.amount)),i.totalReward=i.totalReward.add(s)}}else if(t.version===6)for(let o of t.rewardInfos){if(o.rewardState.eq(new D.default(0)))continue;let i=D.default.min(new D.default(n),o.rewardEndTime);if(o.rewardOpenTime.gte(i))continue;let u=i.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),a=o.totalReward.sub(o.totalRewardEmissioned);a.lt(u)?(u=a,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(a.div(o.rewardPerSecond))):o.rewardLastUpdateTime=i,!e.amount.eq(new D.default(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(u.mul(t.rewardMultiplier).div(e.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(u))}return t}async function Xn({connection:t,farmPools:e,owner:r,config:n}){var S;let o=!1,i=!1,s=new D.default(10),u=[];for(let f of e){let b=Le(f);b.version===6?i=!0:o=!0,u.push({pubkey:b.id,version:b.version,key:"state",poolId:b.id},{pubkey:b.lpVault,version:b.version,key:"lpVault",poolId:b.id}),r&&u.push({pubkey:await ht({programId:b.programId,poolId:b.id,owner:r}),version:b.version,key:"ledger",poolId:b.id})}let a={},d=await br(t,u,n);for(let{pubkey:f,version:b,key:A,poolId:B,accountInfo:w}of d){let F=B.toBase58();if(a[F]=R({},a[F]),A==="state"){let U=Jn(b);(!w||!w.data||w.data.length!==U.span)&&_e.logWithError(`invalid farm state account info, pools.id, ${f}`),a[F].state=U.decode(w.data)}else if(A==="lpVault")(!w||!w.data||w.data.length!==le.span)&&_e.logWithError(`invalid farm lp vault account info, pools.lpVault, ${f}`),a[F].lpVault=le.decode(w.data);else if(A==="ledger"){let U=$n(b);w&&w.data&&(w.data.length!==U.span&&_e.logWithError(`invalid farm ledger account info, ledger, ${f}`),a[F].ledger=U.decode(w.data))}}let p=i||o?await t.getSlot():0,y=i&&(S=await t.getBlockTime(p))!=null?S:0;for(let f of Object.keys(a))a[f].state=zn(a[f].state,a[f].lpVault,p,y);for(let[f,{state:b,ledger:A}]of Object.entries(a))if(A){let B=b.version===6?b.rewardMultiplier:b.rewardInfos.length===1?s.pow(new D.default(9)):s.pow(new D.default(15)),w=b.rewardInfos.map((F,U)=>{let K=A.rewardDebts[U];return A.deposited.mul(b.version===6?F.accRewardPerShare:F.perShareReward).div(B).sub(K)});a[f].wrapped=E(R({},a[f].wrapped),{pendingRewards:w})}return a}async function zr(t){let{farmPools:e}=t,r=await Xn(t);return e.map((o,i)=>E(R(R(R({},e[i]),Le(o)),r[o.id]),{jsonInfo:e[i]}))}function Xr(t,e=Date.now()){if(t.version===6){let r=t.state.rewardInfos;if(r.every(({rewardOpenTime:n})=>Ie(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(r.every(({rewardEndTime:n})=>de(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let r=t.state.rewardInfos.map(({perSlotReward:n})=>n);if(r.length===2){if(String(r[0])==="0"&&String(r[1])!=="0")return"normal fusion pool";if(String(r[0])!=="0"&&String(r[1])!=="0")return"dual fusion pool";if(String(r[0])==="0"&&String(r[1])==="0")return"closed pool"}else if(r.length===1&&String(r[0])==="0")return"closed pool"}}function Zr(t){return t.state.rewardInfos.length===1&&String(t.lpMint)===dr.toBase58()}function Qr(t,e){return t.version===6?t.state.rewardInfos.map(({rewardPerSecond:r,rewardOpenTime:n,rewardEndTime:o},i)=>{var S;let s=Ie(e.currentBlockChainDate,n.toNumber(),{unit:"s"}),u=de(e.currentBlockChainDate,o.toNumber(),{unit:"s"});if(s||u)return;let a=e.rewardTokens[i];if(!a)return;let d=e.rewardTokenPrices[i];if(!d)return;let p=Pe(new g(r,ne).div(oe.pow(new D.default(a.decimals||1))).mul(new D.default(60*60*24*365)),d);return e.tvl?e.tvl.isZero()?re(0):p.div((S=e.tvl)!=null?S:ne):void 0}):t.state.rewardInfos.map(({perSlotReward:n},o)=>{var d;let i=e.rewardTokens[o];if(!i)return;let s=e.rewardTokenPrices[o];if(!s)return;let u=Pe(new g(n,ne).div(oe.pow(new D.default(i.decimals||1))).mul(new D.default(e.blockSlotCountForSecond*60*60*24*365)),s);return e.tvl?e.tvl.isZero()?re(0):u.div((d=e.tvl)!=null?d:ne):void 0})}var Je=class extends Be{constructor(){super(...arguments);this._farmPools=[];this._hydratedFarmPools=[];this._hydratedFarmMap=new Map;this._sdkParsedFarmPools=[];this._lpTokenInfoMap=new Map}async load(r){var o;await this.scope.liquidity.load(r),await this.scope.fetchFarms(r==null?void 0:r.forceUpdate);let n=((o=this.scope.apiData.farmPools)==null?void 0:o.data)||{};this._farmPools=Object.keys(n||{}).reduce((i,s)=>{var u,a;return i.concat(((a=(u=n[s]).map)==null?void 0:a.call(u,d=>{let p=this.scope.token.allTokenMap.get(d.baseMint),y=this.scope.token.allTokenMap.get(d.quoteMint);return p&&y&&this._lpTokenInfoMap.set(d.lpMint,new G({mint:d.lpMint,decimals:p.decimals,symbol:`${p.symbol} - ${y.name}`,name:`${p.symbol} - ${y.name} LP`})),E(R({},d),{name:d.symbol,category:s})}))||[])},[]),await this.fetchSdkFarmInfo()}async fetchSdkFarmInfo(){var r;this._sdkParsedFarmPools=await zr({connection:this.scope.connection,farmPools:this._farmPools,owner:(r=this.scope.owner)==null?void 0:r.publicKey,config:{commitment:"confirmed"}})}async loadHydratedFarmInfo(r){let{forceUpdate:n,skipPrice:o}=r||{};if(this._hydratedFarmPools.length&&!n)return this._hydratedFarmPools;await this.scope.farm.load();try{await this.scope.account.fetchWalletTokenAccounts()}catch{}!o&&await this.scope.token.fetchTokenPrices(),await this.scope.liquidity.loadPairs();let i=await this.scope.chainTimeOffset(),s=at(Date.now()+i,{minutes:0}),u=await this.scope.api.getBlockSlotCountForSecond(this.scope.connection.rpcEndpoint),a=Object.fromEntries(this.scope.liquidity.allPairs.map(d=>[d.ammId,{apr30d:d.apr30d,apr7d:d.apr7d,apr24h:d.apr24h}]));return this._hydratedFarmPools=this._sdkParsedFarmPools.map(d=>{let p=this.hydrateFarmInfo({farmInfo:d,blockSlotCountForSecond:u,farmAprs:a,currentBlockChainDate:s,chainTimeOffset:i});return this._hydratedFarmMap.set(d.id.toBase58(),p),p}),this._hydratedFarmPools}get allFarms(){return this._farmPools}get allParsedFarms(){return this._sdkParsedFarmPools}get allHydratedFarms(){return this._hydratedFarmPools}get allHydratedFarmMap(){return this._hydratedFarmMap}getFarm(r){let n=J({publicKey:r}),o=this.allFarms.find(i=>i.id===n.toBase58());return o||this.logAndCreateError("invalid farm id"),o}getParsedFarm(r){let n=J({publicKey:r}),o=this.allParsedFarms.find(i=>n.equals(i.id));return o||this.logAndCreateError("invalid farm id"),o}getLpTokenInfo(r){let n=J({publicKey:r}),o=this._lpTokenInfoMap.get(n.toBase58());return o||this.logAndCreateError("LP Token not found",n.toBase58()),o}lpDecimalAmount({mint:r,amount:n}){let o=ce(n),i=this.getLpTokenInfo(r);return Ve(new g(o.numerator,o.denominator).mul(new $e.default(10).pow(new $e.default(i.decimals))))}hydrateFarmInfo(r){var It,At,Bt,Rt,Ft,_t,Nt,Kt,Mt,Dt,Vt,Et;let{farmInfo:n,blockSlotCountForSecond:o,farmAprs:i,currentBlockChainDate:s,chainTimeOffset:u=0}=r,a=Xr(n,s),d=Zr(n),p=a==="dual fusion pool",y=a==="normal fusion pool",S=a==="closed pool"&&!n.upcoming,f=n.version!==6?n.upcoming&&S:n.upcoming,b=n.version!==6&&n.upcoming&&!S,A=((It=this.scope.liquidity.allPools.find(h=>h.lpMint===n.lpMint.toBase58()))==null?void 0:It.version)===5,B=d?this.scope.mintToToken(n.lpMint):this.getLpTokenInfo(n.lpMint),w=this.scope.mintToToken(d?n.lpMint:n.baseMint),F=this.scope.mintToToken(d?n.lpMint:n.quoteMint);w!=null&&w.symbol;let U=d?`${(At=w==null?void 0:w.symbol)!=null?At:"unknown"}`:`${(Bt=w==null?void 0:w.symbol)!=null?Bt:"unknown"}-${(Rt=F==null?void 0:F.symbol)!=null?Rt:"unknown"}`,K=n.jsonInfo.rewardInfos.map(({rewardMint:h})=>this.scope.mintToToken(h)),j=(Ft=n.wrapped)==null?void 0:Ft.pendingRewards.map((h,L)=>K[L]?new V(K[L],Ve(hr(h,0))):void 0),se=d?this.scope.token.tokenPrices.get(n.lpMint.toBase58()):this.scope.liquidity.lpPriceMap.get(n.lpMint.toBase58()),Ne=B&&new V(B,n.lpVault.amount),xt=se&&B?Pe(new V(B,n.lpVault.amount),se):void 0,ge=Qr(n,{tvl:xt,currentBlockChainDate:s,rewardTokens:K,rewardTokenPrices:(_t=n.rewardInfos.map(({rewardMint:h})=>this.scope.token.tokenPrices.get(h.toBase58())))!=null?_t:[],blockSlotCountForSecond:o}),ee=(Nt=this.scope.liquidity.allPools.find(h=>h.lpMint===n.lpMint.toBase58()))==null?void 0:Nt.id,Tt=ee?Ee((Kt=i[ee])==null?void 0:Kt.apr7d,{alreadyDecimaled:!0}):void 0,St=ee?Ee((Mt=i[ee])==null?void 0:Mt.apr30d,{alreadyDecimaled:!0}):void 0,kt=ee?Ee((Dt=i[ee])==null?void 0:Dt.apr24h,{alreadyDecimaled:!0}):void 0,en=ge.reduce((h,L)=>h?L?h.add(L):h:L,Tt),tn=ge.reduce((h,L)=>h?L?h.add(L):h:L,St),rn=ge.reduce((h,L)=>h?L?h.add(L):h:L,kt),nn=n.version===6?n.state.rewardInfos.map((h,L)=>{var Ct,Ut,qt,jt;let{rewardOpenTime:ye,rewardEndTime:Ke,rewardPerSecond:ze}=h,te=ye.toNumber()?new Date(ye.toNumber()*1e3+u):void 0,Y=Ke.toNumber()?new Date(Ke.toNumber()*1e3+u):void 0,Xe=Date.now()+u;if(!te&&!Y)return;let ue=this.scope.mintToToken((qt=(Ut=h.rewardMint)!=null?Ut:(Ct=n.rewardInfos[L])==null?void 0:Ct.rewardMint)==null?void 0:qt.toBase58()),vt=Boolean(te&&Ie(Xe,te)),Wt=Boolean(Y&&de(Xe,Y)),Ot=!te&&!Y||!Wt&&!vt,on=Ot&&de(Xe,at(Y,{seconds:-((jt=n.jsonInfo.rewardPeriodExtend)!=null?jt:72*60*60)})),an=ue&&this.scope.mintToTokenAmount({mint:ue.mint,amount:wr(h.totalReward,h.totalRewardEmissioned).toFixed(ue.decimals)}),sn=j==null?void 0:j[L],un=ge[L],cn=Boolean(Y),Me=n.rewardInfos[L];return E(R(R({},Me),h),{owner:Me==null?void 0:Me.rewardSender,apr:un,token:ue,userPendingReward:sn,userHavedReward:cn,perSecond:ue&&this.scope.mintToTokenAmount({mint:ue.mint,amount:ze}).toSignificant(),openTime:te,endTime:Y,isOptionToken:h.rewardType==="Option tokens",isRewardBeforeStart:vt,isRewardEnded:Wt,isRewarding:Ot,isRwardingBeforeEnd72h:on,claimableRewards:an,version:6})}).filter(h=>!!h):n.state.rewardInfos.map((h,L)=>{let ye=j==null?void 0:j[L],Ke=ge[L],ze=K[L],{perSlotReward:te}=h,Y=qe(ye)||qe(te);return E(R({},h),{apr:Ke,token:ze,userPendingReward:ye,userHavedReward:Y,version:n.version})}),Lt=B&&((Vt=n.ledger)==null?void 0:Vt.deposited)?new V(B,(Et=n.ledger)==null?void 0:Et.deposited):void 0;return E(R({},n),{lp:B,lpPrice:se,base:w,quote:F,name:U,isStakePool:d,isDualFusionPool:p,isNormalFusionPool:y,isClosedPool:S,isUpcomingPool:f,isStablePool:A,isNewPool:b,totalApr7d:en,raydiumFeeApr7d:Tt,totalApr24h:rn,raydiumFeeApr24h:kt,totalApr30d:tn,raydiumFeeApr30d:St,ammId:ee,tvl:xt,userHasStaked:qe(Lt),rewards:nn,userStakedLpAmount:Lt,stakedLpAmount:Ne})}async _getUserRewardInfo({payer:r,rewardInfo:n}){if(n.rewardMint.equals(v)){let o=await mt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:r,amount:Pt(n)});return{rewardPubKey:o.signers[0].publicKey,newInstruction:o}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:n.rewardMint})}}async create({poolId:r,rewardInfos:n,payer:o}){this.checkDisabled(),this.scope.checkOwner();let i=J({publicKey:r}),s=this.scope.liquidity.allPools.find(K=>K.id===i.toBase58());s||this.logAndCreateError("invalid pool id");let a={lpMint:new P.PublicKey(s.lpMint),lockInfo:{lockMint:Er,lockVault:vr},version:6,rewardInfos:n,programId:$r(6)},d=this.createTxBuilder(),p=o!=null?o:this.scope.ownerPubKey,y=P.Keypair.generate(),S=await this.scope.connection.getMinimumBalanceForRentExemption(Re.span);d.addInstruction({instructions:[P.SystemProgram.createAccount({fromPubkey:p,newAccountPubkey:y.publicKey,lamports:S,space:Re.span,programId:a.programId})],signers:[y]});let{publicKey:f,nonce:b}=await Yr({programId:a.programId,poolId:y.publicKey}),A=await Ye({programId:a.programId,poolId:y.publicKey,mint:a.lpMint,type:"lpVault"}),B=[],w=[];for(let K of a.rewardInfos){K.rewardOpenTime>=K.rewardEndTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",K.rewardOpenTime.toString()),He[K.rewardType]||this.logAndCreateError("rewardType error",K.rewardType),K.rewardPerSecond<=0&&this.logAndCreateError("rewardPerSecond error",K.rewardPerSecond.toString()),B.push(Jr(K));let{rewardPubKey:j,newInstruction:se}=await this._getUserRewardInfo({rewardInfo:K,payer:p});se&&d.addInstruction(se),j||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let Ne=K.rewardMint.equals(v)?new P.PublicKey(O.mint):K.rewardMint;w.push({rewardMint:Ne,rewardVault:await Ye({programId:a.programId,poolId:y.publicKey,mint:Ne,type:"rewardVault"}),userRewardToken:j})}let F=await this.scope.account.getCreatedTokenAccount({mint:a.lockInfo.lockMint});F||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let U=Hr({farmKeyPair:y,owner:this.scope.ownerPubKey,farmAuthority:f,lpVault:A,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:F,programId:a.programId,rewardInfo:w,rewardInfoConfig:B,nonce:b});return await d.addInstruction({instructions:[U]}).build()}async restartReward({farmId:r,payer:n,newRewardInfo:o}){let i=this.getFarm(r);i.version!==6&&this.logAndCreateError("invalid farm version",i.version);let s={id:new P.PublicKey(i.id),rewardInfos:i.rewardInfos,lpVault:new P.PublicKey(i.lpVault),programId:new P.PublicKey(i.programId)};o.rewardOpenTime>=o.rewardEndTime&&this.logAndCreateError("start time error","newRewardInfo",o);let u=n||this.scope.ownerPubKey,a=o.rewardMint.equals(v)?new P.PublicKey(O.mint):o.rewardMint,d=s.rewardInfos.find(B=>new P.PublicKey(B.rewardMint).equals(a));d||this.logAndCreateError("configuration does not exist","rewardMint",a);let p=d.rewardVault?new P.PublicKey(d.rewardVault):v,y=this.createTxBuilder(),{rewardPubKey:S,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:o,payer:u});f&&y.addInstruction(f),S||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=Buffer.alloc(yt.span);yt.encode({instruction:3,rewardReopenTime:x(o.rewardOpenTime),rewardEndTime:x(o.rewardEndTime),rewardPerSecond:x(o.rewardPerSecond)},b);let A=[c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:s.id}),c({pubkey:s.lpVault,isWritable:!1}),c({pubkey:p}),c({pubkey:S}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await y.addInstruction({instructions:[new P.TransactionInstruction({programId:s.programId,keys:A,data:b})]}).build()}async addNewRewardToken(r){let{farmId:n,newRewardInfo:o,payer:i}=r,s=this.getFarm(n);s.version!==6&&this.logAndCreateError("invalid farm version",s.version);let u=i!=null?i:this.scope.ownerPubKey,a=this.createTxBuilder(),d=await Ye({programId:new P.PublicKey(s.programId),poolId:new P.PublicKey(s.id),mint:o.rewardMint,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:o,payer:u});y&&a.addInstruction(y),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts);let S=o.rewardMint.equals(v)?new P.PublicKey(O.mint):o.rewardMint,f=Buffer.alloc(bt.span);bt.encode({instruction:4,isSet:new $e.default(1),rewardPerSecond:x(o.rewardPerSecond),rewardOpenTime:x(o.rewardOpenTime),rewardEndTime:x(o.rewardEndTime)},f);let b=[...We,c({pubkey:new P.PublicKey(s.id)}),c({pubkey:new P.PublicKey(s.authority),isWritable:!1}),c({pubkey:S,isWritable:!1}),c({pubkey:d}),c({pubkey:p}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await a.addInstruction({instructions:[new P.TransactionInstruction({programId:new P.PublicKey(s.programId),keys:b,data:f})]}).build()}async _prepareFarmAccounts(r){let n=this.createTxBuilder(),{farmInfo:o}=r,{pubKey:i,newInstructions:s}=await this.scope.account.checkOrCreateAta({mint:o.lpMint});n.addInstruction(s);let u=await Promise.all(o.rewardInfos.map(async({rewardMint:p})=>{let{pubKey:y,newInstructions:S}=await this.scope.account.checkOrCreateAta({mint:p,autoUnwrapWSOLToSOL:!0});return n.addInstruction(S),y})),a=await ht({programId:new P.PublicKey(o.programId),poolId:new P.PublicKey(o.id),owner:this.scope.ownerPubKey});if(!o.ledger&&o.version<6){let p=await Gr({id:o.id,programId:o.programId,version:o.version,ledger:a,owner:this.scope.ownerPubKey});n.addInstruction({instructions:[p]})}let d=[c({pubkey:o.id}),c({pubkey:o.authority,isWritable:!1}),c({pubkey:a}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:i}),c({pubkey:new P.PublicKey(o.jsonInfo.lpVault)}),c({pubkey:u[0]}),c({pubkey:o.rewardInfos[0].rewardVault}),c({pubkey:P.SYSVAR_CLOCK_PUBKEY,isWritable:!1}),c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1})];return{txBuilder:n,lpTokenAccount:i,rewardTokenAccountsPublicKeys:u,ledgerAddress:a,lowVersionKeys:d}}async deposit(r){this.scope.checkOwner();let{farmId:n,amount:o}=r,i=this.getParsedFarm(n),s=i.lpMint,{version:u,rewardInfos:a}=i;wt(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:d,ledgerAddress:p,lpTokenAccount:y,lowVersionKeys:S,rewardTokenAccountsPublicKeys:f}=await this._prepareFarmAccounts({mint:s,farmInfo:i}),b=qr({version:u,rewardInfos:a,rewardTokenAccountsPublicKeys:f});b&&this.logAndCreateError(b);let A=Buffer.alloc(Fe.span);Fe.encode({instruction:Cr(u),amount:x(o)},A);let B=u===6?[c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:P.SystemProgram.programId,isWritable:!1}),c({pubkey:i.id}),c({pubkey:i.authority,isWritable:!1}),c({pubkey:i.lpVault.mint}),c({pubkey:p}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:y})]:S;if(u!==3)for(let F=1;F<a.length;F++)B.push(c({pubkey:f[F]})),B.push(c({pubkey:a[F].rewardVault}));let w=new P.TransactionInstruction({programId:i.programId,keys:B,data:A});return await d.addInstruction({instructions:[w]}).build()}async withdraw(r){this.scope.checkOwner();let{farmId:n,amount:o}=r,i=this.getParsedFarm(n),s=i.lpMint,{version:u,rewardInfos:a}=i;wt(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:d,ledgerAddress:p,lpTokenAccount:y,lowVersionKeys:S,rewardTokenAccountsPublicKeys:f}=await this._prepareFarmAccounts({mint:s,farmInfo:i}),b=Buffer.alloc(Fe.span);Fe.encode({instruction:Ur(u),amount:x(o)},b);let A=u===6?[c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:i.id}),c({pubkey:i.authority,isWritable:!1}),c({pubkey:i.lpVault.mint}),c({pubkey:p}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:y})]:S;if(u!==3)for(let w=1;w<a.length;w++)A.push(c({pubkey:f[w]})),A.push(c({pubkey:a[w].rewardVault}));let B=new P.TransactionInstruction({programId:i.programId,keys:A,data:b});return await d.addInstruction({instructions:[B]}).build()}async withdrawFarmReward({farmId:r,withdrawMint:n}){var S;this.scope.checkOwner();let o=this.getParsedFarm(r),{version:i}=o;i!==6&&this.logAndCreateError("invalid farm version",o.version);let s=o.rewardInfos.find(f=>f.rewardMint.equals(n.equals(v)?new P.PublicKey(O.mint):n));s||this.logAndCreateError("withdraw mint error","rewardInfos",o);let u=(S=s==null?void 0:s.rewardVault)!=null?S:v,a=this.createTxBuilder(),d;if(this._getUserRewardInfo({payer:this.scope.ownerPubKey,rewardInfo:s}),n.equals(v)){let f=await mt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:Pt(s)});d=f.signers[0].publicKey,a.addInstruction(f)}else{let f=await this.scope.account.getCreatedTokenAccount({mint:n});f===null?(d=await this.scope.account.getAssociatedTokenAccount(n),a.addInstruction({instructions:[(0,Q.createAssociatedTokenAccountInstruction)(this.scope.ownerPubKey,d,this.scope.ownerPubKey,n)]})):d=f}let p=Buffer.alloc(ft.span);ft.encode({instruction:5},p);let y=[c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:o.id}),c({pubkey:o.authority,isWritable:!1}),c({pubkey:o.lpVault.mint,isWritable:!1}),c({pubkey:u}),c({pubkey:d}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await a.addInstruction({instructions:[new P.TransactionInstruction({programId:o.programId,keys:y,data:p})]}).build()}};0&&(module.exports={});
//# sourceMappingURL=farm.js.map