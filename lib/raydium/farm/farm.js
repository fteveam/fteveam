var cn=Object.create;var be=Object.defineProperty,dn=Object.defineProperties,mn=Object.getOwnPropertyDescriptor,ln=Object.getOwnPropertyDescriptors,pn=Object.getOwnPropertyNames,qt=Object.getOwnPropertySymbols,fn=Object.getPrototypeOf,Gt=Object.prototype.hasOwnProperty,yn=Object.prototype.propertyIsEnumerable;var jt=(e,t,r)=>t in e?be(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,R=(e,t)=>{for(var r in t||(t={}))Gt.call(t,r)&&jt(e,r,t[r]);if(qt)for(var r of qt(t))yn.call(t,r)&&jt(e,r,t[r]);return e},E=(e,t)=>dn(e,ln(t));var gn=(e,t)=>{for(var r in t)be(e,r,{get:t[r],enumerable:!0})},Ht=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of pn(t))!Gt.call(e,o)&&o!==r&&be(e,o,{get:()=>t[o],enumerable:!(n=mn(t,o))||n.enumerable});return e};var v=(e,t,r)=>(r=e!=null?cn(fn(e)):{},Ht(t||!e||!e.__esModule?be(r,"default",{value:e,enumerable:!0}):r,e)),bn=e=>Ht(be({},"__esModule",{value:!0}),e);var Qn={};gn(Qn,{default:()=>Je});module.exports=bn(Qn);var Q=require("@solana/spl-token"),h=require("@solana/web3.js"),Ye=v(require("bn.js"));var we=require("lodash"),Yt=v(require("pino")),Jt=v(require("pino-pretty")),$t={},wn={},Pn=(0,Jt.default)({colorize:!0,levelFirst:!0,translateTime:"SYS:yyyymmdd HH:MM:ss.l"}),hn=(0,Yt.default)({base:null,level:"silent"},Pn);function _(e){let t=(0,we.get)($t,e);if(!t){let r=(0,we.get)(wn,e);t=hn.child({name:e},{level:r}),(0,we.set)($t,e,t)}return t.logWithError=(...r)=>{let n=r.map(o=>typeof o=="object"?JSON.stringify(o):o).join(", ");throw new Error(n)},t}var mr=require("@solana/web3.js"),lr=v(require("bn.js"));var nr=v(require("big.js")),ke=v(require("bn.js"));var I=v(require("bn.js"));var De=_("Raydium_bignumber");var Pe=new I.default(0),ne=new I.default(1),ao=new I.default(2),so=new I.default(3),uo=new I.default(5),oe=new I.default(10),Zt=new I.default(100),co=new I.default(1e3),mo=new I.default(1e4),zt=9007199254740991;function x(e){if(e instanceof I.default)return e;if(typeof e=="string"){if(e.match(/^-?[0-9]+$/))return new I.default(e);De.logWithError(`invalid BigNumberish string: ${e}`)}return typeof e=="number"?(e%1&&De.logWithError(`BigNumberish number underflow: ${e}`),(e>=zt||e<=-zt)&&De.logWithError(`BigNumberish number overflow: ${e}`),new I.default(String(e))):typeof e=="bigint"?new I.default(e.toString()):(De.logWithError(`invalid BigNumberish value: ${e}`),new I.default(0))}function Ze(e){return oe.pow(x(e))}function ce(e){var u;if(e===void 0)return{denominator:"1",numerator:"0"};if(e instanceof I.default)return{numerator:e.toString(),denominator:"1"};if(e instanceof y)return{denominator:e.denominator.toString(),numerator:e.numerator.toString()};let t=String(e),[,r="",n="",o=""]=(u=t.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?u:[],i="1"+"0".repeat(o.length),s=r+(n==="0"?"":n)+o||"0";return{denominator:i,numerator:s,sign:r,int:n,dec:o}}function xn(e){var n;let[,t="",r=""]=(n=e.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?n:[];return`${t}${r}`}function Ve(e,t=0){return e instanceof I.default?e:new I.default(xn(re(e).mul(oe.pow(new I.default(String(t))))))}function re(e){if(e instanceof Y)return new y(e.numerator,e.denominator);if(e instanceof q)return e.adjusted;if(e instanceof V)try{return re(e.toExact())}catch{return new y(Pe)}if(e instanceof y)return e;let t=String(e),r=ce(t);return new y(r.numerator,r.denominator)}function Ee(e,t){let{numerator:r,denominator:n}=ce(e);return new Y(new I.default(r),new I.default(n).mul(t!=null&&t.alreadyDecimaled?new I.default(100):new I.default(1)))}function Qt(e,t){if(e==null||t==null)return;let r=re(e),n=re(t);return r.mul(n)}function Xt(e){let t=new G({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),r=Ve(Qt(e,10**t.decimals));return new V(t,r)}function he(e,t){return Xt(!t||!e?0:Qt(e,t))}var er=v(require("toformat")),Tn=er.default,xe=Tn;var Te=v(require("big.js")),tr=v(require("decimal.js-light"));var We=_("module/fraction"),Qe=xe(Te.default),Se=xe(tr.default),kn={[0]:Se.ROUND_DOWN,[1]:Se.ROUND_HALF_UP,[2]:Se.ROUND_UP},Ln={[0]:Te.default.roundDown,[1]:Te.default.roundHalfUp,[2]:Te.default.roundUp},y=class{constructor(t,r=ne){this.numerator=x(t),this.denominator=x(r)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new y(this.denominator,this.numerator)}add(t){let r=t instanceof y?t:new y(x(t));return this.denominator.eq(r.denominator)?new y(this.numerator.add(r.numerator),this.denominator):new y(this.numerator.mul(r.denominator).add(r.numerator.mul(this.denominator)),this.denominator.mul(r.denominator))}sub(t){let r=t instanceof y?t:new y(x(t));return this.denominator.eq(r.denominator)?new y(this.numerator.sub(r.numerator),this.denominator):new y(this.numerator.mul(r.denominator).sub(r.numerator.mul(this.denominator)),this.denominator.mul(r.denominator))}mul(t){let r=t instanceof y?t:new y(x(t));return new y(this.numerator.mul(r.numerator),this.denominator.mul(r.denominator))}div(t){let r=t instanceof y?t:new y(x(t));return new y(this.numerator.mul(r.denominator),this.denominator.mul(r.numerator))}toSignificant(t,r={groupSeparator:""},n=1){Number.isInteger(t)||We.logWithError(`${t} is not an integer.`),t<=0&&We.logWithError(`${t} is not positive.`),Se.set({precision:t+1,rounding:kn[n]});let o=new Se(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(t);return o.toFormat(o.decimalPlaces(),r)}toFixed(t,r={groupSeparator:""},n=1){return Number.isInteger(t)||We.logWithError(`${t} is not an integer.`),t<0&&We.logWithError(`${t} is negative.`),Qe.DP=t,Qe.RM=Ln[n]||1,new Qe(this.numerator.toString()).div(this.denominator.toString()).toFormat(t,r)}isZero(){return this.numerator.isZero()}};var In=_("Raydium_amount"),rr=xe(nr.default);function An(e,t){let r="0",n="0";if(e.includes(".")){let o=e.split(".");o.length===2?([r,n]=o,n=n.padEnd(t,"0")):In.logWithError(`invalid number string, num: ${e}`)}else r=e;return[r,n.slice(0,t)||n]}var V=class extends y{constructor(r,n,o=!0,i){let s=new ke.default(0),u=oe.pow(new ke.default(r.decimals));if(o)s=x(n);else{let a=new ke.default(0),d=new ke.default(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[p,g]=An(n.toString(),r.decimals);a=x(p),d=x(g)}a=a.mul(u),s=a.add(d)}super(s,u);this.logger=_(i||"Amount"),this.token=r}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(r){return this.token.equals(r.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(r.raw)}lt(r){return this.token.equals(r.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(r.raw)}add(r){return this.token.equals(r.token)||this.logger.logWithError("add token not equals"),new V(this.token,this.raw.add(r.raw))}subtract(r){return this.token.equals(r.token)||this.logger.logWithError("sub token not equals"),new V(this.token,this.raw.sub(r.raw))}toSignificant(r=this.token.decimals,n,o=0){return super.toSignificant(r,n,o)}toFixed(r=this.token.decimals,n,o=0){return r>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(r,n,o)}toExact(r={groupSeparator:""}){return rr.DP=this.token.decimals,new rr(this.numerator.toString()).div(this.denominator.toString()).toFormat(r)}};var or=require("@solana/web3.js"),ir={symbol:"SOL",name:"Solana",decimals:9},O={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},Bo={isQuantumSOL:!0,isLp:!1,official:!0,mint:new or.PublicKey(O.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};var Oe=require("@solana/web3.js");var sr=require("@solana/spl-token"),N=require("@solana/web3.js");function c({pubkey:e,isSigner:t=!1,isWritable:r=!0}){return{pubkey:e,isWritable:r,isSigner:t}}var ve=[c({pubkey:sr.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:N.SystemProgram.programId,isWritable:!1}),c({pubkey:N.SYSVAR_RENT_PUBKEY,isWritable:!1})];function J({publicKey:e,transformSol:t}){if(e instanceof N.PublicKey)return t&&e.equals(W)?ar:e;if(t&&e===W.toBase58())return ar;if(typeof e=="string")try{return new N.PublicKey(e)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}function ur(e){try{return new N.PublicKey(e)}catch{return e}}var cr=new N.PublicKey("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),_o=new N.PublicKey("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),No=new N.PublicKey("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Ko=new N.PublicKey("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),Mo=new N.PublicKey("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Do=new N.PublicKey("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Vo=new N.PublicKey("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Eo=new N.PublicKey("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Wo=new N.PublicKey("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),vo=new N.PublicKey("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Oo=new N.PublicKey("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),ar=new N.PublicKey("So11111111111111111111111111111111111111112"),W=N.PublicKey.default;var et=class{constructor({mint:t,decimals:r,symbol:n="UNKNOWN",name:o="UNKNOWN",skipMint:i=!1}){if(t===W.toBase58()||t instanceof Oe.PublicKey&&W.equals(t)){this.decimals=O.decimals,this.symbol=O.symbol,this.name=O.name,this.mint=new Oe.PublicKey(O.mint);return}this.decimals=r,this.symbol=n,this.name=o,this.mint=i?Oe.PublicKey.default:J({publicKey:t})}equals(t){return this===t?!0:this.mint.equals(t.mint)}},G=et;G.WSOL=new et(O);var rt=class{constructor({decimals:t,symbol:r="UNKNOWN",name:n="UNKNOWN"}){this.decimals=t,this.symbol=r,this.name=n}equals(t){return this===t}},tt=rt;tt.SOL=new rt(ir);var dr=new y(Zt),Y=class extends y{toSignificant(t=5,r,n){return this.mul(dr).toSignificant(t,r,n)}toFixed(t=2,r,n){return this.mul(dr).toFixed(t,r,n)}};var Bn=_("Raydium_price"),q=class extends y{constructor(r){let{baseToken:n,quoteToken:o,numerator:i,denominator:s}=r;super(i,s);this.baseToken=n,this.quoteToken=o,this.scalar=new y(Ze(n.decimals),Ze(o.decimals))}get raw(){return new y(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new q({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(r){this.quoteToken!==r.baseToken&&Bn.logWithError("mul token not equals");let n=super.mul(r);return new q({baseToken:this.baseToken,quoteToken:r.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(r=this.quoteToken.decimals,n,o){return this.adjusted.toSignificant(r,n,o)}toFixed(r=this.quoteToken.decimals,n,o){return this.adjusted.toFixed(r,n,o)}};var Rn=[G,V,mr.PublicKey,y,lr.default,q,Y];function Fn(e){return typeof e=="object"&&e!==null&&!Rn.some(t=>typeof t=="object"&&e instanceof t)}function Le(e){return typeof e=="string"?ur(e):Array.isArray(e)?e.map(t=>Le(t)):Fn(e)?Object.fromEntries(Object.entries(e).map(([t,r])=>[t,Le(r)])):e}var X=require("@solana/web3.js");var Ti=_("Raydium_txTool"),Ce=class{constructor(t){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=t.connection,this.feePayer=t.feePayer,this.signAllTransactions=t.signAllTransactions,this.owner=t.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:t=[],endInstructions:r=[],signers:n=[]}){return this.instructions.push(...t),this.endInstructions.push(...r),this.signers.push(...n),this}build(t){let r=new X.Transaction;return this.allInstructions.length&&r.add(...this.allInstructions),r.feePayer=this.feePayer,{transaction:r,signers:this.signers,execute:async()=>{var o;let n=await pr(this.connection);if(r.recentBlockhash=n,(o=this.owner)!=null&&o.isKeyPair)return(0,X.sendAndConfirmTransaction)(this.connection,r,this.signers);if(this.signAllTransactions){this.signers.length&&r.partialSign(...this.signers);let i=await this.signAllTransactions([r]);return await this.connection.sendRawTransaction(i[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:t||{}}}buildMultiTx(t){let{extraPreBuildData:r=[],extInfo:n}=t,{transaction:o}=this.build(n),i=r.filter(a=>a.transaction.instructions.length>0),s=[...i.map(a=>a.transaction),o],u=[...i.map(a=>a.signers),this.signers];return{transactions:s,signers:u,execute:async()=>{var d;let a=await pr(this.connection);if((d=this.owner)!=null&&d.isKeyPair)return await Promise.all(s.map(async(p,g)=>(p.recentBlockhash=a,await(0,X.sendAndConfirmTransaction)(this.connection,p,u[g]))));if(this.signAllTransactions){let p=s.map((f,b)=>(f.recentBlockhash=a,u[b].length&&f.partialSign(...u[b]),f)),g=await this.signAllTransactions(p),S=[];for(let f=0;f<g.length;f+=1){let b=await this.connection.sendRawTransaction(g[f].serialize(),{skipPreflight:!0});S.push(b)}return S}throw new Error("please connect wallet first")},extInfo:n||{}}}};async function pr(e){var t,r;try{return((r=await((t=e.getLatestBlockhash)==null?void 0:t.call(e)))==null?void 0:r.blockhash)||(await e.getRecentBlockhash()).blockhash}catch{return(await e.getRecentBlockhash()).blockhash}}async function Ue(e,t){let[r,n]=await X.PublicKey.findProgramAddress(e,t);return{publicKey:r,nonce:n}}function fr(e,t=1,r=[]){let n=[...e];if(t<=0)return r;for(;n.length;)r.push(n.splice(0,t));return r}var yr=require("@solana/web3.js");var nt=_("Raydium_accountInfo_util");async function _n(e,t,r){let{batchRequest:n,commitment:o}=R({batchRequest:!1},r),i=fr(t,100),s=new Array(i.length).fill([]);if(n){let u=i.map(d=>{let p=e._buildArgs([d.map(g=>g.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:p}});s=(await e._rpcBatchRequest(u)).map(d=>(d.error&&nt.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(p=>{if(p){let{data:g,executable:S,lamports:f,owner:b,rentEpoch:A}=p;return g.length!==2&&g[1]!=="base64"&&nt.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(g[0],"base64"),executable:S,lamports:f,owner:new yr.PublicKey(b),rentEpoch:A}}return null})))}else try{s=await Promise.all(i.map(u=>e.getMultipleAccountsInfo(u,o)))}catch(u){u instanceof Error&&nt.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return s.flat()}async function gr(e,t,r){let n=await _n(e,t.map(o=>o.pubkey),r);return t.map((o,i)=>E(R({},o),{accountInfo:n[i]}))}function Z(e){if(e instanceof Y)return new y(e.numerator,e.denominator);if(e instanceof q)return e.adjusted;if(e instanceof V)try{return Z(e.toExact())}catch{return new y(Pe)}if(e instanceof y)return e;let t=String(e),r=ce(t);return new y(r.numerator,r.denominator)}function Nn(e,t){if(e==null||t==null)return!1;let r=Z(e),n=Z(t);return r.sub(n).numerator.gt(Pe)}function Kn(e,t){if(e==null||t==null)return!1;let r=Z(e),n=Z(t);return r.sub(n).numerator.eq(Pe)}function br(e,t){if(e==null||t==null)return;let r=Z(e),n=Z(t);return r.sub(n)}function qe(e){return e==null?!1:!Kn(e,0)}function wr(e,t){return Nn(t,e)?t:e}var Pr=e=>typeof e=="number",hr=e=>e?new Date(e):new Date,Mn=e=>hr(e).getTime();function Ie(e,t,r){let n=Pr(t)?t*((r==null?void 0:r.unit)==="s"?1e3:1):t;return new Date(e).getTime()<=n}function de(e,t,r){let n=Pr(t)?t*((r==null?void 0:r.unit)==="s"?1e3:1):t;return new Date(e).getTime()>n}function ot(e,t){let n=Mn(e)+(t.days?t.days*24*60*60*1e3:0)+(t.hours?t.hours*60*60*1e3:0)+(t.minutes?t.minutes*60*1e3:0)+(t.seconds?t.seconds*1e3:0)+(t.milliseconds?t.milliseconds:0);return hr(n)}var ie=require("@solana/spl-token"),pe=require("@solana/web3.js"),kr=v(require("bn.js"));var Sr=require("@solana/web3.js"),me=v(require("bn.js"));var l=require("@solana/buffer-layout"),it=l.Layout,xr=l.Structure;var at=l.UInt;var Tr=l.seq;var Ae=l.blob;var je=class extends it{constructor(r,n,o){super(r,o);this.blob=Ae(r),this.signed=n}decode(r,n=0){let o=new me.default(this.blob.decode(r,n),10,"le");return this.signed?o.fromTwos(this.span*8).clone():o}encode(r,n,o=0){return typeof r=="number"&&(r=new me.default(r)),this.signed&&(r=r.toTwos(this.span*8)),this.blob.encode(r.toArrayLike(Buffer,"le",this.span),n,o)}};function H(e){return new at(1,e)}function Ge(e){return new at(4,e)}function m(e){return new je(8,!1,e)}function z(e){return new je(16,!1,e)}var st=class extends it{constructor(r,n,o,i){super(r.span,i);this.layout=r,this.decoder=n,this.encoder=o}decode(r,n){return this.decoder(this.layout.decode(r,n))}encode(r,n,o){return this.layout.encode(this.encoder(r),n,o)}getSpan(r,n){return this.layout.getSpan(r,n)}};function T(e){return new st(Ae(32),t=>new Sr.PublicKey(t),t=>t.toBuffer(),e)}var ut=class extends xr{decode(t,r){return super.decode(t,r)}};function M(e,t,r){return new ut(e,t,r)}function C(e,t,r){let n,o=typeof t=="number"?t:(0,me.isBN)(t)?t.toNumber():new Proxy(t,{get(i,s){if(!n){let u=Reflect.get(i,"count");n=(0,me.isBN)(u)?u.toNumber():u,Reflect.set(i,"count",n)}return Reflect.get(i,s)},set(i,s,u){return s==="count"&&(n=u),Reflect.set(i,s,u)}});return Tr(e,o,r)}var le=M([T("mint"),T("owner"),m("amount"),Ge("delegateOption"),T("delegate"),H("state"),Ge("isNativeOption"),m("isNative"),m("delegatedAmount"),Ge("closeAuthorityOption"),T("closeAuthority")]);function Dn(e){let{mint:t,tokenAccount:r,owner:n}=e;return(0,ie.createInitializeAccountInstruction)(r,t,n)}function Vn(e){let{tokenAccount:t,payer:r,multiSigners:n=[],owner:o}=e;return(0,ie.createCloseAccountInstruction)(t,r,o,n)}async function ct(e){let{connection:t,amount:r,commitment:n,payer:o,owner:i,skipCloseAccount:s}=e,u=await t.getMinimumBalanceForRentExemption(le.span,n),a=x(r).add(new kr.default(u)),d=pe.Keypair.generate();return{signers:[d],instructions:[pe.SystemProgram.createAccount({fromPubkey:o,newAccountPubkey:d.publicKey,lamports:a.toNumber(),space:le.span,programId:ie.TOKEN_PROGRAM_ID}),Dn({mint:new pe.PublicKey(O.mint),tokenAccount:d.publicKey,owner:i})],endInstructions:s?[]:[Vn({tokenAccount:d.publicKey,payer:o,owner:i})]}}var dt=(...e)=>e.map(t=>{try{return typeof t=="object"?JSON.stringify(t):t}catch{return t}}).join(", "),Be=class{constructor({scope:t,moduleName:r}){this.disabled=!1;this.scope=t,this.logger=_(r)}createTxBuilder(t){return this.scope.checkOwner(),new Ce({connection:this.scope.connection,feePayer:t||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...t){this.logger.debug(dt(t))}logInfo(...t){this.logger.info(dt(t))}logAndCreateError(...t){let r=dt(t);throw new Error(r)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};var fe=require("@solana/web3.js");var mt=M([H("instruction")]),lt=M([H("instruction")]),En=M([m("rewardState"),m("rewardOpenTime"),m("rewardEndTime"),m("rewardLastUpdateTime"),m("totalReward"),m("totalRewardEmissioned"),m("rewardClaimed"),m("rewardPerSecond"),z("accRewardPerShare"),T("rewardVault"),T("rewardMint"),T("rewardSender"),m("rewardType"),C(m(),15,"padding")]),Wn=M([m("state"),m("nonce"),T("lpVault"),T("rewardVault"),T(),T(),m(),m(),m("totalReward"),z("perShareReward"),m("lastSlot"),m("perSlotReward")]),vn=M([m("state"),m("nonce"),T("lpVault"),T("rewardVaultA"),m("totalRewardA"),z("perShareRewardA"),m("perSlotRewardA"),H("option"),T("rewardVaultB"),Ae(7),m("totalRewardB"),z("perShareRewardB"),m("perSlotRewardB"),m("lastSlot"),T()]),On=M([m(),m("state"),m("nonce"),m("validRewardTokenNum"),z("rewardMultiplier"),m("rewardPeriodMax"),m("rewardPeriodMin"),m("rewardPeriodExtend"),T("lpMint"),T("lpVault"),C(En,5,"rewardInfos"),T("creator"),T(),C(m(),32,"padding")]),Lr=new Proxy(Wn,{get(e,t,r){return t==="decode"?(...n)=>{let o=e.decode(...n);return E(R({},o),{version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]})}:Reflect.get(e,t,r)}}),Ir=new Proxy(vn,{get(e,t,r){return t==="decode"?(...n)=>{let o=e.decode(...n);return E(R({},o),{version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]})}:Reflect.get(e,t,r)}}),Re=new Proxy(On,{get(e,t,r){return t==="decode"?(...n)=>{let o=e.decode(...n);return E(R({},o),{version:6,rewardInfos:o.rewardInfos.map(i=>{var s;return E(R({},i),{rewardType:((s=Object.entries(He).find(u=>String(u[1])===i.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(e,t,r)}}),Cn=M([m("isSet"),m("rewardPerSecond"),m("rewardOpenTime"),m("rewardEndTime"),m("rewardType")]),pt=M([H("instruction"),m("nonce"),C(Cn,5,"rewardTimeInfo")]),ft=M([H("instruction"),m("rewardReopenTime"),m("rewardEndTime"),m("rewardPerSecond")]),yt=M([H("instruction"),m("isSet"),m("rewardPerSecond"),m("rewardOpenTime"),m("rewardEndTime")]),ka=M([m("state"),T("id"),T("owner"),m("deposited"),C(m(),1,"rewardDebts")]),Ar=M([m("state"),T("id"),T("owner"),m("deposited"),C(z(),1,"rewardDebts"),C(m(),17)]),La=M([m("state"),T("id"),T("owner"),m("deposited"),C(m(),2,"rewardDebts")]),Br=M([m("state"),T("id"),T("owner"),m("deposited"),C(z(),2,"rewardDebts"),C(m(),17)]),Rr=M([m(),m("state"),T("id"),T("owner"),m("deposited"),C(z(),5,"rewardDebts"),C(m(),16)]),Fe=M([H("instruction"),m("amount")]);var Fr=_("Raydium_farm_config"),_r="EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q",Un=new fe.PublicKey(_r),Nr="9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z",qn=new fe.PublicKey(Nr),Kr="FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG",jn=new fe.PublicKey(Kr),Mr={[_r]:3,[Nr]:5,[Kr]:6},Dr={3:Un,5:qn,6:jn},Vr=new fe.PublicKey("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Er=new fe.PublicKey("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),Wr={3:Lr,5:Ir,6:Re},vr={3:Ar,5:Br,6:Rr},gt=e=>[3,5,6].indexOf(e)!==-1,Gn={3:10,5:11,6:1},Or=e=>{let t=Gn[e];return t||Fr.logWithError("invalid deposit farm version"),t},Hn={3:11,5:12,6:2},Cr=e=>{let t=Hn[e];return t||Fr.logWithError("invalid withdraw farm version"),t},Ur=e=>{var s;let{version:t,rewardInfos:r,rewardTokenAccountsPublicKeys:n}=e,o=`rewardInfo:${JSON.stringify(r)}, rewardAccount:${JSON.stringify(n)}`,i={3:()=>{if(r.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(r.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||r.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}};return(s=i[t])==null?void 0:s.call(i)},He={"Standard SPL":0,"Option tokens":1};var ae=require("@solana/web3.js"),qr=v(require("bn.js"));var $n=_("Raydium_farm_instruction");async function jr(e){let{version:t,id:r,ledger:n,programId:o,owner:i}=e,s={3:9,5:10}[t];s||$n.logWithError(`invalid farm pool version: ${t}`);let u=Buffer.alloc(mt.span);mt.encode({instruction:s},u);let a=[c({pubkey:r}),c({pubkey:n}),c({pubkey:i,isWritable:!1}),c({pubkey:ae.SystemProgram.programId,isWritable:!1}),c({pubkey:ae.SYSVAR_RENT_PUBKEY,isWritable:!1})];return new ae.TransactionInstruction({programId:o,keys:a,data:u})}function Gr(e){var n;let t=Buffer.alloc(pt.span);pt.encode({instruction:0,nonce:new qr.default(e.nonce),rewardTimeInfo:e.rewardInfoConfig},t);let r=[...ve,c({pubkey:e.farmKeyPair.publicKey}),c({pubkey:e.farmAuthority,isWritable:!1}),c({pubkey:e.lpVault}),c({pubkey:e.lpMint,isWritable:!1}),c({pubkey:e.lockVault}),c({pubkey:e.lockMint,isWritable:!1}),c({pubkey:(n=e.lockUserAccount)!=null?n:W}),c({pubkey:e.owner,isWritable:!1,isSigner:!0})];for(let o of e.rewardInfo)r.push(c({pubkey:o.rewardMint,isWritable:!1}),c({pubkey:o.rewardVault}),c({pubkey:o.userRewardToken}));return new ae.TransactionInstruction({programId:e.programId,keys:r,data:t})}var D=v(require("bn.js"));var _e=_("Raydium.farm.util");async function $e({programId:e,poolId:t,mint:r,type:n}){let{publicKey:o}=await Ue([t.toBuffer(),r.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],e);return o}function Yn(e){let r=J({publicKey:e}).toBase58();return Mr[r]}async function bt({programId:e,poolId:t,owner:r}){let{publicKey:n}=await Ue([t.toBuffer(),r.toBuffer(),Buffer.from(Yn(e)===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],e);return n}var Hr=async({programId:e,poolId:t})=>await Ue([t.toBuffer()],e);function $r(e){return Dr[e]}function Yr(e){return{isSet:new D.default(1),rewardPerSecond:x(e.rewardPerSecond),rewardOpenTime:x(e.rewardOpenTime),rewardEndTime:x(e.rewardEndTime),rewardType:x(e.rewardType)}}function wt(e){return x(e.rewardEndTime).sub(x(e.rewardOpenTime)).mul(x(e.rewardPerSecond))}function Jn(e){let t=vr[e];return t||_e.logWithError("invalid version",e),t}function zn(e){let t=Wr[e];return t||_e.logWithError("invalid version",e),t}function Xn(e,t,r,n){if(e.version===3||e.version===5){if(e.lastSlot.gte(new D.default(r)))return e;let o=new D.default(r).sub(e.lastSlot);e.lastSlot=new D.default(r);for(let i of e.rewardInfos){if(t.amount.eq(new D.default(0)))continue;let s=i.perSlotReward.mul(o);i.perShareReward=i.perShareReward.add(s.mul(new D.default(10).pow(new D.default(e.version===3?9:15))).div(t.amount)),i.totalReward=i.totalReward.add(s)}}else if(e.version===6)for(let o of e.rewardInfos){if(o.rewardState.eq(new D.default(0)))continue;let i=D.default.min(new D.default(n),o.rewardEndTime);if(o.rewardOpenTime.gte(i))continue;let u=i.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),a=o.totalReward.sub(o.totalRewardEmissioned);a.lt(u)?(u=a,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(a.div(o.rewardPerSecond))):o.rewardLastUpdateTime=i,!t.amount.eq(new D.default(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(u.mul(e.rewardMultiplier).div(t.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(u))}return e}async function Zn({connection:e,farmPools:t,owner:r,config:n}){var S;let o=!1,i=!1,s=new D.default(10),u=[];for(let f of t){let b=Le(f);b.version===6?i=!0:o=!0,u.push({pubkey:b.id,version:b.version,key:"state",poolId:b.id},{pubkey:b.lpVault,version:b.version,key:"lpVault",poolId:b.id}),r&&u.push({pubkey:await bt({programId:b.programId,poolId:b.id,owner:r}),version:b.version,key:"ledger",poolId:b.id})}let a={},d=await gr(e,u,n);for(let{pubkey:f,version:b,key:A,poolId:B,accountInfo:w}of d){let F=B.toBase58();if(a[F]=R({},a[F]),A==="state"){let U=zn(b);(!w||!w.data||w.data.length!==U.span)&&_e.logWithError(`invalid farm state account info, pools.id, ${f}`),a[F].state=U.decode(w.data)}else if(A==="lpVault")(!w||!w.data||w.data.length!==le.span)&&_e.logWithError(`invalid farm lp vault account info, pools.lpVault, ${f}`),a[F].lpVault=le.decode(w.data);else if(A==="ledger"){let U=Jn(b);w&&w.data&&(w.data.length!==U.span&&_e.logWithError(`invalid farm ledger account info, ledger, ${f}`),a[F].ledger=U.decode(w.data))}}let p=i||o?await e.getSlot():0,g=i&&(S=await e.getBlockTime(p))!=null?S:0;for(let f of Object.keys(a))a[f].state=Xn(a[f].state,a[f].lpVault,p,g);for(let[f,{state:b,ledger:A}]of Object.entries(a))if(A){let B=b.version===6?b.rewardMultiplier:b.rewardInfos.length===1?s.pow(new D.default(9)):s.pow(new D.default(15)),w=b.rewardInfos.map((F,U)=>{let K=A.rewardDebts[U];return A.deposited.mul(b.version===6?F.accRewardPerShare:F.perShareReward).div(B).sub(K)});a[f].wrapped=E(R({},a[f].wrapped),{pendingRewards:w})}return a}async function Jr(e){let{farmPools:t}=e,r=await Zn(e);return t.map((o,i)=>E(R(R(R({},t[i]),Le(o)),r[o.id]),{jsonInfo:t[i]}))}function zr(e,t=Date.now()){if(e.version===6){let r=e.state.rewardInfos;if(r.every(({rewardOpenTime:n})=>Ie(t,n.toNumber(),{unit:"s"})))return"upcoming pool";if(r.every(({rewardEndTime:n})=>de(t,n.toNumber(),{unit:"s"})))return"closed pool"}else{let r=e.state.rewardInfos.map(({perSlotReward:n})=>n);if(r.length===2){if(String(r[0])==="0"&&String(r[1])!=="0")return"normal fusion pool";if(String(r[0])!=="0"&&String(r[1])!=="0")return"dual fusion pool";if(String(r[0])==="0"&&String(r[1])==="0")return"closed pool"}else if(r.length===1&&String(r[0])==="0")return"closed pool"}}function Xr(e){return e.state.rewardInfos.length===1&&String(e.lpMint)===cr.toBase58()}function Zr(e,t){return e.version===6?e.state.rewardInfos.map(({rewardPerSecond:r,rewardOpenTime:n,rewardEndTime:o},i)=>{var S;let s=Ie(t.currentBlockChainDate,n.toNumber(),{unit:"s"}),u=de(t.currentBlockChainDate,o.toNumber(),{unit:"s"});if(s||u)return;let a=t.rewardTokens[i];if(!a)return;let d=t.rewardTokenPrices[i];if(!d)return;let p=he(new y(r,ne).div(oe.pow(new D.default(a.decimals||1))).mul(new D.default(60*60*24*365)),d);return t.tvl?t.tvl.isZero()?re(0):p.div((S=t.tvl)!=null?S:ne):void 0}):e.state.rewardInfos.map(({perSlotReward:n},o)=>{var d;let i=t.rewardTokens[o];if(!i)return;let s=t.rewardTokenPrices[o];if(!s)return;let u=he(new y(n,ne).div(oe.pow(new D.default(i.decimals||1))).mul(new D.default(t.blockSlotCountForSecond*60*60*24*365)),s);return t.tvl?t.tvl.isZero()?re(0):u.div((d=t.tvl)!=null?d:ne):void 0})}var Je=class extends Be{constructor(){super(...arguments);this._farmPools=[];this._hydratedFarmPools=[];this._hydratedFarmMap=new Map;this._sdkParsedFarmPools=[];this._lpTokenInfoMap=new Map}async load(r){var o;await this.scope.liquidity.load(r),await this.scope.fetchFarms(r==null?void 0:r.forceUpdate);let n=((o=this.scope.apiData.farmPools)==null?void 0:o.data)||{};this._farmPools=Object.keys(n||{}).reduce((i,s)=>{var u,a;return i.concat(((a=(u=n[s]).map)==null?void 0:a.call(u,d=>{let p=this.scope.token.allTokenMap.get(d.baseMint),g=this.scope.token.allTokenMap.get(d.quoteMint);return p&&g&&this._lpTokenInfoMap.set(d.lpMint,new G({mint:d.lpMint,decimals:p.decimals,symbol:`${p.symbol} - ${g.name}`,name:`${p.symbol} - ${g.name} LP`})),E(R({},d),{name:d.symbol,category:s})}))||[])},[]),await this.fetchSdkFarmInfo()}async fetchSdkFarmInfo(){var r;this._sdkParsedFarmPools=await Jr({connection:this.scope.connection,farmPools:this._farmPools,owner:(r=this.scope.owner)==null?void 0:r.publicKey,config:{commitment:"confirmed"}})}async loadHydratedFarmInfo(r){let{forceUpdate:n,skipPrice:o}=r||{};if(this._hydratedFarmPools.length&&!n)return this._hydratedFarmPools;await this.scope.farm.load(),!o&&await this.scope.token.fetchTokenPrices(),await this.scope.liquidity.loadPairs();let i=await this.scope.chainTimeOffset(),s=ot(Date.now()+i,{minutes:0}),u=await this.scope.api.getBlockSlotCountForSecond(this.scope.connection.rpcEndpoint),a=Object.fromEntries(this.scope.liquidity.allPairs.map(d=>[d.ammId,{apr30d:d.apr30d,apr7d:d.apr7d,apr24h:d.apr24h}]));return this._hydratedFarmPools=this._sdkParsedFarmPools.map(d=>{let p=this.hydrateFarmInfo({farmInfo:d,blockSlotCountForSecond:u,farmAprs:a,currentBlockChainDate:s,chainTimeOffset:i});return this._hydratedFarmMap.set(d.id.toBase58(),p),p}),this._hydratedFarmPools}get allFarms(){return this._farmPools}get allParsedFarms(){return this._sdkParsedFarmPools}get allHydratedFarms(){return this._hydratedFarmPools}get allHydratedFarmMap(){return this._hydratedFarmMap}getFarm(r){let n=J({publicKey:r}),o=this.allFarms.find(i=>i.id===n.toBase58());return o||this.logAndCreateError("invalid farm id"),o}getParsedFarm(r){let n=J({publicKey:r}),o=this.allParsedFarms.find(i=>n.equals(i.id));return o||this.logAndCreateError("invalid farm id"),o}getLpTokenInfo(r){let n=J({publicKey:r}),o=this._lpTokenInfoMap.get(n.toBase58());return o||this.logAndCreateError("LP Token not found",n.toBase58()),o}lpDecimalAmount({mint:r,amount:n}){let o=ce(n),i=this.getLpTokenInfo(r);return Ve(new y(o.numerator,o.denominator).mul(new Ye.default(10).pow(new Ye.default(i.decimals))))}hydrateFarmInfo(r){var kt,Lt,It,At,Bt,Rt,Ft,_t,Nt,Kt,Mt,Dt;let{farmInfo:n,blockSlotCountForSecond:o,farmAprs:i,currentBlockChainDate:s,chainTimeOffset:u=0}=r,a=zr(n,s),d=Xr(n),p=a==="dual fusion pool",g=a==="normal fusion pool",S=a==="closed pool"&&!n.upcoming,f=n.version!==6?n.upcoming&&S:n.upcoming,b=n.version!==6&&n.upcoming&&!S,A=((kt=this.scope.liquidity.allPools.find(P=>P.lpMint===n.lpMint.toBase58()))==null?void 0:kt.version)===5,B=d?this.scope.mintToToken(n.lpMint):this.getLpTokenInfo(n.lpMint),w=this.scope.mintToToken(d?n.lpMint:n.baseMint),F=this.scope.mintToToken(d?n.lpMint:n.quoteMint);w!=null&&w.symbol;let U=d?`${(Lt=w==null?void 0:w.symbol)!=null?Lt:"unknown"}`:`${(It=w==null?void 0:w.symbol)!=null?It:"unknown"}-${(At=F==null?void 0:F.symbol)!=null?At:"unknown"}`,K=n.jsonInfo.rewardInfos.map(({rewardMint:P})=>this.scope.mintToToken(P)),j=(Bt=n.wrapped)==null?void 0:Bt.pendingRewards.map((P,L)=>K[L]?new V(K[L],Ve(wr(P,0))):void 0),se=d?this.scope.token.tokenPrices.get(n.lpMint.toBase58()):this.scope.liquidity.lpPriceMap.get(n.lpMint.toBase58()),Ne=B&&new V(B,n.lpVault.amount),Pt=se&&B?he(new V(B,n.lpVault.amount),se):void 0,ye=Zr(n,{tvl:Pt,currentBlockChainDate:s,rewardTokens:K,rewardTokenPrices:(Rt=n.rewardInfos.map(({rewardMint:P})=>this.scope.token.tokenPrices.get(P.toBase58())))!=null?Rt:[],blockSlotCountForSecond:o}),ee=(Ft=this.scope.liquidity.allPools.find(P=>P.lpMint===n.lpMint.toBase58()))==null?void 0:Ft.id,ht=ee?Ee((_t=i[ee])==null?void 0:_t.apr7d,{alreadyDecimaled:!0}):void 0,xt=ee?Ee((Nt=i[ee])==null?void 0:Nt.apr30d,{alreadyDecimaled:!0}):void 0,Tt=ee?Ee((Kt=i[ee])==null?void 0:Kt.apr24h,{alreadyDecimaled:!0}):void 0,Qr=ye.reduce((P,L)=>P?L?P.add(L):P:L,ht),en=ye.reduce((P,L)=>P?L?P.add(L):P:L,xt),tn=ye.reduce((P,L)=>P?L?P.add(L):P:L,Tt),rn=n.version===6?n.state.rewardInfos.map((P,L)=>{var vt,Ot,Ct,Ut;let{rewardOpenTime:ge,rewardEndTime:Ke,rewardPerSecond:ze}=P,te=ge.toNumber()?new Date(ge.toNumber()*1e3+u):void 0,$=Ke.toNumber()?new Date(Ke.toNumber()*1e3+u):void 0,Xe=Date.now()+u;if(!te&&!$)return;let ue=this.scope.mintToToken((Ct=(Ot=P.rewardMint)!=null?Ot:(vt=n.rewardInfos[L])==null?void 0:vt.rewardMint)==null?void 0:Ct.toBase58()),Vt=Boolean(te&&Ie(Xe,te)),Et=Boolean($&&de(Xe,$)),Wt=!te&&!$||!Et&&!Vt,nn=Wt&&de(Xe,ot($,{seconds:-((Ut=n.jsonInfo.rewardPeriodExtend)!=null?Ut:72*60*60)})),on=ue&&this.scope.mintToTokenAmount({mint:ue.mint,amount:br(P.totalReward,P.totalRewardEmissioned).toFixed(ue.decimals)}),an=j==null?void 0:j[L],sn=ye[L],un=Boolean($),Me=n.rewardInfos[L];return E(R(R({},Me),P),{owner:Me==null?void 0:Me.rewardSender,apr:sn,token:ue,userPendingReward:an,userHavedReward:un,perSecond:ue&&this.scope.mintToTokenAmount({mint:ue.mint,amount:ze}).toSignificant(),openTime:te,endTime:$,isOptionToken:P.rewardType==="Option tokens",isRewardBeforeStart:Vt,isRewardEnded:Et,isRewarding:Wt,isRwardingBeforeEnd72h:nn,claimableRewards:on,version:6})}).filter(P=>!!P):n.state.rewardInfos.map((P,L)=>{let ge=j==null?void 0:j[L],Ke=ye[L],ze=K[L],{perSlotReward:te}=P,$=qe(ge)||qe(te);return E(R({},P),{apr:Ke,token:ze,userPendingReward:ge,userHavedReward:$,version:n.version})}),St=B&&((Mt=n.ledger)==null?void 0:Mt.deposited)?new V(B,(Dt=n.ledger)==null?void 0:Dt.deposited):void 0;return E(R({},n),{lp:B,lpPrice:se,base:w,quote:F,name:U,isStakePool:d,isDualFusionPool:p,isNormalFusionPool:g,isClosedPool:S,isUpcomingPool:f,isStablePool:A,isNewPool:b,totalApr7d:Qr,raydiumFeeApr7d:ht,totalApr24h:tn,raydiumFeeApr24h:Tt,totalApr30d:en,raydiumFeeApr30d:xt,ammId:ee,tvl:Pt,userHasStaked:qe(St),rewards:rn,userStakedLpAmount:St,stakedLpAmount:Ne})}async _getUserRewardInfo({payer:r,rewardInfo:n}){if(n.rewardMint.equals(W)){let o=await ct({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:r,amount:wt(n)});return{rewardPubKey:o.signers[0].publicKey,newInstruction:o}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:n.rewardMint})}}async create({poolId:r,rewardInfos:n,payer:o}){this.checkDisabled(),this.scope.checkOwner();let i=J({publicKey:r}),s=this.scope.liquidity.allPools.find(K=>K.id===i.toBase58());s||this.logAndCreateError("invalid pool id");let a={lpMint:new h.PublicKey(s.lpMint),lockInfo:{lockMint:Vr,lockVault:Er},version:6,rewardInfos:n,programId:$r(6)},d=this.createTxBuilder(),p=o!=null?o:this.scope.ownerPubKey,g=h.Keypair.generate(),S=await this.scope.connection.getMinimumBalanceForRentExemption(Re.span);d.addInstruction({instructions:[h.SystemProgram.createAccount({fromPubkey:p,newAccountPubkey:g.publicKey,lamports:S,space:Re.span,programId:a.programId})],signers:[g]});let{publicKey:f,nonce:b}=await Hr({programId:a.programId,poolId:g.publicKey}),A=await $e({programId:a.programId,poolId:g.publicKey,mint:a.lpMint,type:"lpVault"}),B=[],w=[];for(let K of a.rewardInfos){K.rewardOpenTime>=K.rewardEndTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",K.rewardOpenTime.toString()),He[K.rewardType]||this.logAndCreateError("rewardType error",K.rewardType),K.rewardPerSecond<=0&&this.logAndCreateError("rewardPerSecond error",K.rewardPerSecond.toString()),B.push(Yr(K));let{rewardPubKey:j,newInstruction:se}=await this._getUserRewardInfo({rewardInfo:K,payer:p});se&&d.addInstruction(se),j||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let Ne=K.rewardMint.equals(W)?new h.PublicKey(O.mint):K.rewardMint;w.push({rewardMint:Ne,rewardVault:await $e({programId:a.programId,poolId:g.publicKey,mint:Ne,type:"rewardVault"}),userRewardToken:j})}let F=await this.scope.account.getCreatedTokenAccount({mint:a.lockInfo.lockMint});F||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let U=Gr({farmKeyPair:g,owner:this.scope.ownerPubKey,farmAuthority:f,lpVault:A,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:F,programId:a.programId,rewardInfo:w,rewardInfoConfig:B,nonce:b});return await d.addInstruction({instructions:[U]}).build()}async restartReward({farmId:r,payer:n,newRewardInfo:o}){let i=this.getFarm(r);i.version!==6&&this.logAndCreateError("invalid farm version",i.version);let s={id:new h.PublicKey(i.id),rewardInfos:i.rewardInfos,lpVault:new h.PublicKey(i.lpVault),programId:new h.PublicKey(i.programId)};o.rewardOpenTime>=o.rewardEndTime&&this.logAndCreateError("start time error","newRewardInfo",o);let u=n||this.scope.ownerPubKey,a=o.rewardMint.equals(W)?new h.PublicKey(O.mint):o.rewardMint,d=s.rewardInfos.find(B=>new h.PublicKey(B.rewardMint).equals(a));d||this.logAndCreateError("configuration does not exist","rewardMint",a);let p=d.rewardVault?new h.PublicKey(d.rewardVault):W,g=this.createTxBuilder(),{rewardPubKey:S,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:o,payer:u});f&&g.addInstruction(f),S||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=Buffer.alloc(ft.span);ft.encode({instruction:3,rewardReopenTime:x(o.rewardOpenTime),rewardEndTime:x(o.rewardEndTime),rewardPerSecond:x(o.rewardPerSecond)},b);let A=[c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:s.id}),c({pubkey:s.lpVault,isWritable:!1}),c({pubkey:p}),c({pubkey:S}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await g.addInstruction({instructions:[new h.TransactionInstruction({programId:s.programId,keys:A,data:b})]}).build()}async addNewRewardToken(r){let{farmId:n,newRewardInfo:o,payer:i}=r,s=this.getFarm(n);s.version!==6&&this.logAndCreateError("invalid farm version",s.version);let u=i!=null?i:this.scope.ownerPubKey,a=this.createTxBuilder(),d=await $e({programId:new h.PublicKey(s.programId),poolId:new h.PublicKey(s.id),mint:o.rewardMint,type:"rewardVault"}),{rewardPubKey:p,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:o,payer:u});g&&a.addInstruction(g),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts);let S=o.rewardMint.equals(W)?new h.PublicKey(O.mint):o.rewardMint,f=Buffer.alloc(yt.span);yt.encode({instruction:4,isSet:new Ye.default(1),rewardPerSecond:x(o.rewardPerSecond),rewardOpenTime:x(o.rewardOpenTime),rewardEndTime:x(o.rewardEndTime)},f);let b=[...ve,c({pubkey:new h.PublicKey(s.id)}),c({pubkey:new h.PublicKey(s.authority),isWritable:!1}),c({pubkey:S,isWritable:!1}),c({pubkey:d}),c({pubkey:p}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await a.addInstruction({instructions:[new h.TransactionInstruction({programId:new h.PublicKey(s.programId),keys:b,data:f})]}).build()}async _prepareFarmAccounts(r){let n=this.createTxBuilder(),{farmInfo:o}=r,{pubKey:i,newInstructions:s}=await this.scope.account.checkOrCreateAta({mint:o.lpMint});n.addInstruction(s);let u=await Promise.all(o.rewardInfos.map(async({rewardMint:p})=>{let{pubKey:g,newInstructions:S}=await this.scope.account.checkOrCreateAta({mint:p,autoUnwrapWSOLToSOL:!0});return n.addInstruction(S),g})),a=await bt({programId:new h.PublicKey(o.programId),poolId:new h.PublicKey(o.id),owner:this.scope.ownerPubKey});if(!o.ledger&&o.version<6){let p=await jr({id:o.id,programId:o.programId,version:o.version,ledger:a,owner:this.scope.ownerPubKey});n.addInstruction({instructions:[p]})}let d=[c({pubkey:o.id}),c({pubkey:o.authority,isWritable:!1}),c({pubkey:a}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:i}),c({pubkey:new h.PublicKey(o.jsonInfo.lpVault)}),c({pubkey:u[0]}),c({pubkey:o.rewardInfos[0].rewardVault}),c({pubkey:h.SYSVAR_CLOCK_PUBKEY,isWritable:!1}),c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1})];return{txBuilder:n,lpTokenAccount:i,rewardTokenAccountsPublicKeys:u,ledgerAddress:a,lowVersionKeys:d}}async deposit(r){this.scope.checkOwner();let{farmId:n,amount:o}=r,i=this.getParsedFarm(n),s=i.lpMint,{version:u,rewardInfos:a}=i;gt(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:d,ledgerAddress:p,lpTokenAccount:g,lowVersionKeys:S,rewardTokenAccountsPublicKeys:f}=await this._prepareFarmAccounts({mint:s,farmInfo:i}),b=Ur({version:u,rewardInfos:a,rewardTokenAccountsPublicKeys:f});b&&this.logAndCreateError(b);let A=Buffer.alloc(Fe.span);Fe.encode({instruction:Or(u),amount:x(o)},A);let B=u===6?[c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:h.SystemProgram.programId,isWritable:!1}),c({pubkey:i.id}),c({pubkey:i.authority,isWritable:!1}),c({pubkey:i.lpVault.mint}),c({pubkey:p}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:g})]:S;if(u!==3)for(let F=1;F<a.length;F++)B.push(c({pubkey:f[F]})),B.push(c({pubkey:a[F].rewardVault}));let w=new h.TransactionInstruction({programId:i.programId,keys:B,data:A});return await d.addInstruction({instructions:[w]}).build()}async withdraw(r){this.scope.checkOwner();let{farmId:n,amount:o}=r,i=this.getParsedFarm(n),s=i.lpMint,{version:u,rewardInfos:a}=i;gt(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:d,ledgerAddress:p,lpTokenAccount:g,lowVersionKeys:S,rewardTokenAccountsPublicKeys:f}=await this._prepareFarmAccounts({mint:s,farmInfo:i}),b=Buffer.alloc(Fe.span);Fe.encode({instruction:Cr(u),amount:x(o)},b);let A=u===6?[c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:i.id}),c({pubkey:i.authority,isWritable:!1}),c({pubkey:i.lpVault.mint}),c({pubkey:p}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:g})]:S;if(u!==3)for(let w=1;w<a.length;w++)A.push(c({pubkey:f[w]})),A.push(c({pubkey:a[w].rewardVault}));let B=new h.TransactionInstruction({programId:i.programId,keys:A,data:b});return await d.addInstruction({instructions:[B]}).build()}async withdrawFarmReward({farmId:r,withdrawMint:n}){var S;this.scope.checkOwner();let o=this.getParsedFarm(r),{version:i}=o;i!==6&&this.logAndCreateError("invalid farm version",o.version);let s=o.rewardInfos.find(f=>f.rewardMint.equals(n.equals(W)?new h.PublicKey(O.mint):n));s||this.logAndCreateError("withdraw mint error","rewardInfos",o);let u=(S=s==null?void 0:s.rewardVault)!=null?S:W,a=this.createTxBuilder(),d;if(this._getUserRewardInfo({payer:this.scope.ownerPubKey,rewardInfo:s}),n.equals(W)){let f=await ct({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:wt(s)});d=f.signers[0].publicKey,a.addInstruction(f)}else{let f=await this.scope.account.getCreatedTokenAccount({mint:n});f===null?(d=await this.scope.account.getAssociatedTokenAccount(n),a.addInstruction({instructions:[(0,Q.createAssociatedTokenAccountInstruction)(this.scope.ownerPubKey,d,this.scope.ownerPubKey,n)]})):d=f}let p=Buffer.alloc(lt.span);lt.encode({instruction:5},p);let g=[c({pubkey:Q.TOKEN_PROGRAM_ID,isWritable:!1}),c({pubkey:o.id}),c({pubkey:o.authority,isWritable:!1}),c({pubkey:o.lpVault.mint,isWritable:!1}),c({pubkey:u}),c({pubkey:d}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await a.addInstruction({instructions:[new h.TransactionInstruction({programId:o.programId,keys:g,data:p})]}).build()}};0&&(module.exports={});
//# sourceMappingURL=farm.js.map