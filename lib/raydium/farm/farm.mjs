var Hr=Object.defineProperty,$r=Object.defineProperties;var Yr=Object.getOwnPropertyDescriptors;var Vt=Object.getOwnPropertySymbols;var Jr=Object.prototype.hasOwnProperty,zr=Object.prototype.propertyIsEnumerable;var Et=(e,t,r)=>t in e?Hr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,A=(e,t)=>{for(var r in t||(t={}))Jr.call(t,r)&&Et(e,r,t[r]);if(Vt)for(var r of Vt(t))zr.call(t,r)&&Et(e,r,t[r]);return e},V=(e,t)=>$r(e,Yr(t));import{TOKEN_PROGRAM_ID as xe,createAssociatedTokenAccountInstruction as mo}from"@solana/spl-token";import{Keypair as lo,PublicKey as M,SystemProgram as Vr,SYSVAR_CLOCK_PUBKEY as po,TransactionInstruction as Te}from"@solana/web3.js";import dt from"bn.js";import{get as Wt,set as Xr}from"lodash";import Zr from"pino";import Qr from"pino-pretty";var vt={},en={},tn=Qr({colorize:!0,levelFirst:!0,translateTime:"SYS:yyyymmdd HH:MM:ss.l"}),rn=Zr({base:null,level:"silent"},tn);function F(e){let t=Wt(vt,e);if(!t){let r=Wt(en,e);t=rn.child({name:e},{level:r}),Xr(vt,e,t)}return t.logWithError=(...r)=>{let n=r.map(o=>typeof o=="object"?JSON.stringify(o):o).join(", ");throw new Error(n)},t}import{PublicKey as Pn}from"@solana/web3.js";import hn from"bn.js";import mn from"big.js";import _e from"bn.js";import B from"bn.js";var Ie=F("Raydium_bignumber");var ce=new B(0),ee=new B(1),ko=new B(2),Lo=new B(3),Io=new B(5),te=new B(10),Ut=new B(100),Ao=new B(1e3),Bo=new B(1e4),Ot=9007199254740991;function P(e){if(e instanceof B)return e;if(typeof e=="string"){if(e.match(/^-?[0-9]+$/))return new B(e);Ie.logWithError(`invalid BigNumberish string: ${e}`)}return typeof e=="number"?(e%1&&Ie.logWithError(`BigNumberish number underflow: ${e}`),(e>=Ot||e<=-Ot)&&Ie.logWithError(`BigNumberish number overflow: ${e}`),new B(String(e))):typeof e=="bigint"?new B(e.toString()):(Ie.logWithError(`invalid BigNumberish value: ${e}`),new B(0))}function Ue(e){return te.pow(P(e))}function oe(e){var u;if(e===void 0)return{denominator:"1",numerator:"0"};if(e instanceof B)return{numerator:e.toString(),denominator:"1"};if(e instanceof f)return{denominator:e.denominator.toString(),numerator:e.numerator.toString()};let t=String(e),[,r="",n="",o=""]=(u=t.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?u:[],i="1"+"0".repeat(o.length),s=r+(n==="0"?"":n)+o||"0";return{denominator:i,numerator:s,sign:r,int:n,dec:o}}function nn(e){var n;let[,t="",r=""]=(n=e.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?n:[];return`${t}${r}`}function Ae(e,t=0){return e instanceof B?e:new B(nn(Q(e).mul(te.pow(new B(String(t))))))}function Q(e){if(e instanceof $)return new f(e.numerator,e.denominator);if(e instanceof U)return e.adjusted;if(e instanceof D)try{return Q(e.toExact())}catch{return new f(ce)}if(e instanceof f)return e;let t=String(e),r=oe(t);return new f(r.numerator,r.denominator)}function Be(e,t){let{numerator:r,denominator:n}=oe(e);return new $(new B(r),new B(n).mul(t!=null&&t.alreadyDecimaled?new B(100):new B(1)))}function qt(e,t){if(e==null||t==null)return;let r=Q(e),n=Q(t);return r.mul(n)}function Ct(e){let t=new j({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),r=Ae(qt(e,10**t.decimals));return new D(t,r)}function de(e,t){return Ct(!t||!e?0:qt(e,t))}import on from"toformat";var an=on,me=an;import Fe from"big.js";import un from"decimal.js-light";var Re=F("module/fraction"),qe=me(Fe),le=me(un),cn={[0]:le.ROUND_DOWN,[1]:le.ROUND_HALF_UP,[2]:le.ROUND_UP},dn={[0]:Fe.roundDown,[1]:Fe.roundHalfUp,[2]:Fe.roundUp},f=class{constructor(t,r=ee){this.numerator=P(t),this.denominator=P(r)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new f(this.denominator,this.numerator)}add(t){let r=t instanceof f?t:new f(P(t));return this.denominator.eq(r.denominator)?new f(this.numerator.add(r.numerator),this.denominator):new f(this.numerator.mul(r.denominator).add(r.numerator.mul(this.denominator)),this.denominator.mul(r.denominator))}sub(t){let r=t instanceof f?t:new f(P(t));return this.denominator.eq(r.denominator)?new f(this.numerator.sub(r.numerator),this.denominator):new f(this.numerator.mul(r.denominator).sub(r.numerator.mul(this.denominator)),this.denominator.mul(r.denominator))}mul(t){let r=t instanceof f?t:new f(P(t));return new f(this.numerator.mul(r.numerator),this.denominator.mul(r.denominator))}div(t){let r=t instanceof f?t:new f(P(t));return new f(this.numerator.mul(r.denominator),this.denominator.mul(r.numerator))}toSignificant(t,r={groupSeparator:""},n=1){Number.isInteger(t)||Re.logWithError(`${t} is not an integer.`),t<=0&&Re.logWithError(`${t} is not positive.`),le.set({precision:t+1,rounding:cn[n]});let o=new le(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(t);return o.toFormat(o.decimalPlaces(),r)}toFixed(t,r={groupSeparator:""},n=1){return Number.isInteger(t)||Re.logWithError(`${t} is not an integer.`),t<0&&Re.logWithError(`${t} is negative.`),qe.DP=t,qe.RM=dn[n]||1,new qe(this.numerator.toString()).div(this.denominator.toString()).toFormat(t,r)}isZero(){return this.numerator.isZero()}};var ln=F("Raydium_amount"),jt=me(mn);function pn(e,t){let r="0",n="0";if(e.includes(".")){let o=e.split(".");o.length===2?([r,n]=o,n=n.padEnd(t,"0")):ln.logWithError(`invalid number string, num: ${e}`)}else r=e;return[r,n.slice(0,t)||n]}var D=class extends f{constructor(r,n,o=!0,i){let s=new _e(0),u=te.pow(new _e(r.decimals));if(o)s=P(n);else{let a=new _e(0),d=new _e(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,y]=pn(n.toString(),r.decimals);a=P(l),d=P(y)}a=a.mul(u),s=a.add(d)}super(s,u);this.logger=F(i||"Amount"),this.token=r}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(r){return this.token.equals(r.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(r.raw)}lt(r){return this.token.equals(r.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(r.raw)}add(r){return this.token.equals(r.token)||this.logger.logWithError("add token not equals"),new D(this.token,this.raw.add(r.raw))}subtract(r){return this.token.equals(r.token)||this.logger.logWithError("sub token not equals"),new D(this.token,this.raw.sub(r.raw))}toSignificant(r=this.token.decimals,n,o=0){return super.toSignificant(r,n,o)}toFixed(r=this.token.decimals,n,o=0){return r>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(r,n,o)}toExact(r={groupSeparator:""}){return jt.DP=this.token.decimals,new jt(this.numerator.toString()).div(this.denominator.toString()).toFormat(r)}};import{PublicKey as fn}from"@solana/web3.js";var Gt={symbol:"SOL",name:"Solana",decimals:9},v={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},Xo={isQuantumSOL:!0,isLp:!1,official:!0,mint:new fn(v.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};import{PublicKey as je}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as yn}from"@solana/spl-token";import{PublicKey as E,SystemProgram as gn,SYSVAR_RENT_PUBKEY as bn}from"@solana/web3.js";function c({pubkey:e,isSigner:t=!1,isWritable:r=!0}){return{pubkey:e,isWritable:r,isSigner:t}}var Ne=[c({pubkey:yn,isWritable:!1}),c({pubkey:gn.programId,isWritable:!1}),c({pubkey:bn,isWritable:!1})];function Y({publicKey:e,transformSol:t}){if(e instanceof E)return t&&e.equals(W)?Ht:e;if(t&&e===W.toBase58())return Ht;if(typeof e=="string")try{return new E(e)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}function $t(e){try{return new E(e)}catch{return e}}var Yt=new E("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),ri=new E("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),ni=new E("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),oi=new E("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),ii=new E("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),ai=new E("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),si=new E("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),ui=new E("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),ci=new E("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),di=new E("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),mi=new E("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),Ht=new E("So11111111111111111111111111111111111111112"),W=E.default;var Ge=class{constructor({mint:t,decimals:r,symbol:n="UNKNOWN",name:o="UNKNOWN",skipMint:i=!1}){if(t===W.toBase58()||t instanceof je&&W.equals(t)){this.decimals=v.decimals,this.symbol=v.symbol,this.name=v.name,this.mint=new je(v.mint);return}this.decimals=r,this.symbol=n,this.name=o,this.mint=i?je.default:Y({publicKey:t})}equals(t){return this===t?!0:this.mint.equals(t.mint)}},j=Ge;j.WSOL=new Ge(v);var $e=class{constructor({decimals:t,symbol:r="UNKNOWN",name:n="UNKNOWN"}){this.decimals=t,this.symbol=r,this.name=n}equals(t){return this===t}},He=$e;He.SOL=new $e(Gt);var Jt=new f(Ut),$=class extends f{toSignificant(t=5,r,n){return this.mul(Jt).toSignificant(t,r,n)}toFixed(t=2,r,n){return this.mul(Jt).toFixed(t,r,n)}};var wn=F("Raydium_price"),U=class extends f{constructor(r){let{baseToken:n,quoteToken:o,numerator:i,denominator:s}=r;super(i,s);this.baseToken=n,this.quoteToken=o,this.scalar=new f(Ue(n.decimals),Ue(o.decimals))}get raw(){return new f(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new U({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(r){this.quoteToken!==r.baseToken&&wn.logWithError("mul token not equals");let n=super.mul(r);return new U({baseToken:this.baseToken,quoteToken:r.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(r=this.quoteToken.decimals,n,o){return this.adjusted.toSignificant(r,n,o)}toFixed(r=this.quoteToken.decimals,n,o){return this.adjusted.toFixed(r,n,o)}};var xn=[j,D,Pn,f,hn,U,$];function Tn(e){return typeof e=="object"&&e!==null&&!xn.some(t=>typeof t=="object"&&e instanceof t)}function pe(e){return typeof e=="string"?$t(e):Array.isArray(e)?e.map(t=>pe(t)):Tn(e)?Object.fromEntries(Object.entries(e).map(([t,r])=>[t,pe(r)])):e}import{PACKET_DATA_SIZE as Hi,PublicKey as Sn,sendAndConfirmTransaction as zt,Transaction as kn}from"@solana/web3.js";var Zi=F("Raydium_txTool"),Ke=class{constructor(t){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=t.connection,this.feePayer=t.feePayer,this.signAllTransactions=t.signAllTransactions,this.owner=t.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:t=[],endInstructions:r=[],signers:n=[]}){return this.instructions.push(...t),this.endInstructions.push(...r),this.signers.push(...n),this}build(t){let r=new kn;return this.allInstructions.length&&r.add(...this.allInstructions),r.feePayer=this.feePayer,{transaction:r,signers:this.signers,execute:async()=>{var o;let n=await Xt(this.connection);if(r.recentBlockhash=n,(o=this.owner)!=null&&o.isKeyPair)return zt(this.connection,r,this.signers);if(this.signAllTransactions){this.signers.length&&r.partialSign(...this.signers);let i=await this.signAllTransactions([r]);return await this.connection.sendRawTransaction(i[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:t||{}}}buildMultiTx(t){let{extraPreBuildData:r=[],extInfo:n}=t,{transaction:o}=this.build(n),i=r.filter(a=>a.transaction.instructions.length>0),s=[...i.map(a=>a.transaction),o],u=[...i.map(a=>a.signers),this.signers];return{transactions:s,signers:u,execute:async()=>{var d;let a=await Xt(this.connection);if((d=this.owner)!=null&&d.isKeyPair)return await Promise.all(s.map(async(l,y)=>(l.recentBlockhash=a,await zt(this.connection,l,u[y]))));if(this.signAllTransactions){let l=s.map((p,g)=>(p.recentBlockhash=a,u[g].length&&p.partialSign(...u[g]),p)),y=await this.signAllTransactions(l),x=[];for(let p=0;p<y.length;p+=1){let g=await this.connection.sendRawTransaction(y[p].serialize(),{skipPreflight:!0});x.push(g)}return x}throw new Error("please connect wallet first")},extInfo:n||{}}}};async function Xt(e){var t,r;try{return((r=await((t=e.getLatestBlockhash)==null?void 0:t.call(e)))==null?void 0:r.blockhash)||(await e.getRecentBlockhash()).blockhash}catch{return(await e.getRecentBlockhash()).blockhash}}async function Me(e,t){let[r,n]=await Sn.findProgramAddress(e,t);return{publicKey:r,nonce:n}}function Zt(e,t=1,r=[]){let n=[...e];if(t<=0)return r;for(;n.length;)r.push(n.splice(0,t));return r}import{PublicKey as Ln}from"@solana/web3.js";var Ye=F("Raydium_accountInfo_util");async function In(e,t,r){let{batchRequest:n,commitment:o}=A({batchRequest:!1},r),i=Zt(t,100),s=new Array(i.length).fill([]);if(n){let u=i.map(d=>{let l=e._buildArgs([d.map(y=>y.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:l}});s=(await e._rpcBatchRequest(u)).map(d=>(d.error&&Ye.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(l=>{if(l){let{data:y,executable:x,lamports:p,owner:g,rentEpoch:L}=l;return y.length!==2&&y[1]!=="base64"&&Ye.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(y[0],"base64"),executable:x,lamports:p,owner:new Ln(g),rentEpoch:L}}return null})))}else try{s=await Promise.all(i.map(u=>e.getMultipleAccountsInfo(u,o)))}catch(u){u instanceof Error&&Ye.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return s.flat()}async function Qt(e,t,r){let n=await In(e,t.map(o=>o.pubkey),r);return t.map((o,i)=>V(A({},o),{accountInfo:n[i]}))}function z(e){if(e instanceof $)return new f(e.numerator,e.denominator);if(e instanceof U)return e.adjusted;if(e instanceof D)try{return z(e.toExact())}catch{return new f(ce)}if(e instanceof f)return e;let t=String(e),r=oe(t);return new f(r.numerator,r.denominator)}function An(e,t){if(e==null||t==null)return!1;let r=z(e),n=z(t);return r.sub(n).numerator.gt(ce)}function Bn(e,t){if(e==null||t==null)return!1;let r=z(e),n=z(t);return r.sub(n).numerator.eq(ce)}function er(e,t){if(e==null||t==null)return;let r=z(e),n=z(t);return r.sub(n)}function De(e){return e==null?!1:!Bn(e,0)}function tr(e,t){return An(t,e)?t:e}var rr=e=>typeof e=="number",nr=e=>e?new Date(e):new Date,Rn=e=>nr(e).getTime();function fe(e,t,r){let n=rr(t)?t*((r==null?void 0:r.unit)==="s"?1e3:1):t;return new Date(e).getTime()<=n}function ie(e,t,r){let n=rr(t)?t*((r==null?void 0:r.unit)==="s"?1e3:1):t;return new Date(e).getTime()>n}function Je(e,t){let n=Rn(e)+(t.days?t.days*24*60*60*1e3:0)+(t.hours?t.hours*60*60*1e3:0)+(t.minutes?t.minutes*60*1e3:0)+(t.seconds?t.seconds*1e3:0)+(t.milliseconds?t.milliseconds:0);return nr(n)}import{createInitializeAccountInstruction as Vn,createCloseAccountInstruction as En,createTransferInstruction as Rs,TOKEN_PROGRAM_ID as Wn}from"@solana/spl-token";import{Keypair as vn,PublicKey as On,SystemProgram as Cn}from"@solana/web3.js";import Un from"bn.js";import{PublicKey as Dn}from"@solana/web3.js";import ar,{isBN as sr}from"bn.js";import{bits as Ia,BitStructure as Aa,blob as Fn,Blob as Ba,cstr as Ra,f32 as Fa,f32be as _a,f64 as Na,f64be as Ka,greedy as Ma,Layout as _n,ns64 as Da,ns64be as Va,nu64 as Ea,nu64be as Wa,offset as va,s16 as Oa,s16be as Ca,s24 as Ua,s24be as qa,s32 as ja,s32be as Ga,s40 as Ha,s40be as $a,s48 as Ya,s48be as Ja,s8 as za,seq as Nn,struct as Xa,Structure as Kn,u16 as Za,u16be as Qa,u24 as es,u24be as ts,u32 as rs,u32be as ns,u40 as os,u40be as is,u48 as as,u48be as ss,u8 as us,UInt as Mn,union as cs,Union as ds,unionLayoutDiscriminator as ms,utf8 as ls}from"@solana/buffer-layout";var ze=_n,or=Kn;var Xe=Mn;var ir=Nn;var ye=Fn;var Ve=class extends ze{constructor(r,n,o){super(r,o);this.blob=ye(r),this.signed=n}decode(r,n=0){let o=new ar(this.blob.decode(r,n),10,"le");return this.signed?o.fromTwos(this.span*8).clone():o}encode(r,n,o=0){return typeof r=="number"&&(r=new ar(r)),this.signed&&(r=r.toTwos(this.span*8)),this.blob.encode(r.toArrayLike(Buffer,"le",this.span),n,o)}};function G(e){return new Xe(1,e)}function Ee(e){return new Xe(4,e)}function m(e){return new Ve(8,!1,e)}function J(e){return new Ve(16,!1,e)}var Ze=class extends ze{constructor(r,n,o,i){super(r.span,i);this.layout=r,this.decoder=n,this.encoder=o}decode(r,n){return this.decoder(this.layout.decode(r,n))}encode(r,n,o){return this.layout.encode(this.encoder(r),n,o)}getSpan(r,n){return this.layout.getSpan(r,n)}};function h(e){return new Ze(ye(32),t=>new Dn(t),t=>t.toBuffer(),e)}var Qe=class extends or{decode(t,r){return super.decode(t,r)}};function N(e,t,r){return new Qe(e,t,r)}function O(e,t,r){let n,o=typeof t=="number"?t:sr(t)?t.toNumber():new Proxy(t,{get(i,s){if(!n){let u=Reflect.get(i,"count");n=sr(u)?u.toNumber():u,Reflect.set(i,"count",n)}return Reflect.get(i,s)},set(i,s,u){return s==="count"&&(n=u),Reflect.set(i,s,u)}});return ir(e,o,r)}var ae=N([h("mint"),h("owner"),m("amount"),Ee("delegateOption"),h("delegate"),G("state"),Ee("isNativeOption"),m("isNative"),m("delegatedAmount"),Ee("closeAuthorityOption"),h("closeAuthority")]);function qn(e){let{mint:t,tokenAccount:r,owner:n}=e;return Vn(r,t,n)}function jn(e){let{tokenAccount:t,payer:r,multiSigners:n=[],owner:o}=e;return En(t,r,o,n)}async function et(e){let{connection:t,amount:r,commitment:n,payer:o,owner:i,skipCloseAccount:s}=e,u=await t.getMinimumBalanceForRentExemption(ae.span,n),a=P(r).add(new Un(u)),d=vn.generate();return{signers:[d],instructions:[Cn.createAccount({fromPubkey:o,newAccountPubkey:d.publicKey,lamports:a.toNumber(),space:ae.span,programId:Wn}),qn({mint:new On(v.mint),tokenAccount:d.publicKey,owner:i})],endInstructions:s?[]:[jn({tokenAccount:d.publicKey,payer:o,owner:i})]}}var tt=(...e)=>e.map(t=>{try{return typeof t=="object"?JSON.stringify(t):t}catch{return t}}).join(", "),ge=class{constructor({scope:t,moduleName:r}){this.disabled=!1;this.scope=t,this.logger=F(r)}createTxBuilder(t){return this.scope.checkOwner(),new Ke({connection:this.scope.connection,feePayer:t||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...t){this.logger.debug(tt(t))}logInfo(...t){this.logger.info(tt(t))}logAndCreateError(...t){let r=tt(t);throw new Error(r)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as Pe}from"@solana/web3.js";var rt=N([G("instruction")]),nt=N([G("instruction")]),Gn=N([m("rewardState"),m("rewardOpenTime"),m("rewardEndTime"),m("rewardLastUpdateTime"),m("totalReward"),m("totalRewardEmissioned"),m("rewardClaimed"),m("rewardPerSecond"),J("accRewardPerShare"),h("rewardVault"),h("rewardMint"),h("rewardSender"),m("rewardType"),O(m(),15,"padding")]),Hn=N([m("state"),m("nonce"),h("lpVault"),h("rewardVault"),h(),h(),m(),m(),m("totalReward"),J("perShareReward"),m("lastSlot"),m("perSlotReward")]),$n=N([m("state"),m("nonce"),h("lpVault"),h("rewardVaultA"),m("totalRewardA"),J("perShareRewardA"),m("perSlotRewardA"),G("option"),h("rewardVaultB"),ye(7),m("totalRewardB"),J("perShareRewardB"),m("perSlotRewardB"),m("lastSlot"),h()]),Yn=N([m(),m("state"),m("nonce"),m("validRewardTokenNum"),J("rewardMultiplier"),m("rewardPeriodMax"),m("rewardPeriodMin"),m("rewardPeriodExtend"),h("lpMint"),h("lpVault"),O(Gn,5,"rewardInfos"),h("creator"),h(),O(m(),32,"padding")]),ur=new Proxy(Hn,{get(e,t,r){return t==="decode"?(...n)=>{let o=e.decode(...n);return V(A({},o),{version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]})}:Reflect.get(e,t,r)}}),cr=new Proxy($n,{get(e,t,r){return t==="decode"?(...n)=>{let o=e.decode(...n);return V(A({},o),{version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]})}:Reflect.get(e,t,r)}}),be=new Proxy(Yn,{get(e,t,r){return t==="decode"?(...n)=>{let o=e.decode(...n);return V(A({},o),{version:6,rewardInfos:o.rewardInfos.map(i=>{var s;return V(A({},i),{rewardType:((s=Object.entries(We).find(u=>String(u[1])===i.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(e,t,r)}}),Jn=N([m("isSet"),m("rewardPerSecond"),m("rewardOpenTime"),m("rewardEndTime"),m("rewardType")]),ot=N([G("instruction"),m("nonce"),O(Jn,5,"rewardTimeInfo")]),it=N([G("instruction"),m("rewardReopenTime"),m("rewardEndTime"),m("rewardPerSecond")]),at=N([G("instruction"),m("isSet"),m("rewardPerSecond"),m("rewardOpenTime"),m("rewardEndTime")]),Js=N([m("state"),h("id"),h("owner"),m("deposited"),O(m(),1,"rewardDebts")]),dr=N([m("state"),h("id"),h("owner"),m("deposited"),O(J(),1,"rewardDebts"),O(m(),17)]),zs=N([m("state"),h("id"),h("owner"),m("deposited"),O(m(),2,"rewardDebts")]),mr=N([m("state"),h("id"),h("owner"),m("deposited"),O(J(),2,"rewardDebts"),O(m(),17)]),lr=N([m(),m("state"),h("id"),h("owner"),m("deposited"),O(J(),5,"rewardDebts"),O(m(),16)]),we=N([G("instruction"),m("amount")]);var pr=F("Raydium_farm_config"),fr="EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q",zn=new Pe(fr),yr="9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z",Xn=new Pe(yr),gr="FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG",Zn=new Pe(gr),br={[fr]:3,[yr]:5,[gr]:6},wr={3:zn,5:Xn,6:Zn},Pr=new Pe("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),hr=new Pe("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),xr={3:ur,5:cr,6:be},Tr={3:dr,5:mr,6:lr},st=e=>[3,5,6].indexOf(e)!==-1,Qn={3:10,5:11,6:1},Sr=e=>{let t=Qn[e];return t||pr.logWithError("invalid deposit farm version"),t},eo={3:11,5:12,6:2},kr=e=>{let t=eo[e];return t||pr.logWithError("invalid withdraw farm version"),t},Lr=e=>{var s;let{version:t,rewardInfos:r,rewardTokenAccountsPublicKeys:n}=e,o=`rewardInfo:${JSON.stringify(r)}, rewardAccount:${JSON.stringify(n)}`,i={3:()=>{if(r.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(r.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||r.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}};return(s=i[t])==null?void 0:s.call(i)},We={"Standard SPL":0,"Option tokens":1};import{SystemProgram as to,SYSVAR_RENT_PUBKEY as ro,TransactionInstruction as Ir}from"@solana/web3.js";import no from"bn.js";var oo=F("Raydium_farm_instruction");async function Ar(e){let{version:t,id:r,ledger:n,programId:o,owner:i}=e,s={3:9,5:10}[t];s||oo.logWithError(`invalid farm pool version: ${t}`);let u=Buffer.alloc(rt.span);rt.encode({instruction:s},u);let a=[c({pubkey:r}),c({pubkey:n}),c({pubkey:i,isWritable:!1}),c({pubkey:to.programId,isWritable:!1}),c({pubkey:ro,isWritable:!1})];return new Ir({programId:o,keys:a,data:u})}function Br(e){var n;let t=Buffer.alloc(ot.span);ot.encode({instruction:0,nonce:new no(e.nonce),rewardTimeInfo:e.rewardInfoConfig},t);let r=[...Ne,c({pubkey:e.farmKeyPair.publicKey}),c({pubkey:e.farmAuthority,isWritable:!1}),c({pubkey:e.lpVault}),c({pubkey:e.lpMint,isWritable:!1}),c({pubkey:e.lockVault}),c({pubkey:e.lockMint,isWritable:!1}),c({pubkey:(n=e.lockUserAccount)!=null?n:W}),c({pubkey:e.owner,isWritable:!1,isSigner:!0})];for(let o of e.rewardInfo)r.push(c({pubkey:o.rewardMint,isWritable:!1}),c({pubkey:o.rewardVault}),c({pubkey:o.userRewardToken}));return new Ir({programId:e.programId,keys:r,data:t})}import K from"bn.js";var he=F("Raydium.farm.util");async function ve({programId:e,poolId:t,mint:r,type:n}){let{publicKey:o}=await Me([t.toBuffer(),r.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],e);return o}function io(e){let r=Y({publicKey:e}).toBase58();return br[r]}async function ut({programId:e,poolId:t,owner:r}){let{publicKey:n}=await Me([t.toBuffer(),r.toBuffer(),Buffer.from(io(e)===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],e);return n}var Rr=async({programId:e,poolId:t})=>await Me([t.toBuffer()],e);function Fr(e){return wr[e]}function _r(e){return{isSet:new K(1),rewardPerSecond:P(e.rewardPerSecond),rewardOpenTime:P(e.rewardOpenTime),rewardEndTime:P(e.rewardEndTime),rewardType:P(e.rewardType)}}function ct(e){return P(e.rewardEndTime).sub(P(e.rewardOpenTime)).mul(P(e.rewardPerSecond))}function ao(e){let t=Tr[e];return t||he.logWithError("invalid version",e),t}function so(e){let t=xr[e];return t||he.logWithError("invalid version",e),t}function uo(e,t,r,n){if(e.version===3||e.version===5){if(e.lastSlot.gte(new K(r)))return e;let o=new K(r).sub(e.lastSlot);e.lastSlot=new K(r);for(let i of e.rewardInfos){if(t.amount.eq(new K(0)))continue;let s=i.perSlotReward.mul(o);i.perShareReward=i.perShareReward.add(s.mul(new K(10).pow(new K(e.version===3?9:15))).div(t.amount)),i.totalReward=i.totalReward.add(s)}}else if(e.version===6)for(let o of e.rewardInfos){if(o.rewardState.eq(new K(0)))continue;let i=K.min(new K(n),o.rewardEndTime);if(o.rewardOpenTime.gte(i))continue;let u=i.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),a=o.totalReward.sub(o.totalRewardEmissioned);a.lt(u)?(u=a,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(a.div(o.rewardPerSecond))):o.rewardLastUpdateTime=i,!t.amount.eq(new K(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(u.mul(e.rewardMultiplier).div(t.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(u))}return e}async function co({connection:e,farmPools:t,owner:r,config:n}){var x;let o=!1,i=!1,s=new K(10),u=[];for(let p of t){let g=pe(p);g.version===6?i=!0:o=!0,u.push({pubkey:g.id,version:g.version,key:"state",poolId:g.id},{pubkey:g.lpVault,version:g.version,key:"lpVault",poolId:g.id}),r&&u.push({pubkey:await ut({programId:g.programId,poolId:g.id,owner:r}),version:g.version,key:"ledger",poolId:g.id})}let a={},d=await Qt(e,u,n);for(let{pubkey:p,version:g,key:L,poolId:I,accountInfo:b}of d){let R=I.toBase58();if(a[R]=A({},a[R]),L==="state"){let C=so(g);(!b||!b.data||b.data.length!==C.span)&&he.logWithError(`invalid farm state account info, pools.id, ${p}`),a[R].state=C.decode(b.data)}else if(L==="lpVault")(!b||!b.data||b.data.length!==ae.span)&&he.logWithError(`invalid farm lp vault account info, pools.lpVault, ${p}`),a[R].lpVault=ae.decode(b.data);else if(L==="ledger"){let C=ao(g);b&&b.data&&(b.data.length!==C.span&&he.logWithError(`invalid farm ledger account info, ledger, ${p}`),a[R].ledger=C.decode(b.data))}}let l=i||o?await e.getSlot():0,y=i&&(x=await e.getBlockTime(l))!=null?x:0;for(let p of Object.keys(a))a[p].state=uo(a[p].state,a[p].lpVault,l,y);for(let[p,{state:g,ledger:L}]of Object.entries(a))if(L){let I=g.version===6?g.rewardMultiplier:g.rewardInfos.length===1?s.pow(new K(9)):s.pow(new K(15)),b=g.rewardInfos.map((R,C)=>{let _=L.rewardDebts[C];return L.deposited.mul(g.version===6?R.accRewardPerShare:R.perShareReward).div(I).sub(_)});a[p].wrapped=V(A({},a[p].wrapped),{pendingRewards:b})}return a}async function Nr(e){let{farmPools:t}=e,r=await co(e);return t.map((o,i)=>V(A(A(A({},t[i]),pe(o)),r[o.id]),{jsonInfo:t[i]}))}function Kr(e,t=Date.now()){if(e.version===6){let r=e.state.rewardInfos;if(r.every(({rewardOpenTime:n})=>fe(t,n.toNumber(),{unit:"s"})))return"upcoming pool";if(r.every(({rewardEndTime:n})=>ie(t,n.toNumber(),{unit:"s"})))return"closed pool"}else{let r=e.state.rewardInfos.map(({perSlotReward:n})=>n);if(r.length===2){if(String(r[0])==="0"&&String(r[1])!=="0")return"normal fusion pool";if(String(r[0])!=="0"&&String(r[1])!=="0")return"dual fusion pool";if(String(r[0])==="0"&&String(r[1])==="0")return"closed pool"}else if(r.length===1&&String(r[0])==="0")return"closed pool"}}function Mr(e){return e.state.rewardInfos.length===1&&String(e.lpMint)===Yt.toBase58()}function Dr(e,t){return e.version===6?e.state.rewardInfos.map(({rewardPerSecond:r,rewardOpenTime:n,rewardEndTime:o},i)=>{var x;let s=fe(t.currentBlockChainDate,n.toNumber(),{unit:"s"}),u=ie(t.currentBlockChainDate,o.toNumber(),{unit:"s"});if(s||u)return;let a=t.rewardTokens[i];if(!a)return;let d=t.rewardTokenPrices[i];if(!d)return;let l=de(new f(r,ee).div(te.pow(new K(a.decimals||1))).mul(new K(60*60*24*365)),d);return t.tvl?t.tvl.isZero()?Q(0):l.div((x=t.tvl)!=null?x:ee):void 0}):e.state.rewardInfos.map(({perSlotReward:n},o)=>{var d;let i=t.rewardTokens[o];if(!i)return;let s=t.rewardTokenPrices[o];if(!s)return;let u=de(new f(n,ee).div(te.pow(new K(i.decimals||1))).mul(new K(t.blockSlotCountForSecond*60*60*24*365)),s);return t.tvl?t.tvl.isZero()?Q(0):u.div((d=t.tvl)!=null?d:ee):void 0})}var mt=class extends ge{constructor(){super(...arguments);this._farmPools=[];this._hydratedFarmPools=[];this._hydratedFarmMap=new Map;this._sdkParsedFarmPools=[];this._lpTokenInfoMap=new Map}async load(r){var o;await this.scope.liquidity.load(r),await this.scope.fetchFarms(r==null?void 0:r.forceUpdate);let n=((o=this.scope.apiData.farmPools)==null?void 0:o.data)||{};this._farmPools=Object.keys(n||{}).reduce((i,s)=>{var u,a;return i.concat(((a=(u=n[s]).map)==null?void 0:a.call(u,d=>{let l=this.scope.token.allTokenMap.get(d.baseMint),y=this.scope.token.allTokenMap.get(d.quoteMint);return l&&y&&this._lpTokenInfoMap.set(d.lpMint,new j({mint:d.lpMint,decimals:l.decimals,symbol:`${l.symbol} - ${y.name}`,name:`${l.symbol} - ${y.name} LP`})),V(A({},d),{name:d.symbol,category:s})}))||[])},[]),await this.fetchSdkFarmInfo()}async fetchSdkFarmInfo(){var r;this._sdkParsedFarmPools=await Nr({connection:this.scope.connection,farmPools:this._farmPools,owner:(r=this.scope.owner)==null?void 0:r.publicKey,config:{commitment:"confirmed"}})}async loadHydratedFarmInfo(r){let{forceUpdate:n,skipPrice:o}=r||{};if(this._hydratedFarmPools.length&&!n)return this._hydratedFarmPools;await this.scope.farm.load(),!o&&await this.scope.token.fetchTokenPrices(),await this.scope.liquidity.loadPairs();let i=await this.scope.chainTimeOffset(),s=Je(Date.now()+i,{minutes:0}),u=await this.scope.api.getBlockSlotCountForSecond(this.scope.connection.rpcEndpoint),a=Object.fromEntries(this.scope.liquidity.allPairs.map(d=>[d.ammId,{apr30d:d.apr30d,apr7d:d.apr7d,apr24h:d.apr24h}]));return this._hydratedFarmPools=this._sdkParsedFarmPools.map(d=>{let l=this.hydrateFarmInfo({farmInfo:d,blockSlotCountForSecond:u,farmAprs:a,currentBlockChainDate:s,chainTimeOffset:i});return this._hydratedFarmMap.set(d.id.toBase58(),l),l}),this._hydratedFarmPools}get allFarms(){return this._farmPools}get allParsedFarms(){return this._sdkParsedFarmPools}get allHydratedFarms(){return this._hydratedFarmPools}get allHydratedFarmMap(){return this._hydratedFarmMap}getFarm(r){let n=Y({publicKey:r}),o=this.allFarms.find(i=>i.id===n.toBase58());return o||this.logAndCreateError("invalid farm id"),o}getParsedFarm(r){let n=Y({publicKey:r}),o=this.allParsedFarms.find(i=>n.equals(i.id));return o||this.logAndCreateError("invalid farm id"),o}getLpTokenInfo(r){let n=Y({publicKey:r}),o=this._lpTokenInfoMap.get(n.toBase58());return o||this.logAndCreateError("LP Token not found",n.toBase58()),o}lpDecimalAmount({mint:r,amount:n}){let o=oe(n),i=this.getLpTokenInfo(r);return Ae(new f(o.numerator,o.denominator).mul(new dt(10).pow(new dt(i.decimals))))}hydrateFarmInfo(r){var bt,wt,Pt,ht,xt,Tt,St,kt,Lt,It,At,Bt;let{farmInfo:n,blockSlotCountForSecond:o,farmAprs:i,currentBlockChainDate:s,chainTimeOffset:u=0}=r,a=Kr(n,s),d=Mr(n),l=a==="dual fusion pool",y=a==="normal fusion pool",x=a==="closed pool"&&!n.upcoming,p=n.version!==6?n.upcoming&&x:n.upcoming,g=n.version!==6&&n.upcoming&&!x,L=((bt=this.scope.liquidity.allPools.find(w=>w.lpMint===n.lpMint.toBase58()))==null?void 0:bt.version)===5,I=d?this.scope.mintToToken(n.lpMint):this.getLpTokenInfo(n.lpMint),b=this.scope.mintToToken(d?n.lpMint:n.baseMint),R=this.scope.mintToToken(d?n.lpMint:n.quoteMint);b!=null&&b.symbol;let C=d?`${(wt=b==null?void 0:b.symbol)!=null?wt:"unknown"}`:`${(Pt=b==null?void 0:b.symbol)!=null?Pt:"unknown"}-${(ht=R==null?void 0:R.symbol)!=null?ht:"unknown"}`,_=n.jsonInfo.rewardInfos.map(({rewardMint:w})=>this.scope.mintToToken(w)),q=(xt=n.wrapped)==null?void 0:xt.pendingRewards.map((w,k)=>_[k]?new D(_[k],Ae(tr(w,0))):void 0),re=d?this.scope.token.tokenPrices.get(n.lpMint.toBase58()):this.scope.liquidity.lpPriceMap.get(n.lpMint.toBase58()),Se=I&&new D(I,n.lpVault.amount),lt=re&&I?de(new D(I,n.lpVault.amount),re):void 0,se=Dr(n,{tvl:lt,currentBlockChainDate:s,rewardTokens:_,rewardTokenPrices:(Tt=n.rewardInfos.map(({rewardMint:w})=>this.scope.token.tokenPrices.get(w.toBase58())))!=null?Tt:[],blockSlotCountForSecond:o}),X=(St=this.scope.liquidity.allPools.find(w=>w.lpMint===n.lpMint.toBase58()))==null?void 0:St.id,pt=X?Be((kt=i[X])==null?void 0:kt.apr7d,{alreadyDecimaled:!0}):void 0,ft=X?Be((Lt=i[X])==null?void 0:Lt.apr30d,{alreadyDecimaled:!0}):void 0,yt=X?Be((It=i[X])==null?void 0:It.apr24h,{alreadyDecimaled:!0}):void 0,Er=se.reduce((w,k)=>w?k?w.add(k):w:k,pt),Wr=se.reduce((w,k)=>w?k?w.add(k):w:k,ft),vr=se.reduce((w,k)=>w?k?w.add(k):w:k,yt),Or=n.version===6?n.state.rewardInfos.map((w,k)=>{var Nt,Kt,Mt,Dt;let{rewardOpenTime:ue,rewardEndTime:ke,rewardPerSecond:Oe}=w,Z=ue.toNumber()?new Date(ue.toNumber()*1e3+u):void 0,H=ke.toNumber()?new Date(ke.toNumber()*1e3+u):void 0,Ce=Date.now()+u;if(!Z&&!H)return;let ne=this.scope.mintToToken((Mt=(Kt=w.rewardMint)!=null?Kt:(Nt=n.rewardInfos[k])==null?void 0:Nt.rewardMint)==null?void 0:Mt.toBase58()),Rt=Boolean(Z&&fe(Ce,Z)),Ft=Boolean(H&&ie(Ce,H)),_t=!Z&&!H||!Ft&&!Rt,Cr=_t&&ie(Ce,Je(H,{seconds:-((Dt=n.jsonInfo.rewardPeriodExtend)!=null?Dt:72*60*60)})),Ur=ne&&this.scope.mintToTokenAmount({mint:ne.mint,amount:er(w.totalReward,w.totalRewardEmissioned).toFixed(ne.decimals)}),qr=q==null?void 0:q[k],jr=se[k],Gr=Boolean(H),Le=n.rewardInfos[k];return V(A(A({},Le),w),{owner:Le==null?void 0:Le.rewardSender,apr:jr,token:ne,userPendingReward:qr,userHavedReward:Gr,perSecond:ne&&this.scope.mintToTokenAmount({mint:ne.mint,amount:Oe}).toSignificant(),openTime:Z,endTime:H,isOptionToken:w.rewardType==="Option tokens",isRewardBeforeStart:Rt,isRewardEnded:Ft,isRewarding:_t,isRwardingBeforeEnd72h:Cr,claimableRewards:Ur,version:6})}).filter(w=>!!w):n.state.rewardInfos.map((w,k)=>{let ue=q==null?void 0:q[k],ke=se[k],Oe=_[k],{perSlotReward:Z}=w,H=De(ue)||De(Z);return V(A({},w),{apr:ke,token:Oe,userPendingReward:ue,userHavedReward:H,version:n.version})}),gt=I&&((At=n.ledger)==null?void 0:At.deposited)?new D(I,(Bt=n.ledger)==null?void 0:Bt.deposited):void 0;return V(A({},n),{lp:I,lpPrice:re,base:b,quote:R,name:C,isStakePool:d,isDualFusionPool:l,isNormalFusionPool:y,isClosedPool:x,isUpcomingPool:p,isStablePool:L,isNewPool:g,totalApr7d:Er,raydiumFeeApr7d:pt,totalApr24h:vr,raydiumFeeApr24h:yt,totalApr30d:Wr,raydiumFeeApr30d:ft,ammId:X,tvl:lt,userHasStaked:De(gt),rewards:Or,userStakedLpAmount:gt,stakedLpAmount:Se})}async _getUserRewardInfo({payer:r,rewardInfo:n}){if(n.rewardMint.equals(W)){let o=await et({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:r,amount:ct(n)});return{rewardPubKey:o.signers[0].publicKey,newInstruction:o}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:n.rewardMint})}}async create({poolId:r,rewardInfos:n,payer:o}){this.checkDisabled(),this.scope.checkOwner();let i=Y({publicKey:r}),s=this.scope.liquidity.allPools.find(_=>_.id===i.toBase58());s||this.logAndCreateError("invalid pool id");let a={lpMint:new M(s.lpMint),lockInfo:{lockMint:Pr,lockVault:hr},version:6,rewardInfos:n,programId:Fr(6)},d=this.createTxBuilder(),l=o!=null?o:this.scope.ownerPubKey,y=lo.generate(),x=await this.scope.connection.getMinimumBalanceForRentExemption(be.span);d.addInstruction({instructions:[Vr.createAccount({fromPubkey:l,newAccountPubkey:y.publicKey,lamports:x,space:be.span,programId:a.programId})],signers:[y]});let{publicKey:p,nonce:g}=await Rr({programId:a.programId,poolId:y.publicKey}),L=await ve({programId:a.programId,poolId:y.publicKey,mint:a.lpMint,type:"lpVault"}),I=[],b=[];for(let _ of a.rewardInfos){_.rewardOpenTime>=_.rewardEndTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",_.rewardOpenTime.toString()),We[_.rewardType]||this.logAndCreateError("rewardType error",_.rewardType),_.rewardPerSecond<=0&&this.logAndCreateError("rewardPerSecond error",_.rewardPerSecond.toString()),I.push(_r(_));let{rewardPubKey:q,newInstruction:re}=await this._getUserRewardInfo({rewardInfo:_,payer:l});re&&d.addInstruction(re),q||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let Se=_.rewardMint.equals(W)?new M(v.mint):_.rewardMint;b.push({rewardMint:Se,rewardVault:await ve({programId:a.programId,poolId:y.publicKey,mint:Se,type:"rewardVault"}),userRewardToken:q})}let R=await this.scope.account.getCreatedTokenAccount({mint:a.lockInfo.lockMint});R||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let C=Br({farmKeyPair:y,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:L,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:R,programId:a.programId,rewardInfo:b,rewardInfoConfig:I,nonce:g});return await d.addInstruction({instructions:[C]}).build()}async restartReward({farmId:r,payer:n,newRewardInfo:o}){let i=this.getFarm(r);i.version!==6&&this.logAndCreateError("invalid farm version",i.version);let s={id:new M(i.id),rewardInfos:i.rewardInfos,lpVault:new M(i.lpVault),programId:new M(i.programId)};o.rewardOpenTime>=o.rewardEndTime&&this.logAndCreateError("start time error","newRewardInfo",o);let u=n||this.scope.ownerPubKey,a=o.rewardMint.equals(W)?new M(v.mint):o.rewardMint,d=s.rewardInfos.find(I=>new M(I.rewardMint).equals(a));d||this.logAndCreateError("configuration does not exist","rewardMint",a);let l=d.rewardVault?new M(d.rewardVault):W,y=this.createTxBuilder(),{rewardPubKey:x,newInstruction:p}=await this._getUserRewardInfo({rewardInfo:o,payer:u});p&&y.addInstruction(p),x||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let g=Buffer.alloc(it.span);it.encode({instruction:3,rewardReopenTime:P(o.rewardOpenTime),rewardEndTime:P(o.rewardEndTime),rewardPerSecond:P(o.rewardPerSecond)},g);let L=[c({pubkey:xe,isWritable:!1}),c({pubkey:s.id}),c({pubkey:s.lpVault,isWritable:!1}),c({pubkey:l}),c({pubkey:x}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await y.addInstruction({instructions:[new Te({programId:s.programId,keys:L,data:g})]}).build()}async addNewRewardToken(r){let{farmId:n,newRewardInfo:o,payer:i}=r,s=this.getFarm(n);s.version!==6&&this.logAndCreateError("invalid farm version",s.version);let u=i!=null?i:this.scope.ownerPubKey,a=this.createTxBuilder(),d=await ve({programId:new M(s.programId),poolId:new M(s.id),mint:o.rewardMint,type:"rewardVault"}),{rewardPubKey:l,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:o,payer:u});y&&a.addInstruction(y),l||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts);let x=o.rewardMint.equals(W)?new M(v.mint):o.rewardMint,p=Buffer.alloc(at.span);at.encode({instruction:4,isSet:new dt(1),rewardPerSecond:P(o.rewardPerSecond),rewardOpenTime:P(o.rewardOpenTime),rewardEndTime:P(o.rewardEndTime)},p);let g=[...Ne,c({pubkey:new M(s.id)}),c({pubkey:new M(s.authority),isWritable:!1}),c({pubkey:x,isWritable:!1}),c({pubkey:d}),c({pubkey:l}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await a.addInstruction({instructions:[new Te({programId:new M(s.programId),keys:g,data:p})]}).build()}async _prepareFarmAccounts(r){let n=this.createTxBuilder(),{farmInfo:o}=r,{pubKey:i,newInstructions:s}=await this.scope.account.checkOrCreateAta({mint:o.lpMint});n.addInstruction(s);let u=await Promise.all(o.rewardInfos.map(async({rewardMint:l})=>{let{pubKey:y,newInstructions:x}=await this.scope.account.checkOrCreateAta({mint:l,autoUnwrapWSOLToSOL:!0});return n.addInstruction(x),y})),a=await ut({programId:new M(o.programId),poolId:new M(o.id),owner:this.scope.ownerPubKey});if(!o.ledger&&o.version<6){let l=await Ar({id:o.id,programId:o.programId,version:o.version,ledger:a,owner:this.scope.ownerPubKey});n.addInstruction({instructions:[l]})}let d=[c({pubkey:o.id}),c({pubkey:o.authority,isWritable:!1}),c({pubkey:a}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:i}),c({pubkey:new M(o.jsonInfo.lpVault)}),c({pubkey:u[0]}),c({pubkey:o.rewardInfos[0].rewardVault}),c({pubkey:po,isWritable:!1}),c({pubkey:xe,isWritable:!1})];return{txBuilder:n,lpTokenAccount:i,rewardTokenAccountsPublicKeys:u,ledgerAddress:a,lowVersionKeys:d}}async deposit(r){this.scope.checkOwner();let{farmId:n,amount:o}=r,i=this.getParsedFarm(n),s=i.lpMint,{version:u,rewardInfos:a}=i;st(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:d,ledgerAddress:l,lpTokenAccount:y,lowVersionKeys:x,rewardTokenAccountsPublicKeys:p}=await this._prepareFarmAccounts({mint:s,farmInfo:i}),g=Lr({version:u,rewardInfos:a,rewardTokenAccountsPublicKeys:p});g&&this.logAndCreateError(g);let L=Buffer.alloc(we.span);we.encode({instruction:Sr(u),amount:P(o)},L);let I=u===6?[c({pubkey:xe,isWritable:!1}),c({pubkey:Vr.programId,isWritable:!1}),c({pubkey:i.id}),c({pubkey:i.authority,isWritable:!1}),c({pubkey:i.lpVault.mint}),c({pubkey:l}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:y})]:x;if(u!==3)for(let R=1;R<a.length;R++)I.push(c({pubkey:p[R]})),I.push(c({pubkey:a[R].rewardVault}));let b=new Te({programId:i.programId,keys:I,data:L});return await d.addInstruction({instructions:[b]}).build()}async withdraw(r){this.scope.checkOwner();let{farmId:n,amount:o}=r,i=this.getParsedFarm(n),s=i.lpMint,{version:u,rewardInfos:a}=i;st(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:d,ledgerAddress:l,lpTokenAccount:y,lowVersionKeys:x,rewardTokenAccountsPublicKeys:p}=await this._prepareFarmAccounts({mint:s,farmInfo:i}),g=Buffer.alloc(we.span);we.encode({instruction:kr(u),amount:P(o)},g);let L=u===6?[c({pubkey:xe,isWritable:!1}),c({pubkey:i.id}),c({pubkey:i.authority,isWritable:!1}),c({pubkey:i.lpVault.mint}),c({pubkey:l}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:y})]:x;if(u!==3)for(let b=1;b<a.length;b++)L.push(c({pubkey:p[b]})),L.push(c({pubkey:a[b].rewardVault}));let I=new Te({programId:i.programId,keys:L,data:g});return await d.addInstruction({instructions:[I]}).build()}async withdrawFarmReward({farmId:r,withdrawMint:n}){var x;this.scope.checkOwner();let o=this.getParsedFarm(r),{version:i}=o;i!==6&&this.logAndCreateError("invalid farm version",o.version);let s=o.rewardInfos.find(p=>p.rewardMint.equals(n.equals(W)?new M(v.mint):n));s||this.logAndCreateError("withdraw mint error","rewardInfos",o);let u=(x=s==null?void 0:s.rewardVault)!=null?x:W,a=this.createTxBuilder(),d;if(this._getUserRewardInfo({payer:this.scope.ownerPubKey,rewardInfo:s}),n.equals(W)){let p=await et({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:ct(s)});d=p.signers[0].publicKey,a.addInstruction(p)}else{let p=await this.scope.account.getCreatedTokenAccount({mint:n});p===null?(d=await this.scope.account.getAssociatedTokenAccount(n),a.addInstruction({instructions:[mo(this.scope.ownerPubKey,d,this.scope.ownerPubKey,n)]})):d=p}let l=Buffer.alloc(nt.span);nt.encode({instruction:5},l);let y=[c({pubkey:xe,isWritable:!1}),c({pubkey:o.id}),c({pubkey:o.authority,isWritable:!1}),c({pubkey:o.lpVault.mint,isWritable:!1}),c({pubkey:u}),c({pubkey:d}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await a.addInstruction({instructions:[new Te({programId:o.programId,keys:y,data:l})]}).build()}};export{mt as default};
//# sourceMappingURL=farm.mjs.map