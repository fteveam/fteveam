var $r=Object.defineProperty,Jr=Object.defineProperties;var zr=Object.getOwnPropertyDescriptors;var Et=Object.getOwnPropertySymbols;var Xr=Object.prototype.hasOwnProperty,Zr=Object.prototype.propertyIsEnumerable;var vt=(t,e,r)=>e in t?$r(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,A=(t,e)=>{for(var r in e||(e={}))Xr.call(e,r)&&vt(t,r,e[r]);if(Et)for(var r of Et(e))Zr.call(e,r)&&vt(t,r,e[r]);return t},V=(t,e)=>Jr(t,zr(e));import{TOKEN_PROGRAM_ID as xe,createAssociatedTokenAccountInstruction as co}from"@solana/spl-token";import{Keypair as mo,PublicKey as M,SystemProgram as vr,SYSVAR_CLOCK_PUBKEY as lo,TransactionInstruction as Te}from"@solana/web3.js";import mt from"bn.js";import{get as Wt,set as Qr}from"lodash";import Ct from"dayjs";import en from"dayjs/plugin/utc";Ct.extend(en);var Ue=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:3,this.name=e.name}set level(e){this.logLevel=e}get time(){return Ct().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let r=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(r)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Ot={},tn={};function F(t){let e=Wt(Ot,t);if(!e){let r=Wt(tn,t);e=new Ue({name:t,logLevel:r}),Qr(Ot,t,e)}return e}import{PublicKey as wn}from"@solana/web3.js";import hn from"bn.js";import dn from"big.js";import _e from"bn.js";import B from"bn.js";var Ie=F("Raydium_bignumber");var ce=new B(0),ee=new B(1),xo=new B(2),To=new B(3),So=new B(5),te=new B(10),jt=new B(100),ko=new B(1e3),Lo=new B(1e4),Ut=9007199254740991;function h(t){if(t instanceof B)return t;if(typeof t=="string"){if(t.match(/^-?[0-9]+$/))return new B(t);Ie.logWithError(`invalid BigNumberish string: ${t}`)}return typeof t=="number"?(t%1&&Ie.logWithError(`BigNumberish number underflow: ${t}`),(t>=Ut||t<=-Ut)&&Ie.logWithError(`BigNumberish number overflow: ${t}`),new B(String(t))):typeof t=="bigint"?new B(t.toString()):(Ie.logWithError(`invalid BigNumberish value: ${t}`),new B(0))}function qe(t){return te.pow(h(t))}function oe(t){var u;if(t===void 0)return{denominator:"1",numerator:"0"};if(t instanceof B)return{numerator:t.toString(),denominator:"1"};if(t instanceof f)return{denominator:t.denominator.toString(),numerator:t.numerator.toString()};let e=String(t),[,r="",n="",o=""]=(u=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?u:[],i="1"+"0".repeat(o.length),s=r+(n==="0"?"":n)+o||"0";return{denominator:i,numerator:s,sign:r,int:n,dec:o}}function rn(t){var n;let[,e="",r=""]=(n=t.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?n:[];return`${e}${r}`}function Ae(t,e=0){return t instanceof B?t:new B(rn(Q(t).mul(te.pow(new B(String(e))))))}function Q(t){if(t instanceof Y)return new f(t.numerator,t.denominator);if(t instanceof U)return t.adjusted;if(t instanceof D)try{return Q(t.toExact())}catch{return new f(ce)}if(t instanceof f)return t;let e=String(t),r=oe(e);return new f(r.numerator,r.denominator)}function Be(t,e){let{numerator:r,denominator:n}=oe(t);return new Y(new B(r),new B(n).mul(e!=null&&e.alreadyDecimaled?new B(100):new B(1)))}function Gt(t,e){if(t==null||e==null)return;let r=Q(t),n=Q(e);return r.mul(n)}function qt(t){let e=new j({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),r=Ae(Gt(t,10**e.decimals));return new D(e,r)}function de(t,e){return qt(!e||!t?0:Gt(t,e))}import nn from"toformat";var on=nn,me=on;import Fe from"big.js";import sn from"decimal.js-light";var Re=F("module/fraction"),je=me(Fe),le=me(sn),un={[0]:le.ROUND_DOWN,[1]:le.ROUND_HALF_UP,[2]:le.ROUND_UP},cn={[0]:Fe.roundDown,[1]:Fe.roundHalfUp,[2]:Fe.roundUp},f=class{constructor(e,r=ee){this.numerator=h(e),this.denominator=h(r)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new f(this.denominator,this.numerator)}add(e){let r=e instanceof f?e:new f(h(e));return this.denominator.eq(r.denominator)?new f(this.numerator.add(r.numerator),this.denominator):new f(this.numerator.mul(r.denominator).add(r.numerator.mul(this.denominator)),this.denominator.mul(r.denominator))}sub(e){let r=e instanceof f?e:new f(h(e));return this.denominator.eq(r.denominator)?new f(this.numerator.sub(r.numerator),this.denominator):new f(this.numerator.mul(r.denominator).sub(r.numerator.mul(this.denominator)),this.denominator.mul(r.denominator))}mul(e){let r=e instanceof f?e:new f(h(e));return new f(this.numerator.mul(r.numerator),this.denominator.mul(r.denominator))}div(e){let r=e instanceof f?e:new f(h(e));return new f(this.numerator.mul(r.denominator),this.denominator.mul(r.numerator))}toSignificant(e,r={groupSeparator:""},n=1){Number.isInteger(e)||Re.logWithError(`${e} is not an integer.`),e<=0&&Re.logWithError(`${e} is not positive.`),le.set({precision:e+1,rounding:un[n]});let o=new le(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),r)}toFixed(e,r={groupSeparator:""},n=1){return Number.isInteger(e)||Re.logWithError(`${e} is not an integer.`),e<0&&Re.logWithError(`${e} is negative.`),je.DP=e,je.RM=cn[n]||1,new je(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,r)}isZero(){return this.numerator.isZero()}};var mn=F("Raydium_amount"),Ht=me(dn);function ln(t,e){let r="0",n="0";if(t.includes(".")){let o=t.split(".");o.length===2?([r,n]=o,n=n.padEnd(e,"0")):mn.logWithError(`invalid number string, num: ${t}`)}else r=t;return[r,n.slice(0,e)||n]}var D=class extends f{constructor(r,n,o=!0,i){let s=new _e(0),u=te.pow(new _e(r.decimals));if(o)s=h(n);else{let a=new _e(0),d=new _e(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,g]=ln(n.toString(),r.decimals);a=h(l),d=h(g)}a=a.mul(u),s=a.add(d)}super(s,u);this.logger=F(i||"Amount"),this.token=r}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(r){return this.token.equals(r.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(r.raw)}lt(r){return this.token.equals(r.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(r.raw)}add(r){return this.token.equals(r.token)||this.logger.logWithError("add token not equals"),new D(this.token,this.raw.add(r.raw))}subtract(r){return this.token.equals(r.token)||this.logger.logWithError("sub token not equals"),new D(this.token,this.raw.sub(r.raw))}toSignificant(r=this.token.decimals,n,o=0){return super.toSignificant(r,n,o)}toFixed(r=this.token.decimals,n,o=0){return r>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(r,n,o)}toExact(r={groupSeparator:""}){return Ht.DP=this.token.decimals,new Ht(this.numerator.toString()).div(this.denominator.toString()).toFormat(r)}};import{PublicKey as pn}from"@solana/web3.js";var Yt={symbol:"SOL",name:"Solana",decimals:9},W={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},$o={isQuantumSOL:!0,isLp:!1,official:!0,mint:new pn(W.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};import{PublicKey as Ge}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as fn}from"@solana/spl-token";import{PublicKey as E,SystemProgram as gn,SYSVAR_RENT_PUBKEY as yn}from"@solana/web3.js";function c({pubkey:t,isSigner:e=!1,isWritable:r=!0}){return{pubkey:t,isWritable:r,isSigner:e}}var Ne=[c({pubkey:fn,isWritable:!1}),c({pubkey:gn.programId,isWritable:!1}),c({pubkey:yn,isWritable:!1})];function $({publicKey:t,transformSol:e}){if(t instanceof E)return e&&t.equals(v)?$t:t;if(e&&t===v.toBase58())return $t;if(typeof t=="string")try{return new E(t)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}function Jt(t){try{return new E(t)}catch{return t}}var zt=new E("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Qo=new E("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),ei=new E("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),ti=new E("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),ri=new E("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),ni=new E("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),oi=new E("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),ii=new E("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),ai=new E("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),si=new E("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),ui=new E("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),$t=new E("So11111111111111111111111111111111111111112"),v=E.default;var He=class{constructor({mint:e,decimals:r,symbol:n="UNKNOWN",name:o="UNKNOWN",skipMint:i=!1}){if(e===v.toBase58()||e instanceof Ge&&v.equals(e)){this.decimals=W.decimals,this.symbol=W.symbol,this.name=W.name,this.mint=new Ge(W.mint);return}this.decimals=r,this.symbol=n,this.name=o,this.mint=i?Ge.default:$({publicKey:e})}equals(e){return this===e?!0:this.mint.equals(e.mint)}},j=He;j.WSOL=new He(W);var $e=class{constructor({decimals:e,symbol:r="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=r,this.name=n}equals(e){return this===e}},Ye=$e;Ye.SOL=new $e(Yt);var Xt=new f(jt),Y=class extends f{toSignificant(e=5,r,n){return this.mul(Xt).toSignificant(e,r,n)}toFixed(e=2,r,n){return this.mul(Xt).toFixed(e,r,n)}};var bn=F("Raydium_price"),U=class extends f{constructor(r){let{baseToken:n,quoteToken:o,numerator:i,denominator:s}=r;super(i,s);this.baseToken=n,this.quoteToken=o,this.scalar=new f(qe(n.decimals),qe(o.decimals))}get raw(){return new f(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new U({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(r){this.quoteToken!==r.baseToken&&bn.logWithError("mul token not equals");let n=super.mul(r);return new U({baseToken:this.baseToken,quoteToken:r.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(r=this.quoteToken.decimals,n,o){return this.adjusted.toSignificant(r,n,o)}toFixed(r=this.quoteToken.decimals,n,o){return this.adjusted.toFixed(r,n,o)}};var Pn=[j,D,wn,f,hn,U,Y];function xn(t){return typeof t=="object"&&t!==null&&!Pn.some(e=>typeof e=="object"&&t instanceof e)}function pe(t){return typeof t=="string"?Jt(t):Array.isArray(t)?t.map(e=>pe(e)):xn(t)?Object.fromEntries(Object.entries(t).map(([e,r])=>[e,pe(r)])):t}import{PACKET_DATA_SIZE as qi,PublicKey as Tn,sendAndConfirmTransaction as Zt,Transaction as Sn}from"@solana/web3.js";var Ji=F("Raydium_txTool"),Ke=class{constructor(e){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:e=[],endInstructions:r=[],signers:n=[]}){return this.instructions.push(...e),this.endInstructions.push(...r),this.signers.push(...n),this}build(e){let r=new Sn;return this.allInstructions.length&&r.add(...this.allInstructions),r.feePayer=this.feePayer,{transaction:r,signers:this.signers,execute:async()=>{var o;let n=await Qt(this.connection);if(r.recentBlockhash=n,(o=this.owner)!=null&&o.isKeyPair)return Zt(this.connection,r,this.signers);if(this.signAllTransactions){this.signers.length&&r.partialSign(...this.signers);let i=await this.signAllTransactions([r]);return await this.connection.sendRawTransaction(i[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:r=[],extInfo:n}=e,{transaction:o}=this.build(n),i=r.filter(a=>a.transaction.instructions.length>0),s=[...i.map(a=>a.transaction),o],u=[...i.map(a=>a.signers),this.signers];return{transactions:s,signers:u,execute:async()=>{var d;let a=await Qt(this.connection);if((d=this.owner)!=null&&d.isKeyPair)return await Promise.all(s.map(async(l,g)=>(l.recentBlockhash=a,await Zt(this.connection,l,u[g]))));if(this.signAllTransactions){let l=s.map((p,y)=>(p.recentBlockhash=a,u[y].length&&p.partialSign(...u[y]),p)),g=await this.signAllTransactions(l),x=[];for(let p=0;p<g.length;p+=1){let y=await this.connection.sendRawTransaction(g[p].serialize(),{skipPreflight:!0});x.push(y)}return x}throw new Error("please connect wallet first")},extInfo:n||{}}}};async function Qt(t){var e,r;try{return((r=await((e=t.getLatestBlockhash)==null?void 0:e.call(t)))==null?void 0:r.blockhash)||(await t.getRecentBlockhash()).blockhash}catch{return(await t.getRecentBlockhash()).blockhash}}async function Me(t,e){let[r,n]=await Tn.findProgramAddress(t,e);return{publicKey:r,nonce:n}}function er(t,e=1,r=[]){let n=[...t];if(e<=0)return r;for(;n.length;)r.push(n.splice(0,e));return r}import{PublicKey as kn}from"@solana/web3.js";var Je=F("Raydium_accountInfo_util");async function Ln(t,e,r){let{batchRequest:n,commitment:o}=A({batchRequest:!1},r),i=er(e,100),s=new Array(i.length).fill([]);if(n){let u=i.map(d=>{let l=t._buildArgs([d.map(g=>g.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:l}});s=(await t._rpcBatchRequest(u)).map(d=>(d.error&&Je.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(l=>{if(l){let{data:g,executable:x,lamports:p,owner:y,rentEpoch:L}=l;return g.length!==2&&g[1]!=="base64"&&Je.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(g[0],"base64"),executable:x,lamports:p,owner:new kn(y),rentEpoch:L}}return null})))}else try{s=await Promise.all(i.map(u=>t.getMultipleAccountsInfo(u,o)))}catch(u){u instanceof Error&&Je.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return s.flat()}async function tr(t,e,r){let n=await Ln(t,e.map(o=>o.pubkey),r);return e.map((o,i)=>V(A({},o),{accountInfo:n[i]}))}function z(t){if(t instanceof Y)return new f(t.numerator,t.denominator);if(t instanceof U)return t.adjusted;if(t instanceof D)try{return z(t.toExact())}catch{return new f(ce)}if(t instanceof f)return t;let e=String(t),r=oe(e);return new f(r.numerator,r.denominator)}function In(t,e){if(t==null||e==null)return!1;let r=z(t),n=z(e);return r.sub(n).numerator.gt(ce)}function An(t,e){if(t==null||e==null)return!1;let r=z(t),n=z(e);return r.sub(n).numerator.eq(ce)}function rr(t,e){if(t==null||e==null)return;let r=z(t),n=z(e);return r.sub(n)}function De(t){return t==null?!1:!An(t,0)}function nr(t,e){return In(e,t)?e:t}var or=t=>typeof t=="number",ir=t=>t?new Date(t):new Date,Bn=t=>ir(t).getTime();function fe(t,e,r){let n=or(e)?e*((r==null?void 0:r.unit)==="s"?1e3:1):e;return new Date(t).getTime()<=n}function ie(t,e,r){let n=or(e)?e*((r==null?void 0:r.unit)==="s"?1e3:1):e;return new Date(t).getTime()>n}function ze(t,e){let n=Bn(t)+(e.days?e.days*24*60*60*1e3:0)+(e.hours?e.hours*60*60*1e3:0)+(e.minutes?e.minutes*60*1e3:0)+(e.seconds?e.seconds*1e3:0)+(e.milliseconds?e.milliseconds:0);return ir(n)}import{createInitializeAccountInstruction as Dn,createCloseAccountInstruction as Vn,createTransferInstruction as Is,TOKEN_PROGRAM_ID as En}from"@solana/spl-token";import{Keypair as vn,PublicKey as Wn,SystemProgram as On}from"@solana/web3.js";import Cn from"bn.js";import{PublicKey as Mn}from"@solana/web3.js";import ur,{isBN as cr}from"bn.js";import{bits as Sa,BitStructure as ka,blob as Rn,Blob as La,cstr as Ia,f32 as Aa,f32be as Ba,f64 as Ra,f64be as Fa,greedy as _a,Layout as Fn,ns64 as Na,ns64be as Ka,nu64 as Ma,nu64be as Da,offset as Va,s16 as Ea,s16be as va,s24 as Wa,s24be as Oa,s32 as Ca,s32be as Ua,s40 as qa,s40be as ja,s48 as Ga,s48be as Ha,s8 as Ya,seq as _n,struct as $a,Structure as Nn,u16 as Ja,u16be as za,u24 as Xa,u24be as Za,u32 as Qa,u32be as es,u40 as ts,u40be as rs,u48 as ns,u48be as os,u8 as is,UInt as Kn,union as as,Union as ss,unionLayoutDiscriminator as us,utf8 as cs}from"@solana/buffer-layout";var Xe=Fn,ar=Nn;var Ze=Kn;var sr=_n;var ge=Rn;var Ve=class extends Xe{constructor(r,n,o){super(r,o);this.blob=ge(r),this.signed=n}decode(r,n=0){let o=new ur(this.blob.decode(r,n),10,"le");return this.signed?o.fromTwos(this.span*8).clone():o}encode(r,n,o=0){return typeof r=="number"&&(r=new ur(r)),this.signed&&(r=r.toTwos(this.span*8)),this.blob.encode(r.toArrayLike(Buffer,"le",this.span),n,o)}};function G(t){return new Ze(1,t)}function Ee(t){return new Ze(4,t)}function m(t){return new Ve(8,!1,t)}function J(t){return new Ve(16,!1,t)}var Qe=class extends Xe{constructor(r,n,o,i){super(r.span,i);this.layout=r,this.decoder=n,this.encoder=o}decode(r,n){return this.decoder(this.layout.decode(r,n))}encode(r,n,o){return this.layout.encode(this.encoder(r),n,o)}getSpan(r,n){return this.layout.getSpan(r,n)}};function P(t){return new Qe(ge(32),e=>new Mn(e),e=>e.toBuffer(),t)}var et=class extends ar{decode(e,r){return super.decode(e,r)}};function N(t,e,r){return new et(t,e,r)}function O(t,e,r){let n,o=typeof e=="number"?e:cr(e)?e.toNumber():new Proxy(e,{get(i,s){if(!n){let u=Reflect.get(i,"count");n=cr(u)?u.toNumber():u,Reflect.set(i,"count",n)}return Reflect.get(i,s)},set(i,s,u){return s==="count"&&(n=u),Reflect.set(i,s,u)}});return sr(t,o,r)}var ae=N([P("mint"),P("owner"),m("amount"),Ee("delegateOption"),P("delegate"),G("state"),Ee("isNativeOption"),m("isNative"),m("delegatedAmount"),Ee("closeAuthorityOption"),P("closeAuthority")]);function Un(t){let{mint:e,tokenAccount:r,owner:n}=t;return Dn(r,e,n)}function qn(t){let{tokenAccount:e,payer:r,multiSigners:n=[],owner:o}=t;return Vn(e,r,o,n)}async function tt(t){let{connection:e,amount:r,commitment:n,payer:o,owner:i,skipCloseAccount:s}=t,u=await e.getMinimumBalanceForRentExemption(ae.span,n),a=h(r).add(new Cn(u)),d=vn.generate();return{signers:[d],instructions:[On.createAccount({fromPubkey:o,newAccountPubkey:d.publicKey,lamports:a.toNumber(),space:ae.span,programId:En}),Un({mint:new Wn(W.mint),tokenAccount:d.publicKey,owner:i})],endInstructions:s?[]:[qn({tokenAccount:d.publicKey,payer:o,owner:i})]}}var rt=(...t)=>t.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),ye=class{constructor({scope:e,moduleName:r}){this.disabled=!1;this.scope=e,this.logger=F(r)}createTxBuilder(e){return this.scope.checkOwner(),new Ke({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(rt(e))}logInfo(...e){this.logger.info(rt(e))}logAndCreateError(...e){let r=rt(e);throw new Error(r)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as he}from"@solana/web3.js";var nt=N([G("instruction")]),ot=N([G("instruction")]),jn=N([m("rewardState"),m("rewardOpenTime"),m("rewardEndTime"),m("rewardLastUpdateTime"),m("totalReward"),m("totalRewardEmissioned"),m("rewardClaimed"),m("rewardPerSecond"),J("accRewardPerShare"),P("rewardVault"),P("rewardMint"),P("rewardSender"),m("rewardType"),O(m(),15,"padding")]),Gn=N([m("state"),m("nonce"),P("lpVault"),P("rewardVault"),P(),P(),m(),m(),m("totalReward"),J("perShareReward"),m("lastSlot"),m("perSlotReward")]),Hn=N([m("state"),m("nonce"),P("lpVault"),P("rewardVaultA"),m("totalRewardA"),J("perShareRewardA"),m("perSlotRewardA"),G("option"),P("rewardVaultB"),ge(7),m("totalRewardB"),J("perShareRewardB"),m("perSlotRewardB"),m("lastSlot"),P()]),Yn=N([m(),m("state"),m("nonce"),m("validRewardTokenNum"),J("rewardMultiplier"),m("rewardPeriodMax"),m("rewardPeriodMin"),m("rewardPeriodExtend"),P("lpMint"),P("lpVault"),O(jn,5,"rewardInfos"),P("creator"),P(),O(m(),32,"padding")]),dr=new Proxy(Gn,{get(t,e,r){return e==="decode"?(...n)=>{let o=t.decode(...n);return V(A({},o),{version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]})}:Reflect.get(t,e,r)}}),mr=new Proxy(Hn,{get(t,e,r){return e==="decode"?(...n)=>{let o=t.decode(...n);return V(A({},o),{version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]})}:Reflect.get(t,e,r)}}),be=new Proxy(Yn,{get(t,e,r){return e==="decode"?(...n)=>{let o=t.decode(...n);return V(A({},o),{version:6,rewardInfos:o.rewardInfos.map(i=>{var s;return V(A({},i),{rewardType:((s=Object.entries(ve).find(u=>String(u[1])===i.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(t,e,r)}}),$n=N([m("isSet"),m("rewardPerSecond"),m("rewardOpenTime"),m("rewardEndTime"),m("rewardType")]),it=N([G("instruction"),m("nonce"),O($n,5,"rewardTimeInfo")]),at=N([G("instruction"),m("rewardReopenTime"),m("rewardEndTime"),m("rewardPerSecond")]),st=N([G("instruction"),m("isSet"),m("rewardPerSecond"),m("rewardOpenTime"),m("rewardEndTime")]),Ys=N([m("state"),P("id"),P("owner"),m("deposited"),O(m(),1,"rewardDebts")]),lr=N([m("state"),P("id"),P("owner"),m("deposited"),O(J(),1,"rewardDebts"),O(m(),17)]),$s=N([m("state"),P("id"),P("owner"),m("deposited"),O(m(),2,"rewardDebts")]),pr=N([m("state"),P("id"),P("owner"),m("deposited"),O(J(),2,"rewardDebts"),O(m(),17)]),fr=N([m(),m("state"),P("id"),P("owner"),m("deposited"),O(J(),5,"rewardDebts"),O(m(),16)]),we=N([G("instruction"),m("amount")]);var gr=F("Raydium_farm_config"),yr="EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q",Jn=new he(yr),br="9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z",zn=new he(br),wr="FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG",Xn=new he(wr),hr={[yr]:3,[br]:5,[wr]:6},Pr={3:Jn,5:zn,6:Xn},xr=new he("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Tr=new he("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),Sr={3:dr,5:mr,6:be},kr={3:lr,5:pr,6:fr},ut=t=>[3,5,6].indexOf(t)!==-1,Zn={3:10,5:11,6:1},Lr=t=>{let e=Zn[t];return e||gr.logWithError("invalid deposit farm version"),e},Qn={3:11,5:12,6:2},Ir=t=>{let e=Qn[t];return e||gr.logWithError("invalid withdraw farm version"),e},Ar=t=>{var s;let{version:e,rewardInfos:r,rewardTokenAccountsPublicKeys:n}=t,o=`rewardInfo:${JSON.stringify(r)}, rewardAccount:${JSON.stringify(n)}`,i={3:()=>{if(r.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(r.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||r.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}};return(s=i[e])==null?void 0:s.call(i)},ve={"Standard SPL":0,"Option tokens":1};import{SystemProgram as eo,SYSVAR_RENT_PUBKEY as to,TransactionInstruction as Br}from"@solana/web3.js";import ro from"bn.js";var no=F("Raydium_farm_instruction");async function Rr(t){let{version:e,id:r,ledger:n,programId:o,owner:i}=t,s={3:9,5:10}[e];s||no.logWithError(`invalid farm pool version: ${e}`);let u=Buffer.alloc(nt.span);nt.encode({instruction:s},u);let a=[c({pubkey:r}),c({pubkey:n}),c({pubkey:i,isWritable:!1}),c({pubkey:eo.programId,isWritable:!1}),c({pubkey:to,isWritable:!1})];return new Br({programId:o,keys:a,data:u})}function Fr(t){var n;let e=Buffer.alloc(it.span);it.encode({instruction:0,nonce:new ro(t.nonce),rewardTimeInfo:t.rewardInfoConfig},e);let r=[...Ne,c({pubkey:t.farmKeyPair.publicKey}),c({pubkey:t.farmAuthority,isWritable:!1}),c({pubkey:t.lpVault}),c({pubkey:t.lpMint,isWritable:!1}),c({pubkey:t.lockVault}),c({pubkey:t.lockMint,isWritable:!1}),c({pubkey:(n=t.lockUserAccount)!=null?n:v}),c({pubkey:t.owner,isWritable:!1,isSigner:!0})];for(let o of t.rewardInfo)r.push(c({pubkey:o.rewardMint,isWritable:!1}),c({pubkey:o.rewardVault}),c({pubkey:o.userRewardToken}));return new Br({programId:t.programId,keys:r,data:e})}import K from"bn.js";var Pe=F("Raydium.farm.util");async function We({programId:t,poolId:e,mint:r,type:n}){let{publicKey:o}=await Me([e.toBuffer(),r.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],t);return o}function oo(t){let r=$({publicKey:t}).toBase58();return hr[r]}async function ct({programId:t,poolId:e,owner:r}){let{publicKey:n}=await Me([e.toBuffer(),r.toBuffer(),Buffer.from(oo(t)===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],t);return n}var _r=async({programId:t,poolId:e})=>await Me([e.toBuffer()],t);function Nr(t){return Pr[t]}function Kr(t){return{isSet:new K(1),rewardPerSecond:h(t.rewardPerSecond),rewardOpenTime:h(t.rewardOpenTime),rewardEndTime:h(t.rewardEndTime),rewardType:h(t.rewardType)}}function dt(t){return h(t.rewardEndTime).sub(h(t.rewardOpenTime)).mul(h(t.rewardPerSecond))}function io(t){let e=kr[t];return e||Pe.logWithError("invalid version",t),e}function ao(t){let e=Sr[t];return e||Pe.logWithError("invalid version",t),e}function so(t,e,r,n){if(t.version===3||t.version===5){if(t.lastSlot.gte(new K(r)))return t;let o=new K(r).sub(t.lastSlot);t.lastSlot=new K(r);for(let i of t.rewardInfos){if(e.amount.eq(new K(0)))continue;let s=i.perSlotReward.mul(o);i.perShareReward=i.perShareReward.add(s.mul(new K(10).pow(new K(t.version===3?9:15))).div(e.amount)),i.totalReward=i.totalReward.add(s)}}else if(t.version===6)for(let o of t.rewardInfos){if(o.rewardState.eq(new K(0)))continue;let i=K.min(new K(n),o.rewardEndTime);if(o.rewardOpenTime.gte(i))continue;let u=i.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),a=o.totalReward.sub(o.totalRewardEmissioned);a.lt(u)?(u=a,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(a.div(o.rewardPerSecond))):o.rewardLastUpdateTime=i,!e.amount.eq(new K(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(u.mul(t.rewardMultiplier).div(e.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(u))}return t}async function uo({connection:t,farmPools:e,owner:r,config:n}){var x;let o=!1,i=!1,s=new K(10),u=[];for(let p of e){let y=pe(p);y.version===6?i=!0:o=!0,u.push({pubkey:y.id,version:y.version,key:"state",poolId:y.id},{pubkey:y.lpVault,version:y.version,key:"lpVault",poolId:y.id}),r&&u.push({pubkey:await ct({programId:y.programId,poolId:y.id,owner:r}),version:y.version,key:"ledger",poolId:y.id})}let a={},d=await tr(t,u,n);for(let{pubkey:p,version:y,key:L,poolId:I,accountInfo:b}of d){let R=I.toBase58();if(a[R]=A({},a[R]),L==="state"){let C=ao(y);(!b||!b.data||b.data.length!==C.span)&&Pe.logWithError(`invalid farm state account info, pools.id, ${p}`),a[R].state=C.decode(b.data)}else if(L==="lpVault")(!b||!b.data||b.data.length!==ae.span)&&Pe.logWithError(`invalid farm lp vault account info, pools.lpVault, ${p}`),a[R].lpVault=ae.decode(b.data);else if(L==="ledger"){let C=io(y);b&&b.data&&(b.data.length!==C.span&&Pe.logWithError(`invalid farm ledger account info, ledger, ${p}`),a[R].ledger=C.decode(b.data))}}let l=i||o?await t.getSlot():0,g=i&&(x=await t.getBlockTime(l))!=null?x:0;for(let p of Object.keys(a))a[p].state=so(a[p].state,a[p].lpVault,l,g);for(let[p,{state:y,ledger:L}]of Object.entries(a))if(L){let I=y.version===6?y.rewardMultiplier:y.rewardInfos.length===1?s.pow(new K(9)):s.pow(new K(15)),b=y.rewardInfos.map((R,C)=>{let _=L.rewardDebts[C];return L.deposited.mul(y.version===6?R.accRewardPerShare:R.perShareReward).div(I).sub(_)});a[p].wrapped=V(A({},a[p].wrapped),{pendingRewards:b})}return a}async function Mr(t){let{farmPools:e}=t,r=await uo(t);return e.map((o,i)=>V(A(A(A({},e[i]),pe(o)),r[o.id]),{jsonInfo:e[i]}))}function Dr(t,e=Date.now()){if(t.version===6){let r=t.state.rewardInfos;if(r.every(({rewardOpenTime:n})=>fe(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(r.every(({rewardEndTime:n})=>ie(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let r=t.state.rewardInfos.map(({perSlotReward:n})=>n);if(r.length===2){if(String(r[0])==="0"&&String(r[1])!=="0")return"normal fusion pool";if(String(r[0])!=="0"&&String(r[1])!=="0")return"dual fusion pool";if(String(r[0])==="0"&&String(r[1])==="0")return"closed pool"}else if(r.length===1&&String(r[0])==="0")return"closed pool"}}function Vr(t){return t.state.rewardInfos.length===1&&String(t.lpMint)===zt.toBase58()}function Er(t,e){return t.version===6?t.state.rewardInfos.map(({rewardPerSecond:r,rewardOpenTime:n,rewardEndTime:o},i)=>{var x;let s=fe(e.currentBlockChainDate,n.toNumber(),{unit:"s"}),u=ie(e.currentBlockChainDate,o.toNumber(),{unit:"s"});if(s||u)return;let a=e.rewardTokens[i];if(!a)return;let d=e.rewardTokenPrices[i];if(!d)return;let l=de(new f(r,ee).div(te.pow(new K(a.decimals||1))).mul(new K(60*60*24*365)),d);return e.tvl?e.tvl.isZero()?Q(0):l.div((x=e.tvl)!=null?x:ee):void 0}):t.state.rewardInfos.map(({perSlotReward:n},o)=>{var d;let i=e.rewardTokens[o];if(!i)return;let s=e.rewardTokenPrices[o];if(!s)return;let u=de(new f(n,ee).div(te.pow(new K(i.decimals||1))).mul(new K(e.blockSlotCountForSecond*60*60*24*365)),s);return e.tvl?e.tvl.isZero()?Q(0):u.div((d=e.tvl)!=null?d:ee):void 0})}var lt=class extends ye{constructor(){super(...arguments);this._farmPools=[];this._hydratedFarmPools=[];this._hydratedFarmMap=new Map;this._sdkParsedFarmPools=[];this._lpTokenInfoMap=new Map}async load(r){var o;await this.scope.liquidity.load(r),await this.scope.fetchFarms(r==null?void 0:r.forceUpdate);let n=((o=this.scope.apiData.farmPools)==null?void 0:o.data)||{};this._farmPools=Object.keys(n||{}).reduce((i,s)=>{var u,a;return i.concat(((a=(u=n[s]).map)==null?void 0:a.call(u,d=>{let l=this.scope.token.allTokenMap.get(d.baseMint),g=this.scope.token.allTokenMap.get(d.quoteMint);return l&&g&&this._lpTokenInfoMap.set(d.lpMint,new j({mint:d.lpMint,decimals:l.decimals,symbol:`${l.symbol} - ${g.name}`,name:`${l.symbol} - ${g.name} LP`})),V(A({},d),{name:d.symbol,category:s})}))||[])},[]),await this.fetchSdkFarmInfo()}async fetchSdkFarmInfo(){var r;this._sdkParsedFarmPools=await Mr({connection:this.scope.connection,farmPools:this._farmPools,owner:(r=this.scope.owner)==null?void 0:r.publicKey,config:{commitment:"confirmed"}})}async loadHydratedFarmInfo(r){let{forceUpdate:n,skipPrice:o}=r||{};if(this._hydratedFarmPools.length&&!n)return this._hydratedFarmPools;await this.scope.farm.load();try{await this.scope.account.fetchWalletTokenAccounts()}catch{}!o&&await this.scope.token.fetchTokenPrices(),await this.scope.liquidity.loadPairs();let i=await this.scope.chainTimeOffset(),s=ze(Date.now()+i,{minutes:0}),u=await this.scope.api.getBlockSlotCountForSecond(this.scope.connection.rpcEndpoint),a=Object.fromEntries(this.scope.liquidity.allPairs.map(d=>[d.ammId,{apr30d:d.apr30d,apr7d:d.apr7d,apr24h:d.apr24h}]));return this._hydratedFarmPools=this._sdkParsedFarmPools.map(d=>{let l=this.hydrateFarmInfo({farmInfo:d,blockSlotCountForSecond:u,farmAprs:a,currentBlockChainDate:s,chainTimeOffset:i});return this._hydratedFarmMap.set(d.id.toBase58(),l),l}),this._hydratedFarmPools}get allFarms(){return this._farmPools}get allParsedFarms(){return this._sdkParsedFarmPools}get allHydratedFarms(){return this._hydratedFarmPools}get allHydratedFarmMap(){return this._hydratedFarmMap}getFarm(r){let n=$({publicKey:r}),o=this.allFarms.find(i=>i.id===n.toBase58());return o||this.logAndCreateError("invalid farm id"),o}getParsedFarm(r){let n=$({publicKey:r}),o=this.allParsedFarms.find(i=>n.equals(i.id));return o||this.logAndCreateError("invalid farm id"),o}getLpTokenInfo(r){let n=$({publicKey:r}),o=this._lpTokenInfoMap.get(n.toBase58());return o||this.logAndCreateError("LP Token not found",n.toBase58()),o}lpDecimalAmount({mint:r,amount:n}){let o=oe(n),i=this.getLpTokenInfo(r);return Ae(new f(o.numerator,o.denominator).mul(new mt(10).pow(new mt(i.decimals))))}hydrateFarmInfo(r){var wt,ht,Pt,xt,Tt,St,kt,Lt,It,At,Bt,Rt;let{farmInfo:n,blockSlotCountForSecond:o,farmAprs:i,currentBlockChainDate:s,chainTimeOffset:u=0}=r,a=Dr(n,s),d=Vr(n),l=a==="dual fusion pool",g=a==="normal fusion pool",x=a==="closed pool"&&!n.upcoming,p=n.version!==6?n.upcoming&&x:n.upcoming,y=n.version!==6&&n.upcoming&&!x,L=((wt=this.scope.liquidity.allPools.find(w=>w.lpMint===n.lpMint.toBase58()))==null?void 0:wt.version)===5,I=d?this.scope.mintToToken(n.lpMint):this.getLpTokenInfo(n.lpMint),b=this.scope.mintToToken(d?n.lpMint:n.baseMint),R=this.scope.mintToToken(d?n.lpMint:n.quoteMint);b!=null&&b.symbol;let C=d?`${(ht=b==null?void 0:b.symbol)!=null?ht:"unknown"}`:`${(Pt=b==null?void 0:b.symbol)!=null?Pt:"unknown"}-${(xt=R==null?void 0:R.symbol)!=null?xt:"unknown"}`,_=n.jsonInfo.rewardInfos.map(({rewardMint:w})=>this.scope.mintToToken(w)),q=(Tt=n.wrapped)==null?void 0:Tt.pendingRewards.map((w,k)=>_[k]?new D(_[k],Ae(nr(w,0))):void 0),re=d?this.scope.token.tokenPrices.get(n.lpMint.toBase58()):this.scope.liquidity.lpPriceMap.get(n.lpMint.toBase58()),Se=I&&new D(I,n.lpVault.amount),pt=re&&I?de(new D(I,n.lpVault.amount),re):void 0,se=Er(n,{tvl:pt,currentBlockChainDate:s,rewardTokens:_,rewardTokenPrices:(St=n.rewardInfos.map(({rewardMint:w})=>this.scope.token.tokenPrices.get(w.toBase58())))!=null?St:[],blockSlotCountForSecond:o}),X=(kt=this.scope.liquidity.allPools.find(w=>w.lpMint===n.lpMint.toBase58()))==null?void 0:kt.id,ft=X?Be((Lt=i[X])==null?void 0:Lt.apr7d,{alreadyDecimaled:!0}):void 0,gt=X?Be((It=i[X])==null?void 0:It.apr30d,{alreadyDecimaled:!0}):void 0,yt=X?Be((At=i[X])==null?void 0:At.apr24h,{alreadyDecimaled:!0}):void 0,Wr=se.reduce((w,k)=>w?k?w.add(k):w:k,ft),Or=se.reduce((w,k)=>w?k?w.add(k):w:k,gt),Cr=se.reduce((w,k)=>w?k?w.add(k):w:k,yt),Ur=n.version===6?n.state.rewardInfos.map((w,k)=>{var Kt,Mt,Dt,Vt;let{rewardOpenTime:ue,rewardEndTime:ke,rewardPerSecond:Oe}=w,Z=ue.toNumber()?new Date(ue.toNumber()*1e3+u):void 0,H=ke.toNumber()?new Date(ke.toNumber()*1e3+u):void 0,Ce=Date.now()+u;if(!Z&&!H)return;let ne=this.scope.mintToToken((Dt=(Mt=w.rewardMint)!=null?Mt:(Kt=n.rewardInfos[k])==null?void 0:Kt.rewardMint)==null?void 0:Dt.toBase58()),Ft=Boolean(Z&&fe(Ce,Z)),_t=Boolean(H&&ie(Ce,H)),Nt=!Z&&!H||!_t&&!Ft,qr=Nt&&ie(Ce,ze(H,{seconds:-((Vt=n.jsonInfo.rewardPeriodExtend)!=null?Vt:72*60*60)})),jr=ne&&this.scope.mintToTokenAmount({mint:ne.mint,amount:rr(w.totalReward,w.totalRewardEmissioned).toFixed(ne.decimals)}),Gr=q==null?void 0:q[k],Hr=se[k],Yr=Boolean(H),Le=n.rewardInfos[k];return V(A(A({},Le),w),{owner:Le==null?void 0:Le.rewardSender,apr:Hr,token:ne,userPendingReward:Gr,userHavedReward:Yr,perSecond:ne&&this.scope.mintToTokenAmount({mint:ne.mint,amount:Oe}).toSignificant(),openTime:Z,endTime:H,isOptionToken:w.rewardType==="Option tokens",isRewardBeforeStart:Ft,isRewardEnded:_t,isRewarding:Nt,isRwardingBeforeEnd72h:qr,claimableRewards:jr,version:6})}).filter(w=>!!w):n.state.rewardInfos.map((w,k)=>{let ue=q==null?void 0:q[k],ke=se[k],Oe=_[k],{perSlotReward:Z}=w,H=De(ue)||De(Z);return V(A({},w),{apr:ke,token:Oe,userPendingReward:ue,userHavedReward:H,version:n.version})}),bt=I&&((Bt=n.ledger)==null?void 0:Bt.deposited)?new D(I,(Rt=n.ledger)==null?void 0:Rt.deposited):void 0;return V(A({},n),{lp:I,lpPrice:re,base:b,quote:R,name:C,isStakePool:d,isDualFusionPool:l,isNormalFusionPool:g,isClosedPool:x,isUpcomingPool:p,isStablePool:L,isNewPool:y,totalApr7d:Wr,raydiumFeeApr7d:ft,totalApr24h:Cr,raydiumFeeApr24h:yt,totalApr30d:Or,raydiumFeeApr30d:gt,ammId:X,tvl:pt,userHasStaked:De(bt),rewards:Ur,userStakedLpAmount:bt,stakedLpAmount:Se})}async _getUserRewardInfo({payer:r,rewardInfo:n}){if(n.rewardMint.equals(v)){let o=await tt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:r,amount:dt(n)});return{rewardPubKey:o.signers[0].publicKey,newInstruction:o}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:n.rewardMint})}}async create({poolId:r,rewardInfos:n,payer:o}){this.checkDisabled(),this.scope.checkOwner();let i=$({publicKey:r}),s=this.scope.liquidity.allPools.find(_=>_.id===i.toBase58());s||this.logAndCreateError("invalid pool id");let a={lpMint:new M(s.lpMint),lockInfo:{lockMint:xr,lockVault:Tr},version:6,rewardInfos:n,programId:Nr(6)},d=this.createTxBuilder(),l=o!=null?o:this.scope.ownerPubKey,g=mo.generate(),x=await this.scope.connection.getMinimumBalanceForRentExemption(be.span);d.addInstruction({instructions:[vr.createAccount({fromPubkey:l,newAccountPubkey:g.publicKey,lamports:x,space:be.span,programId:a.programId})],signers:[g]});let{publicKey:p,nonce:y}=await _r({programId:a.programId,poolId:g.publicKey}),L=await We({programId:a.programId,poolId:g.publicKey,mint:a.lpMint,type:"lpVault"}),I=[],b=[];for(let _ of a.rewardInfos){_.rewardOpenTime>=_.rewardEndTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",_.rewardOpenTime.toString()),ve[_.rewardType]||this.logAndCreateError("rewardType error",_.rewardType),_.rewardPerSecond<=0&&this.logAndCreateError("rewardPerSecond error",_.rewardPerSecond.toString()),I.push(Kr(_));let{rewardPubKey:q,newInstruction:re}=await this._getUserRewardInfo({rewardInfo:_,payer:l});re&&d.addInstruction(re),q||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let Se=_.rewardMint.equals(v)?new M(W.mint):_.rewardMint;b.push({rewardMint:Se,rewardVault:await We({programId:a.programId,poolId:g.publicKey,mint:Se,type:"rewardVault"}),userRewardToken:q})}let R=await this.scope.account.getCreatedTokenAccount({mint:a.lockInfo.lockMint});R||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let C=Fr({farmKeyPair:g,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:L,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:R,programId:a.programId,rewardInfo:b,rewardInfoConfig:I,nonce:y});return await d.addInstruction({instructions:[C]}).build()}async restartReward({farmId:r,payer:n,newRewardInfo:o}){let i=this.getFarm(r);i.version!==6&&this.logAndCreateError("invalid farm version",i.version);let s={id:new M(i.id),rewardInfos:i.rewardInfos,lpVault:new M(i.lpVault),programId:new M(i.programId)};o.rewardOpenTime>=o.rewardEndTime&&this.logAndCreateError("start time error","newRewardInfo",o);let u=n||this.scope.ownerPubKey,a=o.rewardMint.equals(v)?new M(W.mint):o.rewardMint,d=s.rewardInfos.find(I=>new M(I.rewardMint).equals(a));d||this.logAndCreateError("configuration does not exist","rewardMint",a);let l=d.rewardVault?new M(d.rewardVault):v,g=this.createTxBuilder(),{rewardPubKey:x,newInstruction:p}=await this._getUserRewardInfo({rewardInfo:o,payer:u});p&&g.addInstruction(p),x||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let y=Buffer.alloc(at.span);at.encode({instruction:3,rewardReopenTime:h(o.rewardOpenTime),rewardEndTime:h(o.rewardEndTime),rewardPerSecond:h(o.rewardPerSecond)},y);let L=[c({pubkey:xe,isWritable:!1}),c({pubkey:s.id}),c({pubkey:s.lpVault,isWritable:!1}),c({pubkey:l}),c({pubkey:x}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await g.addInstruction({instructions:[new Te({programId:s.programId,keys:L,data:y})]}).build()}async addNewRewardToken(r){let{farmId:n,newRewardInfo:o,payer:i}=r,s=this.getFarm(n);s.version!==6&&this.logAndCreateError("invalid farm version",s.version);let u=i!=null?i:this.scope.ownerPubKey,a=this.createTxBuilder(),d=await We({programId:new M(s.programId),poolId:new M(s.id),mint:o.rewardMint,type:"rewardVault"}),{rewardPubKey:l,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:o,payer:u});g&&a.addInstruction(g),l||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts);let x=o.rewardMint.equals(v)?new M(W.mint):o.rewardMint,p=Buffer.alloc(st.span);st.encode({instruction:4,isSet:new mt(1),rewardPerSecond:h(o.rewardPerSecond),rewardOpenTime:h(o.rewardOpenTime),rewardEndTime:h(o.rewardEndTime)},p);let y=[...Ne,c({pubkey:new M(s.id)}),c({pubkey:new M(s.authority),isWritable:!1}),c({pubkey:x,isWritable:!1}),c({pubkey:d}),c({pubkey:l}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await a.addInstruction({instructions:[new Te({programId:new M(s.programId),keys:y,data:p})]}).build()}async _prepareFarmAccounts(r){let n=this.createTxBuilder(),{farmInfo:o}=r,{pubKey:i,newInstructions:s}=await this.scope.account.checkOrCreateAta({mint:o.lpMint});n.addInstruction(s);let u=await Promise.all(o.rewardInfos.map(async({rewardMint:l})=>{let{pubKey:g,newInstructions:x}=await this.scope.account.checkOrCreateAta({mint:l,autoUnwrapWSOLToSOL:!0});return n.addInstruction(x),g})),a=await ct({programId:new M(o.programId),poolId:new M(o.id),owner:this.scope.ownerPubKey});if(!o.ledger&&o.version<6){let l=await Rr({id:o.id,programId:o.programId,version:o.version,ledger:a,owner:this.scope.ownerPubKey});n.addInstruction({instructions:[l]})}let d=[c({pubkey:o.id}),c({pubkey:o.authority,isWritable:!1}),c({pubkey:a}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:i}),c({pubkey:new M(o.jsonInfo.lpVault)}),c({pubkey:u[0]}),c({pubkey:o.rewardInfos[0].rewardVault}),c({pubkey:lo,isWritable:!1}),c({pubkey:xe,isWritable:!1})];return{txBuilder:n,lpTokenAccount:i,rewardTokenAccountsPublicKeys:u,ledgerAddress:a,lowVersionKeys:d}}async deposit(r){this.scope.checkOwner();let{farmId:n,amount:o}=r,i=this.getParsedFarm(n),s=i.lpMint,{version:u,rewardInfos:a}=i;ut(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:d,ledgerAddress:l,lpTokenAccount:g,lowVersionKeys:x,rewardTokenAccountsPublicKeys:p}=await this._prepareFarmAccounts({mint:s,farmInfo:i}),y=Ar({version:u,rewardInfos:a,rewardTokenAccountsPublicKeys:p});y&&this.logAndCreateError(y);let L=Buffer.alloc(we.span);we.encode({instruction:Lr(u),amount:h(o)},L);let I=u===6?[c({pubkey:xe,isWritable:!1}),c({pubkey:vr.programId,isWritable:!1}),c({pubkey:i.id}),c({pubkey:i.authority,isWritable:!1}),c({pubkey:i.lpVault.mint}),c({pubkey:l}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:g})]:x;if(u!==3)for(let R=1;R<a.length;R++)I.push(c({pubkey:p[R]})),I.push(c({pubkey:a[R].rewardVault}));let b=new Te({programId:i.programId,keys:I,data:L});return await d.addInstruction({instructions:[b]}).build()}async withdraw(r){this.scope.checkOwner();let{farmId:n,amount:o}=r,i=this.getParsedFarm(n),s=i.lpMint,{version:u,rewardInfos:a}=i;ut(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:d,ledgerAddress:l,lpTokenAccount:g,lowVersionKeys:x,rewardTokenAccountsPublicKeys:p}=await this._prepareFarmAccounts({mint:s,farmInfo:i}),y=Buffer.alloc(we.span);we.encode({instruction:Ir(u),amount:h(o)},y);let L=u===6?[c({pubkey:xe,isWritable:!1}),c({pubkey:i.id}),c({pubkey:i.authority,isWritable:!1}),c({pubkey:i.lpVault.mint}),c({pubkey:l}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),c({pubkey:g})]:x;if(u!==3)for(let b=1;b<a.length;b++)L.push(c({pubkey:p[b]})),L.push(c({pubkey:a[b].rewardVault}));let I=new Te({programId:i.programId,keys:L,data:y});return await d.addInstruction({instructions:[I]}).build()}async withdrawFarmReward({farmId:r,withdrawMint:n}){var x;this.scope.checkOwner();let o=this.getParsedFarm(r),{version:i}=o;i!==6&&this.logAndCreateError("invalid farm version",o.version);let s=o.rewardInfos.find(p=>p.rewardMint.equals(n.equals(v)?new M(W.mint):n));s||this.logAndCreateError("withdraw mint error","rewardInfos",o);let u=(x=s==null?void 0:s.rewardVault)!=null?x:v,a=this.createTxBuilder(),d;if(this._getUserRewardInfo({payer:this.scope.ownerPubKey,rewardInfo:s}),n.equals(v)){let p=await tt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:dt(s)});d=p.signers[0].publicKey,a.addInstruction(p)}else{let p=await this.scope.account.getCreatedTokenAccount({mint:n});p===null?(d=await this.scope.account.getAssociatedTokenAccount(n),a.addInstruction({instructions:[co(this.scope.ownerPubKey,d,this.scope.ownerPubKey,n)]})):d=p}let l=Buffer.alloc(ot.span);ot.encode({instruction:5},l);let g=[c({pubkey:xe,isWritable:!1}),c({pubkey:o.id}),c({pubkey:o.authority,isWritable:!1}),c({pubkey:o.lpVault.mint,isWritable:!1}),c({pubkey:u}),c({pubkey:d}),c({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await a.addInstruction({instructions:[new Te({programId:o.programId,keys:g,data:l})]}).build()}};export{lt as default};
//# sourceMappingURL=farm.mjs.map