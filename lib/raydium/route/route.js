var It=Object.create;var ne=Object.defineProperty;var Lt=Object.getOwnPropertyDescriptor;var Bt=Object.getOwnPropertyNames,Ue=Object.getOwnPropertySymbols,At=Object.getPrototypeOf,Fe=Object.prototype.hasOwnProperty,_t=Object.prototype.propertyIsEnumerable;var Q=(n,e)=>{var t={};for(var i in n)Fe.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&Ue)for(var i of Ue(n))e.indexOf(i)<0&&_t.call(n,i)&&(t[i]=n[i]);return t};var Nt=(n,e)=>{for(var t in e)ne(n,t,{get:e[t],enumerable:!0})},Ce=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Bt(e))!Fe.call(n,a)&&a!==t&&ne(n,a,{get:()=>e[a],enumerable:!(i=Lt(e,a))||i.enumerable});return n};var T=(n,e,t)=>(t=n!=null?It(At(n)):{},Ce(e||!n||!n.__esModule?ne(t,"default",{value:n,enumerable:!0}):t,n)),Ot=n=>Ce(ne({},"__esModule",{value:!0}),n);var sn={};Nt(sn,{default:()=>le});module.exports=Ot(sn);var Re=require("@solana/web3.js"),K=require("lodash");var k=T(require("bn.js"));var $e=T(require("big.js")),Vt=T(require("bn.js"));var Y=require("lodash"),Ye=T(require("pino")),Ge=T(require("pino-pretty")),Qe={},Wt={},Mt=(0,Ge.default)({colorize:!0,levelFirst:!0,translateTime:"SYS:yyyymmdd HH:MM:ss.l"}),qt=(0,Ye.default)({base:null,level:"silent"},Mt);function d(n){let e=(0,Y.get)(Qe,n);if(!e){let t=(0,Y.get)(Wt,n);e=qt.child({name:n},{level:t}),(0,Y.set)(Qe,n,e)}return e.logWithError=(...t)=>{let i=t.map(a=>typeof a=="object"?JSON.stringify(a):a).join(", ");throw new Error(i)},e}var je=T(require("toformat")),Et=je.default,G=Et;var j=T(require("big.js")),ze=T(require("decimal.js-light"));var re=d("module/fraction"),Pe=G(j.default),z=G(ze.default),Dt={[0]:z.ROUND_DOWN,[1]:z.ROUND_HALF_UP,[2]:z.ROUND_UP},Rt={[0]:j.default.roundDown,[1]:j.default.roundHalfUp,[2]:j.default.roundUp},m=class{constructor(e,t=He){this.numerator=g(e),this.denominator=g(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new m(this.denominator,this.numerator)}add(e){let t=e instanceof m?e:new m(g(e));return this.denominator.eq(t.denominator)?new m(this.numerator.add(t.numerator),this.denominator):new m(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof m?e:new m(g(e));return this.denominator.eq(t.denominator)?new m(this.numerator.sub(t.numerator),this.denominator):new m(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof m?e:new m(g(e));return new m(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof m?e:new m(g(e));return new m(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},i=1){Number.isInteger(e)||re.logWithError(`${e} is not an integer.`),e<=0&&re.logWithError(`${e} is not positive.`),z.set({precision:e+1,rounding:Dt[i]});let a=new z(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return a.toFormat(a.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},i=1){return Number.isInteger(e)||re.logWithError(`${e} is not an integer.`),e<0&&re.logWithError(`${e} is negative.`),Pe.DP=e,Pe.RM=Rt[i]||1,new Pe(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Ln=d("Raydium_amount"),Bn=G($e.default);var Ze=require("@solana/web3.js"),Je={symbol:"SOL",name:"Solana",decimals:9},q={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},_n={isQuantumSOL:!0,isLp:!1,official:!0,mint:new Ze.PublicKey(q.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};var ie=require("@solana/web3.js");var Ke=require("@solana/spl-token"),b=require("@solana/web3.js");function o({pubkey:n,isSigner:e=!1,isWritable:t=!0}){return{pubkey:n,isWritable:t,isSigner:e}}var Ut=[o({pubkey:Ke.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:b.SystemProgram.programId,isWritable:!1}),o({pubkey:b.SYSVAR_RENT_PUBKEY,isWritable:!1})];function we({publicKey:n,transformSol:e}){if(n instanceof b.PublicKey)return e&&n.equals(H)?oe:n;if(e&&n===H.toBase58())return oe;if(typeof n=="string")try{return new b.PublicKey(n)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}var et=new b.PublicKey("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),tt=new b.PublicKey("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Wn=new b.PublicKey("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),nt=new b.PublicKey("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),rt=new b.PublicKey("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),ot=new b.PublicKey("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),it=new b.PublicKey("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),at=new b.PublicKey("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Mn=new b.PublicKey("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),qn=new b.PublicKey("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),st=new b.PublicKey("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),oe=new b.PublicKey("So11111111111111111111111111111111111111112"),H=b.PublicKey.default;var Te=class{constructor({mint:e,decimals:t,symbol:i="UNKNOWN",name:a="UNKNOWN",skipMint:u=!1}){if(e===H.toBase58()||e instanceof ie.PublicKey&&H.equals(e)){this.decimals=q.decimals,this.symbol=q.symbol,this.name=q.name,this.mint=new ie.PublicKey(q.mint);return}this.decimals=t,this.symbol=i,this.name=a,this.mint=u?ie.PublicKey.default:we({publicKey:e})}equals(e){return this===e?!0:this.mint.equals(e.mint)}},N=Te;N.WSOL=new Te(q);var Ie=class{constructor({decimals:e,symbol:t="UNKNOWN",name:i="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=i}equals(e){return this===e}},Se=Ie;Se.SOL=new Ie(Je);var jn=new m(ut);var ae=d("Raydium_bignumber");var ir=new k.default(0),He=new k.default(1),ar=new k.default(2),sr=new k.default(3),ur=new k.default(5),Xe=new k.default(10),ut=new k.default(100),cr=new k.default(1e3),mr=new k.default(1e4),ct=9007199254740991;function g(n){if(n instanceof k.default)return n;if(typeof n=="string"){if(n.match(/^-?[0-9]+$/))return new k.default(n);ae.logWithError(`invalid BigNumberish string: ${n}`)}return typeof n=="number"?(n%1&&ae.logWithError(`BigNumberish number underflow: ${n}`),(n>=ct||n<=-ct)&&ae.logWithError(`BigNumberish number overflow: ${n}`),new k.default(String(n))):typeof n=="bigint"?new k.default(n.toString()):(ae.logWithError(`invalid BigNumberish value: ${n}`),new k.default(0))}function Le(n){return Xe.pow(g(n))}var Qt=d("Raydium_price"),O=class extends m{constructor(t){let{baseToken:i,quoteToken:a,numerator:u,denominator:l}=t;super(u,l);this.baseToken=i,this.quoteToken=a,this.scalar=new m(Le(i.decimals),Le(a.decimals))}get raw(){return new m(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new O({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Qt.logWithError("mul token not equals");let i=super.mul(t);return new O({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:i.denominator,numerator:i.numerator})}toSignificant(t=this.quoteToken.decimals,i,a){return this.adjusted.toSignificant(t,i,a)}toFixed(t=this.quoteToken.decimals,i,a){return this.adjusted.toFixed(t,i,a)}};var en=require("@project-serum/serum"),tn=T(require("bn.js"));var W=require("@solana/web3.js");var Sr=d("Raydium_txTool"),se=class{constructor(e){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:e=[],endInstructions:t=[],signers:i=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...i),this}build(e){let t=new W.Transaction;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,{transaction:t,signers:this.signers,execute:async()=>{var a;let i=await pt(this.connection);if(t.recentBlockhash=i,(a=this.owner)!=null&&a.isKeyPair)return(0,W.sendAndConfirmTransaction)(this.connection,t,this.signers);if(this.signAllTransactions){this.signers.length&&t.partialSign(...this.signers);let u=await this.signAllTransactions([t]);return await this.connection.sendRawTransaction(u[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:i}=e,{transaction:a}=this.build(i),u=t.filter(x=>x.transaction.instructions.length>0),l=[...u.map(x=>x.transaction),a],f=[...u.map(x=>x.signers),this.signers];return{transactions:l,signers:f,execute:async()=>{var L;let x=await pt(this.connection);if((L=this.owner)!=null&&L.isKeyPair)return await Promise.all(l.map(async(h,I)=>(h.recentBlockhash=x,await(0,W.sendAndConfirmTransaction)(this.connection,h,f[I]))));if(this.signAllTransactions){let h=l.map((P,A)=>(P.recentBlockhash=x,f[A].length&&P.partialSign(...f[A]),P)),I=await this.signAllTransactions(h),B=[];for(let P=0;P<I.length;P+=1){let A=await this.connection.sendRawTransaction(I[P].serialize(),{skipPreflight:!0});B.push(A)}return B}throw new Error("please connect wallet first")},extInfo:i||{}}}};async function pt(n){var e,t;try{return((t=await((e=n.getLatestBlockhash)==null?void 0:e.call(n)))==null?void 0:t.blockhash)||(await n.getRecentBlockhash()).blockhash}catch{return(await n.getRecentBlockhash()).blockhash}}async function Be(n,e){let[t,i]=await W.PublicKey.findProgramAddress(n,e);return{publicKey:t,nonce:i}}var Ae=require("@solana/web3.js"),_e=T(require("bn.js"));var Lr=new _e.default(25),Br=new _e.default(1e4),lt="675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8",Ar=new Ae.PublicKey(lt),dt="5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h",_r=new Ae.PublicKey(dt),Nr={[lt]:4,[dt]:5};var Kt=require("@solana/spl-token"),xt=require("@solana/web3.js");var gt=require("@solana/web3.js"),R=T(require("bn.js"));var s=require("@solana/buffer-layout"),Ne=s.Layout,bt=s.Structure;var ft=s.UInt;var yt=s.seq;var Oe=s.blob;var ue=class extends Ne{constructor(t,i,a){super(t,a);this.blob=Oe(t),this.signed=i}decode(t,i=0){let a=new R.default(this.blob.decode(t,i),10,"le");return this.signed?a.fromTwos(this.span*8).clone():a}encode(t,i,a=0){return typeof t=="number"&&(t=new R.default(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),i,a)}};function w(n){return new ft(1,n)}function r(n){return new ue(8,!1,n)}function S(n){return new ue(16,!1,n)}var We=class extends Ne{constructor(t,i,a,u){super(t.span,u);this.layout=t,this.decoder=i,this.encoder=a}decode(t,i){return this.decoder(this.layout.decode(t,i))}encode(t,i,a){return this.layout.encode(this.encoder(t),i,a)}getSpan(t,i){return this.layout.getSpan(t,i)}};function p(n){return new We(Oe(32),e=>new gt.PublicKey(e),e=>e.toBuffer(),n)}var Me=class extends bt{decode(e,t){return super.decode(e,t)}};function y(n,e,t){return new Me(n,e,t)}function $(n,e,t){let i,a=typeof e=="number"?e:(0,R.isBN)(e)?e.toNumber():new Proxy(e,{get(u,l){if(!i){let f=Reflect.get(u,"count");i=(0,R.isBN)(f)?f.toNumber():f,Reflect.set(u,"count",i)}return Reflect.get(u,l)},set(u,l,f){return l==="count"&&(i=f),Reflect.set(u,l,f)}});return yt(n,a,t)}var Yt=y([w("instruction"),r("amountIn"),r("minAmountOut")]),Gt=y([w("instruction"),r("maxAmountIn"),r("amountOut")]),jt=y([w("instruction"),w("nonce")]),zt=y([w("instruction"),w("nonce"),r("startTime")]),Ht=y([r("status"),r("nonce"),r("maxOrder"),r("depth"),r("baseDecimal"),r("quoteDecimal"),r("state"),r("resetFlag"),r("minSize"),r("volMaxCutRatio"),r("amountWaveRatio"),r("baseLotSize"),r("quoteLotSize"),r("minPriceMultiplier"),r("maxPriceMultiplier"),r("systemDecimalValue"),r("minSeparateNumerator"),r("minSeparateDenominator"),r("tradeFeeNumerator"),r("tradeFeeDenominator"),r("pnlNumerator"),r("pnlDenominator"),r("swapFeeNumerator"),r("swapFeeDenominator"),r("baseNeedTakePnl"),r("quoteNeedTakePnl"),r("quoteTotalPnl"),r("baseTotalPnl"),S("quoteTotalDeposited"),S("baseTotalDeposited"),S("swapBaseInAmount"),S("swapQuoteOutAmount"),r("swapBase2QuoteFee"),S("swapQuoteInAmount"),S("swapBaseOutAmount"),r("swapQuote2BaseFee"),p("baseVault"),p("quoteVault"),p("baseMint"),p("quoteMint"),p("lpMint"),p("openOrders"),p("marketId"),p("marketProgramId"),p("targetOrders"),p("withdrawQueue"),p("lpVault"),p("owner"),r("lpReserve"),$(r(),3,"padding")]),Gr=y([r("accountType"),r("status"),r("nonce"),r("maxOrder"),r("depth"),r("baseDecimal"),r("quoteDecimal"),r("state"),r("resetFlag"),r("minSize"),r("volMaxCutRatio"),r("amountWaveRatio"),r("baseLotSize"),r("quoteLotSize"),r("minPriceMultiplier"),r("maxPriceMultiplier"),r("systemDecimalsValue"),r("abortTradeFactor"),r("priceTickMultiplier"),r("priceTick"),r("minSeparateNumerator"),r("minSeparateDenominator"),r("tradeFeeNumerator"),r("tradeFeeDenominator"),r("pnlNumerator"),r("pnlDenominator"),r("swapFeeNumerator"),r("swapFeeDenominator"),r("baseNeedTakePnl"),r("quoteNeedTakePnl"),r("quoteTotalPnl"),r("baseTotalPnl"),r("poolOpenTime"),r("punishPcAmount"),r("punishCoinAmount"),r("orderbookToInitTime"),S("swapBaseInAmount"),S("swapQuoteOutAmount"),S("swapQuoteInAmount"),S("swapBaseOutAmount"),r("swapQuote2BaseFee"),r("swapBase2QuoteFee"),p("baseVault"),p("quoteVault"),p("baseMint"),p("quoteMint"),p("lpMint"),p("modelDataAccount"),p("openOrders"),p("marketId"),p("marketProgramId"),p("targetOrders"),p("owner"),$(r(),64,"padding")]),$t=y([w("instruction"),r("baseAmountIn"),r("quoteAmountIn"),r("fixedSide")]),Xt=y([w("instruction"),r("amountIn")]);var kt=require("@solana/web3.js");var ce=new kt.PublicKey("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Zt=5e4,Jt=y([r("x"),r("y"),r("price")]),$r=y([r("accountType"),r("status"),r("multiplier"),r("validDataCount"),$(Jt,Zt,"DataElement")]);var oo=d("Raydium_liquidity_instruction");var ht=require("@solana/web3.js");var co=d("Raydium_liquidity_serum"),Pt="9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin",mo=new ht.PublicKey(Pt),po={[Pt]:3};var qo=d("Raydium_liquidity_util");function qe(n,e){let{baseMint:t,quoteMint:i}=e;return n.mint.equals(t)||n.mint.equals(i)}function Ee(n){let{status:e,startTime:t}=n,i=e.toNumber();return{[0]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[1]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[2]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[3]:{swap:!1,addLiquidity:!1,removeLiquidity:!0},[4]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[5]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[6]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[7]:{swap:Date.now()/1e3>=t.toNumber(),addLiquidity:!0,removeLiquidity:!0}}[i]||{swap:!1,addLiquidity:!1,removeLiquidity:!1}}var De=(...n)=>n.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),X=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=d(t)}createTxBuilder(e){return this.scope.checkOwner(),new se({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(De(e))}logInfo(...e){this.logger.info(De(e))}logAndCreateError(...e){let t=De(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};var wt=require("@solana/web3.js");var nn="routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS",Z=new wt.PublicKey(nn);var Uo=[nt,et,oe,ot,tt,it,at,rt,st].map(n=>n.toBase58());var J=require("@solana/spl-token"),v=require("@solana/web3.js");var me=y([w("instruction"),r("amountIn"),r("amountOut")]),pe=y([w("instruction")]);var rn=d("Raydium_route_instruction");function Tt(n){let{fixedSide:e}=n;if(e==="in")return[on(n),an(n)];throw rn.logWithError("invalid params","params",n),new Error(`invalid params, params: ${n}`)}function on({fromPoolKeys:n,toPoolKeys:e,userKeys:t,amountIn:i,amountOut:a}){let u=Buffer.alloc(me.span),l;return n.version===4?(me.encode({instruction:0,amountIn:g(i),amountOut:g(a)},u),l=[o({pubkey:v.SystemProgram.programId,isWritable:!1}),o({pubkey:J.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:n.programId,isWritable:!1}),o({pubkey:n.id}),o({pubkey:e.id,isWritable:!1}),o({pubkey:n.authority,isWritable:!1}),o({pubkey:n.openOrders}),o({pubkey:n.baseVault}),o({pubkey:n.quoteVault}),o({pubkey:n.marketProgramId,isWritable:!1}),o({pubkey:n.marketId}),o({pubkey:n.marketBids}),o({pubkey:n.marketAsks}),o({pubkey:n.marketEventQueue}),o({pubkey:n.marketBaseVault}),o({pubkey:n.marketQuoteVault}),o({pubkey:n.marketAuthority,isWritable:!1}),o({pubkey:t.inTokenAccount}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(me.encode({instruction:2,amountIn:g(i),amountOut:g(a)},u),l=[o({pubkey:v.SystemProgram.programId,isWritable:!1}),o({pubkey:J.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:n.programId,isWritable:!1}),o({pubkey:n.id}),o({pubkey:e.id,isWritable:!1}),o({pubkey:n.authority,isWritable:!1}),o({pubkey:n.openOrders}),o({pubkey:n.baseVault}),o({pubkey:n.quoteVault}),o({pubkey:ce,isWritable:!1}),o({pubkey:n.marketProgramId,isWritable:!1}),o({pubkey:n.marketId}),o({pubkey:n.marketBids}),o({pubkey:n.marketAsks}),o({pubkey:n.marketEventQueue}),o({pubkey:n.id}),o({pubkey:n.id}),o({pubkey:n.id}),o({pubkey:t.inTokenAccount}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new v.TransactionInstruction({programId:Z,keys:l,data:u})}function an({fromPoolKeys:n,toPoolKeys:e,userKeys:t}){let i=Buffer.alloc(pe.span),a;return e.version===4?(pe.encode({instruction:1},i),a=[o({pubkey:J.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:e.programId,isWritable:!1}),o({pubkey:n.id,isWritable:!1}),o({pubkey:e.id}),o({pubkey:e.authority,isWritable:!1}),o({pubkey:e.openOrders}),o({pubkey:e.baseVault}),o({pubkey:e.quoteVault}),o({pubkey:e.marketProgramId,isWritable:!1}),o({pubkey:e.marketId}),o({pubkey:e.marketBids}),o({pubkey:e.marketAsks}),o({pubkey:e.marketEventQueue}),o({pubkey:e.marketBaseVault}),o({pubkey:e.marketQuoteVault}),o({pubkey:e.marketAuthority,isWritable:!1}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.outTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(pe.encode({instruction:3},i),a=[o({pubkey:J.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:e.programId,isWritable:!1}),o({pubkey:n.id,isWritable:!1}),o({pubkey:e.id}),o({pubkey:e.authority,isWritable:!1}),o({pubkey:e.openOrders}),o({pubkey:e.baseVault}),o({pubkey:e.quoteVault}),o({pubkey:ce,isWritable:!1}),o({pubkey:e.marketProgramId,isWritable:!1}),o({pubkey:e.marketId}),o({pubkey:e.marketBids}),o({pubkey:e.marketAsks}),o({pubkey:e.marketEventQueue}),o({pubkey:e.id}),o({pubkey:e.id}),o({pubkey:e.id}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.outTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new v.TransactionInstruction({programId:Z,keys:a,data:i})}async function St({programId:n,fromPoolId:e,middleMint:t,owner:i}){let{publicKey:a}=await Be([e.toBuffer(),t.toBuffer(),i.toBuffer()],n);return a}var le=class extends X{constructor(e){super(e)}computeRouteAmountOut({fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:i,toPoolInfo:a,amountIn:u,outputToken:l,slippage:f}){let{swap:x}=Ee(i),{swap:L}=Ee(a);(!x||!L)&&this.logAndCreateError("pools swap not enabled","pools",{fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:i,toPoolInfo:a});let h=u.token,I=l;(!qe(h,e)||!qe(I,t))&&this.logAndCreateError("pools cannot be routed","pools",{fromPoolKeys:e,toPoolKeys:t});let B=[e.baseMint.toBase58(),e.quoteMint.toBase58()],P=[t.baseMint.toBase58(),t.quoteMint.toBase58()],A=[...B,...P],de=[i.baseDecimals,i.quoteDecimals,a.baseDecimals,a.quoteDecimals],[ve,be]=[h.mint.toBase58(),I.mint.toBase58()],_=(0,K.xor)(B,P);(_.length!==2||!_.includes(ve)||!_.includes(be))&&this.logAndCreateError("xor tokens not match","pools",{fromPoolKeys:e,toPoolKeys:t});let V=(0,K.intersection)(B,P);V.length!==1&&this.logAndCreateError("cannot found middle token of two pools","pools",{fromPoolKeys:e,toPoolKeys:t});let E=V[0],U=A.indexOf(E);U===-1&&this.logAndCreateError("cannot found middle token","pools",{fromPoolKeys:e,toPoolKeys:t});let D=de[U],ee=new Re.PublicKey(E),fe=new N({mint:ee,decimals:D});this.logInfo("from pool:",e),this.logInfo("to pool:",t),this.logInfo("intersection mints:",V),this.logInfo("xor mints:",_),this.logInfo("middleMint:",E);let{minAmountOut:ye,priceImpact:ge,fee:ke}=this.scope.liquidity.computeAmountOut({poolKeys:e,poolInfo:i,amountIn:u,outputToken:fe,slippage:f}),{amountOut:te,minAmountOut:xe,priceImpact:he,fee:Ve}=this.scope.liquidity.computeAmountOut({poolKeys:t,poolInfo:a,amountIn:ye,outputToken:l,slippage:f}),M=null,[F,C]=[u.raw,te.raw];return!F.isZero()&&!C.isZero()&&(M=new O({baseToken:h,denominator:F,quoteToken:l,numerator:C}),this.logDebug("executionPrice:",`1 ${h.symbol} \u2248 ${M.toFixed()} ${l.symbol}`),this.logDebug("executionPrice invert:",`1 ${l.symbol} \u2248 ${M.invert().toFixed()} ${h.symbol}`)),{amountOut:te,minAmountOut:xe,executionPrice:M,priceImpact:ge.add(he),fee:[ke,Ve]}}async swapWithRoute(e){let{fromPoolKeys:t,toPoolKeys:i,amountIn:a,amountOut:u,fixedSide:l,config:f}=e;this.logDebug("amountIn:",a,"amountOut:",u),(a.isZero()||u.isZero())&&this.logAndCreateError("amounts must greater than zero","amounts",{amountIn:a.toFixed(),amountOut:u.toFixed()});let{account:x}=this.scope,{bypassAssociatedCheck:L=!1}=f||{},[h,I]=[a.token,u.token],B=await this.scope.account.getCreatedTokenAccount({mint:h.mint,associatedOnly:!1}),P=await this.scope.account.getCreatedTokenAccount({mint:I.mint}),A=[t.baseMint.toBase58(),t.quoteMint.toBase58()],de=[i.baseMint.toBase58(),i.quoteMint.toBase58()],be=(0,K.intersection)(A,de)[0],_=new Re.PublicKey(be),V=await this.scope.account.getCreatedTokenAccount({mint:_}),[E,U]=[a.raw,u.raw],D=this.createTxBuilder(),ee=this.createTxBuilder(),M=await x.handleTokenAccount({side:"in",amount:E,mint:h.mint,tokenAccount:B,bypassAssociatedCheck:L,skipCloseAccount:!0}),{tokenAccount:fe}=M,ye=Q(M,["tokenAccount"]);D.addInstruction(ye);let F=await x.handleTokenAccount({side:"out",amount:0,mint:I.mint,tokenAccount:P,bypassAssociatedCheck:L,skipCloseAccount:!0}),{tokenAccount:ge}=F,ke=Q(F,["tokenAccount"]);D.addInstruction(ke);let C=await x.handleTokenAccount({side:"in",amount:0,mint:_,tokenAccount:V,bypassAssociatedCheck:L,skipCloseAccount:!0}),{tokenAccount:te}=C,xe=Q(C,["tokenAccount"]);D.addInstruction(xe),ee.addInstruction({instructions:Tt({fromPoolKeys:t,toPoolKeys:i,userKeys:{inTokenAccount:fe,outTokenAccount:ge,middleTokenAccount:te,middleStatusAccount:await St({programId:Z,fromPoolId:t.id,middleMint:_,owner:this.scope.ownerPubKey}),owner:this.scope.ownerPubKey},amountIn:E,amountOut:U,fixedSide:l})});let he=D.build();return await ee.buildMultiTx({extraPreBuildData:[he],extInfo:{amountOut:U}})}};0&&(module.exports={});
//# sourceMappingURL=route.js.map