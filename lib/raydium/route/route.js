var It=Object.create;var ne=Object.defineProperty;var Bt=Object.getOwnPropertyDescriptor;var At=Object.getOwnPropertyNames,Ce=Object.getOwnPropertySymbols,_t=Object.getPrototypeOf,Qe=Object.prototype.hasOwnProperty,Nt=Object.prototype.propertyIsEnumerable;var Q=(n,e)=>{var t={};for(var i in n)Qe.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&Ce)for(var i of Ce(n))e.indexOf(i)<0&&Nt.call(n,i)&&(t[i]=n[i]);return t};var Ot=(n,e)=>{for(var t in e)ne(n,t,{get:e[t],enumerable:!0})},Ye=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of At(e))!Qe.call(n,a)&&a!==t&&ne(n,a,{get:()=>e[a],enumerable:!(i=Bt(e,a))||i.enumerable});return n};var T=(n,e,t)=>(t=n!=null?It(_t(n)):{},Ye(e||!n||!n.__esModule?ne(t,"default",{value:n,enumerable:!0}):t,n)),Wt=n=>Ye(ne({},"__esModule",{value:!0}),n);var an={};Ot(an,{default:()=>le});module.exports=Wt(an);var Ve=require("@solana/web3.js"),K=require("lodash");var k=T(require("bn.js"));var Xe=T(require("big.js")),vt=T(require("bn.js"));var Y=require("lodash"),we=T(require("dayjs")),je=T(require("dayjs/plugin/utc"));we.default.extend(je.default);var Pe=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return(0,we.default)().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(i=>typeof i=="object"?JSON.stringify(i):i).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Ge={},Dt={};function d(n){let e=(0,Y.get)(Ge,n);if(!e){let t=(0,Y.get)(Dt,n);e=new Pe({name:n,logLevel:t}),(0,Y.set)(Ge,n,e)}return e}var ze=T(require("toformat")),qt=ze.default,G=qt;var j=T(require("big.js")),He=T(require("decimal.js-light"));var re=d("module/fraction"),Te=G(j.default),z=G(He.default),Et={[0]:z.ROUND_DOWN,[1]:z.ROUND_HALF_UP,[2]:z.ROUND_UP},Mt={[0]:j.default.roundDown,[1]:j.default.roundHalfUp,[2]:j.default.roundUp},m=class{constructor(e,t=$e){this.numerator=g(e),this.denominator=g(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new m(this.denominator,this.numerator)}add(e){let t=e instanceof m?e:new m(g(e));return this.denominator.eq(t.denominator)?new m(this.numerator.add(t.numerator),this.denominator):new m(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof m?e:new m(g(e));return this.denominator.eq(t.denominator)?new m(this.numerator.sub(t.numerator),this.denominator):new m(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof m?e:new m(g(e));return new m(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof m?e:new m(g(e));return new m(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},i=1){Number.isInteger(e)||re.logWithError(`${e} is not an integer.`),e<=0&&re.logWithError(`${e} is not positive.`),z.set({precision:e+1,rounding:Et[i]});let a=new z(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return a.toFormat(a.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},i=1){return Number.isInteger(e)||re.logWithError(`${e} is not an integer.`),e<0&&re.logWithError(`${e} is negative.`),Te.DP=e,Te.RM=Mt[i]||1,new Te(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Tn=d("Raydium_amount"),Sn=G(Xe.default);var Je=require("@solana/web3.js"),Ke={symbol:"SOL",name:"Solana",decimals:9},q={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},In={isQuantumSOL:!0,isLp:!1,official:!0,mint:new Je.PublicKey(q.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};var ie=require("@solana/web3.js");var et=require("@solana/spl-token"),b=require("@solana/web3.js");function o({pubkey:n,isSigner:e=!1,isWritable:t=!0}){return{pubkey:n,isWritable:t,isSigner:e}}var Vt=[o({pubkey:et.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:b.SystemProgram.programId,isWritable:!1}),o({pubkey:b.SYSVAR_RENT_PUBKEY,isWritable:!1})];function Se({publicKey:n,transformSol:e}){if(n instanceof b.PublicKey)return e&&n.equals(H)?oe:n;if(e&&n===H.toBase58())return oe;if(typeof n=="string")try{return new b.PublicKey(n)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}var tt=new b.PublicKey("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),nt=new b.PublicKey("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),_n=new b.PublicKey("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),rt=new b.PublicKey("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),ot=new b.PublicKey("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),it=new b.PublicKey("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),at=new b.PublicKey("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),st=new b.PublicKey("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Nn=new b.PublicKey("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),On=new b.PublicKey("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),ut=new b.PublicKey("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),oe=new b.PublicKey("So11111111111111111111111111111111111111112"),H=b.PublicKey.default;var Le=class{constructor({mint:e,decimals:t,symbol:i="UNKNOWN",name:a="UNKNOWN",skipMint:u=!1}){if(e===H.toBase58()||e instanceof ie.PublicKey&&H.equals(e)){this.decimals=q.decimals,this.symbol=q.symbol,this.name=q.name,this.mint=new ie.PublicKey(q.mint);return}this.decimals=t,this.symbol=i,this.name=a,this.mint=u?ie.PublicKey.default:Se({publicKey:e})}equals(e){return this===e?!0:this.mint.equals(e.mint)}},N=Le;N.WSOL=new Le(q);var Be=class{constructor({decimals:e,symbol:t="UNKNOWN",name:i="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=i}equals(e){return this===e}},Ie=Be;Ie.SOL=new Be(Ke);var Qn=new m(ct);var ae=d("Raydium_bignumber");var nr=new k.default(0),$e=new k.default(1),rr=new k.default(2),or=new k.default(3),ir=new k.default(5),Ze=new k.default(10),ct=new k.default(100),ar=new k.default(1e3),sr=new k.default(1e4),mt=9007199254740991;function g(n){if(n instanceof k.default)return n;if(typeof n=="string"){if(n.match(/^-?[0-9]+$/))return new k.default(n);ae.logWithError(`invalid BigNumberish string: ${n}`)}return typeof n=="number"?(n%1&&ae.logWithError(`BigNumberish number underflow: ${n}`),(n>=mt||n<=-mt)&&ae.logWithError(`BigNumberish number overflow: ${n}`),new k.default(String(n))):typeof n=="bigint"?new k.default(n.toString()):(ae.logWithError(`invalid BigNumberish value: ${n}`),new k.default(0))}function Ae(n){return Ze.pow(g(n))}var Ct=d("Raydium_price"),O=class extends m{constructor(t){let{baseToken:i,quoteToken:a,numerator:u,denominator:l}=t;super(u,l);this.baseToken=i,this.quoteToken=a,this.scalar=new m(Ae(i.decimals),Ae(a.decimals))}get raw(){return new m(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new O({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Ct.logWithError("mul token not equals");let i=super.mul(t);return new O({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:i.denominator,numerator:i.numerator})}toSignificant(t=this.quoteToken.decimals,i,a){return this.adjusted.toSignificant(t,i,a)}toFixed(t=this.quoteToken.decimals,i,a){return this.adjusted.toFixed(t,i,a)}};var Kt=require("@project-serum/serum"),en=T(require("bn.js"));var W=require("@solana/web3.js");var Pr=d("Raydium_txTool"),se=class{constructor(e){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:e=[],endInstructions:t=[],signers:i=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...i),this}build(e){let t=new W.Transaction;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,{transaction:t,signers:this.signers,execute:async()=>{var a;let i=await lt(this.connection);if(t.recentBlockhash=i,(a=this.owner)!=null&&a.isKeyPair)return(0,W.sendAndConfirmTransaction)(this.connection,t,this.signers);if(this.signAllTransactions){this.signers.length&&t.partialSign(...this.signers);let u=await this.signAllTransactions([t]);return await this.connection.sendRawTransaction(u[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:i}=e,{transaction:a}=this.build(i),u=t.filter(x=>x.transaction.instructions.length>0),l=[...u.map(x=>x.transaction),a],f=[...u.map(x=>x.signers),this.signers];return{transactions:l,signers:f,execute:async()=>{var I;let x=await lt(this.connection);if((I=this.owner)!=null&&I.isKeyPair)return await Promise.all(l.map(async(h,L)=>(h.recentBlockhash=x,await(0,W.sendAndConfirmTransaction)(this.connection,h,f[L]))));if(this.signAllTransactions){let h=l.map((P,A)=>(P.recentBlockhash=x,f[A].length&&P.partialSign(...f[A]),P)),L=await this.signAllTransactions(h),B=[];for(let P=0;P<L.length;P+=1){let A=await this.connection.sendRawTransaction(L[P].serialize(),{skipPreflight:!0});B.push(A)}return B}throw new Error("please connect wallet first")},extInfo:i||{}}}};async function lt(n){var e,t;try{return((t=await((e=n.getLatestBlockhash)==null?void 0:e.call(n)))==null?void 0:t.blockhash)||(await n.getRecentBlockhash()).blockhash}catch{return(await n.getRecentBlockhash()).blockhash}}async function _e(n,e){let[t,i]=await W.PublicKey.findProgramAddress(n,e);return{publicKey:t,nonce:i}}var Ne=require("@solana/web3.js"),Oe=T(require("bn.js"));var Tr=new Oe.default(25),Sr=new Oe.default(1e4),dt="675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8",Lr=new Ne.PublicKey(dt),bt="5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h",Ir=new Ne.PublicKey(bt),Br={[dt]:4,[bt]:5};var Jt=require("@solana/spl-token"),ht=require("@solana/web3.js");var kt=require("@solana/web3.js"),R=T(require("bn.js"));var s=require("@solana/buffer-layout"),We=s.Layout,ft=s.Structure;var yt=s.UInt;var gt=s.seq;var De=s.blob;var ue=class extends We{constructor(t,i,a){super(t,a);this.blob=De(t),this.signed=i}decode(t,i=0){let a=new R.default(this.blob.decode(t,i),10,"le");return this.signed?a.fromTwos(this.span*8).clone():a}encode(t,i,a=0){return typeof t=="number"&&(t=new R.default(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),i,a)}};function w(n){return new yt(1,n)}function r(n){return new ue(8,!1,n)}function S(n){return new ue(16,!1,n)}var qe=class extends We{constructor(t,i,a,u){super(t.span,u);this.layout=t,this.decoder=i,this.encoder=a}decode(t,i){return this.decoder(this.layout.decode(t,i))}encode(t,i,a){return this.layout.encode(this.encoder(t),i,a)}getSpan(t,i){return this.layout.getSpan(t,i)}};function p(n){return new qe(De(32),e=>new kt.PublicKey(e),e=>e.toBuffer(),n)}var Ee=class extends ft{decode(e,t){return super.decode(e,t)}};function y(n,e,t){return new Ee(n,e,t)}function $(n,e,t){let i,a=typeof e=="number"?e:(0,R.isBN)(e)?e.toNumber():new Proxy(e,{get(u,l){if(!i){let f=Reflect.get(u,"count");i=(0,R.isBN)(f)?f.toNumber():f,Reflect.set(u,"count",i)}return Reflect.get(u,l)},set(u,l,f){return l==="count"&&(i=f),Reflect.set(u,l,f)}});return gt(n,a,t)}var Qt=y([w("instruction"),r("amountIn"),r("minAmountOut")]),Yt=y([w("instruction"),r("maxAmountIn"),r("amountOut")]),Gt=y([w("instruction"),w("nonce")]),jt=y([w("instruction"),w("nonce"),r("startTime")]),zt=y([r("status"),r("nonce"),r("maxOrder"),r("depth"),r("baseDecimal"),r("quoteDecimal"),r("state"),r("resetFlag"),r("minSize"),r("volMaxCutRatio"),r("amountWaveRatio"),r("baseLotSize"),r("quoteLotSize"),r("minPriceMultiplier"),r("maxPriceMultiplier"),r("systemDecimalValue"),r("minSeparateNumerator"),r("minSeparateDenominator"),r("tradeFeeNumerator"),r("tradeFeeDenominator"),r("pnlNumerator"),r("pnlDenominator"),r("swapFeeNumerator"),r("swapFeeDenominator"),r("baseNeedTakePnl"),r("quoteNeedTakePnl"),r("quoteTotalPnl"),r("baseTotalPnl"),S("quoteTotalDeposited"),S("baseTotalDeposited"),S("swapBaseInAmount"),S("swapQuoteOutAmount"),r("swapBase2QuoteFee"),S("swapQuoteInAmount"),S("swapBaseOutAmount"),r("swapQuote2BaseFee"),p("baseVault"),p("quoteVault"),p("baseMint"),p("quoteMint"),p("lpMint"),p("openOrders"),p("marketId"),p("marketProgramId"),p("targetOrders"),p("withdrawQueue"),p("lpVault"),p("owner"),r("lpReserve"),$(r(),3,"padding")]),Cr=y([r("accountType"),r("status"),r("nonce"),r("maxOrder"),r("depth"),r("baseDecimal"),r("quoteDecimal"),r("state"),r("resetFlag"),r("minSize"),r("volMaxCutRatio"),r("amountWaveRatio"),r("baseLotSize"),r("quoteLotSize"),r("minPriceMultiplier"),r("maxPriceMultiplier"),r("systemDecimalsValue"),r("abortTradeFactor"),r("priceTickMultiplier"),r("priceTick"),r("minSeparateNumerator"),r("minSeparateDenominator"),r("tradeFeeNumerator"),r("tradeFeeDenominator"),r("pnlNumerator"),r("pnlDenominator"),r("swapFeeNumerator"),r("swapFeeDenominator"),r("baseNeedTakePnl"),r("quoteNeedTakePnl"),r("quoteTotalPnl"),r("baseTotalPnl"),r("poolOpenTime"),r("punishPcAmount"),r("punishCoinAmount"),r("orderbookToInitTime"),S("swapBaseInAmount"),S("swapQuoteOutAmount"),S("swapQuoteInAmount"),S("swapBaseOutAmount"),r("swapQuote2BaseFee"),r("swapBase2QuoteFee"),p("baseVault"),p("quoteVault"),p("baseMint"),p("quoteMint"),p("lpMint"),p("modelDataAccount"),p("openOrders"),p("marketId"),p("marketProgramId"),p("targetOrders"),p("owner"),$(r(),64,"padding")]),Ht=y([w("instruction"),r("baseAmountIn"),r("quoteAmountIn"),r("fixedSide")]),$t=y([w("instruction"),r("amountIn")]);var xt=require("@solana/web3.js");var ce=new xt.PublicKey("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Xt=5e4,Zt=y([r("x"),r("y"),r("price")]),jr=y([r("accountType"),r("status"),r("multiplier"),r("validDataCount"),$(Zt,Xt,"DataElement")]);var to=d("Raydium_liquidity_instruction");var Pt=require("@solana/web3.js");var ao=d("Raydium_liquidity_serum"),wt="9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin",so=new Pt.PublicKey(wt),uo={[wt]:3};var Oo=d("Raydium_liquidity_util");function Me(n,e){let{baseMint:t,quoteMint:i}=e;return n.mint.equals(t)||n.mint.equals(i)}function Re(n){let{status:e,startTime:t}=n,i=e.toNumber();return{[0]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[1]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[2]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[3]:{swap:!1,addLiquidity:!1,removeLiquidity:!0},[4]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[5]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[6]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[7]:{swap:Date.now()/1e3>=t.toNumber(),addLiquidity:!0,removeLiquidity:!0}}[i]||{swap:!1,addLiquidity:!1,removeLiquidity:!1}}var ve=(...n)=>n.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),X=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=d(t)}createTxBuilder(e){return this.scope.checkOwner(),new se({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(ve(e))}logInfo(...e){this.logger.info(ve(e))}logAndCreateError(...e){let t=ve(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};var Tt=require("@solana/web3.js");var tn="routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS",Z=new Tt.PublicKey(tn);var vo=[rt,tt,oe,it,nt,at,st,ot,ut].map(n=>n.toBase58());var J=require("@solana/spl-token"),v=require("@solana/web3.js");var me=y([w("instruction"),r("amountIn"),r("amountOut")]),pe=y([w("instruction")]);var nn=d("Raydium_route_instruction");function St(n){let{fixedSide:e}=n;if(e==="in")return[rn(n),on(n)];throw nn.logWithError("invalid params","params",n),new Error(`invalid params, params: ${n}`)}function rn({fromPoolKeys:n,toPoolKeys:e,userKeys:t,amountIn:i,amountOut:a}){let u=Buffer.alloc(me.span),l;return n.version===4?(me.encode({instruction:0,amountIn:g(i),amountOut:g(a)},u),l=[o({pubkey:v.SystemProgram.programId,isWritable:!1}),o({pubkey:J.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:n.programId,isWritable:!1}),o({pubkey:n.id}),o({pubkey:e.id,isWritable:!1}),o({pubkey:n.authority,isWritable:!1}),o({pubkey:n.openOrders}),o({pubkey:n.baseVault}),o({pubkey:n.quoteVault}),o({pubkey:n.marketProgramId,isWritable:!1}),o({pubkey:n.marketId}),o({pubkey:n.marketBids}),o({pubkey:n.marketAsks}),o({pubkey:n.marketEventQueue}),o({pubkey:n.marketBaseVault}),o({pubkey:n.marketQuoteVault}),o({pubkey:n.marketAuthority,isWritable:!1}),o({pubkey:t.inTokenAccount}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(me.encode({instruction:2,amountIn:g(i),amountOut:g(a)},u),l=[o({pubkey:v.SystemProgram.programId,isWritable:!1}),o({pubkey:J.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:n.programId,isWritable:!1}),o({pubkey:n.id}),o({pubkey:e.id,isWritable:!1}),o({pubkey:n.authority,isWritable:!1}),o({pubkey:n.openOrders}),o({pubkey:n.baseVault}),o({pubkey:n.quoteVault}),o({pubkey:ce,isWritable:!1}),o({pubkey:n.marketProgramId,isWritable:!1}),o({pubkey:n.marketId}),o({pubkey:n.marketBids}),o({pubkey:n.marketAsks}),o({pubkey:n.marketEventQueue}),o({pubkey:n.id}),o({pubkey:n.id}),o({pubkey:n.id}),o({pubkey:t.inTokenAccount}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new v.TransactionInstruction({programId:Z,keys:l,data:u})}function on({fromPoolKeys:n,toPoolKeys:e,userKeys:t}){let i=Buffer.alloc(pe.span),a;return e.version===4?(pe.encode({instruction:1},i),a=[o({pubkey:J.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:e.programId,isWritable:!1}),o({pubkey:n.id,isWritable:!1}),o({pubkey:e.id}),o({pubkey:e.authority,isWritable:!1}),o({pubkey:e.openOrders}),o({pubkey:e.baseVault}),o({pubkey:e.quoteVault}),o({pubkey:e.marketProgramId,isWritable:!1}),o({pubkey:e.marketId}),o({pubkey:e.marketBids}),o({pubkey:e.marketAsks}),o({pubkey:e.marketEventQueue}),o({pubkey:e.marketBaseVault}),o({pubkey:e.marketQuoteVault}),o({pubkey:e.marketAuthority,isWritable:!1}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.outTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(pe.encode({instruction:3},i),a=[o({pubkey:J.TOKEN_PROGRAM_ID,isWritable:!1}),o({pubkey:e.programId,isWritable:!1}),o({pubkey:n.id,isWritable:!1}),o({pubkey:e.id}),o({pubkey:e.authority,isWritable:!1}),o({pubkey:e.openOrders}),o({pubkey:e.baseVault}),o({pubkey:e.quoteVault}),o({pubkey:ce,isWritable:!1}),o({pubkey:e.marketProgramId,isWritable:!1}),o({pubkey:e.marketId}),o({pubkey:e.marketBids}),o({pubkey:e.marketAsks}),o({pubkey:e.marketEventQueue}),o({pubkey:e.id}),o({pubkey:e.id}),o({pubkey:e.id}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.outTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new v.TransactionInstruction({programId:Z,keys:a,data:i})}async function Lt({programId:n,fromPoolId:e,middleMint:t,owner:i}){let{publicKey:a}=await _e([e.toBuffer(),t.toBuffer(),i.toBuffer()],n);return a}var le=class extends X{constructor(e){super(e)}computeRouteAmountOut({fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:i,toPoolInfo:a,amountIn:u,outputToken:l,slippage:f}){let{swap:x}=Re(i),{swap:I}=Re(a);(!x||!I)&&this.logAndCreateError("pools swap not enabled","pools",{fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:i,toPoolInfo:a});let h=u.token,L=l;(!Me(h,e)||!Me(L,t))&&this.logAndCreateError("pools cannot be routed","pools",{fromPoolKeys:e,toPoolKeys:t});let B=[e.baseMint.toBase58(),e.quoteMint.toBase58()],P=[t.baseMint.toBase58(),t.quoteMint.toBase58()],A=[...B,...P],de=[i.baseDecimals,i.quoteDecimals,a.baseDecimals,a.quoteDecimals],[Ue,be]=[h.mint.toBase58(),L.mint.toBase58()],_=(0,K.xor)(B,P);(_.length!==2||!_.includes(Ue)||!_.includes(be))&&this.logAndCreateError("xor tokens not match","pools",{fromPoolKeys:e,toPoolKeys:t});let V=(0,K.intersection)(B,P);V.length!==1&&this.logAndCreateError("cannot found middle token of two pools","pools",{fromPoolKeys:e,toPoolKeys:t});let E=V[0],U=A.indexOf(E);U===-1&&this.logAndCreateError("cannot found middle token","pools",{fromPoolKeys:e,toPoolKeys:t});let M=de[U],ee=new Ve.PublicKey(E),fe=new N({mint:ee,decimals:M});this.logInfo("from pool:",e),this.logInfo("to pool:",t),this.logInfo("intersection mints:",V),this.logInfo("xor mints:",_),this.logInfo("middleMint:",E);let{minAmountOut:ye,priceImpact:ge,fee:ke}=this.scope.liquidity.computeAmountOut({poolKeys:e,poolInfo:i,amountIn:u,outputToken:fe,slippage:f}),{amountOut:te,minAmountOut:xe,priceImpact:he,fee:Fe}=this.scope.liquidity.computeAmountOut({poolKeys:t,poolInfo:a,amountIn:ye,outputToken:l,slippage:f}),D=null,[F,C]=[u.raw,te.raw];return!F.isZero()&&!C.isZero()&&(D=new O({baseToken:h,denominator:F,quoteToken:l,numerator:C}),this.logDebug("executionPrice:",`1 ${h.symbol} \u2248 ${D.toFixed()} ${l.symbol}`),this.logDebug("executionPrice invert:",`1 ${l.symbol} \u2248 ${D.invert().toFixed()} ${h.symbol}`)),{amountOut:te,minAmountOut:xe,executionPrice:D,priceImpact:ge.add(he),fee:[ke,Fe]}}async swapWithRoute(e){let{fromPoolKeys:t,toPoolKeys:i,amountIn:a,amountOut:u,fixedSide:l,config:f}=e;this.logDebug("amountIn:",a,"amountOut:",u),(a.isZero()||u.isZero())&&this.logAndCreateError("amounts must greater than zero","amounts",{amountIn:a.toFixed(),amountOut:u.toFixed()});let{account:x}=this.scope,{bypassAssociatedCheck:I=!1}=f||{},[h,L]=[a.token,u.token],B=await this.scope.account.getCreatedTokenAccount({mint:h.mint,associatedOnly:!1}),P=await this.scope.account.getCreatedTokenAccount({mint:L.mint}),A=[t.baseMint.toBase58(),t.quoteMint.toBase58()],de=[i.baseMint.toBase58(),i.quoteMint.toBase58()],be=(0,K.intersection)(A,de)[0],_=new Ve.PublicKey(be),V=await this.scope.account.getCreatedTokenAccount({mint:_}),[E,U]=[a.raw,u.raw],M=this.createTxBuilder(),ee=this.createTxBuilder(),D=await x.handleTokenAccount({side:"in",amount:E,mint:h.mint,tokenAccount:B,bypassAssociatedCheck:I,skipCloseAccount:!0}),{tokenAccount:fe}=D,ye=Q(D,["tokenAccount"]);M.addInstruction(ye);let F=await x.handleTokenAccount({side:"out",amount:0,mint:L.mint,tokenAccount:P,bypassAssociatedCheck:I,skipCloseAccount:!0}),{tokenAccount:ge}=F,ke=Q(F,["tokenAccount"]);M.addInstruction(ke);let C=await x.handleTokenAccount({side:"in",amount:0,mint:_,tokenAccount:V,bypassAssociatedCheck:I,skipCloseAccount:!0}),{tokenAccount:te}=C,xe=Q(C,["tokenAccount"]);M.addInstruction(xe),ee.addInstruction({instructions:St({fromPoolKeys:t,toPoolKeys:i,userKeys:{inTokenAccount:fe,outTokenAccount:ge,middleTokenAccount:te,middleStatusAccount:await Lt({programId:Z,fromPoolId:t.id,middleMint:_,owner:this.scope.ownerPubKey}),owner:this.scope.ownerPubKey},amountIn:E,amountOut:U,fixedSide:l})});let he=M.build();return await ee.buildMultiTx({extraPreBuildData:[he],extInfo:{amountOut:U}})}};0&&(module.exports={});
//# sourceMappingURL=route.js.map