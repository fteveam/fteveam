var Ne=Object.getOwnPropertySymbols;var pt=Object.prototype.hasOwnProperty,lt=Object.prototype.propertyIsEnumerable;var V=(n,e)=>{var t={};for(var i in n)pt.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&Ne)for(var i of Ne(n))e.indexOf(i)<0&&lt.call(n,i)&&(t[i]=n[i]);return t};import{PublicKey as ct}from"@solana/web3.js";import{intersection as mt,xor as on}from"lodash";import x from"bn.js";import It from"big.js";import In from"bn.js";import{get as Oe,set as dt}from"lodash";import bt from"pino";import ft from"pino-pretty";var We={},yt={},gt=ft({colorize:!0,levelFirst:!0,translateTime:"SYS:yyyymmdd HH:MM:ss.l"}),kt=bt({base:null,level:"silent"},gt);function d(n){let e=Oe(We,n);if(!e){let t=Oe(yt,n);e=kt.child({name:n},{level:t}),dt(We,n,e)}return e.logWithError=(...t)=>{let i=t.map(a=>typeof a=="object"?JSON.stringify(a):a).join(", ");throw new Error(i)},e}import xt from"toformat";var ht=xt,U=ht;import $ from"big.js";import Pt from"decimal.js-light";var H=d("module/fraction"),le=U($),F=U(Pt),wt={[0]:F.ROUND_DOWN,[1]:F.ROUND_HALF_UP,[2]:F.ROUND_UP},Tt={[0]:$.roundDown,[1]:$.roundHalfUp,[2]:$.roundUp},m=class{constructor(e,t=Me){this.numerator=y(e),this.denominator=y(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new m(this.denominator,this.numerator)}add(e){let t=e instanceof m?e:new m(y(e));return this.denominator.eq(t.denominator)?new m(this.numerator.add(t.numerator),this.denominator):new m(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof m?e:new m(y(e));return this.denominator.eq(t.denominator)?new m(this.numerator.sub(t.numerator),this.denominator):new m(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof m?e:new m(y(e));return new m(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof m?e:new m(y(e));return new m(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},i=1){Number.isInteger(e)||H.logWithError(`${e} is not an integer.`),e<=0&&H.logWithError(`${e} is not positive.`),F.set({precision:e+1,rounding:wt[i]});let a=new F(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return a.toFormat(a.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},i=1){return Number.isInteger(e)||H.logWithError(`${e} is not an integer.`),e<0&&H.logWithError(`${e} is negative.`),le.DP=e,le.RM=Tt[i]||1,new le(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Mn=d("Raydium_amount"),qn=U(It);import{PublicKey as Lt}from"@solana/web3.js";var Ee={symbol:"SOL",name:"Solana",decimals:9},W={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},Rn={isQuantumSOL:!0,isLp:!1,official:!0,mint:new Lt(W.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};import{PublicKey as be}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Bt}from"@solana/spl-token";import{PublicKey as g,SystemProgram as At,SYSVAR_RENT_PUBKEY as _t}from"@solana/web3.js";function o({pubkey:n,isSigner:e=!1,isWritable:t=!0}){return{pubkey:n,isWritable:t,isSigner:e}}var Nt=[o({pubkey:Bt,isWritable:!1}),o({pubkey:At.programId,isWritable:!1}),o({pubkey:_t,isWritable:!1})];function de({publicKey:n,transformSol:e}){if(n instanceof g)return e&&n.equals(C)?X:n;if(e&&n===C.toBase58())return X;if(typeof n=="string")try{return new g(n)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}var De=new g("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Re=new g("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Cn=new g("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),ve=new g("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),Ve=new g("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Ue=new g("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Fe=new g("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Ce=new g("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Qn=new g("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Yn=new g("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Qe=new g("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),X=new g("So11111111111111111111111111111111111111112"),C=g.default;var fe=class{constructor({mint:e,decimals:t,symbol:i="UNKNOWN",name:a="UNKNOWN",skipMint:s=!1}){if(e===C.toBase58()||e instanceof be&&C.equals(e)){this.decimals=W.decimals,this.symbol=W.symbol,this.name=W.name,this.mint=new be(W.mint);return}this.decimals=t,this.symbol=i,this.name=a,this.mint=s?be.default:de({publicKey:e})}equals(e){return this===e?!0:this.mint.equals(e.mint)}},_=fe;_.WSOL=new fe(W);var ge=class{constructor({decimals:e,symbol:t="UNKNOWN",name:i="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=i}equals(e){return this===e}},ye=ge;ye.SOL=new ge(Ee);var rr=new m(Ye);var Z=d("Raydium_bignumber");var gr=new x(0),Me=new x(1),kr=new x(2),xr=new x(3),hr=new x(5),qe=new x(10),Ye=new x(100),Pr=new x(1e3),wr=new x(1e4),Ge=9007199254740991;function y(n){if(n instanceof x)return n;if(typeof n=="string"){if(n.match(/^-?[0-9]+$/))return new x(n);Z.logWithError(`invalid BigNumberish string: ${n}`)}return typeof n=="number"?(n%1&&Z.logWithError(`BigNumberish number underflow: ${n}`),(n>=Ge||n<=-Ge)&&Z.logWithError(`BigNumberish number overflow: ${n}`),new x(String(n))):typeof n=="bigint"?new x(n.toString()):(Z.logWithError(`invalid BigNumberish value: ${n}`),new x(0))}function ke(n){return qe.pow(y(n))}var Mt=d("Raydium_price"),N=class extends m{constructor(t){let{baseToken:i,quoteToken:a,numerator:s,denominator:l}=t;super(s,l);this.baseToken=i,this.quoteToken=a,this.scalar=new m(ke(i.decimals),ke(a.decimals))}get raw(){return new m(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new N({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Mt.logWithError("mul token not equals");let i=super.mul(t);return new N({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:i.denominator,numerator:i.numerator})}toSignificant(t=this.quoteToken.decimals,i,a){return this.adjusted.toSignificant(t,i,a)}toFixed(t=this.quoteToken.decimals,i,a){return this.adjusted.toFixed(t,i,a)}};import{OpenOrders as vi}from"@project-serum/serum";import Ui from"bn.js";import{PACKET_DATA_SIZE as Wr,PublicKey as qt,sendAndConfirmTransaction as ze,Transaction as Et}from"@solana/web3.js";var vr=d("Raydium_txTool"),J=class{constructor(e){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:e=[],endInstructions:t=[],signers:i=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...i),this}build(e){let t=new Et;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,{transaction:t,signers:this.signers,execute:async()=>{var a;let i=await He(this.connection);if(t.recentBlockhash=i,(a=this.owner)!=null&&a.isKeyPair)return ze(this.connection,t,this.signers);if(this.signAllTransactions){this.signers.length&&t.partialSign(...this.signers);let s=await this.signAllTransactions([t]);return await this.connection.sendRawTransaction(s[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:i}=e,{transaction:a}=this.build(i),s=t.filter(k=>k.transaction.instructions.length>0),l=[...s.map(k=>k.transaction),a],b=[...s.map(k=>k.signers),this.signers];return{transactions:l,signers:b,execute:async()=>{var I;let k=await He(this.connection);if((I=this.owner)!=null&&I.isKeyPair)return await Promise.all(l.map(async(h,S)=>(h.recentBlockhash=k,await ze(this.connection,h,b[S]))));if(this.signAllTransactions){let h=l.map((P,B)=>(P.recentBlockhash=k,b[B].length&&P.partialSign(...b[B]),P)),S=await this.signAllTransactions(h),L=[];for(let P=0;P<S.length;P+=1){let B=await this.connection.sendRawTransaction(S[P].serialize(),{skipPreflight:!0});L.push(B)}return L}throw new Error("please connect wallet first")},extInfo:i||{}}}};async function He(n){var e,t;try{return((t=await((e=n.getLatestBlockhash)==null?void 0:e.call(n)))==null?void 0:t.blockhash)||(await n.getRecentBlockhash()).blockhash}catch{return(await n.getRecentBlockhash()).blockhash}}async function xe(n,e){let[t,i]=await qt.findProgramAddress(n,e);return{publicKey:t,nonce:i}}import{PublicKey as $e}from"@solana/web3.js";import Xe from"bn.js";var Cr=new Xe(25),Qr=new Xe(1e4),Ze="675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8",Yr=new $e(Ze),Je="5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h",Gr=new $e(Je),jr={[Ze]:4,[Je]:5};import{TOKEN_PROGRAM_ID as ai}from"@solana/spl-token";import{SystemProgram as ci,TransactionInstruction as mi}from"@solana/web3.js";import{PublicKey as Ft}from"@solana/web3.js";import nt,{isBN as rt}from"bn.js";import{bits as $r,BitStructure as Xr,blob as Dt,Blob as Zr,cstr as Jr,f32 as Kr,f32be as eo,f64 as to,f64be as no,greedy as ro,Layout as Rt,ns64 as oo,ns64be as io,nu64 as ao,nu64be as so,offset as uo,s16 as co,s16be as mo,s24 as po,s24be as lo,s32 as bo,s32be as fo,s40 as yo,s40be as go,s48 as ko,s48be as xo,s8 as ho,seq as vt,struct as Po,Structure as Vt,u16 as wo,u16be as To,u24 as So,u24be as Io,u32 as Lo,u32be as Bo,u40 as Ao,u40be as _o,u48 as No,u48be as Oo,u8 as Wo,UInt as Ut,union as Mo,Union as qo,unionLayoutDiscriminator as Eo,utf8 as Do}from"@solana/buffer-layout";var he=Rt,Ke=Vt;var et=Ut;var tt=vt;var Pe=Dt;var K=class extends he{constructor(t,i,a){super(t,a);this.blob=Pe(t),this.signed=i}decode(t,i=0){let a=new nt(this.blob.decode(t,i),10,"le");return this.signed?a.fromTwos(this.span*8).clone():a}encode(t,i,a=0){return typeof t=="number"&&(t=new nt(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),i,a)}};function w(n){return new et(1,n)}function r(n){return new K(8,!1,n)}function T(n){return new K(16,!1,n)}var we=class extends he{constructor(t,i,a,s){super(t.span,s);this.layout=t,this.decoder=i,this.encoder=a}decode(t,i){return this.decoder(this.layout.decode(t,i))}encode(t,i,a){return this.layout.encode(this.encoder(t),i,a)}getSpan(t,i){return this.layout.getSpan(t,i)}};function p(n){return new we(Pe(32),e=>new Ft(e),e=>e.toBuffer(),n)}var Te=class extends Ke{decode(e,t){return super.decode(e,t)}};function f(n,e,t){return new Te(n,e,t)}function Q(n,e,t){let i,a=typeof e=="number"?e:rt(e)?e.toNumber():new Proxy(e,{get(s,l){if(!i){let b=Reflect.get(s,"count");i=rt(b)?b.toNumber():b,Reflect.set(s,"count",i)}return Reflect.get(s,l)},set(s,l,b){return l==="count"&&(i=b),Reflect.set(s,l,b)}});return tt(n,a,t)}var Ct=f([w("instruction"),r("amountIn"),r("minAmountOut")]),Qt=f([w("instruction"),r("maxAmountIn"),r("amountOut")]),Yt=f([w("instruction"),w("nonce")]),Gt=f([w("instruction"),w("nonce"),r("startTime")]),jt=f([r("status"),r("nonce"),r("maxOrder"),r("depth"),r("baseDecimal"),r("quoteDecimal"),r("state"),r("resetFlag"),r("minSize"),r("volMaxCutRatio"),r("amountWaveRatio"),r("baseLotSize"),r("quoteLotSize"),r("minPriceMultiplier"),r("maxPriceMultiplier"),r("systemDecimalValue"),r("minSeparateNumerator"),r("minSeparateDenominator"),r("tradeFeeNumerator"),r("tradeFeeDenominator"),r("pnlNumerator"),r("pnlDenominator"),r("swapFeeNumerator"),r("swapFeeDenominator"),r("baseNeedTakePnl"),r("quoteNeedTakePnl"),r("quoteTotalPnl"),r("baseTotalPnl"),T("quoteTotalDeposited"),T("baseTotalDeposited"),T("swapBaseInAmount"),T("swapQuoteOutAmount"),r("swapBase2QuoteFee"),T("swapQuoteInAmount"),T("swapBaseOutAmount"),r("swapQuote2BaseFee"),p("baseVault"),p("quoteVault"),p("baseMint"),p("quoteMint"),p("lpMint"),p("openOrders"),p("marketId"),p("marketProgramId"),p("targetOrders"),p("withdrawQueue"),p("lpVault"),p("owner"),r("lpReserve"),Q(r(),3,"padding")]),Jo=f([r("accountType"),r("status"),r("nonce"),r("maxOrder"),r("depth"),r("baseDecimal"),r("quoteDecimal"),r("state"),r("resetFlag"),r("minSize"),r("volMaxCutRatio"),r("amountWaveRatio"),r("baseLotSize"),r("quoteLotSize"),r("minPriceMultiplier"),r("maxPriceMultiplier"),r("systemDecimalsValue"),r("abortTradeFactor"),r("priceTickMultiplier"),r("priceTick"),r("minSeparateNumerator"),r("minSeparateDenominator"),r("tradeFeeNumerator"),r("tradeFeeDenominator"),r("pnlNumerator"),r("pnlDenominator"),r("swapFeeNumerator"),r("swapFeeDenominator"),r("baseNeedTakePnl"),r("quoteNeedTakePnl"),r("quoteTotalPnl"),r("baseTotalPnl"),r("poolOpenTime"),r("punishPcAmount"),r("punishCoinAmount"),r("orderbookToInitTime"),T("swapBaseInAmount"),T("swapQuoteOutAmount"),T("swapQuoteInAmount"),T("swapBaseOutAmount"),r("swapQuote2BaseFee"),r("swapBase2QuoteFee"),p("baseVault"),p("quoteVault"),p("baseMint"),p("quoteMint"),p("lpMint"),p("modelDataAccount"),p("openOrders"),p("marketId"),p("marketProgramId"),p("targetOrders"),p("owner"),Q(r(),64,"padding")]),zt=f([w("instruction"),r("baseAmountIn"),r("quoteAmountIn"),r("fixedSide")]),Ht=f([w("instruction"),r("amountIn")]);import{PublicKey as $t}from"@solana/web3.js";var ee=new $t("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Xt=5e4,Zt=f([r("x"),r("y"),r("price")]),ri=f([r("accountType"),r("status"),r("multiplier"),r("validDataCount"),Q(Zt,Xt,"DataElement")]);var gi=d("Raydium_liquidity_instruction");import{PublicKey as Jt}from"@solana/web3.js";var Ti=d("Raydium_liquidity_serum"),ot="9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin",Si=new Jt(ot),Ii={[ot]:3};var Zi=d("Raydium_liquidity_util");function Se(n,e){let{baseMint:t,quoteMint:i}=e;return n.mint.equals(t)||n.mint.equals(i)}function Ie(n){let{status:e,startTime:t}=n,i=e.toNumber();return{[0]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[1]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[2]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[3]:{swap:!1,addLiquidity:!1,removeLiquidity:!0},[4]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[5]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[6]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[7]:{swap:Date.now()/1e3>=t.toNumber(),addLiquidity:!0,removeLiquidity:!0}}[i]||{swap:!1,addLiquidity:!1,removeLiquidity:!1}}var Le=(...n)=>n.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Y=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=d(t)}createTxBuilder(e){return this.scope.checkOwner(),new J({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Le(e))}logInfo(...e){this.logger.info(Le(e))}logAndCreateError(...e){let t=Le(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as Kt}from"@solana/web3.js";var en="routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS",G=new Kt(en);var oa=[ve,De,X,Ue,Re,Fe,Ce,Ve,Qe].map(n=>n.toBase58());import{TOKEN_PROGRAM_ID as re}from"@solana/spl-token";import{SystemProgram as it,TransactionInstruction as at}from"@solana/web3.js";var te=f([w("instruction"),r("amountIn"),r("amountOut")]),ne=f([w("instruction")]);var tn=d("Raydium_route_instruction");function st(n){let{fixedSide:e}=n;if(e==="in")return[nn(n),rn(n)];throw tn.logWithError("invalid params","params",n),new Error(`invalid params, params: ${n}`)}function nn({fromPoolKeys:n,toPoolKeys:e,userKeys:t,amountIn:i,amountOut:a}){let s=Buffer.alloc(te.span),l;return n.version===4?(te.encode({instruction:0,amountIn:y(i),amountOut:y(a)},s),l=[o({pubkey:it.programId,isWritable:!1}),o({pubkey:re,isWritable:!1}),o({pubkey:n.programId,isWritable:!1}),o({pubkey:n.id}),o({pubkey:e.id,isWritable:!1}),o({pubkey:n.authority,isWritable:!1}),o({pubkey:n.openOrders}),o({pubkey:n.baseVault}),o({pubkey:n.quoteVault}),o({pubkey:n.marketProgramId,isWritable:!1}),o({pubkey:n.marketId}),o({pubkey:n.marketBids}),o({pubkey:n.marketAsks}),o({pubkey:n.marketEventQueue}),o({pubkey:n.marketBaseVault}),o({pubkey:n.marketQuoteVault}),o({pubkey:n.marketAuthority,isWritable:!1}),o({pubkey:t.inTokenAccount}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(te.encode({instruction:2,amountIn:y(i),amountOut:y(a)},s),l=[o({pubkey:it.programId,isWritable:!1}),o({pubkey:re,isWritable:!1}),o({pubkey:n.programId,isWritable:!1}),o({pubkey:n.id}),o({pubkey:e.id,isWritable:!1}),o({pubkey:n.authority,isWritable:!1}),o({pubkey:n.openOrders}),o({pubkey:n.baseVault}),o({pubkey:n.quoteVault}),o({pubkey:ee,isWritable:!1}),o({pubkey:n.marketProgramId,isWritable:!1}),o({pubkey:n.marketId}),o({pubkey:n.marketBids}),o({pubkey:n.marketAsks}),o({pubkey:n.marketEventQueue}),o({pubkey:n.id}),o({pubkey:n.id}),o({pubkey:n.id}),o({pubkey:t.inTokenAccount}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new at({programId:G,keys:l,data:s})}function rn({fromPoolKeys:n,toPoolKeys:e,userKeys:t}){let i=Buffer.alloc(ne.span),a;return e.version===4?(ne.encode({instruction:1},i),a=[o({pubkey:re,isWritable:!1}),o({pubkey:e.programId,isWritable:!1}),o({pubkey:n.id,isWritable:!1}),o({pubkey:e.id}),o({pubkey:e.authority,isWritable:!1}),o({pubkey:e.openOrders}),o({pubkey:e.baseVault}),o({pubkey:e.quoteVault}),o({pubkey:e.marketProgramId,isWritable:!1}),o({pubkey:e.marketId}),o({pubkey:e.marketBids}),o({pubkey:e.marketAsks}),o({pubkey:e.marketEventQueue}),o({pubkey:e.marketBaseVault}),o({pubkey:e.marketQuoteVault}),o({pubkey:e.marketAuthority,isWritable:!1}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.outTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(ne.encode({instruction:3},i),a=[o({pubkey:re,isWritable:!1}),o({pubkey:e.programId,isWritable:!1}),o({pubkey:n.id,isWritable:!1}),o({pubkey:e.id}),o({pubkey:e.authority,isWritable:!1}),o({pubkey:e.openOrders}),o({pubkey:e.baseVault}),o({pubkey:e.quoteVault}),o({pubkey:ee,isWritable:!1}),o({pubkey:e.marketProgramId,isWritable:!1}),o({pubkey:e.marketId}),o({pubkey:e.marketBids}),o({pubkey:e.marketAsks}),o({pubkey:e.marketEventQueue}),o({pubkey:e.id}),o({pubkey:e.id}),o({pubkey:e.id}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.outTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new at({programId:G,keys:a,data:i})}async function ut({programId:n,fromPoolId:e,middleMint:t,owner:i}){let{publicKey:a}=await xe([e.toBuffer(),t.toBuffer(),i.toBuffer()],n);return a}var Be=class extends Y{constructor(e){super(e)}computeRouteAmountOut({fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:i,toPoolInfo:a,amountIn:s,outputToken:l,slippage:b}){let{swap:k}=Ie(i),{swap:I}=Ie(a);(!k||!I)&&this.logAndCreateError("pools swap not enabled","pools",{fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:i,toPoolInfo:a});let h=s.token,S=l;(!Se(h,e)||!Se(S,t))&&this.logAndCreateError("pools cannot be routed","pools",{fromPoolKeys:e,toPoolKeys:t});let L=[e.baseMint.toBase58(),e.quoteMint.toBase58()],P=[t.baseMint.toBase58(),t.quoteMint.toBase58()],B=[...L,...P],oe=[i.baseDecimals,i.quoteDecimals,a.baseDecimals,a.quoteDecimals],[Ae,ie]=[h.mint.toBase58(),S.mint.toBase58()],A=on(L,P);(A.length!==2||!A.includes(Ae)||!A.includes(ie))&&this.logAndCreateError("xor tokens not match","pools",{fromPoolKeys:e,toPoolKeys:t});let E=mt(L,P);E.length!==1&&this.logAndCreateError("cannot found middle token of two pools","pools",{fromPoolKeys:e,toPoolKeys:t});let M=E[0],D=B.indexOf(M);D===-1&&this.logAndCreateError("cannot found middle token","pools",{fromPoolKeys:e,toPoolKeys:t});let q=oe[D],j=new ct(M),ae=new _({mint:j,decimals:q});this.logInfo("from pool:",e),this.logInfo("to pool:",t),this.logInfo("intersection mints:",E),this.logInfo("xor mints:",A),this.logInfo("middleMint:",M);let{minAmountOut:se,priceImpact:ue,fee:ce}=this.scope.liquidity.computeAmountOut({poolKeys:e,poolInfo:i,amountIn:s,outputToken:ae,slippage:b}),{amountOut:z,minAmountOut:me,priceImpact:pe,fee:_e}=this.scope.liquidity.computeAmountOut({poolKeys:t,poolInfo:a,amountIn:se,outputToken:l,slippage:b}),O=null,[R,v]=[s.raw,z.raw];return!R.isZero()&&!v.isZero()&&(O=new N({baseToken:h,denominator:R,quoteToken:l,numerator:v}),this.logDebug("executionPrice:",`1 ${h.symbol} \u2248 ${O.toFixed()} ${l.symbol}`),this.logDebug("executionPrice invert:",`1 ${l.symbol} \u2248 ${O.invert().toFixed()} ${h.symbol}`)),{amountOut:z,minAmountOut:me,executionPrice:O,priceImpact:ue.add(pe),fee:[ce,_e]}}async swapWithRoute(e){let{fromPoolKeys:t,toPoolKeys:i,amountIn:a,amountOut:s,fixedSide:l,config:b}=e;this.logDebug("amountIn:",a,"amountOut:",s),(a.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amounts",{amountIn:a.toFixed(),amountOut:s.toFixed()});let{account:k}=this.scope,{bypassAssociatedCheck:I=!1}=b||{},[h,S]=[a.token,s.token],L=await this.scope.account.getCreatedTokenAccount({mint:h.mint,associatedOnly:!1}),P=await this.scope.account.getCreatedTokenAccount({mint:S.mint}),B=[t.baseMint.toBase58(),t.quoteMint.toBase58()],oe=[i.baseMint.toBase58(),i.quoteMint.toBase58()],ie=mt(B,oe)[0],A=new ct(ie),E=await this.scope.account.getCreatedTokenAccount({mint:A}),[M,D]=[a.raw,s.raw],q=this.createTxBuilder(),j=this.createTxBuilder(),O=await k.handleTokenAccount({side:"in",amount:M,mint:h.mint,tokenAccount:L,bypassAssociatedCheck:I,skipCloseAccount:!0}),{tokenAccount:ae}=O,se=V(O,["tokenAccount"]);q.addInstruction(se);let R=await k.handleTokenAccount({side:"out",amount:0,mint:S.mint,tokenAccount:P,bypassAssociatedCheck:I,skipCloseAccount:!0}),{tokenAccount:ue}=R,ce=V(R,["tokenAccount"]);q.addInstruction(ce);let v=await k.handleTokenAccount({side:"in",amount:0,mint:A,tokenAccount:E,bypassAssociatedCheck:I,skipCloseAccount:!0}),{tokenAccount:z}=v,me=V(v,["tokenAccount"]);q.addInstruction(me),j.addInstruction({instructions:st({fromPoolKeys:t,toPoolKeys:i,userKeys:{inTokenAccount:ae,outTokenAccount:ue,middleTokenAccount:z,middleStatusAccount:await ut({programId:G,fromPoolId:t.id,middleMint:A,owner:this.scope.ownerPubKey}),owner:this.scope.ownerPubKey},amountIn:M,amountOut:D,fixedSide:l})});let pe=q.build();return await j.buildMultiTx({extraPreBuildData:[pe],extInfo:{amountOut:D}})}};export{Be as default};
//# sourceMappingURL=route.mjs.map