var Oe=Object.getOwnPropertySymbols;var dt=Object.prototype.hasOwnProperty,bt=Object.prototype.propertyIsEnumerable;var V=(n,e)=>{var t={};for(var i in n)dt.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&Oe)for(var i of Oe(n))e.indexOf(i)<0&&bt.call(n,i)&&(t[i]=n[i]);return t};import{PublicKey as pt}from"@solana/web3.js";import{intersection as lt,xor as rn}from"lodash";import x from"bn.js";import St from"big.js";import wn from"bn.js";import{get as We,set as ft}from"lodash";import qe from"dayjs";import yt from"dayjs/plugin/utc";qe.extend(yt);var le=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:3,this.name=e.name}set level(e){this.logLevel=e}get time(){return qe().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(i=>typeof i=="object"?JSON.stringify(i):i).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},De={},gt={};function d(n){let e=We(De,n);if(!e){let t=We(gt,n);e=new le({name:n,logLevel:t}),ft(De,n,e)}return e}import kt from"toformat";var xt=kt,U=xt;import $ from"big.js";import ht from"decimal.js-light";var H=d("module/fraction"),de=U($),F=U(ht),Pt={[0]:F.ROUND_DOWN,[1]:F.ROUND_HALF_UP,[2]:F.ROUND_UP},wt={[0]:$.roundDown,[1]:$.roundHalfUp,[2]:$.roundUp},m=class{constructor(e,t=Me){this.numerator=y(e),this.denominator=y(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new m(this.denominator,this.numerator)}add(e){let t=e instanceof m?e:new m(y(e));return this.denominator.eq(t.denominator)?new m(this.numerator.add(t.numerator),this.denominator):new m(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof m?e:new m(y(e));return this.denominator.eq(t.denominator)?new m(this.numerator.sub(t.numerator),this.denominator):new m(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof m?e:new m(y(e));return new m(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof m?e:new m(y(e));return new m(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},i=1){Number.isInteger(e)||H.logWithError(`${e} is not an integer.`),e<=0&&H.logWithError(`${e} is not positive.`),F.set({precision:e+1,rounding:Pt[i]});let a=new F(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return a.toFormat(a.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},i=1){return Number.isInteger(e)||H.logWithError(`${e} is not an integer.`),e<0&&H.logWithError(`${e} is negative.`),de.DP=e,de.RM=wt[i]||1,new de(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Nn=d("Raydium_amount"),On=U(St);import{PublicKey as Lt}from"@solana/web3.js";var Re={symbol:"SOL",name:"Solana",decimals:9},W={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},qn={isQuantumSOL:!0,isLp:!1,official:!0,mint:new Lt(W.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};import{PublicKey as fe}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as It}from"@solana/spl-token";import{PublicKey as g,SystemProgram as Bt,SYSVAR_RENT_PUBKEY as At}from"@solana/web3.js";function o({pubkey:n,isSigner:e=!1,isWritable:t=!0}){return{pubkey:n,isWritable:t,isSigner:e}}var _t=[o({pubkey:It,isWritable:!1}),o({pubkey:Bt.programId,isWritable:!1}),o({pubkey:At,isWritable:!1})];function be({publicKey:n,transformSol:e}){if(n instanceof g)return e&&n.equals(C)?X:n;if(e&&n===C.toBase58())return X;if(typeof n=="string")try{return new g(n)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}var ve=new g("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Ve=new g("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Vn=new g("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Ue=new g("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),Fe=new g("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Ce=new g("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Qe=new g("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Ye=new g("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Un=new g("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Fn=new g("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Ge=new g("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),X=new g("So11111111111111111111111111111111111111112"),C=g.default;var ye=class{constructor({mint:e,decimals:t,symbol:i="UNKNOWN",name:a="UNKNOWN",skipMint:s=!1}){if(e===C.toBase58()||e instanceof fe&&C.equals(e)){this.decimals=W.decimals,this.symbol=W.symbol,this.name=W.name,this.mint=new fe(W.mint);return}this.decimals=t,this.symbol=i,this.name=a,this.mint=s?fe.default:be({publicKey:e})}equals(e){return this===e?!0:this.mint.equals(e.mint)}},_=ye;_.WSOL=new ye(W);var ke=class{constructor({decimals:e,symbol:t="UNKNOWN",name:i="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=i}equals(e){return this===e}},ge=ke;ge.SOL=new ke(Re);var er=new m(je);var Z=d("Raydium_bignumber");var br=new x(0),Me=new x(1),fr=new x(2),yr=new x(3),gr=new x(5),Ee=new x(10),je=new x(100),kr=new x(1e3),xr=new x(1e4),ze=9007199254740991;function y(n){if(n instanceof x)return n;if(typeof n=="string"){if(n.match(/^-?[0-9]+$/))return new x(n);Z.logWithError(`invalid BigNumberish string: ${n}`)}return typeof n=="number"?(n%1&&Z.logWithError(`BigNumberish number underflow: ${n}`),(n>=ze||n<=-ze)&&Z.logWithError(`BigNumberish number overflow: ${n}`),new x(String(n))):typeof n=="bigint"?new x(n.toString()):(Z.logWithError(`invalid BigNumberish value: ${n}`),new x(0))}function xe(n){return Ee.pow(y(n))}var Wt=d("Raydium_price"),N=class extends m{constructor(t){let{baseToken:i,quoteToken:a,numerator:s,denominator:l}=t;super(s,l);this.baseToken=i,this.quoteToken=a,this.scalar=new m(xe(i.decimals),xe(a.decimals))}get raw(){return new m(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new N({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Wt.logWithError("mul token not equals");let i=super.mul(t);return new N({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:i.denominator,numerator:i.numerator})}toSignificant(t=this.quoteToken.decimals,i,a){return this.adjusted.toSignificant(t,i,a)}toFixed(t=this.quoteToken.decimals,i,a){return this.adjusted.toFixed(t,i,a)}};import{OpenOrders as Mi}from"@project-serum/serum";import Ri from"bn.js";import{PACKET_DATA_SIZE as _r,PublicKey as Dt,sendAndConfirmTransaction as $e,Transaction as qt}from"@solana/web3.js";var Mr=d("Raydium_txTool"),J=class{constructor(e){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:e=[],endInstructions:t=[],signers:i=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...i),this}build(e){let t=new qt;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,{transaction:t,signers:this.signers,execute:async()=>{var a;let i=await Xe(this.connection);if(t.recentBlockhash=i,(a=this.owner)!=null&&a.isKeyPair)return $e(this.connection,t,this.signers);if(this.signAllTransactions){this.signers.length&&t.partialSign(...this.signers);let s=await this.signAllTransactions([t]);return await this.connection.sendRawTransaction(s[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:i}=e,{transaction:a}=this.build(i),s=t.filter(k=>k.transaction.instructions.length>0),l=[...s.map(k=>k.transaction),a],b=[...s.map(k=>k.signers),this.signers];return{transactions:l,signers:b,execute:async()=>{var L;let k=await Xe(this.connection);if((L=this.owner)!=null&&L.isKeyPair)return await Promise.all(l.map(async(h,S)=>(h.recentBlockhash=k,await $e(this.connection,h,b[S]))));if(this.signAllTransactions){let h=l.map((P,B)=>(P.recentBlockhash=k,b[B].length&&P.partialSign(...b[B]),P)),S=await this.signAllTransactions(h),I=[];for(let P=0;P<S.length;P+=1){let B=await this.connection.sendRawTransaction(S[P].serialize(),{skipPreflight:!0});I.push(B)}return I}throw new Error("please connect wallet first")},extInfo:i||{}}}};async function Xe(n){var e,t;try{return((t=await((e=n.getLatestBlockhash)==null?void 0:e.call(n)))==null?void 0:t.blockhash)||(await n.getRecentBlockhash()).blockhash}catch{return(await n.getRecentBlockhash()).blockhash}}async function he(n,e){let[t,i]=await Dt.findProgramAddress(n,e);return{publicKey:t,nonce:i}}import{PublicKey as Ze}from"@solana/web3.js";import Je from"bn.js";var Vr=new Je(25),Ur=new Je(1e4),Ke="675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8",Fr=new Ze(Ke),et="5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h",Cr=new Ze(et),Qr={[Ke]:4,[et]:5};import{TOKEN_PROGRAM_ID as ri}from"@solana/spl-token";import{SystemProgram as ai,TransactionInstruction as si}from"@solana/web3.js";import{PublicKey as Ut}from"@solana/web3.js";import ot,{isBN as it}from"bn.js";import{bits as jr,BitStructure as zr,blob as Mt,Blob as Hr,cstr as $r,f32 as Xr,f32be as Zr,f64 as Jr,f64be as Kr,greedy as eo,Layout as Et,ns64 as to,ns64be as no,nu64 as ro,nu64be as oo,offset as io,s16 as ao,s16be as so,s24 as uo,s24be as co,s32 as mo,s32be as po,s40 as lo,s40be as bo,s48 as fo,s48be as yo,s8 as go,seq as Rt,struct as ko,Structure as vt,u16 as xo,u16be as ho,u24 as Po,u24be as wo,u32 as To,u32be as So,u40 as Lo,u40be as Io,u48 as Bo,u48be as Ao,u8 as _o,UInt as Vt,union as No,Union as Oo,unionLayoutDiscriminator as Wo,utf8 as Do}from"@solana/buffer-layout";var Pe=Et,tt=vt;var nt=Vt;var rt=Rt;var we=Mt;var K=class extends Pe{constructor(t,i,a){super(t,a);this.blob=we(t),this.signed=i}decode(t,i=0){let a=new ot(this.blob.decode(t,i),10,"le");return this.signed?a.fromTwos(this.span*8).clone():a}encode(t,i,a=0){return typeof t=="number"&&(t=new ot(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),i,a)}};function w(n){return new nt(1,n)}function r(n){return new K(8,!1,n)}function T(n){return new K(16,!1,n)}var Te=class extends Pe{constructor(t,i,a,s){super(t.span,s);this.layout=t,this.decoder=i,this.encoder=a}decode(t,i){return this.decoder(this.layout.decode(t,i))}encode(t,i,a){return this.layout.encode(this.encoder(t),i,a)}getSpan(t,i){return this.layout.getSpan(t,i)}};function p(n){return new Te(we(32),e=>new Ut(e),e=>e.toBuffer(),n)}var Se=class extends tt{decode(e,t){return super.decode(e,t)}};function f(n,e,t){return new Se(n,e,t)}function Q(n,e,t){let i,a=typeof e=="number"?e:it(e)?e.toNumber():new Proxy(e,{get(s,l){if(!i){let b=Reflect.get(s,"count");i=it(b)?b.toNumber():b,Reflect.set(s,"count",i)}return Reflect.get(s,l)},set(s,l,b){return l==="count"&&(i=b),Reflect.set(s,l,b)}});return rt(n,a,t)}var Ft=f([w("instruction"),r("amountIn"),r("minAmountOut")]),Ct=f([w("instruction"),r("maxAmountIn"),r("amountOut")]),Qt=f([w("instruction"),w("nonce")]),Yt=f([w("instruction"),w("nonce"),r("startTime")]),Gt=f([r("status"),r("nonce"),r("maxOrder"),r("depth"),r("baseDecimal"),r("quoteDecimal"),r("state"),r("resetFlag"),r("minSize"),r("volMaxCutRatio"),r("amountWaveRatio"),r("baseLotSize"),r("quoteLotSize"),r("minPriceMultiplier"),r("maxPriceMultiplier"),r("systemDecimalValue"),r("minSeparateNumerator"),r("minSeparateDenominator"),r("tradeFeeNumerator"),r("tradeFeeDenominator"),r("pnlNumerator"),r("pnlDenominator"),r("swapFeeNumerator"),r("swapFeeDenominator"),r("baseNeedTakePnl"),r("quoteNeedTakePnl"),r("quoteTotalPnl"),r("baseTotalPnl"),T("quoteTotalDeposited"),T("baseTotalDeposited"),T("swapBaseInAmount"),T("swapQuoteOutAmount"),r("swapBase2QuoteFee"),T("swapQuoteInAmount"),T("swapBaseOutAmount"),r("swapQuote2BaseFee"),p("baseVault"),p("quoteVault"),p("baseMint"),p("quoteMint"),p("lpMint"),p("openOrders"),p("marketId"),p("marketProgramId"),p("targetOrders"),p("withdrawQueue"),p("lpVault"),p("owner"),r("lpReserve"),Q(r(),3,"padding")]),$o=f([r("accountType"),r("status"),r("nonce"),r("maxOrder"),r("depth"),r("baseDecimal"),r("quoteDecimal"),r("state"),r("resetFlag"),r("minSize"),r("volMaxCutRatio"),r("amountWaveRatio"),r("baseLotSize"),r("quoteLotSize"),r("minPriceMultiplier"),r("maxPriceMultiplier"),r("systemDecimalsValue"),r("abortTradeFactor"),r("priceTickMultiplier"),r("priceTick"),r("minSeparateNumerator"),r("minSeparateDenominator"),r("tradeFeeNumerator"),r("tradeFeeDenominator"),r("pnlNumerator"),r("pnlDenominator"),r("swapFeeNumerator"),r("swapFeeDenominator"),r("baseNeedTakePnl"),r("quoteNeedTakePnl"),r("quoteTotalPnl"),r("baseTotalPnl"),r("poolOpenTime"),r("punishPcAmount"),r("punishCoinAmount"),r("orderbookToInitTime"),T("swapBaseInAmount"),T("swapQuoteOutAmount"),T("swapQuoteInAmount"),T("swapBaseOutAmount"),r("swapQuote2BaseFee"),r("swapBase2QuoteFee"),p("baseVault"),p("quoteVault"),p("baseMint"),p("quoteMint"),p("lpMint"),p("modelDataAccount"),p("openOrders"),p("marketId"),p("marketProgramId"),p("targetOrders"),p("owner"),Q(r(),64,"padding")]),jt=f([w("instruction"),r("baseAmountIn"),r("quoteAmountIn"),r("fixedSide")]),zt=f([w("instruction"),r("amountIn")]);import{PublicKey as Ht}from"@solana/web3.js";var ee=new Ht("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),$t=5e4,Xt=f([r("x"),r("y"),r("price")]),ei=f([r("accountType"),r("status"),r("multiplier"),r("validDataCount"),Q(Xt,$t,"DataElement")]);var bi=d("Raydium_liquidity_instruction");import{PublicKey as Zt}from"@solana/web3.js";var hi=d("Raydium_liquidity_serum"),at="9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin",Pi=new Zt(at),wi={[at]:3};var Hi=d("Raydium_liquidity_util");function Le(n,e){let{baseMint:t,quoteMint:i}=e;return n.mint.equals(t)||n.mint.equals(i)}function Ie(n){let{status:e,startTime:t}=n,i=e.toNumber();return{[0]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[1]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[2]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[3]:{swap:!1,addLiquidity:!1,removeLiquidity:!0},[4]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[5]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[6]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[7]:{swap:Date.now()/1e3>=t.toNumber(),addLiquidity:!0,removeLiquidity:!0}}[i]||{swap:!1,addLiquidity:!1,removeLiquidity:!1}}var Be=(...n)=>n.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Y=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=d(t)}createTxBuilder(e){return this.scope.checkOwner(),new J({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Be(e))}logInfo(...e){this.logger.info(Be(e))}logAndCreateError(...e){let t=Be(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as Jt}from"@solana/web3.js";var Kt="routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS",G=new Jt(Kt);var na=[Ue,ve,X,Ce,Ve,Qe,Ye,Fe,Ge].map(n=>n.toBase58());import{TOKEN_PROGRAM_ID as re}from"@solana/spl-token";import{SystemProgram as st,TransactionInstruction as ut}from"@solana/web3.js";var te=f([w("instruction"),r("amountIn"),r("amountOut")]),ne=f([w("instruction")]);var en=d("Raydium_route_instruction");function ct(n){let{fixedSide:e}=n;if(e==="in")return[tn(n),nn(n)];throw en.logWithError("invalid params","params",n),new Error(`invalid params, params: ${n}`)}function tn({fromPoolKeys:n,toPoolKeys:e,userKeys:t,amountIn:i,amountOut:a}){let s=Buffer.alloc(te.span),l;return n.version===4?(te.encode({instruction:0,amountIn:y(i),amountOut:y(a)},s),l=[o({pubkey:st.programId,isWritable:!1}),o({pubkey:re,isWritable:!1}),o({pubkey:n.programId,isWritable:!1}),o({pubkey:n.id}),o({pubkey:e.id,isWritable:!1}),o({pubkey:n.authority,isWritable:!1}),o({pubkey:n.openOrders}),o({pubkey:n.baseVault}),o({pubkey:n.quoteVault}),o({pubkey:n.marketProgramId,isWritable:!1}),o({pubkey:n.marketId}),o({pubkey:n.marketBids}),o({pubkey:n.marketAsks}),o({pubkey:n.marketEventQueue}),o({pubkey:n.marketBaseVault}),o({pubkey:n.marketQuoteVault}),o({pubkey:n.marketAuthority,isWritable:!1}),o({pubkey:t.inTokenAccount}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(te.encode({instruction:2,amountIn:y(i),amountOut:y(a)},s),l=[o({pubkey:st.programId,isWritable:!1}),o({pubkey:re,isWritable:!1}),o({pubkey:n.programId,isWritable:!1}),o({pubkey:n.id}),o({pubkey:e.id,isWritable:!1}),o({pubkey:n.authority,isWritable:!1}),o({pubkey:n.openOrders}),o({pubkey:n.baseVault}),o({pubkey:n.quoteVault}),o({pubkey:ee,isWritable:!1}),o({pubkey:n.marketProgramId,isWritable:!1}),o({pubkey:n.marketId}),o({pubkey:n.marketBids}),o({pubkey:n.marketAsks}),o({pubkey:n.marketEventQueue}),o({pubkey:n.id}),o({pubkey:n.id}),o({pubkey:n.id}),o({pubkey:t.inTokenAccount}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new ut({programId:G,keys:l,data:s})}function nn({fromPoolKeys:n,toPoolKeys:e,userKeys:t}){let i=Buffer.alloc(ne.span),a;return e.version===4?(ne.encode({instruction:1},i),a=[o({pubkey:re,isWritable:!1}),o({pubkey:e.programId,isWritable:!1}),o({pubkey:n.id,isWritable:!1}),o({pubkey:e.id}),o({pubkey:e.authority,isWritable:!1}),o({pubkey:e.openOrders}),o({pubkey:e.baseVault}),o({pubkey:e.quoteVault}),o({pubkey:e.marketProgramId,isWritable:!1}),o({pubkey:e.marketId}),o({pubkey:e.marketBids}),o({pubkey:e.marketAsks}),o({pubkey:e.marketEventQueue}),o({pubkey:e.marketBaseVault}),o({pubkey:e.marketQuoteVault}),o({pubkey:e.marketAuthority,isWritable:!1}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.outTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(ne.encode({instruction:3},i),a=[o({pubkey:re,isWritable:!1}),o({pubkey:e.programId,isWritable:!1}),o({pubkey:n.id,isWritable:!1}),o({pubkey:e.id}),o({pubkey:e.authority,isWritable:!1}),o({pubkey:e.openOrders}),o({pubkey:e.baseVault}),o({pubkey:e.quoteVault}),o({pubkey:ee,isWritable:!1}),o({pubkey:e.marketProgramId,isWritable:!1}),o({pubkey:e.marketId}),o({pubkey:e.marketBids}),o({pubkey:e.marketAsks}),o({pubkey:e.marketEventQueue}),o({pubkey:e.id}),o({pubkey:e.id}),o({pubkey:e.id}),o({pubkey:t.middleTokenAccount}),o({pubkey:t.outTokenAccount}),o({pubkey:t.middleStatusAccount}),o({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new ut({programId:G,keys:a,data:i})}async function mt({programId:n,fromPoolId:e,middleMint:t,owner:i}){let{publicKey:a}=await he([e.toBuffer(),t.toBuffer(),i.toBuffer()],n);return a}var Ae=class extends Y{constructor(e){super(e)}computeRouteAmountOut({fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:i,toPoolInfo:a,amountIn:s,outputToken:l,slippage:b}){let{swap:k}=Ie(i),{swap:L}=Ie(a);(!k||!L)&&this.logAndCreateError("pools swap not enabled","pools",{fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:i,toPoolInfo:a});let h=s.token,S=l;(!Le(h,e)||!Le(S,t))&&this.logAndCreateError("pools cannot be routed","pools",{fromPoolKeys:e,toPoolKeys:t});let I=[e.baseMint.toBase58(),e.quoteMint.toBase58()],P=[t.baseMint.toBase58(),t.quoteMint.toBase58()],B=[...I,...P],oe=[i.baseDecimals,i.quoteDecimals,a.baseDecimals,a.quoteDecimals],[_e,ie]=[h.mint.toBase58(),S.mint.toBase58()],A=rn(I,P);(A.length!==2||!A.includes(_e)||!A.includes(ie))&&this.logAndCreateError("xor tokens not match","pools",{fromPoolKeys:e,toPoolKeys:t});let M=lt(I,P);M.length!==1&&this.logAndCreateError("cannot found middle token of two pools","pools",{fromPoolKeys:e,toPoolKeys:t});let D=M[0],E=B.indexOf(D);E===-1&&this.logAndCreateError("cannot found middle token","pools",{fromPoolKeys:e,toPoolKeys:t});let q=oe[E],j=new pt(D),ae=new _({mint:j,decimals:q});this.logInfo("from pool:",e),this.logInfo("to pool:",t),this.logInfo("intersection mints:",M),this.logInfo("xor mints:",A),this.logInfo("middleMint:",D);let{minAmountOut:se,priceImpact:ue,fee:ce}=this.scope.liquidity.computeAmountOut({poolKeys:e,poolInfo:i,amountIn:s,outputToken:ae,slippage:b}),{amountOut:z,minAmountOut:me,priceImpact:pe,fee:Ne}=this.scope.liquidity.computeAmountOut({poolKeys:t,poolInfo:a,amountIn:se,outputToken:l,slippage:b}),O=null,[R,v]=[s.raw,z.raw];return!R.isZero()&&!v.isZero()&&(O=new N({baseToken:h,denominator:R,quoteToken:l,numerator:v}),this.logDebug("executionPrice:",`1 ${h.symbol} \u2248 ${O.toFixed()} ${l.symbol}`),this.logDebug("executionPrice invert:",`1 ${l.symbol} \u2248 ${O.invert().toFixed()} ${h.symbol}`)),{amountOut:z,minAmountOut:me,executionPrice:O,priceImpact:ue.add(pe),fee:[ce,Ne]}}async swapWithRoute(e){let{fromPoolKeys:t,toPoolKeys:i,amountIn:a,amountOut:s,fixedSide:l,config:b}=e;this.logDebug("amountIn:",a,"amountOut:",s),(a.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amounts",{amountIn:a.toFixed(),amountOut:s.toFixed()});let{account:k}=this.scope,{bypassAssociatedCheck:L=!1}=b||{},[h,S]=[a.token,s.token],I=await this.scope.account.getCreatedTokenAccount({mint:h.mint,associatedOnly:!1}),P=await this.scope.account.getCreatedTokenAccount({mint:S.mint}),B=[t.baseMint.toBase58(),t.quoteMint.toBase58()],oe=[i.baseMint.toBase58(),i.quoteMint.toBase58()],ie=lt(B,oe)[0],A=new pt(ie),M=await this.scope.account.getCreatedTokenAccount({mint:A}),[D,E]=[a.raw,s.raw],q=this.createTxBuilder(),j=this.createTxBuilder(),O=await k.handleTokenAccount({side:"in",amount:D,mint:h.mint,tokenAccount:I,bypassAssociatedCheck:L,skipCloseAccount:!0}),{tokenAccount:ae}=O,se=V(O,["tokenAccount"]);q.addInstruction(se);let R=await k.handleTokenAccount({side:"out",amount:0,mint:S.mint,tokenAccount:P,bypassAssociatedCheck:L,skipCloseAccount:!0}),{tokenAccount:ue}=R,ce=V(R,["tokenAccount"]);q.addInstruction(ce);let v=await k.handleTokenAccount({side:"in",amount:0,mint:A,tokenAccount:M,bypassAssociatedCheck:L,skipCloseAccount:!0}),{tokenAccount:z}=v,me=V(v,["tokenAccount"]);q.addInstruction(me),j.addInstruction({instructions:ct({fromPoolKeys:t,toPoolKeys:i,userKeys:{inTokenAccount:ae,outTokenAccount:ue,middleTokenAccount:z,middleStatusAccount:await mt({programId:G,fromPoolId:t.id,middleMint:A,owner:this.scope.ownerPubKey}),owner:this.scope.ownerPubKey},amountIn:D,amountOut:E,fixedSide:l})});let pe=q.build();return await j.buildMultiTx({extraPreBuildData:[pe],extInfo:{amountOut:E}})}};export{Ae as default};
//# sourceMappingURL=route.mjs.map