var jr=Object.defineProperty,Yr=Object.defineProperties;var Jr=Object.getOwnPropertyDescriptors;var gt=Object.getOwnPropertySymbols;var Vn=Object.prototype.hasOwnProperty,Cn=Object.prototype.propertyIsEnumerable;var Kn=(n,e,t)=>e in n?jr(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,S=(n,e)=>{for(var t in e||(e={}))Vn.call(e,t)&&Kn(n,t,e[t]);if(gt)for(var t of gt(e))Cn.call(e,t)&&Kn(n,t,e[t]);return n},O=(n,e)=>Yr(n,Jr(e));var ee=(n,e)=>{var t={};for(var o in n)Vn.call(n,o)&&e.indexOf(o)<0&&(t[o]=n[o]);if(n!=null&&gt)for(var o of gt(n))e.indexOf(o)<0&&Cn.call(n,o)&&(t[o]=n[o]);return t};import{merge as $a}from"lodash";import Ti from"axios";import{get as Wn,set as Qr}from"lodash";import Gn from"dayjs";import Hr from"dayjs/plugin/utc";Gn.extend(Hr);var Ct=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Gn().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(o=>typeof o=="object"?JSON.stringify(o):o).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Un={},zr={};function M(n){let e=Wn(Un,n);if(!e){let t=Wn(zr,n);e=new Ct({name:n,logLevel:t}),Qr(Un,n,e)}return e}import{PublicKey as pi}from"@solana/web3.js";import fi from"bn.js";import ii from"big.js";import It from"bn.js";import K from"bn.js";var ht=M("Raydium_bignumber");var ae=new K(0),pe=new K(1),es=new K(2),ts=new K(3),ns=new K(5),ye=new K(10),Yn=new K(100),os=new K(1e3),rs=new K(1e4),$n=9007199254740991;function x(n){if(n instanceof K)return n;if(typeof n=="string"){if(n.match(/^-?[0-9]+$/))return new K(n);ht.logWithError(`invalid BigNumberish string: ${n}`)}return typeof n=="number"?(n%1&&ht.logWithError(`BigNumberish number underflow: ${n}`),(n>=$n||n<=-$n)&&ht.logWithError(`BigNumberish number overflow: ${n}`),new K(String(n))):typeof n=="bigint"?new K(n.toString()):(ht.logWithError(`invalid BigNumberish value: ${n}`),new K(0))}function Wt(n){return ye.pow(x(n))}function se(n){var u;if(n===void 0)return{denominator:"1",numerator:"0"};if(n instanceof K)return{numerator:n.toString(),denominator:"1"};if(n instanceof T)return{denominator:n.denominator.toString(),numerator:n.numerator.toString()};let e=String(n),[,t="",o="",r=""]=(u=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?u:[],i="1"+"0".repeat(r.length),a=t+(o==="0"?"":o)+r||"0";return{denominator:i,numerator:a,sign:t,int:o,dec:r}}function Ut(n,e){let t=n.divmod(e);return t.mod.isZero()?t.div:t.div.negative!==0?t.div.isubn(1):t.div.iaddn(1)}function Zr(n){var o;let[,e="",t=""]=(o=n.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?o:[];return`${e}${t}`}function Te(n,e=0){return n instanceof K?n:new K(Zr(Be(n).mul(ye.pow(new K(String(e))))))}function Be(n){if(n instanceof oe)return new T(n.numerator,n.denominator);if(n instanceof Q)return n.adjusted;if(n instanceof F)try{return Be(n.toExact())}catch{return new T(ae)}if(n instanceof T)return n;let e=String(n),t=se(e);return new T(t.numerator,t.denominator)}function wt(n,e){let{numerator:t,denominator:o}=se(n);return new oe(new K(t),new K(o).mul(e!=null&&e.alreadyDecimaled?new K(100):new K(1)))}function $e(n){let{token:e,numberPrice:t,decimalDone:o}=n,r=new G({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),{numerator:i,denominator:a}=se(t),u=o?new K(i).mul(ye.pow(new K(e.decimals))):i,c=new K(a).mul(ye.pow(new K(r.decimals)));return new Q({baseToken:r,denominator:c.toString(),quoteToken:new G(O(S({},e),{skipMint:!0,mint:""})),numerator:u.toString()})}function Jn(n,e){if(n==null||e==null)return;let t=Be(n),o=Be(e);return t.mul(o)}function jn(n){let e=new G({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),t=Te(Jn(n,10**e.decimals));return new F(e,t)}function je(n,e){return jn(!e||!n?0:Jn(n,e))}import Xr from"toformat";var ei=Xr,Ye=ei;import Pt from"big.js";import ni from"decimal.js-light";var kt=M("module/fraction"),Gt=Ye(Pt),Je=Ye(ni),oi={[0]:Je.ROUND_DOWN,[1]:Je.ROUND_HALF_UP,[2]:Je.ROUND_UP},ri={[0]:Pt.roundDown,[1]:Pt.roundHalfUp,[2]:Pt.roundUp},T=class{constructor(e,t=pe){this.numerator=x(e),this.denominator=x(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new T(this.denominator,this.numerator)}add(e){let t=e instanceof T?e:new T(x(e));return this.denominator.eq(t.denominator)?new T(this.numerator.add(t.numerator),this.denominator):new T(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof T?e:new T(x(e));return this.denominator.eq(t.denominator)?new T(this.numerator.sub(t.numerator),this.denominator):new T(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof T?e:new T(x(e));return new T(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof T?e:new T(x(e));return new T(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},o=1){Number.isInteger(e)||kt.logWithError(`${e} is not an integer.`),e<=0&&kt.logWithError(`${e} is not positive.`),Je.set({precision:e+1,rounding:oi[o]});let r=new Je(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return r.toFormat(r.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},o=1){return Number.isInteger(e)||kt.logWithError(`${e} is not an integer.`),e<0&&kt.logWithError(`${e} is negative.`),Gt.DP=e,Gt.RM=ri[o]||1,new Gt(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var ai=M("Raydium_amount"),Qn=Ye(ii);function si(n,e){let t="0",o="0";if(n.includes(".")){let r=n.split(".");r.length===2?([t,o]=r,o=o.padEnd(e,"0")):ai.logWithError(`invalid number string, num: ${n}`)}else t=n;return[t,o.slice(0,e)||o]}var F=class extends T{constructor(t,o,r=!0,i){let a=new It(0),u=ye.pow(new It(t.decimals));if(r)a=x(o);else{let c=new It(0),m=new It(0);if(typeof o=="string"||typeof o=="number"||typeof o=="bigint"){let[d,p]=si(o.toString(),t.decimals);c=x(d),m=x(p)}c=c.mul(u),a=c.add(m)}super(a,u);this.logger=M(i||"Amount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new F(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new F(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,o,r=0){return super.toSignificant(t,o,r)}toFixed(t=this.token.decimals,o,r=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,o,r)}toExact(t={groupSeparator:""}){return Qn.DP=this.token.decimals,new Qn(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as ui}from"@solana/web3.js";var Hn={symbol:"SOL",name:"Solana",decimals:9},Y={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},Qe={isQuantumSOL:!0,isLp:!1,official:!0,mint:new ui(Y.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};import{PublicKey as $t}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ci}from"@solana/spl-token";import{PublicKey as te,SystemProgram as mi,SYSVAR_RENT_PUBKEY as li}from"@solana/web3.js";function s({pubkey:n,isSigner:e=!1,isWritable:t=!0}){return{pubkey:n,isWritable:t,isSigner:e}}var Oe=[s({pubkey:ci,isWritable:!1}),s({pubkey:mi.programId,isWritable:!1}),s({pubkey:li,isWritable:!1})];function V({publicKey:n,transformSol:e}){if(n instanceof te)return e&&n.equals(W)?xe:n;if(e&&n===W.toBase58())return xe;if(typeof n=="string")try{return new te(n)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}function zn(n){try{return new te(n)}catch{return n}}var At=new te("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Zn=new te("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Bs=new te("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Xn=new te("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),eo=new te("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),to=new te("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),no=new te("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),oo=new te("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Os=new te("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Fs=new te("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),ro=new te("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),xe=new te("So11111111111111111111111111111111111111112"),W=te.default;var jt=class{constructor({mint:e,decimals:t,symbol:o="UNKNOWN",name:r="UNKNOWN",skipMint:i=!1}){if(e===W.toBase58()||e instanceof $t&&W.equals(e)){this.decimals=Y.decimals,this.symbol=Y.symbol,this.name=Y.name,this.mint=new $t(Y.mint);return}this.decimals=t,this.symbol=o,this.name=r,this.mint=i?$t.default:V({publicKey:e})}equals(e){return this===e?!0:this.mint.equals(e.mint)}},G=jt;G.WSOL=new jt(Y);var Jt=class{constructor({decimals:e,symbol:t="UNKNOWN",name:o="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=o}equals(e){return this===e}},Yt=Jt;Yt.SOL=new Jt(Hn);var io=new T(Yn),oe=class extends T{toSignificant(e=5,t,o){return this.mul(io).toSignificant(e,t,o)}toFixed(e=2,t,o){return this.mul(io).toFixed(e,t,o)}};var di=M("Raydium_price"),Q=class extends T{constructor(t){let{baseToken:o,quoteToken:r,numerator:i,denominator:a}=t;super(i,a);this.baseToken=o,this.quoteToken=r,this.scalar=new T(Wt(o.decimals),Wt(r.decimals))}get raw(){return new T(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new Q({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&di.logWithError("mul token not equals");let o=super.mul(t);return new Q({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:o.denominator,numerator:o.numerator})}toSignificant(t=this.quoteToken.decimals,o,r){return this.adjusted.toSignificant(t,o,r)}toFixed(t=this.quoteToken.decimals,o,r){return this.adjusted.toFixed(t,o,r)}};var bi=[G,F,pi,T,fi,Q,oe];function yi(n){return typeof n=="object"&&n!==null&&!bi.some(e=>typeof e=="object"&&n instanceof e)}function me(n){return typeof n=="string"?zn(n):Array.isArray(n)?n.map(e=>me(e)):yi(n)?Object.fromEntries(Object.entries(n).map(([e,t])=>[e,me(t)])):n}import{PACKET_DATA_SIZE as gi,PublicKey as uo,sendAndConfirmTransaction as ao,Transaction as Tt}from"@solana/web3.js";var Se=M("Raydium_txTool"),xt=class{constructor(e){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:e=[],endInstructions:t=[],signers:o=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...o),this}build(e){let t=new Tt;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,{transaction:t,signers:this.signers,execute:async()=>{var r;let o=await so(this.connection);if(t.recentBlockhash=o,(r=this.owner)!=null&&r.isKeyPair)return ao(this.connection,t,this.signers);if(this.signAllTransactions){this.signers.length&&t.partialSign(...this.signers);let i=await this.signAllTransactions([t]);return await this.connection.sendRawTransaction(i[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:o}=e,{transaction:r}=this.build(o),i=t.filter(c=>c.transaction.instructions.length>0),a=[...i.map(c=>c.transaction),r],u=[...i.map(c=>c.signers),this.signers];return{transactions:a,signers:u,execute:async()=>{var m;let c=await so(this.connection);if((m=this.owner)!=null&&m.isKeyPair)return await Promise.all(a.map(async(d,p)=>(d.recentBlockhash=c,await ao(this.connection,d,u[p]))));if(this.signAllTransactions){let d=a.map((f,y)=>(f.recentBlockhash=c,u[y].length&&f.partialSign(...u[y]),f)),p=await this.signAllTransactions(d),b=[];for(let f=0;f<p.length;f+=1){let y=await this.connection.sendRawTransaction(p[f].serialize(),{skipPreflight:!0});b.push(y)}return b}throw new Error("please connect wallet first")},extInfo:o||{}}}};async function so(n){var e,t;try{return((t=await((e=n.getLatestBlockhash)==null?void 0:e.call(n)))==null?void 0:t.blockhash)||(await n.getRecentBlockhash()).blockhash}catch{return(await n.getRecentBlockhash()).blockhash}}function hi(n,e){n.length<1&&Se.logWithError(`no instructions provided: ${n.toString()}`),e.length<1&&Se.logWithError(`no signers provided:, ${e.toString()}`);let t=new Tt;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...n);let o=t.compileMessage().serialize();return e.length+e.length*64+o.length}async function co(n,e,t){let o=new uo("RaydiumSimuLateTransaction11111111111111111"),r=[],i=new Tt;i.feePayer=o;for(let c of e)hi([...i.instructions,c],[o])>gi&&(r.push(i),i=new Tt,i.feePayer=o),i.add(c);i.instructions.length>0&&r.push(i);let a=[];try{a=await Promise.all(r.map(c=>n.simulateTransaction(c)))}catch(c){c instanceof Error&&Se.logWithError(`failed to simulate for instructions, RPC_ERROR, ${c.message}`)}let u=[];for(let c of a){let{value:m}=c;if(Se.debug(`simulate result: ${JSON.stringify(c)}`),m.logs){let d=m.logs.filter(p=>p&&p.includes(t));Se.debug(`filteredLog: ${JSON.stringify(u)}`),d.length||Se.logWithError(` "simulate log not match keyword, keyword: ${t}`),u.push(...d)}}return u}function mo(n,e){let t=n.match(/{["\w:,]+}/g);return!t||t.length!==1?Se.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function ge(n,e){let o=new RegExp(`"${e}":(\\d+)`,"g").exec(n);return!o||o.length!==2?Se.logWithError(`simulate log fail to match key", key: ${e}`):o[1]}async function he(n,e){let[t,o]=await uo.findProgramAddress(n,e);return{publicKey:t,nonce:o}}var le=class{constructor(e){this._owner=e}get publicKey(){return le.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return le.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return le.isKeyPair(this._owner)}get isPublicKey(){return le.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!le.isKeyPair(e)}};function lo(n,e=1,t=[]){let o=[...n];if(e<=0)return t;for(;o.length;)t.push(o.splice(0,e));return t}import{PublicKey as wi}from"@solana/web3.js";var Qt=M("Raydium_accountInfo_util");async function ki(n,e,t){let{batchRequest:o,commitment:r}=S({batchRequest:!1},t),i=lo(e,100),a=new Array(i.length).fill([]);if(o){let u=i.map(m=>{let d=n._buildArgs([m.map(p=>p.toBase58())],r,"base64");return{methodName:"getMultipleAccounts",args:d}});a=(await n._rpcBatchRequest(u)).map(m=>(m.error&&Qt.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:b,lamports:f,owner:y,rentEpoch:h}=d;return p.length!==2&&p[1]!=="base64"&&Qt.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:b,lamports:f,owner:new wi(y),rentEpoch:h}}return null})))}else try{a=await Promise.all(i.map(u=>n.getMultipleAccountsInfo(u,r)))}catch(u){u instanceof Error&&Qt.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return a.flat()}async function po(n,e,t){let o=await ki(n,e.map(r=>r.pubkey),t);return e.map((r,i)=>O(S({},r),{accountInfo:o[i]}))}function ue(n){if(n instanceof oe)return new T(n.numerator,n.denominator);if(n instanceof Q)return n.adjusted;if(n instanceof F)try{return ue(n.toExact())}catch{return new T(ae)}if(n instanceof T)return n;let e=String(n),t=se(e);return new T(t.numerator,t.denominator)}function Pi(n,e){if(n==null||e==null)return!1;let t=ue(n),o=ue(e);return t.sub(o).numerator.gt(ae)}function fo(n,e){if(n==null||e==null)return!1;let t=ue(n),o=ue(e);return t.sub(o).numerator.gte(ae)}function Ii(n,e){if(n==null||e==null)return!1;let t=ue(n),o=ue(e);return t.sub(o).numerator.eq(ae)}function Ht(n,e){if(n==null||e==null)return;let t=ue(n),o=ue(e);try{return t.div(o)}catch{return t}}function bo(n,e){if(n==null||e==null)return;let t=ue(n),o=ue(e);return t.sub(o)}function St(n){return n==null?!1:!Ii(n,0)}function yo(n,e){return Pi(e,n)?e:n}var go=n=>typeof n=="number",ho=n=>n?new Date(n):new Date,Ai=n=>ho(n).getTime();function He(n,e,t){let o=go(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(n).getTime()<=o}function Ee(n,e,t){let o=go(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(n).getTime()>o}function zt(n,e){let o=Ai(n)+(e.days?e.days*24*60*60*1e3:0)+(e.hours?e.hours*60*60*1e3:0)+(e.minutes?e.minutes*60*1e3:0)+(e.seconds?e.seconds*1e3:0)+(e.milliseconds?e.milliseconds:0);return ho(o)}var Lt=M("Raydium_Api");var _t=class{constructor({cluster:e,timeout:t}){this.cluster=e,this.api=Ti.create({baseURL:"https://api.raydium.io/v2",timeout:t}),this.api.interceptors.request.use(o=>{let{method:r,baseURL:i,url:a}=o;return Lt.debug(`${r==null?void 0:r.toUpperCase()} ${i}${a}`),o},o=>(Lt.error("Request failed"),Promise.reject(o))),this.api.interceptors.response.use(o=>{let{config:r,data:i,status:a}=o,{method:u,baseURL:c,url:m}=r;return Lt.debug(`${u==null?void 0:u.toUpperCase()} ${c}${m}  ${a}`),i},o=>{let{config:r,response:i={}}=o,{status:a}=i,{method:u,baseURL:c,url:m}=r;return Lt.error(`${u.toUpperCase()} ${c}${m} ${a||o.message}`),Promise.reject(o)})}async getTokens(){return this.api.get("/sdk/token/raydium.mainnet.json")}async getLiquidityPools(){return this.api.get(`/sdk/liquidity/${this.cluster}.json`)}async getPairsInfo(){return this.api.get("https://api.raydium.io/v2/main/pairs")}async getFarmPools(){return this.api.get(`/sdk/farm-v2/${this.cluster}.json`)}async getCoingeckoPrice(e){return this.api.get(`https://api.coingecko.com/api/v3/simple/price?ids=${e.join(",")}&vs_currencies=usd`)}async getRaydiumTokenPrice(){return this.api.get("https://api.raydium.io/v2/main/price")}async getBlockSlotCountForSecond(e){if(!e)return 2;let o=(await this.api.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(r=>r.numSlots);return o.reduce((r,i)=>r+i,0)/o.length/60}};var Rt="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",wo="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{getAssociatedTokenAddress as xo,createAssociatedTokenAccountInstruction as So,TOKEN_PROGRAM_ID as Ui}from"@solana/spl-token";import{PublicKey as Gi}from"@solana/web3.js";var Zt=(...n)=>n.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),re=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=M(t)}createTxBuilder(e){return this.scope.checkOwner(),new xt({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Zt(e))}logInfo(...e){this.logger.info(Zt(e))}logAndCreateError(...e){let t=Zt(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{createInitializeAccountInstruction as Bi,createCloseAccountInstruction as Oi,createTransferInstruction as Fi,TOKEN_PROGRAM_ID as qi}from"@solana/spl-token";import{Keypair as Ni,PublicKey as vi,SystemProgram as Di}from"@solana/web3.js";import Ei from"bn.js";import{PublicKey as Mi}from"@solana/web3.js";import Io,{isBN as Ao}from"bn.js";import{bits as ic,BitStructure as ac,blob as xi,Blob as sc,cstr as uc,f32 as cc,f32be as mc,f64 as lc,f64be as dc,greedy as pc,Layout as Si,ns64 as fc,ns64be as bc,nu64 as yc,nu64be as gc,offset as hc,s16 as wc,s16be as kc,s24 as Pc,s24be as Ic,s32 as Ac,s32be as Tc,s40 as xc,s40be as Sc,s48 as Lc,s48be as _c,s8 as Rc,seq as Li,struct as Mc,Structure as _i,u16 as Bc,u16be as Oc,u24 as Fc,u24be as qc,u32 as Nc,u32be as vc,u40 as Dc,u40be as Ec,u48 as Kc,u48be as Vc,u8 as Cc,UInt as Ri,union as Wc,Union as Uc,unionLayoutDiscriminator as Gc,utf8 as $c}from"@solana/buffer-layout";var Xt=Si,ko=_i;var en=Ri;var Po=Li;var ze=xi;var Mt=class extends Xt{constructor(t,o,r){super(t,r);this.blob=ze(t),this.signed=o}decode(t,o=0){let r=new Io(this.blob.decode(t,o),10,"le");return this.signed?r.fromTwos(this.span*8).clone():r}encode(t,o,r=0){return typeof t=="number"&&(t=new Io(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),o,r)}};function D(n){return new en(1,n)}function Fe(n){return new en(4,n)}function l(n){return new Mt(8,!1,n)}function J(n){return new Mt(16,!1,n)}var tn=class extends Xt{constructor(t,o,r,i){super(t.span,i);this.layout=t,this.decoder=o,this.encoder=r}decode(t,o){return this.decoder(this.layout.decode(t,o))}encode(t,o,r){return this.layout.encode(this.encoder(t),o,r)}getSpan(t,o){return this.layout.getSpan(t,o)}};function w(n){return new tn(ze(32),e=>new Mi(e),e=>e.toBuffer(),n)}var nn=class extends ko{decode(e,t){return super.decode(e,t)}};function R(n,e,t){return new nn(n,e,t)}function H(n,e,t){let o,r=typeof e=="number"?e:Ao(e)?e.toNumber():new Proxy(e,{get(i,a){if(!o){let u=Reflect.get(i,"count");o=Ao(u)?u.toNumber():u,Reflect.set(i,"count",o)}return Reflect.get(i,a)},set(i,a,u){return a==="count"&&(o=u),Reflect.set(i,a,u)}});return Po(n,r,t)}var we=R([w("mint"),w("owner"),l("amount"),Fe("delegateOption"),w("delegate"),D("state"),Fe("isNativeOption"),l("isNative"),l("delegatedAmount"),Fe("closeAuthorityOption"),w("closeAuthority")]);function Ki(n){let{mint:e,tokenAccount:t,owner:o}=n;return Bi(t,e,o)}function qe(n){let{tokenAccount:e,payer:t,multiSigners:o=[],owner:r}=n;return Oi(e,t,r,o)}async function Le(n){let{connection:e,amount:t,commitment:o,payer:r,owner:i,skipCloseAccount:a}=n,u=await e.getMinimumBalanceForRentExemption(we.span,o),c=x(t).add(new Ei(u)),m=Ni.generate();return{signers:[m],instructions:[Di.createAccount({fromPubkey:r,newAccountPubkey:m.publicKey,lamports:c.toNumber(),space:we.span,programId:qi}),Ki({mint:new vi(Y.mint),tokenAccount:m.publicKey,owner:i})],endInstructions:a?[]:[qe({tokenAccount:m.publicKey,payer:r,owner:i})]}}function Ke({source:n,destination:e,owner:t,amount:o,multiSigners:r=[]}){return Fi(n,e,t,x(o).toNumber(),r)}import{PublicKey as Vi}from"@solana/web3.js";import Ci from"bn.js";var Wi=M("Raydium_Util");function To({solAccountResp:n,tokenAccountResp:e}){let t=[],o=[];for(let{pubkey:r,account:i}of e.value){if(i.data.length!==we.span)throw Wi.error("invalid token account layout length","publicKey",r.toBase58()),new Error("invalid token account layout length");let a=we.decode(i.data),{mint:u,amount:c}=a;t.push({publicKey:r,mint:u,amount:c,isNative:!1}),o.push({pubkey:r,accountInfo:a})}return n&&t.push({mint:Vi.default,amount:new Ci(n.lamports),isNative:!0}),{tokenAccounts:t,tokenAccountRawInfos:o}}var Ze=class extends re{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._ataCache=new Map;this._accountListener=[];this._clientOwnedToken=!1;let{tokenAccounts:o,tokenAccountRawInfos:r}=t;this._tokenAccounts=o||[],this._tokenAccountRawInfos=r||[],this._clientOwnedToken=!!(o||r)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:o}){return t&&(this._tokenAccounts=t),o&&(this._tokenAccountRawInfos=o),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(o=>o!==t),this}async getAssociatedTokenAccount(t){this.scope.checkOwner();let o=`${this.scope.ownerPubKey.toBase58()}_${t.toBase58()}`;if(this._ataCache.has(o))return this._ataCache.get(o);let r=await xo(t,this.scope.ownerPubKey,!0);return this._ataCache.set(o,r),r}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let r=S(S({},{}),t),i=await this.scope.connection.getAccountInfo(this.scope.ownerPubKey,r.commitment),a=await this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Ui},r.commitment),{tokenAccounts:u,tokenAccountRawInfos:c}=To({solAccountResp:i,tokenAccountResp:a});return this._tokenAccounts=u,this._tokenAccountRawInfos=c,this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),"confirmed"),{tokenAccounts:u,tokenAccountRawInfos:c}}async getCreatedTokenAccount({mint:t,associatedOnly:o=!0}){await this.fetchWalletTokenAccounts();let r=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,u)=>a.amount.lt(u.amount)?1:-1),i=await this.getAssociatedTokenAccount(t);for(let a of r){let{publicKey:u}=a;if(u)return o&&i.equals(u),u}}async checkOrCreateAta({mint:t,autoUnwrapWSOLToSOL:o}){var u;await this.fetchWalletTokenAccounts();let r=(u=this.scope.account.tokenAccounts.find(({mint:c})=>(c==null?void 0:c.toBase58())===t.toBase58()))==null?void 0:u.publicKey,i=this.scope.ownerPubKey,a={};if(!r){let c=await this.getAssociatedTokenAccount(t),m=await So(i,c,i,t);a.instructions=[m],r=c}return o&&Y.mint===t.toBase58()&&(a.endInstructions=[qe({owner:i,payer:i,tokenAccount:r})]),{pubKey:r,newInstructions:a}}async handleTokenAccount(t){let{side:o,amount:r,mint:i,tokenAccount:a,payer:u=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:m}=t,d=this.createTxBuilder(),p=await xo(i,this.scope.ownerPubKey,!0);if(new Gi(Y.mint).equals(i)){let b=await Le({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:u,amount:r,skipCloseAccount:m});return d.addInstruction(b),S({tokenAccount:b.signers[0].publicKey},b)}else if(!a||o==="out"&&!p.equals(a)&&!c)return{tokenAccount:p,instructions:[So(this.scope.ownerPubKey,p,this.scope.ownerPubKey,i)]};return{tokenAccount:a}}};import{TOKEN_PROGRAM_ID as ot,createAssociatedTokenAccountInstruction as ma}from"@solana/spl-token";import{Keypair as la,PublicKey as Z,SystemProgram as tr,SYSVAR_CLOCK_PUBKEY as da,TransactionInstruction as rt}from"@solana/web3.js";import dn from"bn.js";import{PublicKey as tt}from"@solana/web3.js";var on=R([D("instruction")]),rn=R([D("instruction")]),$i=R([l("rewardState"),l("rewardOpenTime"),l("rewardEndTime"),l("rewardLastUpdateTime"),l("totalReward"),l("totalRewardEmissioned"),l("rewardClaimed"),l("rewardPerSecond"),J("accRewardPerShare"),w("rewardVault"),w("rewardMint"),w("rewardSender"),l("rewardType"),H(l(),15,"padding")]),ji=R([l("state"),l("nonce"),w("lpVault"),w("rewardVault"),w(),w(),l(),l(),l("totalReward"),J("perShareReward"),l("lastSlot"),l("perSlotReward")]),Yi=R([l("state"),l("nonce"),w("lpVault"),w("rewardVaultA"),l("totalRewardA"),J("perShareRewardA"),l("perSlotRewardA"),D("option"),w("rewardVaultB"),ze(7),l("totalRewardB"),J("perShareRewardB"),l("perSlotRewardB"),l("lastSlot"),w()]),Ji=R([l(),l("state"),l("nonce"),l("validRewardTokenNum"),J("rewardMultiplier"),l("rewardPeriodMax"),l("rewardPeriodMin"),l("rewardPeriodExtend"),w("lpMint"),w("lpVault"),H($i,5,"rewardInfos"),w("creator"),w(),H(l(),32,"padding")]),Lo=new Proxy(ji,{get(n,e,t){return e==="decode"?(...o)=>{let r=n.decode(...o);return O(S({},r),{version:3,rewardInfos:[{rewardVault:r.rewardVault,totalReward:r.totalReward,perSlotReward:r.perSlotReward,perShareReward:r.perShareReward}]})}:Reflect.get(n,e,t)}}),_o=new Proxy(Yi,{get(n,e,t){return e==="decode"?(...o)=>{let r=n.decode(...o);return O(S({},r),{version:5,rewardInfos:[{rewardVault:r.rewardVaultA,totalReward:r.totalRewardA,perSlotReward:r.perSlotRewardA,perShareReward:r.perShareRewardA},{rewardVault:r.rewardVaultB,totalReward:r.totalRewardB,perSlotReward:r.perSlotRewardB,perShareReward:r.perShareRewardB}]})}:Reflect.get(n,e,t)}}),Xe=new Proxy(Ji,{get(n,e,t){return e==="decode"?(...o)=>{let r=n.decode(...o);return O(S({},r),{version:6,rewardInfos:r.rewardInfos.map(i=>{var a;return O(S({},i),{rewardType:((a=Object.entries(Bt).find(u=>String(u[1])===i.rewardType.toString()))!=null?a:["Standard SPL"])[0]})})})}:Reflect.get(n,e,t)}}),Qi=R([l("isSet"),l("rewardPerSecond"),l("rewardOpenTime"),l("rewardEndTime"),l("rewardType")]),an=R([D("instruction"),l("nonce"),H(Qi,5,"rewardTimeInfo")]),sn=R([D("instruction"),l("rewardReopenTime"),l("rewardEndTime"),l("rewardPerSecond")]),un=R([D("instruction"),l("isSet"),l("rewardPerSecond"),l("rewardOpenTime"),l("rewardEndTime")]),Vm=R([l("state"),w("id"),w("owner"),l("deposited"),H(l(),1,"rewardDebts")]),Ro=R([l("state"),w("id"),w("owner"),l("deposited"),H(J(),1,"rewardDebts"),H(l(),17)]),Cm=R([l("state"),w("id"),w("owner"),l("deposited"),H(l(),2,"rewardDebts")]),Mo=R([l("state"),w("id"),w("owner"),l("deposited"),H(J(),2,"rewardDebts"),H(l(),17)]),Bo=R([l(),l("state"),w("id"),w("owner"),l("deposited"),H(J(),5,"rewardDebts"),H(l(),16)]),et=R([D("instruction"),l("amount")]);var Oo=M("Raydium_farm_config"),Fo="EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q",Hi=new tt(Fo),qo="9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z",zi=new tt(qo),No="FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG",Zi=new tt(No),vo={[Fo]:3,[qo]:5,[No]:6},Do={3:Hi,5:zi,6:Zi},Eo=new tt("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Ko=new tt("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),Vo={3:Lo,5:_o,6:Xe},Co={3:Ro,5:Mo,6:Bo},cn=n=>[3,5,6].indexOf(n)!==-1,Xi={3:10,5:11,6:1},Wo=n=>{let e=Xi[n];return e||Oo.logWithError("invalid deposit farm version"),e},ea={3:11,5:12,6:2},Uo=n=>{let e=ea[n];return e||Oo.logWithError("invalid withdraw farm version"),e},Go=n=>{var a;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:o}=n,r=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(o)}`,i={3:()=>{if(t.length!==1||o.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${r}`},5:()=>{if(t.length!==o.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${r}`},6:()=>{if(!o.length||t.length!==o.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${r}`}};return(a=i[e])==null?void 0:a.call(i)},Bt={"Standard SPL":0,"Option tokens":1};import{SystemProgram as ta,SYSVAR_RENT_PUBKEY as na,TransactionInstruction as $o}from"@solana/web3.js";import oa from"bn.js";var ra=M("Raydium_farm_instruction");async function jo(n){let{version:e,id:t,ledger:o,programId:r,owner:i}=n,a={3:9,5:10}[e];a||ra.logWithError(`invalid farm pool version: ${e}`);let u=Buffer.alloc(on.span);on.encode({instruction:a},u);let c=[s({pubkey:t}),s({pubkey:o}),s({pubkey:i,isWritable:!1}),s({pubkey:ta.programId,isWritable:!1}),s({pubkey:na,isWritable:!1})];return new $o({programId:r,keys:c,data:u})}function Yo(n){var o;let e=Buffer.alloc(an.span);an.encode({instruction:0,nonce:new oa(n.nonce),rewardTimeInfo:n.rewardInfoConfig},e);let t=[...Oe,s({pubkey:n.farmKeyPair.publicKey}),s({pubkey:n.farmAuthority,isWritable:!1}),s({pubkey:n.lpVault}),s({pubkey:n.lpMint,isWritable:!1}),s({pubkey:n.lockVault}),s({pubkey:n.lockMint,isWritable:!1}),s({pubkey:(o=n.lockUserAccount)!=null?o:W}),s({pubkey:n.owner,isWritable:!1,isSigner:!0})];for(let r of n.rewardInfo)t.push(s({pubkey:r.rewardMint,isWritable:!1}),s({pubkey:r.rewardVault}),s({pubkey:r.userRewardToken}));return new $o({programId:n.programId,keys:t,data:e})}import z from"bn.js";var nt=M("Raydium.farm.util");async function Ot({programId:n,poolId:e,mint:t,type:o}){let{publicKey:r}=await he([e.toBuffer(),t.toBuffer(),Buffer.from(o==="lpVault"?"lp_vault_associated_seed":o==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],n);return r}function ia(n){let t=V({publicKey:n}).toBase58();return vo[t]}async function mn({programId:n,poolId:e,owner:t}){let{publicKey:o}=await he([e.toBuffer(),t.toBuffer(),Buffer.from(ia(n)===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],n);return o}var Jo=async({programId:n,poolId:e})=>await he([e.toBuffer()],n);function Qo(n){return Do[n]}function Ho(n){return{isSet:new z(1),rewardPerSecond:x(n.rewardPerSecond),rewardOpenTime:x(n.rewardOpenTime),rewardEndTime:x(n.rewardEndTime),rewardType:x(n.rewardType)}}function ln(n){return x(n.rewardEndTime).sub(x(n.rewardOpenTime)).mul(x(n.rewardPerSecond))}function aa(n){let e=Co[n];return e||nt.logWithError("invalid version",n),e}function sa(n){let e=Vo[n];return e||nt.logWithError("invalid version",n),e}function ua(n,e,t,o){if(n.version===3||n.version===5){if(n.lastSlot.gte(new z(t)))return n;let r=new z(t).sub(n.lastSlot);n.lastSlot=new z(t);for(let i of n.rewardInfos){if(e.amount.eq(new z(0)))continue;let a=i.perSlotReward.mul(r);i.perShareReward=i.perShareReward.add(a.mul(new z(10).pow(new z(n.version===3?9:15))).div(e.amount)),i.totalReward=i.totalReward.add(a)}}else if(n.version===6)for(let r of n.rewardInfos){if(r.rewardState.eq(new z(0)))continue;let i=z.min(new z(o),r.rewardEndTime);if(r.rewardOpenTime.gte(i))continue;let u=i.sub(r.rewardLastUpdateTime).mul(r.rewardPerSecond),c=r.totalReward.sub(r.totalRewardEmissioned);c.lt(u)?(u=c,r.rewardLastUpdateTime=r.rewardLastUpdateTime.add(c.div(r.rewardPerSecond))):r.rewardLastUpdateTime=i,!e.amount.eq(new z(0))&&(r.accRewardPerShare=r.accRewardPerShare.add(u.mul(n.rewardMultiplier).div(e.amount)),r.totalRewardEmissioned=r.totalRewardEmissioned.add(u))}return n}async function ca({connection:n,farmPools:e,owner:t,config:o}){var b;let r=!1,i=!1,a=new z(10),u=[];for(let f of e){let y=me(f);y.version===6?i=!0:r=!0,u.push({pubkey:y.id,version:y.version,key:"state",poolId:y.id},{pubkey:y.lpVault,version:y.version,key:"lpVault",poolId:y.id}),t&&u.push({pubkey:await mn({programId:y.programId,poolId:y.id,owner:t}),version:y.version,key:"ledger",poolId:y.id})}let c={},m=await po(n,u,o);for(let{pubkey:f,version:y,key:h,poolId:L,accountInfo:g}of m){let k=L.toBase58();if(c[k]=S({},c[k]),h==="state"){let _=sa(y);(!g||!g.data||g.data.length!==_.span)&&nt.logWithError(`invalid farm state account info, pools.id, ${f}`),c[k].state=_.decode(g.data)}else if(h==="lpVault")(!g||!g.data||g.data.length!==we.span)&&nt.logWithError(`invalid farm lp vault account info, pools.lpVault, ${f}`),c[k].lpVault=we.decode(g.data);else if(h==="ledger"){let _=aa(y);g&&g.data&&(g.data.length!==_.span&&nt.logWithError(`invalid farm ledger account info, ledger, ${f}`),c[k].ledger=_.decode(g.data))}}let d=i||r?await n.getSlot():0,p=i&&(b=await n.getBlockTime(d))!=null?b:0;for(let f of Object.keys(c))c[f].state=ua(c[f].state,c[f].lpVault,d,p);for(let[f,{state:y,ledger:h}]of Object.entries(c))if(h){let L=y.version===6?y.rewardMultiplier:y.rewardInfos.length===1?a.pow(new z(9)):a.pow(new z(15)),g=y.rewardInfos.map((k,_)=>{let P=h.rewardDebts[_];return h.deposited.mul(y.version===6?k.accRewardPerShare:k.perShareReward).div(L).sub(P)});c[f].wrapped=O(S({},c[f].wrapped),{pendingRewards:g})}return c}async function zo(n){let{farmPools:e}=n,t=await ca(n);return e.map((r,i)=>O(S(S(S({},e[i]),me(r)),t[r.id]),{jsonInfo:e[i]}))}function Zo(n,e=Date.now()){if(n.version===6){let t=n.state.rewardInfos;if(t.every(({rewardOpenTime:o})=>He(e,o.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:o})=>Ee(e,o.toNumber(),{unit:"s"})))return"closed pool"}else{let t=n.state.rewardInfos.map(({perSlotReward:o})=>o);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}function Xo(n){return n.state.rewardInfos.length===1&&String(n.lpMint)===At.toBase58()}function er(n,e){return n.version===6?n.state.rewardInfos.map(({rewardPerSecond:t,rewardOpenTime:o,rewardEndTime:r},i)=>{var b;let a=He(e.currentBlockChainDate,o.toNumber(),{unit:"s"}),u=Ee(e.currentBlockChainDate,r.toNumber(),{unit:"s"});if(a||u)return;let c=e.rewardTokens[i];if(!c)return;let m=e.rewardTokenPrices[i];if(!m)return;let d=je(new T(t,pe).div(ye.pow(new z(c.decimals||1))).mul(new z(60*60*24*365)),m);return e.tvl?e.tvl.isZero()?Be(0):d.div((b=e.tvl)!=null?b:pe):void 0}):n.state.rewardInfos.map(({perSlotReward:o},r)=>{var m;let i=e.rewardTokens[r];if(!i)return;let a=e.rewardTokenPrices[r];if(!a)return;let u=je(new T(o,pe).div(ye.pow(new z(i.decimals||1))).mul(new z(e.blockSlotCountForSecond*60*60*24*365)),a);return e.tvl?e.tvl.isZero()?Be(0):u.div((m=e.tvl)!=null?m:pe):void 0})}var it=class extends re{constructor(){super(...arguments);this._farmPools=[];this._hydratedFarmPools=[];this._hydratedFarmMap=new Map;this._sdkParsedFarmPools=[];this._lpTokenInfoMap=new Map}async load(t){var r;await this.scope.liquidity.load(t),await this.scope.fetchFarms(t==null?void 0:t.forceUpdate);let o=((r=this.scope.apiData.farmPools)==null?void 0:r.data)||{};this._farmPools=Object.keys(o||{}).reduce((i,a)=>{var u,c;return i.concat(((c=(u=o[a]).map)==null?void 0:c.call(u,m=>{let d=this.scope.token.allTokenMap.get(m.baseMint),p=this.scope.token.allTokenMap.get(m.quoteMint);return d&&p&&this._lpTokenInfoMap.set(m.lpMint,new G({mint:m.lpMint,decimals:d.decimals,symbol:`${d.symbol} - ${p.name}`,name:`${d.symbol} - ${p.name} LP`})),O(S({},m),{name:m.symbol,category:a})}))||[])},[]),await this.fetchSdkFarmInfo()}async fetchSdkFarmInfo(){var t;this._sdkParsedFarmPools=await zo({connection:this.scope.connection,farmPools:this._farmPools,owner:(t=this.scope.owner)==null?void 0:t.publicKey,config:{commitment:"confirmed"}})}async loadHydratedFarmInfo(t){let{forceUpdate:o,skipPrice:r}=t||{};if(this._hydratedFarmPools.length&&!o)return this._hydratedFarmPools;await this.scope.farm.load();try{await this.scope.account.fetchWalletTokenAccounts()}catch{}!r&&await this.scope.token.fetchTokenPrices(),await this.scope.liquidity.loadPairs();let i=await this.scope.chainTimeOffset(),a=zt(Date.now()+i,{minutes:0}),u=await this.scope.api.getBlockSlotCountForSecond(this.scope.connection.rpcEndpoint),c=Object.fromEntries(this.scope.liquidity.allPairs.map(m=>[m.ammId,{apr30d:m.apr30d,apr7d:m.apr7d,apr24h:m.apr24h}]));return this._hydratedFarmPools=this._sdkParsedFarmPools.map(m=>{let d=this.hydrateFarmInfo({farmInfo:m,blockSlotCountForSecond:u,farmAprs:c,currentBlockChainDate:a,chainTimeOffset:i});return this._hydratedFarmMap.set(m.id.toBase58(),d),d}),this._hydratedFarmPools}get allFarms(){return this._farmPools}get allParsedFarms(){return this._sdkParsedFarmPools}get allHydratedFarms(){return this._hydratedFarmPools}get allHydratedFarmMap(){return this._hydratedFarmMap}getFarm(t){let o=V({publicKey:t}),r=this.allFarms.find(i=>i.id===o.toBase58());return r||this.logAndCreateError("invalid farm id"),r}getParsedFarm(t){let o=V({publicKey:t}),r=this.allParsedFarms.find(i=>o.equals(i.id));return r||this.logAndCreateError("invalid farm id"),r}getLpTokenInfo(t){let o=V({publicKey:t}),r=this._lpTokenInfoMap.get(o.toBase58());return r||this.logAndCreateError("LP Token not found",o.toBase58()),r}lpDecimalAmount({mint:t,amount:o}){let r=se(o),i=this.getLpTokenInfo(t);return Te(new T(r.numerator,r.denominator).mul(new dn(10).pow(new dn(i.decimals))))}hydrateFarmInfo(t){var dt,pt,Ce,We,Ue,ft,Sn,Ln,_n,Rn,Mn,Bn;let{farmInfo:o,blockSlotCountForSecond:r,farmAprs:i,currentBlockChainDate:a,chainTimeOffset:u=0}=t,c=Zo(o,a),m=Xo(o),d=c==="dual fusion pool",p=c==="normal fusion pool",b=c==="closed pool"&&!o.upcoming,f=o.version!==6?o.upcoming&&b:o.upcoming,y=o.version!==6&&o.upcoming&&!b,h=((dt=this.scope.liquidity.allPools.find(B=>B.lpMint===o.lpMint.toBase58()))==null?void 0:dt.version)===5,L=m?this.scope.mintToToken(o.lpMint):this.getLpTokenInfo(o.lpMint),g=this.scope.mintToToken(m?o.lpMint:o.baseMint),k=this.scope.mintToToken(m?o.lpMint:o.quoteMint);g!=null&&g.symbol;let _=m?`${(pt=g==null?void 0:g.symbol)!=null?pt:"unknown"}`:`${(Ce=g==null?void 0:g.symbol)!=null?Ce:"unknown"}-${(We=k==null?void 0:k.symbol)!=null?We:"unknown"}`,P=o.jsonInfo.rewardInfos.map(({rewardMint:B})=>this.scope.mintToToken(B)),q=(Ue=o.wrapped)==null?void 0:Ue.pendingRewards.map((B,C)=>P[C]?new F(P[C],Te(yo(B,0))):void 0),N=m?this.scope.token.tokenPrices.get(o.lpMint.toBase58()):this.scope.liquidity.lpPriceMap.get(o.lpMint.toBase58()),v=L&&new F(L,o.lpVault.amount),$=N&&L?je(new F(L,o.lpVault.amount),N):void 0,E=er(o,{tvl:$,currentBlockChainDate:a,rewardTokens:P,rewardTokenPrices:(ft=o.rewardInfos.map(({rewardMint:B})=>this.scope.token.tokenPrices.get(B.toBase58())))!=null?ft:[],blockSlotCountForSecond:r}),U=(Sn=this.scope.liquidity.allPools.find(B=>B.lpMint===o.lpMint.toBase58()))==null?void 0:Sn.id,X=U?wt((Ln=i[U])==null?void 0:Ln.apr7d,{alreadyDecimaled:!0}):void 0,j=U?wt((_n=i[U])==null?void 0:_n.apr30d,{alreadyDecimaled:!0}):void 0,ne=U?wt((Rn=i[U])==null?void 0:Rn.apr24h,{alreadyDecimaled:!0}):void 0,ie=E.reduce((B,C)=>B?C?B.add(C):B:C,X),Ae=E.reduce((B,C)=>B?C?B.add(C):B:C,j),ce=E.reduce((B,C)=>B?C?B.add(C):B:C,ne),fe=o.version===6?o.state.rewardInfos.map((B,C)=>{var Nn,vn,Dn,En;let{rewardOpenTime:Ge,rewardEndTime:bt,rewardPerSecond:Kt}=B,Me=Ge.toNumber()?new Date(Ge.toNumber()*1e3+u):void 0,be=bt.toNumber()?new Date(bt.toNumber()*1e3+u):void 0,Vt=Date.now()+u;if(!Me&&!be)return;let De=this.scope.mintToToken((Dn=(vn=B.rewardMint)!=null?vn:(Nn=o.rewardInfos[C])==null?void 0:Nn.rewardMint)==null?void 0:Dn.toBase58()),On=Boolean(Me&&He(Vt,Me)),Fn=Boolean(be&&Ee(Vt,be)),qn=!Me&&!be||!Fn&&!On,Cr=qn&&Ee(Vt,zt(be,{seconds:-((En=o.jsonInfo.rewardPeriodExtend)!=null?En:72*60*60)})),Wr=De&&this.scope.mintToTokenAmount({mint:De.mint,amount:bo(B.totalReward,B.totalRewardEmissioned).toFixed(De.decimals)}),Ur=q==null?void 0:q[C],Gr=E[C],$r=Boolean(be),yt=o.rewardInfos[C];return O(S(S({},yt),B),{owner:yt==null?void 0:yt.rewardSender,apr:Gr,token:De,userPendingReward:Ur,userHavedReward:$r,perSecond:De&&this.scope.mintToTokenAmount({mint:De.mint,amount:Kt}).toSignificant(),openTime:Me,endTime:be,isOptionToken:B.rewardType==="Option tokens",isRewardBeforeStart:On,isRewardEnded:Fn,isRewarding:qn,isRwardingBeforeEnd72h:Cr,claimableRewards:Wr,version:6})}).filter(B=>!!B):o.state.rewardInfos.map((B,C)=>{let Ge=q==null?void 0:q[C],bt=E[C],Kt=P[C],{perSlotReward:Me}=B,be=St(Ge)||St(Me);return O(S({},B),{apr:bt,token:Kt,userPendingReward:Ge,userHavedReward:be,version:o.version})}),de=L&&((Mn=o.ledger)==null?void 0:Mn.deposited)?new F(L,(Bn=o.ledger)==null?void 0:Bn.deposited):void 0;return O(S({},o),{lp:L,lpPrice:N,base:g,quote:k,name:_,isStakePool:m,isDualFusionPool:d,isNormalFusionPool:p,isClosedPool:b,isUpcomingPool:f,isStablePool:h,isNewPool:y,totalApr7d:ie,raydiumFeeApr7d:X,totalApr24h:ce,raydiumFeeApr24h:ne,totalApr30d:Ae,raydiumFeeApr30d:j,ammId:U,tvl:$,userHasStaked:St(de),rewards:fe,userStakedLpAmount:de,stakedLpAmount:v})}async _getUserRewardInfo({payer:t,rewardInfo:o}){if(o.rewardMint.equals(W)){let r=await Le({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:t,amount:ln(o)});return{rewardPubKey:r.signers[0].publicKey,newInstruction:r}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:o.rewardMint})}}async create({poolId:t,rewardInfos:o,payer:r}){this.checkDisabled(),this.scope.checkOwner();let i=V({publicKey:t}),a=this.scope.liquidity.allPools.find(P=>P.id===i.toBase58());a||this.logAndCreateError("invalid pool id");let c={lpMint:new Z(a.lpMint),lockInfo:{lockMint:Eo,lockVault:Ko},version:6,rewardInfos:o,programId:Qo(6)},m=this.createTxBuilder(),d=r!=null?r:this.scope.ownerPubKey,p=la.generate(),b=await this.scope.connection.getMinimumBalanceForRentExemption(Xe.span);m.addInstruction({instructions:[tr.createAccount({fromPubkey:d,newAccountPubkey:p.publicKey,lamports:b,space:Xe.span,programId:c.programId})],signers:[p]});let{publicKey:f,nonce:y}=await Jo({programId:c.programId,poolId:p.publicKey}),h=await Ot({programId:c.programId,poolId:p.publicKey,mint:c.lpMint,type:"lpVault"}),L=[],g=[];for(let P of c.rewardInfos){P.rewardOpenTime>=P.rewardEndTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",P.rewardOpenTime.toString()),Bt[P.rewardType]||this.logAndCreateError("rewardType error",P.rewardType),P.rewardPerSecond<=0&&this.logAndCreateError("rewardPerSecond error",P.rewardPerSecond.toString()),L.push(Ho(P));let{rewardPubKey:q,newInstruction:N}=await this._getUserRewardInfo({rewardInfo:P,payer:d});N&&m.addInstruction(N),q||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let v=P.rewardMint.equals(W)?new Z(Y.mint):P.rewardMint;g.push({rewardMint:v,rewardVault:await Ot({programId:c.programId,poolId:p.publicKey,mint:v,type:"rewardVault"}),userRewardToken:q})}let k=await this.scope.account.getCreatedTokenAccount({mint:c.lockInfo.lockMint});k||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let _=Yo({farmKeyPair:p,owner:this.scope.ownerPubKey,farmAuthority:f,lpVault:h,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:k,programId:c.programId,rewardInfo:g,rewardInfoConfig:L,nonce:y});return await m.addInstruction({instructions:[_]}).build()}async restartReward({farmId:t,payer:o,newRewardInfo:r}){let i=this.getFarm(t);i.version!==6&&this.logAndCreateError("invalid farm version",i.version);let a={id:new Z(i.id),rewardInfos:i.rewardInfos,lpVault:new Z(i.lpVault),programId:new Z(i.programId)};r.rewardOpenTime>=r.rewardEndTime&&this.logAndCreateError("start time error","newRewardInfo",r);let u=o||this.scope.ownerPubKey,c=r.rewardMint.equals(W)?new Z(Y.mint):r.rewardMint,m=a.rewardInfos.find(L=>new Z(L.rewardMint).equals(c));m||this.logAndCreateError("configuration does not exist","rewardMint",c);let d=m.rewardVault?new Z(m.rewardVault):W,p=this.createTxBuilder(),{rewardPubKey:b,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:r,payer:u});f&&p.addInstruction(f),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let y=Buffer.alloc(sn.span);sn.encode({instruction:3,rewardReopenTime:x(r.rewardOpenTime),rewardEndTime:x(r.rewardEndTime),rewardPerSecond:x(r.rewardPerSecond)},y);let h=[s({pubkey:ot,isWritable:!1}),s({pubkey:a.id}),s({pubkey:a.lpVault,isWritable:!1}),s({pubkey:d}),s({pubkey:b}),s({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await p.addInstruction({instructions:[new rt({programId:a.programId,keys:h,data:y})]}).build()}async addNewRewardToken(t){let{farmId:o,newRewardInfo:r,payer:i}=t,a=this.getFarm(o);a.version!==6&&this.logAndCreateError("invalid farm version",a.version);let u=i!=null?i:this.scope.ownerPubKey,c=this.createTxBuilder(),m=await Ot({programId:new Z(a.programId),poolId:new Z(a.id),mint:r.rewardMint,type:"rewardVault"}),{rewardPubKey:d,newInstruction:p}=await this._getUserRewardInfo({rewardInfo:r,payer:u});p&&c.addInstruction(p),d||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts);let b=r.rewardMint.equals(W)?new Z(Y.mint):r.rewardMint,f=Buffer.alloc(un.span);un.encode({instruction:4,isSet:new dn(1),rewardPerSecond:x(r.rewardPerSecond),rewardOpenTime:x(r.rewardOpenTime),rewardEndTime:x(r.rewardEndTime)},f);let y=[...Oe,s({pubkey:new Z(a.id)}),s({pubkey:new Z(a.authority),isWritable:!1}),s({pubkey:b,isWritable:!1}),s({pubkey:m}),s({pubkey:d}),s({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await c.addInstruction({instructions:[new rt({programId:new Z(a.programId),keys:y,data:f})]}).build()}async _prepareFarmAccounts(t){let o=this.createTxBuilder(),{farmInfo:r}=t,{pubKey:i,newInstructions:a}=await this.scope.account.checkOrCreateAta({mint:r.lpMint});o.addInstruction(a);let u=await Promise.all(r.rewardInfos.map(async({rewardMint:d})=>{let{pubKey:p,newInstructions:b}=await this.scope.account.checkOrCreateAta({mint:d,autoUnwrapWSOLToSOL:!0});return o.addInstruction(b),p})),c=await mn({programId:new Z(r.programId),poolId:new Z(r.id),owner:this.scope.ownerPubKey});if(!r.ledger&&r.version<6){let d=await jo({id:r.id,programId:r.programId,version:r.version,ledger:c,owner:this.scope.ownerPubKey});o.addInstruction({instructions:[d]})}let m=[s({pubkey:r.id}),s({pubkey:r.authority,isWritable:!1}),s({pubkey:c}),s({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),s({pubkey:i}),s({pubkey:new Z(r.jsonInfo.lpVault)}),s({pubkey:u[0]}),s({pubkey:r.rewardInfos[0].rewardVault}),s({pubkey:da,isWritable:!1}),s({pubkey:ot,isWritable:!1})];return{txBuilder:o,lpTokenAccount:i,rewardTokenAccountsPublicKeys:u,ledgerAddress:c,lowVersionKeys:m}}async deposit(t){this.scope.checkOwner();let{farmId:o,amount:r}=t,i=this.getParsedFarm(o),a=i.lpMint,{version:u,rewardInfos:c}=i;cn(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:m,ledgerAddress:d,lpTokenAccount:p,lowVersionKeys:b,rewardTokenAccountsPublicKeys:f}=await this._prepareFarmAccounts({mint:a,farmInfo:i}),y=Go({version:u,rewardInfos:c,rewardTokenAccountsPublicKeys:f});y&&this.logAndCreateError(y);let h=Buffer.alloc(et.span);et.encode({instruction:Wo(u),amount:x(r)},h);let L=u===6?[s({pubkey:ot,isWritable:!1}),s({pubkey:tr.programId,isWritable:!1}),s({pubkey:i.id}),s({pubkey:i.authority,isWritable:!1}),s({pubkey:i.lpVault.mint}),s({pubkey:d}),s({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),s({pubkey:p})]:b;if(u!==3)for(let k=1;k<c.length;k++)L.push(s({pubkey:f[k]})),L.push(s({pubkey:c[k].rewardVault}));let g=new rt({programId:i.programId,keys:L,data:h});return await m.addInstruction({instructions:[g]}).build()}async withdraw(t){this.scope.checkOwner();let{farmId:o,amount:r}=t,i=this.getParsedFarm(o),a=i.lpMint,{version:u,rewardInfos:c}=i;cn(u)||this.logAndCreateError("invalid farm version:",u);let{txBuilder:m,ledgerAddress:d,lpTokenAccount:p,lowVersionKeys:b,rewardTokenAccountsPublicKeys:f}=await this._prepareFarmAccounts({mint:a,farmInfo:i}),y=Buffer.alloc(et.span);et.encode({instruction:Uo(u),amount:x(r)},y);let h=u===6?[s({pubkey:ot,isWritable:!1}),s({pubkey:i.id}),s({pubkey:i.authority,isWritable:!1}),s({pubkey:i.lpVault.mint}),s({pubkey:d}),s({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0}),s({pubkey:p})]:b;if(u!==3)for(let g=1;g<c.length;g++)h.push(s({pubkey:f[g]})),h.push(s({pubkey:c[g].rewardVault}));let L=new rt({programId:i.programId,keys:h,data:y});return await m.addInstruction({instructions:[L]}).build()}async withdrawFarmReward({farmId:t,withdrawMint:o}){var b;this.scope.checkOwner();let r=this.getParsedFarm(t),{version:i}=r;i!==6&&this.logAndCreateError("invalid farm version",r.version);let a=r.rewardInfos.find(f=>f.rewardMint.equals(o.equals(W)?new Z(Y.mint):o));a||this.logAndCreateError("withdraw mint error","rewardInfos",r);let u=(b=a==null?void 0:a.rewardVault)!=null?b:W,c=this.createTxBuilder(),m;if(this._getUserRewardInfo({payer:this.scope.ownerPubKey,rewardInfo:a}),o.equals(W)){let f=await Le({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:ln(a)});m=f.signers[0].publicKey,c.addInstruction(f)}else{let f=await this.scope.account.getCreatedTokenAccount({mint:o});f===null?(m=await this.scope.account.getAssociatedTokenAccount(o),c.addInstruction({instructions:[ma(this.scope.ownerPubKey,m,this.scope.ownerPubKey,o)]})):m=f}let d=Buffer.alloc(rn.span);rn.encode({instruction:5},d);let p=[s({pubkey:ot,isWritable:!1}),s({pubkey:r.id}),s({pubkey:r.authority,isWritable:!1}),s({pubkey:r.lpVault.mint,isWritable:!1}),s({pubkey:u}),s({pubkey:m}),s({pubkey:this.scope.ownerPubKey,isWritable:!1,isSigner:!0})];return await c.addInstruction({instructions:[new rt({programId:r.programId,keys:p,data:d})]}).build()}};import{ComputeBudgetProgram as va}from"@solana/web3.js";import Ie from"bn.js";import{PublicKey as nr}from"@solana/web3.js";import or from"bn.js";var rr=new or(25),ir=new or(1e4),ar="675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8",pa=new nr(ar),sr="5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h",fa=new nr(sr),Ql={[ar]:4,[sr]:5},ur={4:pa,5:fa},cr={4:3,5:3};import{TOKEN_PROGRAM_ID as kn}from"@solana/spl-token";import{SystemProgram as _a,TransactionInstruction as Pe}from"@solana/web3.js";var pn=R([D("instruction"),l("amountIn"),l("minAmountOut")]),fn=R([D("instruction"),l("maxAmountIn"),l("amountOut")]),bn=R([D("instruction"),D("nonce")]),yn=R([D("instruction"),D("nonce"),l("startTime")]),ba=R([l("status"),l("nonce"),l("maxOrder"),l("depth"),l("baseDecimal"),l("quoteDecimal"),l("state"),l("resetFlag"),l("minSize"),l("volMaxCutRatio"),l("amountWaveRatio"),l("baseLotSize"),l("quoteLotSize"),l("minPriceMultiplier"),l("maxPriceMultiplier"),l("systemDecimalValue"),l("minSeparateNumerator"),l("minSeparateDenominator"),l("tradeFeeNumerator"),l("tradeFeeDenominator"),l("pnlNumerator"),l("pnlDenominator"),l("swapFeeNumerator"),l("swapFeeDenominator"),l("baseNeedTakePnl"),l("quoteNeedTakePnl"),l("quoteTotalPnl"),l("baseTotalPnl"),J("quoteTotalDeposited"),J("baseTotalDeposited"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),l("swapBase2QuoteFee"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),l("swapQuote2BaseFee"),w("baseVault"),w("quoteVault"),w("baseMint"),w("quoteMint"),w("lpMint"),w("openOrders"),w("marketId"),w("marketProgramId"),w("targetOrders"),w("withdrawQueue"),w("lpVault"),w("owner"),l("lpReserve"),H(l(),3,"padding")]),Xl=R([l("accountType"),l("status"),l("nonce"),l("maxOrder"),l("depth"),l("baseDecimal"),l("quoteDecimal"),l("state"),l("resetFlag"),l("minSize"),l("volMaxCutRatio"),l("amountWaveRatio"),l("baseLotSize"),l("quoteLotSize"),l("minPriceMultiplier"),l("maxPriceMultiplier"),l("systemDecimalsValue"),l("abortTradeFactor"),l("priceTickMultiplier"),l("priceTick"),l("minSeparateNumerator"),l("minSeparateDenominator"),l("tradeFeeNumerator"),l("tradeFeeDenominator"),l("pnlNumerator"),l("pnlDenominator"),l("swapFeeNumerator"),l("swapFeeDenominator"),l("baseNeedTakePnl"),l("quoteNeedTakePnl"),l("quoteTotalPnl"),l("baseTotalPnl"),l("poolOpenTime"),l("punishPcAmount"),l("punishCoinAmount"),l("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),l("swapQuote2BaseFee"),l("swapBase2QuoteFee"),w("baseVault"),w("quoteVault"),w("baseMint"),w("quoteMint"),w("lpMint"),w("modelDataAccount"),w("openOrders"),w("marketId"),w("marketProgramId"),w("targetOrders"),w("owner"),H(l(),64,"padding")]),gn=R([D("instruction"),l("baseAmountIn"),l("quoteAmountIn"),l("fixedSide")]),hn=R([D("instruction"),l("amountIn")]);import{PublicKey as ya}from"@solana/web3.js";var ke=new ya("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),ve=5e4,ga=R([l("x"),l("y"),l("price")]),ha=R([l("accountType"),l("status"),l("multiplier"),l("validDataCount"),H(ga,ve,"DataElement")]);function wa(n,e){return[0,ve-2]}function ka(n){return[0,ve-2]}function Pa(n){return[0,ve-2]}function Ia(n,e,t){let[o,r]=wa(e,t),i=o,a=r,u=0,c=e*n.multiplier/t;for(;i<=a;){if(u=Math.floor((a+i)/2),u===0||u>=ve-2)return[u,u,!1];let m=n.DataElement[u].x*n.multiplier/n.DataElement[u].y,d=n.DataElement[u-1].x*n.multiplier/n.DataElement[u-1].y,p=n.DataElement[u+1].x*n.multiplier/n.DataElement[u+1].y;if(c===m)return[u,u,!0];if(c===d)return[u-1,u-1,!0];if(c===p)return[u+1,u+1,!0];if(c<d)a=u-1;else{if(c>d&&c<m)return[u-1,u,!0];if(c>m&&c<p)return[u,u+1,!0];i=u+1}}return[u,u,!1]}function wn(n,e,t){let[o,r,i]=Ia(n,e,t);if(!i)return 0;if(o===r){let a=n.DataElement[o].x;return e*n.multiplier/a}else{let a=n.DataElement[o].x,u=n.DataElement[o].y,c=n.DataElement[r].x,m=n.DataElement[r].y,d=t*(c*u-a*m),p=a*d,b=(c-a)*(e*u-a*t)*m,f=p+b;return e*n.multiplier*d/f}}function Ne(n,e,t){return e*n.multiplier/t}function mr(n,e,t){return e*t/n.multiplier}function Aa(n,e){let[t,o]=ka(e),r=t,i=o,a=0,u=e;for(;r<i;){if(a=Math.floor((i+r)/2),a<=0||a>ve-2)return[a,a,!1];let c=n.DataElement[a].x,m=n.DataElement[a-1].x,d=n.DataElement[a+1].x;if(u===c)return[a,a,!0];if(u===m)return[a-1,a-1,!0];if(u===d)return[a+1,a+1,!0];if(u<m)i=a-1;else{if(u>m&&u<c)return[a-1,a,!0];if(u>c&&u<d)return[a,a+1,!0];r=a+1}}return[a,a,!1]}function Ta(n,e){let[t,o]=Pa(e),r=t,i=o,a=0,u=e;for(;r<=i;){if(a=Math.floor((i+r)/2),a<=0||a>=ve-2)return[a,a,!1];let c=n.DataElement[a].y,m=n.DataElement[a-1].y,d=n.DataElement[a+1].y;if(u===c)return[a,a,!0];if(u===m)return[a-1,a-1,!0];if(u===d)return[a+1,a+1,!0];if(u<d)r=a+1;else{if(u<m&&u>c)return[a-1,a,!0];if(u<c&&u>d)return[a,a+1,!0];i=a-1}}return[a,a,!1]}function lr(n,e,t,o){let r=o?e+t:e-t,[i,a,u]=Aa(n,r);if(!u)return[0,0,!1,u];if(i===a)return[n.DataElement[a].price,n.DataElement[a].y,!1,u];{let c=n.DataElement[i].x,m=n.DataElement[a].x,d=n.DataElement[i].price,p=n.DataElement[a].price,b=n.DataElement[i].y,f=n.DataElement[a].y;if(e>=c&&e<=m)return o?[p,f,!0,u]:[d,b,!0,u];{let y,h;return o?(y=d+(p-d)*(e-c)/(m-c),h=b-(r-c)*n.multiplier/p):(y=d+(p-d)*(e-c)/(m-c),h=f+(m-r)*n.multiplier/d),[y,h,!1,u]}}}function xa(n,e,t,o){let r=o?e-t:e+t,[i,a,u]=Ta(n,r);if(!u)return[0,0,!1,u];if(i===a)return[n.DataElement[a].price,n.DataElement[a].x,!1,u];{let c=n.DataElement[i].x,m=n.DataElement[a].x,d=n.DataElement[i].price,p=n.DataElement[a].price,b=n.DataElement[i].y,f=n.DataElement[a].y;if(e>=f&&e<=b)return o?[p,m,!0,u]:[d,c,!0,u];{let y,h;return o?(y=d+(p-d)*(b-e)/(b-f),h=c+p*(b-r)/n.multiplier):(y=d+(p-d)*(b-e)/(b-f),h=m-d*(r-f)/n.multiplier),[y,h,!1,u]}}}function Sa(n,e){let t=lr(n,e,0,!1);return t[3]?t[0]:0}function dr(n,e,t,o){let r=wn(n,e,t),i=Ne(n,e,r),a=Ne(n,t,r),u=Ne(n,o,r),c=!0,[m,d,p,b]=lr(n,i,u,c);if(!b)return 0;if(p)return o*n.multiplier/m;{let f=a-d;return mr(n,f,r)}}function pr(n,e,t,o){let r=wn(n,e,t),i=Ne(n,e,r),a=Ne(n,t,r),u=Ne(n,o,r),c=!1,[m,d,p,b]=xa(n,a,u,c);if(!b)return 0;if(p)return o*m/n.multiplier;{let f=i-d;return mr(n,f,r)}}function La(n){let e=ha.decode(n);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function fr(n,e,t,o){let r=Sa(n,Ne(n,e,wn(n,e,t)))/n.multiplier;return o?r:1/r}var Ft=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(ke);e&&(this._layoutData=La(e==null?void 0:e.data))}}};var qt=M("Raydium_liquidity_instruction");function br(n){let{poolKeys:e,userKeys:t,amountIn:o,amountOut:r,fixedSide:i}=n,{version:a}=e;if(a===4||a===5){let u={poolKeys:e,userKeys:t};if(i==="in")return Ra(O(S({},u),{amountIn:o,minAmountOut:r}),a);if(i==="out")return Ma(O(S({},u),{maxAmountIn:o,amountOut:r}),a);qt.logWithError("invalid params","params",n)}throw qt.logWithError("invalid version","poolKeys.version",a),new Error("invalid version")}function yr(n){let e=R([D("instruction"),D("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let o=[s({pubkey:n.id,isWritable:!1}),s({pubkey:n.authority,isWritable:!1}),s({pubkey:n.openOrders,isWritable:!1}),s({pubkey:n.baseVault,isWritable:!1}),s({pubkey:n.quoteVault,isWritable:!1}),s({pubkey:n.lpMint,isWritable:!1}),s({pubkey:n.marketId,isWritable:!1})];return new Pe({programId:n.programId,keys:o,data:t})}function Ra({poolKeys:n,userKeys:e,amountIn:t,minAmountOut:o},r){let i=Buffer.alloc(pn.span);pn.encode({instruction:9,amountIn:x(t),minAmountOut:x(o)},i);let a=[s({pubkey:kn,isWritable:!1}),s({pubkey:n.id}),s({pubkey:n.authority,isWritable:!1}),s({pubkey:n.openOrders})];return r===4&&a.push(s({pubkey:n.targetOrders})),a.push(s({pubkey:n.baseVault}),s({pubkey:n.quoteVault})),r===5&&a.push(s({pubkey:ke})),a.push(s({pubkey:n.marketProgramId,isWritable:!1}),s({pubkey:n.marketId}),s({pubkey:n.marketBids}),s({pubkey:n.marketAsks}),s({pubkey:n.marketEventQueue}),s({pubkey:n.marketBaseVault}),s({pubkey:n.marketQuoteVault}),s({pubkey:n.marketAuthority,isWritable:!1}),s({pubkey:e.tokenAccountIn}),s({pubkey:e.tokenAccountOut}),s({pubkey:e.owner,isWritable:!1})),new Pe({programId:n.programId,keys:a,data:i})}function Ma({poolKeys:n,userKeys:e,maxAmountIn:t,amountOut:o},r){let i=Buffer.alloc(fn.span);fn.encode({instruction:11,maxAmountIn:x(t),amountOut:x(o)},i);let a=[s({pubkey:_a.programId,isWritable:!1}),s({pubkey:n.id}),s({pubkey:n.authority,isWritable:!1}),s({pubkey:n.openOrders}),s({pubkey:n.targetOrders}),s({pubkey:n.baseVault}),s({pubkey:n.quoteVault})];return r===5&&a.push(s({pubkey:ke})),a.push(s({pubkey:n.marketProgramId,isWritable:!1}),s({pubkey:n.marketId}),s({pubkey:n.marketBids}),s({pubkey:n.marketAsks}),s({pubkey:n.marketEventQueue}),s({pubkey:n.marketBaseVault}),s({pubkey:n.marketQuoteVault}),s({pubkey:n.marketAuthority,isWritable:!1}),s({pubkey:e.tokenAccountIn}),s({pubkey:e.tokenAccountOut}),s({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Pe({programId:n.programId,keys:a,data:i})}function gr(n){let i=n,{owner:e}=i,t=ee(i,["owner"]),o=Buffer.alloc(bn.span);bn.encode({instruction:10,nonce:t.nonce},o);let r=[...Oe,s({pubkey:t.targetOrders}),s({pubkey:t.withdrawQueue}),s({pubkey:t.authority,isWritable:!1}),s({pubkey:t.lpMint}),s({pubkey:t.baseMint,isWritable:!1}),s({pubkey:t.quoteMint,isWritable:!1}),s({pubkey:t.baseVault}),s({pubkey:t.quoteVault}),s({pubkey:t.lpVault}),s({pubkey:t.marketId,isWritable:!1}),s({pubkey:e,isSigner:!0})];return new Pe({programId:t.programId,keys:r,data:o})}function hr(n){let{poolKeys:e,userKeys:t,startTime:o}=n,r=Buffer.alloc(yn.span);yn.encode({instruction:0,nonce:e.nonce,startTime:x(o)},r);let i=[...Oe,s({pubkey:e.id}),s({pubkey:e.authority,isWritable:!1}),s({pubkey:e.openOrders}),s({pubkey:e.lpMint}),s({pubkey:e.baseMint,isWritable:!1}),s({pubkey:e.quoteMint,isWritable:!1}),s({pubkey:e.baseVault,isWritable:!1}),s({pubkey:e.quoteVault,isWritable:!1}),s({pubkey:e.withdrawQueue}),s({pubkey:e.targetOrders}),s({pubkey:t.lpTokenAccount}),s({pubkey:e.lpVault,isWritable:!1}),s({pubkey:e.marketProgramId,isWritable:!1}),s({pubkey:e.marketId,isWritable:!1}),s({pubkey:t.payer,isSigner:!0})];return new Pe({programId:e.programId,keys:i,data:r})}function wr(n){let{poolKeys:e,userKeys:t,baseAmountIn:o,quoteAmountIn:r,fixedSide:i}=n,{version:a}=e;if(a===4||a===5){let u=Buffer.alloc(gn.span);gn.encode({instruction:3,baseAmountIn:x(o),quoteAmountIn:x(r),fixedSide:x(i==="base"?0:1)},u);let c=[s({pubkey:kn,isWritable:!1}),s({pubkey:e.id}),s({pubkey:e.authority,isWritable:!1}),s({pubkey:e.openOrders,isWritable:!1}),s({pubkey:e.targetOrders}),s({pubkey:e.lpMint}),s({pubkey:e.baseVault}),s({pubkey:e.quoteVault})];return a===5&&c.push(s({pubkey:ke})),c.push(s({pubkey:e.marketId,isWritable:!1}),s({pubkey:t.baseTokenAccount}),s({pubkey:t.quoteTokenAccount}),s({pubkey:t.lpTokenAccount}),s({pubkey:t.owner,isWritable:!1,isSigner:!0})),new Pe({programId:e.programId,keys:c,data:u})}return qt.logWithError("invalid version","poolKeys.version",a),new Pe({programId:e.programId,keys:[]})}function kr(n){let{poolKeys:e,userKeys:t,amountIn:o}=n,{version:r}=e;if(r===4||r===5){let i=Buffer.alloc(hn.span);hn.encode({instruction:4,amountIn:x(o)},i);let a=[s({pubkey:kn,isWritable:!1}),s({pubkey:e.id}),s({pubkey:e.authority,isWritable:!1}),s({pubkey:e.openOrders}),s({pubkey:e.targetOrders}),s({pubkey:e.lpMint}),s({pubkey:e.baseVault}),s({pubkey:e.quoteVault})];return r===5?a.push(s({pubkey:ke})):a.push(s({pubkey:e.withdrawQueue}),s({pubkey:e.lpVault})),a.push(s({pubkey:e.marketProgramId,isWritable:!1}),s({pubkey:e.marketId}),s({pubkey:e.marketBaseVault}),s({pubkey:e.marketQuoteVault}),s({pubkey:e.marketAuthority,isWritable:!1}),s({pubkey:t.lpTokenAccount}),s({pubkey:t.baseTokenAccount}),s({pubkey:t.quoteTokenAccount}),s({pubkey:t.owner,isWritable:!1,isSigner:!0}),s({pubkey:e.marketEventQueue}),s({pubkey:e.marketBids}),s({pubkey:e.marketAsks})),new Pe({programId:e.programId,keys:a,data:i})}return qt.logWithError("invalid version","poolKeys.version",r),new Pe({programId:e.programId,keys:[]})}import{OpenOrders as Ad}from"@project-serum/serum";import at from"bn.js";import{PublicKey as Pr}from"@solana/web3.js";var Pn=M("Raydium_liquidity_serum"),Ir="9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin",Ba=new Pr(Ir),hd={[Ir]:3},Oa={3:Ba};function Ar(n){let e=cr[n];return e||Pn.logWithError("invalid version","version",n),e}function Tr(n){let e=Oa[n];return e||Pn.logWithError("invalid version","version",n),e}async function xr({programId:n,marketId:e}){let t=[e.toBuffer()],o=0,r;for(;o<100;){try{let i=t.concat(Buffer.from([o]),Buffer.alloc(7));r=await Pr.createProgramAddress(i,n)}catch(i){if(i instanceof TypeError)throw i;o++;continue}return{publicKey:r,nonce:o}}throw Pn.logWithError("unable to find a viable program address nonce","params",{programId:n,marketId:e}),new Error("unable to find a viable program address nonce")}var In=M("Raydium_liquidity_util");function An(n,e){let t=n instanceof F?n.token:G.WSOL,{baseMint:o,quoteMint:r}=e;if(t.mint.equals(o))return"base";if(t.mint.equals(r))return"quote";let i=`liquidity getTokenSide - token not match with pool, params: ${JSON.stringify({token:t.mint,baseMint:o,quoteMint:r})}`;throw console.error(i),new Error(i)}function Ve(n,e){let{baseMint:t,quoteMint:o}=e;return n.mint.equals(t)||n.mint.equals(o)}function Tn(n){let{status:e,startTime:t}=n,o=e.toNumber();return{[0]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[1]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[2]:{swap:!1,addLiquidity:!1,removeLiquidity:!1},[3]:{swap:!1,addLiquidity:!1,removeLiquidity:!0},[4]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[5]:{swap:!1,addLiquidity:!0,removeLiquidity:!0},[6]:{swap:!0,addLiquidity:!0,removeLiquidity:!0},[7]:{swap:Date.now()/1e3>=t.toNumber(),addLiquidity:!0,removeLiquidity:!0}}[o]||{swap:!1,addLiquidity:!1,removeLiquidity:!1}}function Fa(n){let e=ur[n];return e||In.logWithError("invalid version","version",n),e}async function _e({name:n,programId:e,marketId:t}){let{publicKey:o}=await he([e.toBuffer(),t.toBuffer(),Buffer.from(n,"utf-8")],e);return o}async function qa({programId:n}){return he([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],n)}async function xn({version:n,marketId:e,baseMint:t,quoteMint:o}){let r=Fa(n),[i,a,u]=[V({publicKey:e}),V({publicKey:t,transformSol:!0}),V({publicKey:o,transformSol:!0})],c=await _e({name:"amm_associated_seed",programId:r,marketId:i}),m=await _e({name:"lp_mint_associated_seed",programId:r,marketId:i}),{publicKey:d,nonce:p}=await qa({programId:r}),b=await _e({name:"coin_vault_associated_seed",programId:r,marketId:i}),f=await _e({name:"pc_vault_associated_seed",programId:r,marketId:i}),y=await _e({name:"temp_lp_token_associated_seed",programId:r,marketId:i}),h=await _e({name:"open_order_associated_seed",programId:r,marketId:i}),L=await _e({name:"target_associated_seed",programId:r,marketId:i}),g=await _e({name:"withdraw_associated_seed",programId:r,marketId:i}),k=Ar(n),_=Tr(k),{publicKey:P}=await xr({programId:_,marketId:i});return{id:c,baseMint:a,quoteMint:u,lpMint:m,version:n,programId:r,authority:d,nonce:p,baseVault:b,quoteVault:f,lpVault:y,openOrders:h,targetOrders:L,withdrawQueue:g,marketVersion:k,marketProgramId:_,marketId:i,marketAuthority:P}}async function Lr({connection:n,pools:e}){let t=e.map(r=>yr(r));return(await co(n,t,"GetPoolData")).map(r=>{let i=mo(r,"GetPoolData"),a=new at(ge(i,"status")),u=Number(ge(i,"coin_decimals")),c=Number(ge(i,"pc_decimals")),m=Number(ge(i,"lp_decimals")),d=new at(ge(i,"pool_coin_amount")),p=new at(ge(i,"pool_pc_amount")),b=new at(ge(i,"pool_lp_supply")),f="0";try{f=ge(i,"pool_open_time")}catch{f="0"}return{status:a,baseDecimals:u,quoteDecimals:c,lpDecimals:m,baseReserve:d,quoteReserve:p,lpSupply:b,startTime:new at(f)}})}function _r(n,e,t){return Na(n.token,e.token,t)}function Na(n,e,t){let{baseMint:o,quoteMint:r}=t,i=Sr(n,t),a=Sr(e,t);return i===a&&In.logWithError("tokens not match with pool","params",{tokenA:n.mint,tokenB:e.mint,baseMint:o,quoteMint:r}),[i,a]}function Sr(n,e){let{baseMint:t,quoteMint:o}=e;return n.mint.equals(t)?"base":n.mint.equals(o)?"quote":(In.logWithError("token not match with pool","params",{token:n.mint,baseMint:t,quoteMint:o}),"base")}var Rr=n=>n==="a"||n==="b";var st=class extends re{constructor(t){super(t);this._poolInfos=[];this._poolInfoMap=new Map;this._pairsInfo=[];this._pairsInfoMap=new Map;this._lpTokenMap=new Map;this._lpPriceMap=new Map;this._officialIds=new Set;this._unOfficialIds=new Set;this._sdkParseInfoCache=new Map;this._stableLayout=new Ft({connection:this.scope.connection})}async load(t){if(await this.scope.fetchLiquidity(t==null?void 0:t.forceUpdate),!this.scope.apiData.liquidityPools)return;let{data:o}=this.scope.apiData.liquidityPools,[r,i]=[o.official||[],o.unOfficial||[]];this._poolInfos=[...r,...i],this._officialIds=new Set(r.map(a=>{var c,m;let u=`${(c=this.scope.token.allTokenMap.get(a.baseMint))==null?void 0:c.symbol} - ${(m=this.scope.token.allTokenMap.get(a.quoteMint))==null?void 0:m.symbol}`;return this._poolInfoMap.set(a.id,a),this._lpTokenMap.set(a.lpMint,new G({mint:a.lpMint,decimals:a.lpDecimals,symbol:u,name:`${u} LP`})),a.id})),this._unOfficialIds=new Set(i.map(a=>{var c,m;let u=`${(c=this.scope.token.allTokenMap.get(a.baseMint))==null?void 0:c.symbol} - ${(m=this.scope.token.allTokenMap.get(a.quoteMint))==null?void 0:m.symbol}`;return this._poolInfoMap.set(a.id,a),this._lpTokenMap.set(a.lpMint,new G({mint:a.lpMint,decimals:a.lpDecimals,symbol:u,name:`${u} LP`})),a.id}))}async loadPairs(t){var o;return await this.scope.fetchPairs(t==null?void 0:t.forceUpdate),this._pairsInfo=((o=this.scope.apiData.liquidityPairsInfo)==null?void 0:o.data)||[],this._pairsInfoMap=new Map(this._pairsInfo.map(r=>{let i=this._lpTokenMap.get(r.lpMint),a=i&&r.lpPrice?$e({token:i,numberPrice:r.lpPrice,decimalDone:!0}):null;return a&&this._lpPriceMap.set(r.lpMint,a),[r.ammId,r]})),this._pairsInfo}get allPools(){return this._poolInfos}get allPoolIdSet(){return{official:this._officialIds,unOfficial:this._unOfficialIds}}get allPoolMap(){return this._poolInfoMap}get allPairs(){return this._pairsInfo}get allPairsMap(){return this._pairsInfoMap}get lpTokenMap(){return this._lpTokenMap}get lpPriceMap(){return this._lpPriceMap}async fetchMultipleInfo(t){return await this._stableLayout.initStableModelLayout(),await Lr(O(S({},t),{connection:this.scope.connection}))}async sdkParseJsonLiquidityInfo(t){if(!t.length)return[];let o=t.map(r=>r.id).join("-");if(this._sdkParseInfoCache.has(o))return this._sdkParseInfoCache.get(o);try{let i=(await this.fetchMultipleInfo({pools:t.map(me)})).map((a,u)=>S(S({jsonInfo:t[u]},me(t[u])),a));return this._sdkParseInfoCache.set(o,i),i}catch(r){return console.error(r),[]}}computeAmountOut({poolKeys:t,poolInfo:o,amountIn:r,outputToken:i,slippage:a}){this.checkDisabled();let u=M("Raydium_computeAmountOut"),c=r.token,m=i;(!Ve(c,t)||!Ve(m,t))&&u.logWithError("token not match with pool","poolKeys",t);let{baseReserve:d,quoteReserve:p}=o;this.logDebug("baseReserve:",d.toString(),"quoteReserve:",p.toString());let b=r.token;this.logDebug("inputToken:",b),this.logDebug("amountIn:",r.toFixed()),this.logDebug("outputToken:",i),this.logDebug("slippage:",`${a.toSignificant()}%`);let f=[d,p],y=An(r,t);y==="quote"&&f.reverse(),this.logDebug("input side:",y);let[h,L]=f,g;if(t.version===4)g=new Q({baseToken:b,denominator:h,quoteToken:i,numerator:L});else{let j=fr(this._stableLayout.stableModelData,d.toNumber(),p.toNumber(),!1);g=new Q({baseToken:b,denominator:y==="quote"?new Ie(j*1e6):new Ie(1e6),quoteToken:i,numerator:y==="quote"?new Ie(1e6):new Ie(j*1e6)})}this.logDebug("currentPrice:",`1 ${b.symbol} \u2248 ${g.toFixed()} ${i.symbol}`),this.logDebug("currentPrice invert:",`1 ${i.symbol} \u2248 ${g.invert().toFixed()} ${b.symbol}`);let k=r.raw,_=ae,P=ae;if(!k.isZero())if(t.version===4){P=k.mul(rr).div(ir);let j=k.sub(P),ne=h.add(j);_=L.mul(j).div(ne)}else{P=k.mul(new Ie(2)).div(new Ie(1e4));let j=k.sub(P),ne=y==="quote"?dr:pr;_=new Ie(ne(this._stableLayout.stableModelData,p.toNumber(),d.toNumber(),j.toNumber()))}let N=new oe(pe).add(a).invert().mul(_).quotient,v=new F(i,_),$=new F(i,N);this.logDebug("amountOut:",v.toFixed(),"minAmountOut:",$.toFixed());let E=new Q({baseToken:b,denominator:k.sub(P),quoteToken:i,numerator:_});!k.isZero()&&!_.isZero()&&(E=new Q({baseToken:b,denominator:k.sub(P),quoteToken:i,numerator:_}),this.logDebug("executionPrice:",`1 ${b.symbol} \u2248 ${E.toFixed()} ${i.symbol}`),this.logDebug("executionPrice invert:",`1 ${i.symbol} \u2248 ${E.invert().toFixed()} ${b.symbol}`));let U=new oe(parseInt(String(Math.abs(parseFloat(E.toFixed())-parseFloat(g.toFixed()))*1e9)),parseInt(String(parseFloat(g.toFixed())*1e9))),X=new F(b,P);return{amountOut:v,minAmountOut:$,currentPrice:g,executionPrice:E,priceImpact:U,fee:X}}async computePairAmount({poolId:t,amount:o,anotherToken:r,slippage:i}){let a=V({publicKey:t}),u=this._poolInfoMap.get(a.toBase58());u||this.logAndCreateError("pool not found",a.toBase58());let c=(await this.sdkParseJsonLiquidityInfo([u]))[0];c||this.logAndCreateError("pool parseInfo not found",a.toBase58());let{baseReserve:m,quoteReserve:d}=c;this.logDebug("baseReserve:",m.toString(),"quoteReserve:",d.toString());let p=o.token;this.logDebug("tokenIn:",p,"amount:",o.toFixed(),"anotherToken:",r,"slippage:",`${i.toSignificant()}%`);let b=An(o,me(u));this.logDebug("input side:",b);let f=ae;o.isZero()||(f=b==="base"?Ut(o.raw.mul(d),m):Ut(o.raw.mul(m),d));let h=new oe(pe).add(i).mul(f).quotient,L=new F(r,f),g=new F(r,h);return this.logDebug("anotherAmount:",L.toFixed(),"maxAnotherAmount:",g.toFixed()),{anotherAmount:L,maxAnotherAmount:g}}async swapWithAMM(t){let{poolKeys:o,payer:r,amountIn:i,amountOut:a,fixedSide:u,config:c}=t;this.logDebug("amountIn:",i),this.logDebug("amountOut:",a),(i.isZero()||a.isZero())&&this.logAndCreateError("amounts must greater than zero","amounts",{amountIn:i.toFixed(),amountOut:a.toFixed()});let{account:m}=this.scope,d=this.createTxBuilder(),{bypassAssociatedCheck:p=!1}=c||{},[b,f]=[i.token,a.token],y=await m.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1}),h=await m.getCreatedTokenAccount({mint:f.mint}),[L,g]=[i.raw,a.raw],N=await m.handleTokenAccount({side:"in",amount:L,mint:b.mint,tokenAccount:y,bypassAssociatedCheck:p}),{tokenAccount:k}=N,_=ee(N,["tokenAccount"]);d.addInstruction(_);let v=await m.handleTokenAccount({side:"out",amount:0,mint:f.mint,tokenAccount:h,payer:r,bypassAssociatedCheck:p}),{tokenAccount:P}=v,q=ee(v,["tokenAccount"]);return d.addInstruction(q),d.addInstruction({instructions:[br({poolKeys:o,userKeys:{tokenAccountIn:k,tokenAccountOut:P,owner:this.scope.ownerPubKey},amountIn:L,amountOut:g,fixedSide:u})]}),d.buildMultiTx({extInfo:{amountOut:a}})}async createPool(t){this.checkDisabled(),this.scope.checkOwner(),t.version!==4&&this.logAndCreateError("invalid version","poolKeys.version",t.version);let o=this.createTxBuilder(),r=await xn(t);return await o.addInstruction({instructions:[gr(O(S({},r),{owner:this.scope.ownerPubKey}))]}).build()}async initPool(t){t.version!==4&&this.logAndCreateError("invalid version","poolKeys.version",t.version);let{baseAmount:o,quoteAmount:r,startTime:i=0,config:a}=t,u=await xn(t),{baseMint:c,quoteMint:m,lpMint:d,baseVault:p,quoteVault:b}=u,f=this.createTxBuilder(),{account:y}=this.scope,h=!!(a!=null&&a.bypassAssociatedCheck),L=await y.getCreatedTokenAccount({mint:c,associatedOnly:!1}),g=await y.getCreatedTokenAccount({mint:m,associatedOnly:!1});!L&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",y.tokenAccounts);let k=await y.getCreatedTokenAccount({mint:d,associatedOnly:!1}),E=await y.handleTokenAccount({side:"in",amount:o.raw,mint:c,tokenAccount:L,bypassAssociatedCheck:h}),{tokenAccount:_}=E,P=ee(E,["tokenAccount"]);f.addInstruction(P);let U=await y.handleTokenAccount({side:"in",amount:r.raw,mint:m,tokenAccount:g,bypassAssociatedCheck:h}),{tokenAccount:q}=U,N=ee(U,["tokenAccount"]);f.addInstruction(N);let X=await y.handleTokenAccount({side:"out",amount:0,mint:d,tokenAccount:k,bypassAssociatedCheck:h}),{tokenAccount:v}=X,$=ee(X,["tokenAccount"]);return f.addInstruction($),f.addInstruction({instructions:[Ke({source:_,destination:p,owner:this.scope.ownerPubKey,amount:o.raw}),Ke({source:q,destination:b,owner:this.scope.ownerPubKey,amount:r.raw}),hr({poolKeys:u,userKeys:{lpTokenAccount:v,payer:this.scope.ownerPubKey},startTime:i})]}),await f.build()}async addLiquidity(t){let{poolId:o,amountInA:r,amountInB:i,fixedSide:a,config:u}=t,c=V({publicKey:o}),m=this.allPools.find(ft=>ft.id===c.toBase58());m||this.logAndCreateError("pool not found",o);let p=(await this.sdkParseJsonLiquidityInfo([m]))[0];p||this.logAndCreateError("pool parse error",p),this.logDebug("amountInA:",r,"amountInB:",i),(r.isZero()||i.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:i.toFixed()});let{account:b}=this.scope,f=(u==null?void 0:u.bypassAssociatedCheck)||!1,[y,h]=[r.token,i.token],L=await b.getCreatedTokenAccount({mint:y.mint,associatedOnly:!1}),g=await b.getCreatedTokenAccount({mint:h.mint,associatedOnly:!1});!L&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",b.tokenAccounts);let k=await b.getCreatedTokenAccount({mint:p.lpMint}),_=[y,h],P=[L,g],q=[r.raw,i.raw],[N]=_r(r,i,p),v="base";(!["quote","base"].includes(N)||!Rr(a))&&this.logAndCreateError("invalid fixedSide","fixedSide",a),N==="quote"?(_.reverse(),P.reverse(),q.reverse(),v=a==="a"?"quote":"base"):N==="base"&&(v=a==="a"?"base":"quote");let[$,E]=_,[U,X]=P,[j,ne]=q,ie=this.createTxBuilder(),Ce=await b.handleTokenAccount({side:"in",amount:j,mint:$.mint,tokenAccount:U,bypassAssociatedCheck:f}),{tokenAccount:Ae}=Ce,ce=ee(Ce,["tokenAccount"]);ie.addInstruction(ce);let We=await b.handleTokenAccount({side:"in",amount:ne,mint:E.mint,tokenAccount:X,bypassAssociatedCheck:f}),{tokenAccount:fe}=We,de=ee(We,["tokenAccount"]);ie.addInstruction(de);let Ue=await b.handleTokenAccount({side:"out",amount:0,mint:p.lpMint,tokenAccount:k,bypassAssociatedCheck:f}),{tokenAccount:dt}=Ue,pt=ee(Ue,["tokenAccount"]);return ie.addInstruction(pt),ie.addInstruction({instructions:[wr({poolKeys:p,userKeys:{baseTokenAccount:Ae,quoteTokenAccount:fe,lpTokenAccount:dt,owner:this.scope.ownerPubKey},baseAmountIn:j,quoteAmountIn:ne,fixedSide:v})]}),await ie.build()}async removeLiquidity(t){let{poolId:o,amountIn:r,config:i}=t,a=V({publicKey:o}),u=this.allPools.find(E=>E.id===a.toBase58());u||this.logAndCreateError("pool not found",o);let m=(await this.sdkParseJsonLiquidityInfo([u]))[0];m||this.logAndCreateError("pool pass error",m);let{baseMint:d,quoteMint:p,lpMint:b}=m;this.logDebug("amountIn:",r),r.isZero()&&this.logAndCreateError("amount must greater than zero","amountIn",r.toFixed()),r.token.mint.equals(b)||this.logAndCreateError("amountIn's token not match lpMint","amountIn",r);let{account:f}=this.scope,y=await f.getCreatedTokenAccount({mint:b,associatedOnly:!1});y||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",f.tokenAccounts);let h=await f.getCreatedTokenAccount({mint:d}),L=await f.getCreatedTokenAccount({mint:p}),g=this.createTxBuilder(),k=(i==null?void 0:i.bypassAssociatedCheck)||!1,v=await f.handleTokenAccount({side:"out",amount:0,mint:d,tokenAccount:h,bypassAssociatedCheck:k}),{tokenAccount:_}=v,P=ee(v,["tokenAccount"]);g.addInstruction(P);let $=await f.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:L,bypassAssociatedCheck:k}),{tokenAccount:q}=$,N=ee($,["tokenAccount"]);return g.addInstruction(N),g.addInstruction({instructions:[va.requestUnits({units:4e5,additionalFee:0}),kr({poolKeys:m,userKeys:{lpTokenAccount:y,baseTokenAccount:_,quoteTokenAccount:q,owner:this.scope.ownerPubKey},amountIn:r.raw})]}),await g.build()}lpMintToTokenAmount({poolId:t,amount:o,decimalDone:r}){let i=V({publicKey:t});i||this.logAndCreateError("pool not found");let a=this._poolInfoMap.get(i.toBase58()),u=se(o),c=new G({mint:a.lpMint,decimals:a.lpDecimals}),m=r?new T(u.numerator,u.denominator):new T(u.numerator,u.denominator).mul(new Ie(10).pow(new Ie(c.decimals)));return new F(c,Te(m))}getFixedSide({poolId:t,inputMint:o}){let[r,i]=[V({publicKey:t}),V({publicKey:o})],a=this._poolInfoMap.get(r.toBase58());a||this.logAndCreateError("pool not found",r.toBase58());let u=a.baseMint===i.toBase58();return(i.equals(xe)||i.equals(W))&&(u=!u),u?"a":"b"}};import{PublicKey as vr}from"@solana/web3.js";import{intersection as Dr,xor as Wa}from"lodash";import{PublicKey as Da}from"@solana/web3.js";var Ea="routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS",ut=new Da(Ea),Mr=["amm","serum","route"],Br=[Xn,At,xe,to,Zn,no,oo,eo,ro].map(n=>n.toBase58());import{TOKEN_PROGRAM_ID as Dt}from"@solana/spl-token";import{SystemProgram as Or,TransactionInstruction as Fr}from"@solana/web3.js";var Nt=R([D("instruction"),l("amountIn"),l("amountOut")]),vt=R([D("instruction")]);var Ka=M("Raydium_route_instruction");function qr(n){let{fixedSide:e}=n;if(e==="in")return[Va(n),Ca(n)];throw Ka.logWithError("invalid params","params",n),new Error(`invalid params, params: ${n}`)}function Va({fromPoolKeys:n,toPoolKeys:e,userKeys:t,amountIn:o,amountOut:r}){let i=Buffer.alloc(Nt.span),a;return n.version===4?(Nt.encode({instruction:0,amountIn:x(o),amountOut:x(r)},i),a=[s({pubkey:Or.programId,isWritable:!1}),s({pubkey:Dt,isWritable:!1}),s({pubkey:n.programId,isWritable:!1}),s({pubkey:n.id}),s({pubkey:e.id,isWritable:!1}),s({pubkey:n.authority,isWritable:!1}),s({pubkey:n.openOrders}),s({pubkey:n.baseVault}),s({pubkey:n.quoteVault}),s({pubkey:n.marketProgramId,isWritable:!1}),s({pubkey:n.marketId}),s({pubkey:n.marketBids}),s({pubkey:n.marketAsks}),s({pubkey:n.marketEventQueue}),s({pubkey:n.marketBaseVault}),s({pubkey:n.marketQuoteVault}),s({pubkey:n.marketAuthority,isWritable:!1}),s({pubkey:t.inTokenAccount}),s({pubkey:t.middleTokenAccount}),s({pubkey:t.middleStatusAccount}),s({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(Nt.encode({instruction:2,amountIn:x(o),amountOut:x(r)},i),a=[s({pubkey:Or.programId,isWritable:!1}),s({pubkey:Dt,isWritable:!1}),s({pubkey:n.programId,isWritable:!1}),s({pubkey:n.id}),s({pubkey:e.id,isWritable:!1}),s({pubkey:n.authority,isWritable:!1}),s({pubkey:n.openOrders}),s({pubkey:n.baseVault}),s({pubkey:n.quoteVault}),s({pubkey:ke,isWritable:!1}),s({pubkey:n.marketProgramId,isWritable:!1}),s({pubkey:n.marketId}),s({pubkey:n.marketBids}),s({pubkey:n.marketAsks}),s({pubkey:n.marketEventQueue}),s({pubkey:n.id}),s({pubkey:n.id}),s({pubkey:n.id}),s({pubkey:t.inTokenAccount}),s({pubkey:t.middleTokenAccount}),s({pubkey:t.middleStatusAccount}),s({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new Fr({programId:ut,keys:a,data:i})}function Ca({fromPoolKeys:n,toPoolKeys:e,userKeys:t}){let o=Buffer.alloc(vt.span),r;return e.version===4?(vt.encode({instruction:1},o),r=[s({pubkey:Dt,isWritable:!1}),s({pubkey:e.programId,isWritable:!1}),s({pubkey:n.id,isWritable:!1}),s({pubkey:e.id}),s({pubkey:e.authority,isWritable:!1}),s({pubkey:e.openOrders}),s({pubkey:e.baseVault}),s({pubkey:e.quoteVault}),s({pubkey:e.marketProgramId,isWritable:!1}),s({pubkey:e.marketId}),s({pubkey:e.marketBids}),s({pubkey:e.marketAsks}),s({pubkey:e.marketEventQueue}),s({pubkey:e.marketBaseVault}),s({pubkey:e.marketQuoteVault}),s({pubkey:e.marketAuthority,isWritable:!1}),s({pubkey:t.middleTokenAccount}),s({pubkey:t.outTokenAccount}),s({pubkey:t.middleStatusAccount}),s({pubkey:t.owner,isWritable:!1,isSigner:!0})]):(vt.encode({instruction:3},o),r=[s({pubkey:Dt,isWritable:!1}),s({pubkey:e.programId,isWritable:!1}),s({pubkey:n.id,isWritable:!1}),s({pubkey:e.id}),s({pubkey:e.authority,isWritable:!1}),s({pubkey:e.openOrders}),s({pubkey:e.baseVault}),s({pubkey:e.quoteVault}),s({pubkey:ke,isWritable:!1}),s({pubkey:e.marketProgramId,isWritable:!1}),s({pubkey:e.marketId}),s({pubkey:e.marketBids}),s({pubkey:e.marketAsks}),s({pubkey:e.marketEventQueue}),s({pubkey:e.id}),s({pubkey:e.id}),s({pubkey:e.id}),s({pubkey:t.middleTokenAccount}),s({pubkey:t.outTokenAccount}),s({pubkey:t.middleStatusAccount}),s({pubkey:t.owner,isWritable:!1,isSigner:!0})]),new Fr({programId:ut,keys:r,data:o})}async function Nr({programId:n,fromPoolId:e,middleMint:t,owner:o}){let{publicKey:r}=await he([e.toBuffer(),t.toBuffer(),o.toBuffer()],n);return r}var ct=class extends re{constructor(e){super(e)}computeRouteAmountOut({fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:o,toPoolInfo:r,amountIn:i,outputToken:a,slippage:u}){let{swap:c}=Tn(o),{swap:m}=Tn(r);(!c||!m)&&this.logAndCreateError("pools swap not enabled","pools",{fromPoolKeys:e,toPoolKeys:t,fromPoolInfo:o,toPoolInfo:r});let d=i.token,p=a;(!Ve(d,e)||!Ve(p,t))&&this.logAndCreateError("pools cannot be routed","pools",{fromPoolKeys:e,toPoolKeys:t});let b=[e.baseMint.toBase58(),e.quoteMint.toBase58()],f=[t.baseMint.toBase58(),t.quoteMint.toBase58()],y=[...b,...f],h=[o.baseDecimals,o.quoteDecimals,r.baseDecimals,r.quoteDecimals],[L,g]=[d.mint.toBase58(),p.mint.toBase58()],k=Wa(b,f);(k.length!==2||!k.includes(L)||!k.includes(g))&&this.logAndCreateError("xor tokens not match","pools",{fromPoolKeys:e,toPoolKeys:t});let _=Dr(b,f);_.length!==1&&this.logAndCreateError("cannot found middle token of two pools","pools",{fromPoolKeys:e,toPoolKeys:t});let P=_[0],q=y.indexOf(P);q===-1&&this.logAndCreateError("cannot found middle token","pools",{fromPoolKeys:e,toPoolKeys:t});let N=h[q],v=new vr(P),$=new G({mint:v,decimals:N});this.logInfo("from pool:",e),this.logInfo("to pool:",t),this.logInfo("intersection mints:",_),this.logInfo("xor mints:",k),this.logInfo("middleMint:",P);let{minAmountOut:E,priceImpact:U,fee:X}=this.scope.liquidity.computeAmountOut({poolKeys:e,poolInfo:o,amountIn:i,outputToken:$,slippage:u}),{amountOut:j,minAmountOut:ne,priceImpact:ie,fee:Ae}=this.scope.liquidity.computeAmountOut({poolKeys:t,poolInfo:r,amountIn:E,outputToken:a,slippage:u}),ce=null,[fe,de]=[i.raw,j.raw];return!fe.isZero()&&!de.isZero()&&(ce=new Q({baseToken:d,denominator:fe,quoteToken:a,numerator:de}),this.logDebug("executionPrice:",`1 ${d.symbol} \u2248 ${ce.toFixed()} ${a.symbol}`),this.logDebug("executionPrice invert:",`1 ${a.symbol} \u2248 ${ce.invert().toFixed()} ${d.symbol}`)),{amountOut:j,minAmountOut:ne,executionPrice:ce,priceImpact:U.add(ie),fee:[X,Ae]}}async swapWithRoute(e){let{fromPoolKeys:t,toPoolKeys:o,amountIn:r,amountOut:i,fixedSide:a,config:u}=e;this.logDebug("amountIn:",r,"amountOut:",i),(r.isZero()||i.isZero())&&this.logAndCreateError("amounts must greater than zero","amounts",{amountIn:r.toFixed(),amountOut:i.toFixed()});let{account:c}=this.scope,{bypassAssociatedCheck:m=!1}=u||{},[d,p]=[r.token,i.token],b=await this.scope.account.getCreatedTokenAccount({mint:d.mint,associatedOnly:!1}),f=await this.scope.account.getCreatedTokenAccount({mint:p.mint}),y=[t.baseMint.toBase58(),t.quoteMint.toBase58()],h=[o.baseMint.toBase58(),o.quoteMint.toBase58()],g=Dr(y,h)[0],k=new vr(g),_=await this.scope.account.getCreatedTokenAccount({mint:k}),[P,q]=[r.raw,i.raw],N=this.createTxBuilder(),v=this.createTxBuilder(),ce=await c.handleTokenAccount({side:"in",amount:P,mint:d.mint,tokenAccount:b,bypassAssociatedCheck:m,skipCloseAccount:!0}),{tokenAccount:$}=ce,E=ee(ce,["tokenAccount"]);N.addInstruction(E);let fe=await c.handleTokenAccount({side:"out",amount:0,mint:p.mint,tokenAccount:f,bypassAssociatedCheck:m,skipCloseAccount:!0}),{tokenAccount:U}=fe,X=ee(fe,["tokenAccount"]);N.addInstruction(X);let de=await c.handleTokenAccount({side:"in",amount:0,mint:k,tokenAccount:_,bypassAssociatedCheck:m,skipCloseAccount:!0}),{tokenAccount:j}=de,ne=ee(de,["tokenAccount"]);N.addInstruction(ne),v.addInstruction({instructions:qr({fromPoolKeys:t,toPoolKeys:o,userKeys:{inTokenAccount:$,outTokenAccount:U,middleTokenAccount:j,middleStatusAccount:await Nr({programId:ut,fromPoolId:t.id,middleMint:k,owner:this.scope.ownerPubKey}),owner:this.scope.ownerPubKey},amountIn:P,amountOut:q,fixedSide:a})});let ie=N.build();return await v.buildMultiTx({extraPreBuildData:[ie],extInfo:{amountOut:q}})}};import{PublicKey as Ga}from"@solana/web3.js";import Kr from"bn.js";var Ua=R([Fe("mintAuthorityOption"),w("mintAuthority"),l("supply"),D("decimals"),D("isInitialized"),Fe("freezeAuthorityOption"),w("freezeAuthority")]);function Er(n,e){return n.sort((t,o)=>{let{official:r,unOfficial:i}=e,a=new Set(r),u=new Set(i),c=p=>a.has(p.mint)?1:u.has(p.mint)?2:3,m=c(t)-c(o),d=p=>!/^[a-zA-Z]/.test(p);if(m===0){let p=d(t.symbol),b=d(o.symbol);return p&&!b?1:!p&&b?-1:t.symbol.localeCompare(o.symbol)}else return m})}var mt=class extends re{constructor(t){super(t);this._tokens=[];this._tokenMap=new Map;this._tokenPrice=new Map;this._mintList={official:[],unOfficial:[],unNamed:[]}}async load(t){this.checkDisabled(),await this.scope.fetchTokens(t==null?void 0:t.forceUpdate),this._mintList={official:[],unOfficial:[],unNamed:[]},this._tokens=[],this._tokenMap=new Map;let{data:o}=this.scope.apiData.tokens||{data:{official:[],unOfficial:[],unNamed:[],blacklist:[]}},r=new Set(o.blacklist);[o.official,o.unOfficial,o.unNamed].forEach((i,a)=>{i.forEach(u=>{let c=["official","unOfficial","unNamed"][a];!r.has(u.mint)&&u.mint!==W.toBase58()&&(this._tokens.push(O(S({},u),{symbol:u.symbol||"",name:u.name||""})),this._mintList[c].push(u.mint))})}),this._mintList.official.push(Qe.mint.toBase58()),this._tokens=Er(this._tokens,this._mintList),this._tokens.push(O(S({},Qe),{mint:W.toBase58()})),this._tokens.forEach(i=>{this._tokenMap.set(i.mint,O(S({},i),{id:i.mint}))}),this._tokenMap.set(Y.mint,O(S({},Y),{icon:Qe.icon,id:"wsol"})),this._tokenMap.set(W.toBase58(),O(S({},Qe),{mint:W.toBase58()}))}get allTokens(){return this._tokens}get allTokenMap(){return this._tokenMap}get tokenMints(){return this._mintList}get tokenPrices(){return this._tokenPrice}async fetchTokenPrices(t){let o=this.allTokens.filter(m=>{var d;return!!((d=m.extensions)!=null&&d.coingeckoId)&&m.mint!==Ga.default.toBase58()}),r=o.map(m=>m.extensions.coingeckoId),i=await this.scope.api.getCoingeckoPrice(r),a=o.reduce((m,d)=>i[d.extensions.coingeckoId].usd?O(S({},m),{[d.mint]:$e({token:this._tokenMap.get(d.mint),numberPrice:i[d.extensions.coingeckoId].usd,decimalDone:!0})}):m,{}),u=t||await this.scope.api.getRaydiumTokenPrice(),c=Object.keys(u).reduce((m,d)=>this._tokenMap.get(d)?O(S({},m),{[d]:$e({token:this._tokenMap.get(d),numberPrice:u[d],decimalDone:!0})}):m,{});return this._tokenPrice=new Map([...Object.entries(a),...Object.entries(c)]),this._tokenPrice}mintToToken(t){let o=V({publicKey:t,transformSol:!0}),r=this.allTokenMap.get(o.toBase58());r||this.logAndCreateError("token not found, mint:",o.toBase58());let{decimals:i,name:a,symbol:u}=r;return new G({mint:t,decimals:i,name:a,symbol:u})}mintToTokenAmount({mint:t,amount:o,decimalDone:r}){let i=this.mintToToken(t);return r?new F(i,x(o)):new F(i,this.decimalAmount({mint:t,amount:o,decimalDone:r}))}decimalAmount({mint:t,amount:o}){let r=se(o),i=this.mintToToken(t);return Te(new T(r.numerator,r.denominator).mul(new Kr(10**i.decimals)))}uiAmount({mint:t,amount:o}){let r=se(o),i=this.mintToToken(t);return i?new T(r.numerator,r.denominator).div(new Kr(10**i.decimals)).toSignificant(i.decimals):""}};function Vr(n){let e=[];for(let t=0;t<n.length;t++)for(let o=0;o<n.length;o++)t!=o&&e.push([n[t],n[o]]);return e}var lt=class extends re{async load(){this.checkDisabled(),await this.scope.fetchLiquidity()}async _getBestSwapPool({availablePools:e,officialPoolIdSet:t}){if(e.length===0)return;if(e.length===1)return e[0];let o=e.filter(a=>t.has(a.id));return o.length===1?o[0]:(await this.scope.liquidity.sdkParseJsonLiquidityInfo(o.length?o:e)).reduce((a,u)=>{let c=a.version===5,m=u.version===5;return c&&!m?a:!c&&m?u:fo(Ht(a.lpSupply,10**a.lpDecimals),Ht(u.lpSupply,10**u.lpDecimals))?a:u}).jsonInfo}async getAvailablePools(e){this.checkDisabled();let{inputMint:t,outputMint:o}=e,[r,i]=[V({publicKey:t,transformSol:!0}).toBase58(),V({publicKey:o,transformSol:!0}).toBase58()],a=this.scope.liquidity.allPools.filter(p=>p.baseMint===r&&p.quoteMint===i||p.baseMint===i&&p.quoteMint===r),u=new Set([...Br,r,i]),c=new Set(JSON.parse(JSON.stringify([...u])));c.delete(r),c.delete(i);let m=this.scope.liquidity.allPools.filter(p=>{let b=u.has(p.baseMint)&&u.has(p.quoteMint),f=c.has(p.baseMint)&&c.has(p.quoteMint);return b&&!f}),d=await this._getBestSwapPool({availablePools:a,officialPoolIdSet:this.scope.liquidity.allPoolIdSet.official});return{availablePools:a,best:d,routedPools:m}}async getBestAmountOut({pools:e,amountIn:t,inputToken:o,outputToken:r,slippage:i,features:a}){if(this.checkDisabled(),!e){let{routedPools:_}=await this.getAvailablePools({inputMint:o.mint,outputMint:r.mint});e=_}let u=await this.scope.liquidity.sdkParseJsonLiquidityInfo(e||[]),c=(e||[]).map((_,P)=>({poolKeys:me(_),poolInfo:u[P]})),m=a||Mr;this.logDebug("features:",m),c.length||this.logAndCreateError("please provide at least one source of trade or (inputMint & outputMint)",c);let d=[],p="amm",b=new F(o,t),f=new F(r,0),y=f,h=null,L=null,g=new oe(ae),k=[];if(m.includes("amm"))for(let{poolKeys:_,poolInfo:P}of c)try{let{amountOut:q,minAmountOut:N,currentPrice:v,executionPrice:$,priceImpact:E,fee:U}=this.scope.liquidity.computeAmountOut({poolKeys:_,poolInfo:P,amountIn:b,outputToken:r,slippage:i});q.gt(f)&&(console.log("amm",P),d=[{source:"amm",keys:_}],p="amm",f=q,y=N,h=v,L=$,g=E,k=[U])}catch{}if(m.includes("route")){let _=Vr(c);for(let P of _){if(P.length!==2)continue;let[q,N]=P,{poolKeys:v,poolInfo:$}=q,{poolKeys:E,poolInfo:U}=N;try{let{amountOut:X,minAmountOut:j,executionPrice:ne,priceImpact:ie,fee:Ae}=this.scope.route.computeRouteAmountOut({fromPoolKeys:v,toPoolKeys:E,fromPoolInfo:$,toPoolInfo:U,amountIn:b,outputToken:r,slippage:i});X.gt(f)&&(d=[{source:"amm",keys:v},{source:"amm",keys:E}],p="route",f=X,y=j,L=ne,g=ie,k=Ae)}catch{}}}return{routes:d,routeType:p,amountOut:f,minAmountOut:y,fixedSide:"in",currentPrice:h,executionPrice:L,priceImpact:g,fee:k}}async directSwap(e){this.checkDisabled();let{amountOut:t,amountIn:o,slippage:r,config:i}=e,a=o.token,u=t.token,{routes:c,routeType:m,minAmountOut:d}=await this.getBestAmountOut({inputToken:a,outputToken:u,amountIn:o.raw,slippage:r});return await this.swap({routes:c,routeType:m,amountIn:o,amountOut:d,fixedSide:"in",config:i})}async swap(e){this.checkDisabled(),this.scope.checkOwner();let{routes:t,routeType:o,amountIn:r,amountOut:i,fixedSide:a,config:u}=e;if(o==="amm"&&t.length===1)return await this.scope.liquidity.swapWithAMM({poolKeys:t[0].keys,amountIn:r,amountOut:i,fixedSide:a,config:u});if(o==="route"&&t.length===2)return await this.scope.route.swapWithRoute({fromPoolKeys:t[0].keys,toPoolKeys:t[1].keys,amountIn:r,amountOut:i,fixedSide:a,config:u});throw this.logAndCreateError("invalid routes with routeType","routes",{routeType:o,routes:t}),new Error("invalid routes with routeType")}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(xe));return e.sort((t,o)=>t.isAssociated?1:o.isAssociated||t.amount.lt(o.amount)?-1:1),e}async unWrapWSol(e){let t=await this.getWSolAccounts(),o=this.createTxBuilder(),r=await Le({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:0});o.addInstruction(r);let i=x(e);for(let a=0;a<t.length;a++)i.gte(t[a].amount)?(o.addInstruction({instructions:[qe({tokenAccount:t[a].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey})]}),i.sub(t[a].amount)):(o.addInstruction({instructions:[qe({tokenAccount:t[a].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey})]}),Ke({destination:r.signers[0].publicKey,source:t[a].publicKey,amount:i,owner:this.scope.ownerPubKey}));return o.build()}async wrapWSol(e){let t=await this.getWSolAccounts(),o=this.createTxBuilder(),r=await Le({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return o.addInstruction(r),t.length&&o.addInstruction({instructions:[Ke({destination:t[0].publicKey,source:r.signers[0].publicKey,amount:e,owner:this.scope.ownerPubKey})],endInstructions:[qe({tokenAccount:r.signers[0].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey})]}),o.build()}};var Re={},Et=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:o,owner:r,api:i,defaultApiTokens:a,defaultApiLiquidityPools:u,defaultApiFarmPools:c,defaultApiPairsInfo:m,apiCacheTime:d}=e;this._connection=t,this.cluster=o,this._owner=r?new le(r):void 0,this._signAllTransactions=e.signAllTransactions,this.api=i,this._apiCacheTime=d||5*60*1e3,this.logger=M("Raydium"),this.farm=new it({scope:this,moduleName:"Raydium_Farm"}),this.account=new Ze({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new st({scope:this,moduleName:"Raydium_Liquidity"}),this.token=new mt({scope:this,moduleName:"Raydium_token"}),this.trade=new lt({scope:this,moduleName:"Raydium_trade"}),this.route=new ct({scope:this,moduleName:"Raydium_route"});let p=new Date().getTime(),[b,f,y,h]=[a?{fetched:p,data:a}:Re.tokens,u?{fetched:p,data:u}:Re.liquidityPools,c?{fetched:p,data:c}:Re.farmPools,m?{fetched:p,data:m}:Re.liquidityPairsInfo];this.apiData=S(S(S(S({},b?{tokens:b}:{}),f?{liquidityPools:f}:{}),y?{farmPools:y}:{}),h?{liquidityPairsInfo:h}:{})}static async load(e){let t=$a({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:o,apiRequestTimeout:r}=t,i=new _t({cluster:o,timeout:r}),a=new Et(O(S({},t),{api:i}));return await a.token.load(),await a.liquidity.load(),a}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(Rt);return this._owner.publicKey}setOwner(e){return this._owner=e?new le(e):void 0,this}get connection(){if(!this._connection)throw new Error(wo);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw this.logger.error(Rt),new Error(Rt)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchTokens(e){if(this.apiData.tokens&&!this.isCacheInvalidate(this.apiData.tokens.fetched)&&!e)return this.apiData.tokens.data;let t={fetched:Date.now(),data:await this.api.getTokens()};return this.apiData.tokens=t,Re.tokens=t,t.data}async fetchLiquidity(e){if(this.apiData.liquidityPools&&!this.isCacheInvalidate(this.apiData.liquidityPools.fetched)&&!e)return this.apiData.liquidityPools.data;let t={fetched:Date.now(),data:await this.api.getLiquidityPools()};return this.apiData.liquidityPools=t,Re.liquidityPools=t,t.data}async fetchPairs(e){var o;if(this.apiData.liquidityPairsInfo&&!this.isCacheInvalidate(this.apiData.liquidityPairsInfo.fetched)&&!e)return((o=this.apiData.liquidityPairsInfo)==null?void 0:o.data)||[];let t={fetched:Date.now(),data:await this.api.getPairsInfo()};return this.apiData.liquidityPairsInfo=t,Re.liquidityPairsInfo=t,t.data}async fetchFarms(e){if(this.apiData.farmPools&&!this.isCacheInvalidate(this.apiData.farmPools.fetched)&&!e)return this.apiData.farmPools.data;let t={fetched:Date.now(),data:await this.api.getFarmPools()};return this.apiData.farmPools=t,Re.farmPools=t,t.data}async chainTimeOffset(){let e=await this.connection.getBlockTime(await this.connection.getSlot());return e?(e*1e3,Number((e*1e3-Date.now()).toFixed(0))):0}mintToToken(e){return this.token.mintToToken(e)}mintToTokenAmount(e){return this.token.mintToTokenAmount(e)}decimalAmount(e){return this.token.decimalAmount(e)}uiAmount(e){return this.token.uiAmount(e)}};export{Et as Raydium};
//# sourceMappingURL=raydium.mjs.map