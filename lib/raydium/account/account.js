var Ue=Object.create;var R=Object.defineProperty;var Fe=Object.getOwnPropertyDescriptor;var Me=Object.getOwnPropertyNames,se=Object.getOwnPropertySymbols,ve=Object.getPrototypeOf,ue=Object.prototype.hasOwnProperty,qe=Object.prototype.propertyIsEnumerable;var ae=(n,t,e)=>t in n?R(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,T=(n,t)=>{for(var e in t||(t={}))ue.call(t,e)&&ae(n,e,t[e]);if(se)for(var e of se(t))qe.call(t,e)&&ae(n,e,t[e]);return n};var je=(n,t)=>{for(var e in t)R(n,e,{get:t[e],enumerable:!0})},ce=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Me(t))!ue.call(n,o)&&o!==e&&R(n,o,{get:()=>t[o],enumerable:!(r=Fe(t,o))||r.enumerable});return n};var g=(n,t,e)=>(e=n!=null?Ue(ve(n)):{},ce(t||!n||!n.__esModule?R(e,"default",{value:n,enumerable:!0}):e,n)),He=n=>ce(R({},"__esModule",{value:!0}),n);var at={};je(at,{default:()=>z});module.exports=He(at);var x=require("@solana/spl-token"),Oe=require("@solana/web3.js");var D=require("lodash"),pe=g(require("pino")),le=g(require("pino-pretty")),me={},$e={},ze=(0,le.default)({colorize:!0,levelFirst:!0,translateTime:"SYS:yyyymmdd HH:MM:ss.l"}),Ve=(0,pe.default)({base:null,level:"silent"},ze);function d(n){let t=(0,D.get)(me,n);if(!t){let e=(0,D.get)($e,n);t=Ve.child({name:n},{level:e}),(0,D.set)(me,n,t)}return t.logWithError=(...e)=>{let r=e.map(o=>typeof o=="object"?JSON.stringify(o):o).join(", ");throw new Error(r)},t}var k=require("@solana/web3.js");var ht=d("Raydium_txTool"),F=class{constructor(t){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=t.connection,this.feePayer=t.feePayer,this.signAllTransactions=t.signAllTransactions,this.owner=t.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:t=[],endInstructions:e=[],signers:r=[]}){return this.instructions.push(...t),this.endInstructions.push(...e),this.signers.push(...r),this}build(t){let e=new k.Transaction;return this.allInstructions.length&&e.add(...this.allInstructions),e.feePayer=this.feePayer,{transaction:e,signers:this.signers,execute:async()=>{var o;let r=await de(this.connection);if(e.recentBlockhash=r,(o=this.owner)!=null&&o.isKeyPair)return(0,k.sendAndConfirmTransaction)(this.connection,e,this.signers);if(this.signAllTransactions){this.signers.length&&e.partialSign(...this.signers);let s=await this.signAllTransactions([e]);return await this.connection.sendRawTransaction(s[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:t||{}}}buildMultiTx(t){let{extraPreBuildData:e=[],extInfo:r}=t,{transaction:o}=this.build(r),s=e.filter(m=>m.transaction.instructions.length>0),a=[...s.map(m=>m.transaction),o],p=[...s.map(m=>m.signers),this.signers];return{transactions:a,signers:p,execute:async()=>{var y;let m=await de(this.connection);if((y=this.owner)!=null&&y.isKeyPair)return await Promise.all(a.map(async(S,P)=>(S.recentBlockhash=m,await(0,k.sendAndConfirmTransaction)(this.connection,S,p[P]))));if(this.signAllTransactions){let S=a.map((w,U)=>(w.recentBlockhash=m,p[U].length&&w.partialSign(...p[U]),w)),P=await this.signAllTransactions(S),B=[];for(let w=0;w<P.length;w+=1){let U=await this.connection.sendRawTransaction(P[w].serialize(),{skipPreflight:!0});B.push(U)}return B}throw new Error("please connect wallet first")},extInfo:r||{}}}};async function de(n){var t,e;try{return((e=await((t=n.getLatestBlockhash)==null?void 0:t.call(n)))==null?void 0:e.blockhash)||(await n.getRecentBlockhash()).blockhash}catch{return(await n.getRecentBlockhash()).blockhash}}var V=(...n)=>n.map(t=>{try{return typeof t=="object"?JSON.stringify(t):t}catch{return t}}).join(", "),I=class{constructor({scope:t,moduleName:e}){this.disabled=!1;this.scope=t,this.logger=d(e)}createTxBuilder(t){return this.scope.checkOwner(),new F({connection:this.scope.connection,feePayer:t||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...t){this.logger.debug(V(t))}logInfo(...t){this.logger.info(V(t))}logAndCreateError(...t){let e=V(t);throw new Error(e)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};var fe=require("@solana/web3.js"),ge={symbol:"SOL",name:"Solana",decimals:9},b={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},kt={isQuantumSOL:!0,isLp:!1,official:!0,mint:new fe.PublicKey(b.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};var A=require("@solana/spl-token"),_=require("@solana/web3.js"),Ie=g(require("bn.js"));var nt=require("@solana/web3.js"),rt=g(require("bn.js"));var Ae=g(require("big.js")),tt=g(require("bn.js"));var f=g(require("bn.js"));var M=d("Raydium_bignumber");var Ge=new f.default(0),ye=new f.default(1),Nt=new f.default(2),Lt=new f.default(3),_t=new f.default(5),Je=new f.default(10),he=new f.default(100),Rt=new f.default(1e3),Dt=new f.default(1e4),be=9007199254740991;function h(n){if(n instanceof f.default)return n;if(typeof n=="string"){if(n.match(/^-?[0-9]+$/))return new f.default(n);M.logWithError(`invalid BigNumberish string: ${n}`)}return typeof n=="number"?(n%1&&M.logWithError(`BigNumberish number underflow: ${n}`),(n>=be||n<=-be)&&M.logWithError(`BigNumberish number overflow: ${n}`),new f.default(String(n))):typeof n=="bigint"?new f.default(n.toString()):(M.logWithError(`invalid BigNumberish value: ${n}`),new f.default(0))}var Te=g(require("toformat")),Xe=Te.default,W=Xe;var K=g(require("big.js")),ke=g(require("decimal.js-light"));var v=d("module/fraction"),Y=W(K.default),C=W(ke.default),Qe={[0]:C.ROUND_DOWN,[1]:C.ROUND_HALF_UP,[2]:C.ROUND_UP},et={[0]:K.default.roundDown,[1]:K.default.roundHalfUp,[2]:K.default.roundUp},c=class{constructor(t,e=ye){this.numerator=h(t),this.denominator=h(e)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new c(this.denominator,this.numerator)}add(t){let e=t instanceof c?t:new c(h(t));return this.denominator.eq(e.denominator)?new c(this.numerator.add(e.numerator),this.denominator):new c(this.numerator.mul(e.denominator).add(e.numerator.mul(this.denominator)),this.denominator.mul(e.denominator))}sub(t){let e=t instanceof c?t:new c(h(t));return this.denominator.eq(e.denominator)?new c(this.numerator.sub(e.numerator),this.denominator):new c(this.numerator.mul(e.denominator).sub(e.numerator.mul(this.denominator)),this.denominator.mul(e.denominator))}mul(t){let e=t instanceof c?t:new c(h(t));return new c(this.numerator.mul(e.numerator),this.denominator.mul(e.denominator))}div(t){let e=t instanceof c?t:new c(h(t));return new c(this.numerator.mul(e.denominator),this.denominator.mul(e.numerator))}toSignificant(t,e={groupSeparator:""},r=1){Number.isInteger(t)||v.logWithError(`${t} is not an integer.`),t<=0&&v.logWithError(`${t} is not positive.`),C.set({precision:t+1,rounding:Qe[r]});let o=new C(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(t);return o.toFormat(o.decimalPlaces(),e)}toFixed(t,e={groupSeparator:""},r=1){return Number.isInteger(t)||v.logWithError(`${t} is not an integer.`),t<0&&v.logWithError(`${t} is negative.`),Y.DP=t,Y.RM=et[r]||1,new Y(this.numerator.toString()).div(this.denominator.toString()).toFormat(t,e)}isZero(){return this.numerator.isZero()}};var Vt=d("Raydium_amount"),Yt=W(Ae.default);var q=require("@solana/web3.js");var Be=require("@solana/spl-token"),l=require("@solana/web3.js");function G({pubkey:n,isSigner:t=!1,isWritable:e=!0}){return{pubkey:n,isWritable:e,isSigner:t}}var Xt=[G({pubkey:Be.TOKEN_PROGRAM_ID,isWritable:!1}),G({pubkey:l.SystemProgram.programId,isWritable:!1}),G({pubkey:l.SYSVAR_RENT_PUBKEY,isWritable:!1})];function Ne({publicKey:n,transformSol:t}){if(n instanceof l.PublicKey)return t&&n.equals(E)?Se:n;if(t&&n===E.toBase58())return Se;if(typeof n=="string")try{return new l.PublicKey(n)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}var Zt=new l.PublicKey("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Qt=new l.PublicKey("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),en=new l.PublicKey("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),tn=new l.PublicKey("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),nn=new l.PublicKey("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),rn=new l.PublicKey("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),on=new l.PublicKey("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),sn=new l.PublicKey("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),an=new l.PublicKey("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),un=new l.PublicKey("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),cn=new l.PublicKey("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),Se=new l.PublicKey("So11111111111111111111111111111111111111112"),E=l.PublicKey.default;var J=class{constructor({mint:t,decimals:e,symbol:r="UNKNOWN",name:o="UNKNOWN",skipMint:s=!1}){if(t===E.toBase58()||t instanceof q.PublicKey&&E.equals(t)){this.decimals=b.decimals,this.symbol=b.symbol,this.name=b.name,this.mint=new q.PublicKey(b.mint);return}this.decimals=e,this.symbol=r,this.name=o,this.mint=s?q.PublicKey.default:Ne({publicKey:t})}equals(t){return this===t?!0:this.mint.equals(t.mint)}},N=J;N.WSOL=new J(b);var Z=class{constructor({decimals:t,symbol:e="UNKNOWN",name:r="UNKNOWN"}){this.decimals=t,this.symbol=e,this.name=r}equals(t){return this===t}},X=Z;X.SOL=new Z(ge);var wn=new c(he);var _n=d("Raydium_price");var ot=require("@solana/web3.js");var Xn=d("Raydium_accountInfo_util");var _e=require("@solana/web3.js"),j=g(require("bn.js"));var i=require("@solana/buffer-layout"),Q=i.Layout,Le=i.Structure;var ee=i.UInt;var te=i.blob;var ne=class extends Q{constructor(e,r,o){super(e,o);this.blob=te(e),this.signed=r}decode(e,r=0){let o=new j.default(this.blob.decode(e,r),10,"le");return this.signed?o.fromTwos(this.span*8).clone():o}encode(e,r,o=0){return typeof e=="number"&&(e=new j.default(e)),this.signed&&(e=e.toTwos(this.span*8)),this.blob.encode(e.toArrayLike(Buffer,"le",this.span),r,o)}};function Re(n){return new ee(1,n)}function H(n){return new ee(4,n)}function $(n){return new ne(8,!1,n)}var re=class extends Q{constructor(e,r,o,s){super(e.span,s);this.layout=e,this.decoder=r,this.encoder=o}decode(e,r){return this.decoder(this.layout.decode(e,r))}encode(e,r,o){return this.layout.encode(this.encoder(e),r,o)}getSpan(e,r){return this.layout.getSpan(e,r)}};function O(n){return new re(te(32),t=>new _e.PublicKey(t),t=>t.toBuffer(),n)}var oe=class extends Le{decode(t,e){return super.decode(t,e)}};function De(n,t,e){return new oe(n,t,e)}var L=De([O("mint"),O("owner"),$("amount"),H("delegateOption"),O("delegate"),Re("state"),H("isNativeOption"),$("isNative"),$("delegatedAmount"),H("closeAuthorityOption"),O("closeAuthority")]);function it(n){let{mint:t,tokenAccount:e,owner:r}=n;return(0,A.createInitializeAccountInstruction)(e,t,r)}function ie(n){let{tokenAccount:t,payer:e,multiSigners:r=[],owner:o}=n;return(0,A.createCloseAccountInstruction)(t,e,o,r)}async function We(n){let{connection:t,amount:e,commitment:r,payer:o,owner:s,skipCloseAccount:a}=n,p=await t.getMinimumBalanceForRentExemption(L.span,r),m=h(e).add(new Ie.default(p)),y=_.Keypair.generate();return{signers:[y],instructions:[_.SystemProgram.createAccount({fromPubkey:o,newAccountPubkey:y.publicKey,lamports:m.toNumber(),space:L.span,programId:A.TOKEN_PROGRAM_ID}),it({mint:new _.PublicKey(b.mint),tokenAccount:y.publicKey,owner:s})],endInstructions:a?[]:[ie({tokenAccount:y.publicKey,payer:o,owner:s})]}}var Ke=require("@solana/web3.js"),Ce=g(require("bn.js"));var st=d("Raydium_Util");function Ee({solAccountResp:n,tokenAccountResp:t}){let e=[],r=[];for(let{pubkey:o,account:s}of t.value){if(s.data.length!==L.span)throw st.error("invalid token account layout length","publicKey",o.toBase58()),new Error("invalid token account layout length");let a=L.decode(s.data),{mint:p,amount:m}=a;e.push({publicKey:o,mint:p,amount:m,isNative:!1}),r.push({pubkey:o,accountInfo:a})}return n&&e.push({mint:Ke.PublicKey.default,amount:new Ce.default(n.lamports),isNative:!0}),{tokenAccounts:e,tokenAccountRawInfos:r}}var z=class extends I{constructor(e){super(e);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._ataCache=new Map;this._accountListener=[];this._clientOwnedToken=!1;let{tokenAccounts:r,tokenAccountRawInfos:o}=e;this._tokenAccounts=r||[],this._tokenAccountRawInfos=o||[],this._clientOwnedToken=!!(r||o)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:e,tokenAccountRawInfos:r}){return e&&(this._tokenAccounts=e),r&&(this._tokenAccountRawInfos=r),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(e){return this._accountListener.push(e),this}removeAccountChangeListener(e){return this._accountListener=this._accountListener.filter(r=>r!==e),this}async getAssociatedTokenAccount(e){this.scope.checkOwner();let r=`${this.scope.ownerPubKey.toBase58()}_${e.toBase58()}`;if(this._ataCache.has(r))return this._ataCache.get(r);let o=await(0,x.getAssociatedTokenAddress)(e,this.scope.ownerPubKey,!0);return this._ataCache.set(r,o),o}async fetchWalletTokenAccounts(e){if(this._clientOwnedToken||!(e!=null&&e.forceUpdate)&&this._tokenAccounts.length)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let o=T(T({},{}),e),s=await this.scope.connection.getAccountInfo(this.scope.ownerPubKey,o.commitment),a=await this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:x.TOKEN_PROGRAM_ID},o.commitment),{tokenAccounts:p,tokenAccountRawInfos:m}=Ee({solAccountResp:s,tokenAccountResp:a});return this._tokenAccounts=p,this._tokenAccountRawInfos=m,this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),"confirmed"),{tokenAccounts:p,tokenAccountRawInfos:m}}async getCreatedTokenAccount({mint:e,associatedOnly:r=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(e)).sort((a,p)=>a.amount.lt(p.amount)?1:-1),s=await this.getAssociatedTokenAccount(e);for(let a of o){let{publicKey:p}=a;if(p)return r&&s.equals(p),p}}async checkOrCreateAta({mint:e,autoUnwrapWSOLToSOL:r}){var p;await this.fetchWalletTokenAccounts();let o=(p=this.scope.account.tokenAccounts.find(({mint:m})=>(m==null?void 0:m.toBase58())===e.toBase58()))==null?void 0:p.publicKey,s=this.scope.ownerPubKey,a={};if(!o){let m=await this.getAssociatedTokenAccount(e),y=await(0,x.createAssociatedTokenAccountInstruction)(s,m,s,e);a.instructions=[y],o=m}return r&&b.mint===e.toBase58()&&(a.endInstructions=[ie({owner:s,payer:s,tokenAccount:o})]),{pubKey:o,newInstructions:a}}async handleTokenAccount(e){let{side:r,amount:o,mint:s,tokenAccount:a,payer:p=this.scope.ownerPubKey,bypassAssociatedCheck:m,skipCloseAccount:y}=e,S=this.createTxBuilder(),P=await(0,x.getAssociatedTokenAddress)(s,this.scope.ownerPubKey,!0);if(new Oe.PublicKey(b.mint).equals(s)){let B=await We({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:p,amount:o,skipCloseAccount:y});return S.addInstruction(B),T({tokenAccount:B.signers[0].publicKey},B)}else if(!a||r==="out"&&!P.equals(a)&&!m)return{tokenAccount:P,instructions:[(0,x.createAssociatedTokenAccountInstruction)(this.scope.ownerPubKey,P,this.scope.ownerPubKey,s)]};return{tokenAccount:a}}};0&&(module.exports={});
//# sourceMappingURL=account.js.map