var we=Object.defineProperty;var Z=Object.getOwnPropertySymbols;var Te=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable;var Q=(n,t,e)=>t in n?we(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,x=(n,t)=>{for(var e in t||(t={}))Te.call(t,e)&&Q(n,e,t[e]);if(Z)for(var e of Z(t))ke.call(t,e)&&Q(n,e,t[e]);return n};import{getAssociatedTokenAddress as Pe,createAssociatedTokenAccountInstruction as xe,TOKEN_PROGRAM_ID as at}from"@solana/spl-token";import{PublicKey as ut}from"@solana/web3.js";import{get as ee,set as Ae}from"lodash";import Se from"pino";import Be from"pino-pretty";var te={},Ne={},Le=Be({colorize:!0,levelFirst:!0,translateTime:"SYS:yyyymmdd HH:MM:ss.l"}),_e=Se({base:null,level:"silent"},Le);function l(n){let t=ee(te,n);if(!t){let e=ee(Ne,n);t=_e.child({name:n},{level:e}),Ae(te,n,t)}return t.logWithError=(...e)=>{let r=e.map(o=>typeof o=="object"?JSON.stringify(o):o).join(", ");throw new Error(r)},t}import{PACKET_DATA_SIZE as ht,PublicKey as Pt,sendAndConfirmTransaction as ne,Transaction as Re}from"@solana/web3.js";var St=l("Raydium_txTool"),D=class{constructor(t){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=t.connection,this.feePayer=t.feePayer,this.signAllTransactions=t.signAllTransactions,this.owner=t.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:t=[],endInstructions:e=[],signers:r=[]}){return this.instructions.push(...t),this.endInstructions.push(...e),this.signers.push(...r),this}build(t){let e=new Re;return this.allInstructions.length&&e.add(...this.allInstructions),e.feePayer=this.feePayer,{transaction:e,signers:this.signers,execute:async()=>{var o;let r=await re(this.connection);if(e.recentBlockhash=r,(o=this.owner)!=null&&o.isKeyPair)return ne(this.connection,e,this.signers);if(this.signAllTransactions){this.signers.length&&e.partialSign(...this.signers);let i=await this.signAllTransactions([e]);return await this.connection.sendRawTransaction(i[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:t||{}}}buildMultiTx(t){let{extraPreBuildData:e=[],extInfo:r}=t,{transaction:o}=this.build(r),i=e.filter(m=>m.transaction.instructions.length>0),s=[...i.map(m=>m.transaction),o],p=[...i.map(m=>m.signers),this.signers];return{transactions:s,signers:p,execute:async()=>{var b;let m=await re(this.connection);if((b=this.owner)!=null&&b.isKeyPair)return await Promise.all(s.map(async(w,h)=>(w.recentBlockhash=m,await ne(this.connection,w,p[h]))));if(this.signAllTransactions){let w=s.map((P,R)=>(P.recentBlockhash=m,p[R].length&&P.partialSign(...p[R]),P)),h=await this.signAllTransactions(w),T=[];for(let P=0;P<h.length;P+=1){let R=await this.connection.sendRawTransaction(h[P].serialize(),{skipPreflight:!0});T.push(R)}return T}throw new Error("please connect wallet first")},extInfo:r||{}}}};async function re(n){var t,e;try{return((e=await((t=n.getLatestBlockhash)==null?void 0:t.call(n)))==null?void 0:e.blockhash)||(await n.getRecentBlockhash()).blockhash}catch{return(await n.getRecentBlockhash()).blockhash}}var O=(...n)=>n.map(t=>{try{return typeof t=="object"?JSON.stringify(t):t}catch{return t}}).join(", "),S=class{constructor({scope:t,moduleName:e}){this.disabled=!1;this.scope=t,this.logger=l(e)}createTxBuilder(t){return this.scope.checkOwner(),new D({connection:this.scope.connection,feePayer:t||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...t){this.logger.debug(O(t))}logInfo(...t){this.logger.info(O(t))}logAndCreateError(...t){let e=O(t);throw new Error(e)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as De}from"@solana/web3.js";var oe={symbol:"SOL",name:"Solana",decimals:9},g={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},Dt={isQuantumSOL:!0,isLp:!1,official:!0,mint:new De(g.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};import{createInitializeAccountInstruction as Je,createCloseAccountInstruction as Xe,createTransferInstruction as Yo,TOKEN_PROGRAM_ID as Ze}from"@solana/spl-token";import{Keypair as Qe,PublicKey as et,SystemProgram as tt}from"@solana/web3.js";import nt from"bn.js";import{PublicKey as ir}from"@solana/web3.js";import ar from"bn.js";import ve from"big.js";import en from"bn.js";import f from"bn.js";var I=l("Raydium_bignumber");var We=new f(0),se=new f(1),Et=new f(2),Ot=new f(3),Ut=new f(5),Ke=new f(10),ae=new f(100),Ft=new f(1e3),Mt=new f(1e4),ie=9007199254740991;function y(n){if(n instanceof f)return n;if(typeof n=="string"){if(n.match(/^-?[0-9]+$/))return new f(n);I.logWithError(`invalid BigNumberish string: ${n}`)}return typeof n=="number"?(n%1&&I.logWithError(`BigNumberish number underflow: ${n}`),(n>=ie||n<=-ie)&&I.logWithError(`BigNumberish number overflow: ${n}`),new f(String(n))):typeof n=="bigint"?new f(n.toString()):(I.logWithError(`invalid BigNumberish value: ${n}`),new f(0))}import Ce from"toformat";var Ee=Ce,B=Ee;import K from"big.js";import Ue from"decimal.js-light";var W=l("module/fraction"),U=B(K),N=B(Ue),Fe={[0]:N.ROUND_DOWN,[1]:N.ROUND_HALF_UP,[2]:N.ROUND_UP},Me={[0]:K.roundDown,[1]:K.roundHalfUp,[2]:K.roundUp},c=class{constructor(t,e=se){this.numerator=y(t),this.denominator=y(e)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new c(this.denominator,this.numerator)}add(t){let e=t instanceof c?t:new c(y(t));return this.denominator.eq(e.denominator)?new c(this.numerator.add(e.numerator),this.denominator):new c(this.numerator.mul(e.denominator).add(e.numerator.mul(this.denominator)),this.denominator.mul(e.denominator))}sub(t){let e=t instanceof c?t:new c(y(t));return this.denominator.eq(e.denominator)?new c(this.numerator.sub(e.numerator),this.denominator):new c(this.numerator.mul(e.denominator).sub(e.numerator.mul(this.denominator)),this.denominator.mul(e.denominator))}mul(t){let e=t instanceof c?t:new c(y(t));return new c(this.numerator.mul(e.numerator),this.denominator.mul(e.denominator))}div(t){let e=t instanceof c?t:new c(y(t));return new c(this.numerator.mul(e.denominator),this.denominator.mul(e.numerator))}toSignificant(t,e={groupSeparator:""},r=1){Number.isInteger(t)||W.logWithError(`${t} is not an integer.`),t<=0&&W.logWithError(`${t} is not positive.`),N.set({precision:t+1,rounding:Fe[r]});let o=new N(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(t);return o.toFormat(o.decimalPlaces(),e)}toFixed(t,e={groupSeparator:""},r=1){return Number.isInteger(t)||W.logWithError(`${t} is not an integer.`),t<0&&W.logWithError(`${t} is negative.`),U.DP=t,U.RM=Me[r]||1,new U(this.numerator.toString()).div(this.denominator.toString()).toFormat(t,e)}isZero(){return this.numerator.isZero()}};var cn=l("Raydium_amount"),mn=B(ve);import{PublicKey as M}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as qe}from"@solana/spl-token";import{PublicKey as d,SystemProgram as je,SYSVAR_RENT_PUBKEY as He}from"@solana/web3.js";function F({pubkey:n,isSigner:t=!1,isWritable:e=!0}){return{pubkey:n,isWritable:e,isSigner:t}}var gn=[F({pubkey:qe,isWritable:!1}),F({pubkey:je.programId,isWritable:!1}),F({pubkey:He,isWritable:!1})];function le({publicKey:n,transformSol:t}){if(n instanceof d)return t&&n.equals(L)?pe:n;if(t&&n===L.toBase58())return pe;if(typeof n=="string")try{return new d(n)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}var bn=new d("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),yn=new d("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),hn=new d("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Pn=new d("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),xn=new d("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),wn=new d("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Tn=new d("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),kn=new d("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),An=new d("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Sn=new d("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Bn=new d("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),pe=new d("So11111111111111111111111111111111111111112"),L=d.default;var v=class{constructor({mint:t,decimals:e,symbol:r="UNKNOWN",name:o="UNKNOWN",skipMint:i=!1}){if(t===L.toBase58()||t instanceof M&&L.equals(t)){this.decimals=g.decimals,this.symbol=g.symbol,this.name=g.name,this.mint=new M(g.mint);return}this.decimals=e,this.symbol=r,this.name=o,this.mint=i?M.default:le({publicKey:t})}equals(t){return this===t?!0:this.mint.equals(t.mint)}},k=v;k.WSOL=new v(g);var j=class{constructor({decimals:t,symbol:e="UNKNOWN",name:r="UNKNOWN"}){this.decimals=t,this.symbol=e,this.name=r}equals(t){return this===t}},q=j;q.SOL=new j(oe);var Fn=new c(ae);var Vn=l("Raydium_price");import{PublicKey as hr}from"@solana/web3.js";var wr=l("Raydium_accountInfo_util");import{PublicKey as Ge}from"@solana/web3.js";import fe,{isBN as vo}from"bn.js";import{bits as vr,BitStructure as qr,blob as $e,Blob as jr,cstr as Hr,f32 as $r,f32be as zr,f64 as Vr,f64be as Yr,greedy as Gr,Layout as ze,ns64 as Jr,ns64be as Xr,nu64 as Zr,nu64be as Qr,offset as eo,s16 as to,s16be as no,s24 as ro,s24be as oo,s32 as io,s32be as so,s40 as ao,s40be as uo,s48 as co,s48be as mo,s8 as po,seq as lo,struct as fo,Structure as Ve,u16 as go,u16be as bo,u24 as yo,u24be as ho,u32 as Po,u32be as xo,u40 as wo,u40be as To,u48 as ko,u48be as Ao,u8 as So,UInt as Ye,union as Bo,Union as No,unionLayoutDiscriminator as Lo,utf8 as _o}from"@solana/buffer-layout";var H=ze,de=Ve;var $=Ye;var z=$e;var V=class extends H{constructor(e,r,o){super(e,o);this.blob=z(e),this.signed=r}decode(e,r=0){let o=new fe(this.blob.decode(e,r),10,"le");return this.signed?o.fromTwos(this.span*8).clone():o}encode(e,r,o=0){return typeof e=="number"&&(e=new fe(e)),this.signed&&(e=e.toTwos(this.span*8)),this.blob.encode(e.toArrayLike(Buffer,"le",this.span),r,o)}};function ge(n){return new $(1,n)}function C(n){return new $(4,n)}function E(n){return new V(8,!1,n)}var Y=class extends H{constructor(e,r,o,i){super(e.span,i);this.layout=e,this.decoder=r,this.encoder=o}decode(e,r){return this.decoder(this.layout.decode(e,r))}encode(e,r,o){return this.layout.encode(this.encoder(e),r,o)}getSpan(e,r){return this.layout.getSpan(e,r)}};function _(n){return new Y(z(32),t=>new Ge(t),t=>t.toBuffer(),n)}var G=class extends de{decode(t,e){return super.decode(t,e)}};function be(n,t,e){return new G(n,t,e)}var A=be([_("mint"),_("owner"),E("amount"),C("delegateOption"),_("delegate"),ge("state"),C("isNativeOption"),E("isNative"),E("delegatedAmount"),C("closeAuthorityOption"),_("closeAuthority")]);function rt(n){let{mint:t,tokenAccount:e,owner:r}=n;return Je(e,t,r)}function J(n){let{tokenAccount:t,payer:e,multiSigners:r=[],owner:o}=n;return Xe(t,e,o,r)}async function ye(n){let{connection:t,amount:e,commitment:r,payer:o,owner:i,skipCloseAccount:s}=n,p=await t.getMinimumBalanceForRentExemption(A.span,r),m=y(e).add(new nt(p)),b=Qe.generate();return{signers:[b],instructions:[tt.createAccount({fromPubkey:o,newAccountPubkey:b.publicKey,lamports:m.toNumber(),space:A.span,programId:Ze}),rt({mint:new et(g.mint),tokenAccount:b.publicKey,owner:i})],endInstructions:s?[]:[J({tokenAccount:b.publicKey,payer:o,owner:i})]}}import{PublicKey as ot}from"@solana/web3.js";import it from"bn.js";var st=l("Raydium_Util");function he({solAccountResp:n,tokenAccountResp:t}){let e=[],r=[];for(let{pubkey:o,account:i}of t.value){if(i.data.length!==A.span)throw st.error("invalid token account layout length","publicKey",o.toBase58()),new Error("invalid token account layout length");let s=A.decode(i.data),{mint:p,amount:m}=s;e.push({publicKey:o,mint:p,amount:m,isNative:!1}),r.push({pubkey:o,accountInfo:s})}return n&&e.push({mint:ot.default,amount:new it(n.lamports),isNative:!0}),{tokenAccounts:e,tokenAccountRawInfos:r}}var X=class extends S{constructor(e){super(e);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._ataCache=new Map;this._accountListener=[];this._clientOwnedToken=!1;let{tokenAccounts:r,tokenAccountRawInfos:o}=e;this._tokenAccounts=r||[],this._tokenAccountRawInfos=o||[],this._clientOwnedToken=!!(r||o)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:e,tokenAccountRawInfos:r}){return e&&(this._tokenAccounts=e),r&&(this._tokenAccountRawInfos=r),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(e){return this._accountListener.push(e),this}removeAccountChangeListener(e){return this._accountListener=this._accountListener.filter(r=>r!==e),this}async getAssociatedTokenAccount(e){this.scope.checkOwner();let r=`${this.scope.ownerPubKey.toBase58()}_${e.toBase58()}`;if(this._ataCache.has(r))return this._ataCache.get(r);let o=await Pe(e,this.scope.ownerPubKey,!0);return this._ataCache.set(r,o),o}async fetchWalletTokenAccounts(e){if(this._clientOwnedToken||!(e!=null&&e.forceUpdate)&&this._tokenAccounts.length)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let o=x(x({},{}),e),i=await this.scope.connection.getAccountInfo(this.scope.ownerPubKey,o.commitment),s=await this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:at},o.commitment),{tokenAccounts:p,tokenAccountRawInfos:m}=he({solAccountResp:i,tokenAccountResp:s});return this._tokenAccounts=p,this._tokenAccountRawInfos=m,this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),"confirmed"),{tokenAccounts:p,tokenAccountRawInfos:m}}async getCreatedTokenAccount({mint:e,associatedOnly:r=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:s})=>s==null?void 0:s.equals(e)).sort((s,p)=>s.amount.lt(p.amount)?1:-1),i=await this.getAssociatedTokenAccount(e);for(let s of o){let{publicKey:p}=s;if(p)return r&&i.equals(p),p}}async checkOrCreateAta({mint:e,autoUnwrapWSOLToSOL:r}){var p;await this.fetchWalletTokenAccounts();let o=(p=this.scope.account.tokenAccounts.find(({mint:m})=>(m==null?void 0:m.toBase58())===e.toBase58()))==null?void 0:p.publicKey,i=this.scope.ownerPubKey,s={};if(!o){let m=await this.getAssociatedTokenAccount(e),b=await xe(i,m,i,e);s.instructions=[b],o=m}return r&&g.mint===e.toBase58()&&(s.endInstructions=[J({owner:i,payer:i,tokenAccount:o})]),{pubKey:o,newInstructions:s}}async handleTokenAccount(e){let{side:r,amount:o,mint:i,tokenAccount:s,payer:p=this.scope.ownerPubKey,bypassAssociatedCheck:m,skipCloseAccount:b}=e,w=this.createTxBuilder(),h=await Pe(i,this.scope.ownerPubKey,!0);if(new ut(g.mint).equals(i)){let T=await ye({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:p,amount:o,skipCloseAccount:b});return w.addInstruction(T),x({tokenAccount:T.signers[0].publicKey},T)}else if(!s||r==="out"&&!h.equals(s)&&!m)return{tokenAccount:h,instructions:[xe(this.scope.ownerPubKey,h,this.scope.ownerPubKey,i)]};return{tokenAccount:s}}};export{X as default};
//# sourceMappingURL=account.mjs.map