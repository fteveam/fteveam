var ke=Object.defineProperty;var Q=Object.getOwnPropertySymbols;var Ae=Object.prototype.hasOwnProperty,Le=Object.prototype.propertyIsEnumerable;var ee=(n,e,t)=>e in n?ke(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,x=(n,e)=>{for(var t in e||(e={}))Ae.call(e,t)&&ee(n,t,e[t]);if(Q)for(var t of Q(e))Le.call(e,t)&&ee(n,t,e[t]);return n};import{getAssociatedTokenAddress as we,createAssociatedTokenAccountInstruction as Te,TOKEN_PROGRAM_ID as st}from"@solana/spl-token";import{PublicKey as at}from"@solana/web3.js";import{get as te,set as Be}from"lodash";import re from"dayjs";import Se from"dayjs/plugin/utc";re.extend(Se);var U=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:3,this.name=e.name}set level(e){this.logLevel=e}get time(){return re().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(r=>typeof r=="object"?JSON.stringify(r):r).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},ne={},Ne={};function l(n){let e=te(ne,n);if(!e){let t=te(Ne,n);e=new U({name:n,logLevel:t}),Be(ne,n,e)}return e}import{PACKET_DATA_SIZE as gt,PublicKey as bt,sendAndConfirmTransaction as oe,Transaction as _e}from"@solana/web3.js";var Tt=l("Raydium_txTool"),D=class{constructor(e){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:e=[],endInstructions:t=[],signers:r=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...r),this}build(e){let t=new _e;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,{transaction:t,signers:this.signers,execute:async()=>{var o;let r=await ie(this.connection);if(t.recentBlockhash=r,(o=this.owner)!=null&&o.isKeyPair)return oe(this.connection,t,this.signers);if(this.signAllTransactions){this.signers.length&&t.partialSign(...this.signers);let i=await this.signAllTransactions([t]);return await this.connection.sendRawTransaction(i[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:r}=e,{transaction:o}=this.build(r),i=t.filter(m=>m.transaction.instructions.length>0),s=[...i.map(m=>m.transaction),o],p=[...i.map(m=>m.signers),this.signers];return{transactions:s,signers:p,execute:async()=>{var b;let m=await ie(this.connection);if((b=this.owner)!=null&&b.isKeyPair)return await Promise.all(s.map(async(w,h)=>(w.recentBlockhash=m,await oe(this.connection,w,p[h]))));if(this.signAllTransactions){let w=s.map((P,R)=>(P.recentBlockhash=m,p[R].length&&P.partialSign(...p[R]),P)),h=await this.signAllTransactions(w),T=[];for(let P=0;P<h.length;P+=1){let R=await this.connection.sendRawTransaction(h[P].serialize(),{skipPreflight:!0});T.push(R)}return T}throw new Error("please connect wallet first")},extInfo:r||{}}}};async function ie(n){var e,t;try{return((t=await((e=n.getLatestBlockhash)==null?void 0:e.call(n)))==null?void 0:t.blockhash)||(await n.getRecentBlockhash()).blockhash}catch{return(await n.getRecentBlockhash()).blockhash}}var O=(...n)=>n.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),L=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=l(t)}createTxBuilder(e){return this.scope.checkOwner(),new D({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(O(e))}logInfo(...e){this.logger.info(O(e))}logAndCreateError(...e){let t=O(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as Re}from"@solana/web3.js";var se={symbol:"SOL",name:"Solana",decimals:9},g={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},_t={isQuantumSOL:!0,isLp:!1,official:!0,mint:new Re(g.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};import{createInitializeAccountInstruction as Ge,createCloseAccountInstruction as Je,createTransferInstruction as Yo,TOKEN_PROGRAM_ID as Xe}from"@solana/spl-token";import{Keypair as Ze,PublicKey as Qe,SystemProgram as et}from"@solana/web3.js";import tt from"bn.js";import{PublicKey as rr}from"@solana/web3.js";import ir from"bn.js";import Fe from"big.js";import Zt from"bn.js";import f from"bn.js";var I=l("Raydium_bignumber");var Ie=new f(0),ue=new f(1),Kt=new f(2),Ct=new f(3),Et=new f(5),We=new f(10),ce=new f(100),Ut=new f(1e3),Ot=new f(1e4),ae=9007199254740991;function y(n){if(n instanceof f)return n;if(typeof n=="string"){if(n.match(/^-?[0-9]+$/))return new f(n);I.logWithError(`invalid BigNumberish string: ${n}`)}return typeof n=="number"?(n%1&&I.logWithError(`BigNumberish number underflow: ${n}`),(n>=ae||n<=-ae)&&I.logWithError(`BigNumberish number overflow: ${n}`),new f(String(n))):typeof n=="bigint"?new f(n.toString()):(I.logWithError(`invalid BigNumberish value: ${n}`),new f(0))}import Ke from"toformat";var Ce=Ke,B=Ce;import K from"big.js";import Ue from"decimal.js-light";var W=l("module/fraction"),v=B(K),S=B(Ue),Oe={[0]:S.ROUND_DOWN,[1]:S.ROUND_HALF_UP,[2]:S.ROUND_UP},ve={[0]:K.roundDown,[1]:K.roundHalfUp,[2]:K.roundUp},c=class{constructor(e,t=ue){this.numerator=y(e),this.denominator=y(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new c(this.denominator,this.numerator)}add(e){let t=e instanceof c?e:new c(y(e));return this.denominator.eq(t.denominator)?new c(this.numerator.add(t.numerator),this.denominator):new c(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof c?e:new c(y(e));return this.denominator.eq(t.denominator)?new c(this.numerator.sub(t.numerator),this.denominator):new c(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof c?e:new c(y(e));return new c(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof c?e:new c(y(e));return new c(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},r=1){Number.isInteger(e)||W.logWithError(`${e} is not an integer.`),e<=0&&W.logWithError(`${e} is not positive.`),S.set({precision:e+1,rounding:Oe[r]});let o=new S(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},r=1){return Number.isInteger(e)||W.logWithError(`${e} is not an integer.`),e<0&&W.logWithError(`${e} is negative.`),v.DP=e,v.RM=ve[r]||1,new v(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var an=l("Raydium_amount"),un=B(Fe);import{PublicKey as M}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Me}from"@solana/spl-token";import{PublicKey as d,SystemProgram as qe,SYSVAR_RENT_PUBKEY as je}from"@solana/web3.js";function F({pubkey:n,isSigner:e=!1,isWritable:t=!0}){return{pubkey:n,isWritable:t,isSigner:e}}var dn=[F({pubkey:Me,isWritable:!1}),F({pubkey:qe.programId,isWritable:!1}),F({pubkey:je,isWritable:!1})];function fe({publicKey:n,transformSol:e}){if(n instanceof d)return e&&n.equals(N)?de:n;if(e&&n===N.toBase58())return de;if(typeof n=="string")try{return new d(n)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}var fn=new d("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),gn=new d("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),bn=new d("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),yn=new d("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),hn=new d("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Pn=new d("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),xn=new d("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),wn=new d("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Tn=new d("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),kn=new d("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),An=new d("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),de=new d("So11111111111111111111111111111111111111112"),N=d.default;var q=class{constructor({mint:e,decimals:t,symbol:r="UNKNOWN",name:o="UNKNOWN",skipMint:i=!1}){if(e===N.toBase58()||e instanceof M&&N.equals(e)){this.decimals=g.decimals,this.symbol=g.symbol,this.name=g.name,this.mint=new M(g.mint);return}this.decimals=t,this.symbol=r,this.name=o,this.mint=i?M.default:fe({publicKey:e})}equals(e){return this===e?!0:this.mint.equals(e.mint)}},k=q;k.WSOL=new q(g);var H=class{constructor({decimals:e,symbol:t="UNKNOWN",name:r="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=r}equals(e){return this===e}},j=H;j.SOL=new H(se);var Un=new c(ce);var $n=l("Raydium_price");import{PublicKey as br}from"@solana/web3.js";var Pr=l("Raydium_accountInfo_util");import{PublicKey as ze}from"@solana/web3.js";import be,{isBN as vo}from"bn.js";import{bits as vr,BitStructure as Fr,blob as He,Blob as Mr,cstr as qr,f32 as jr,f32be as Hr,f64 as $r,f64be as Yr,greedy as Vr,Layout as $e,ns64 as zr,ns64be as Gr,nu64 as Jr,nu64be as Xr,offset as Zr,s16 as Qr,s16be as eo,s24 as to,s24be as no,s32 as ro,s32be as oo,s40 as io,s40be as so,s48 as ao,s48be as uo,s8 as co,seq as mo,struct as po,Structure as Ye,u16 as lo,u16be as fo,u24 as go,u24be as bo,u32 as yo,u32be as ho,u40 as Po,u40be as xo,u48 as wo,u48be as To,u8 as ko,UInt as Ve,union as Ao,Union as Lo,unionLayoutDiscriminator as Bo,utf8 as So}from"@solana/buffer-layout";var $=$e,ge=Ye;var Y=Ve;var V=He;var z=class extends ${constructor(t,r,o){super(t,o);this.blob=V(t),this.signed=r}decode(t,r=0){let o=new be(this.blob.decode(t,r),10,"le");return this.signed?o.fromTwos(this.span*8).clone():o}encode(t,r,o=0){return typeof t=="number"&&(t=new be(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),r,o)}};function ye(n){return new Y(1,n)}function C(n){return new Y(4,n)}function E(n){return new z(8,!1,n)}var G=class extends ${constructor(t,r,o,i){super(t.span,i);this.layout=t,this.decoder=r,this.encoder=o}decode(t,r){return this.decoder(this.layout.decode(t,r))}encode(t,r,o){return this.layout.encode(this.encoder(t),r,o)}getSpan(t,r){return this.layout.getSpan(t,r)}};function _(n){return new G(V(32),e=>new ze(e),e=>e.toBuffer(),n)}var J=class extends ge{decode(e,t){return super.decode(e,t)}};function he(n,e,t){return new J(n,e,t)}var A=he([_("mint"),_("owner"),E("amount"),C("delegateOption"),_("delegate"),ye("state"),C("isNativeOption"),E("isNative"),E("delegatedAmount"),C("closeAuthorityOption"),_("closeAuthority")]);function nt(n){let{mint:e,tokenAccount:t,owner:r}=n;return Ge(t,e,r)}function X(n){let{tokenAccount:e,payer:t,multiSigners:r=[],owner:o}=n;return Je(e,t,o,r)}async function Pe(n){let{connection:e,amount:t,commitment:r,payer:o,owner:i,skipCloseAccount:s}=n,p=await e.getMinimumBalanceForRentExemption(A.span,r),m=y(t).add(new tt(p)),b=Ze.generate();return{signers:[b],instructions:[et.createAccount({fromPubkey:o,newAccountPubkey:b.publicKey,lamports:m.toNumber(),space:A.span,programId:Xe}),nt({mint:new Qe(g.mint),tokenAccount:b.publicKey,owner:i})],endInstructions:s?[]:[X({tokenAccount:b.publicKey,payer:o,owner:i})]}}import{PublicKey as rt}from"@solana/web3.js";import ot from"bn.js";var it=l("Raydium_Util");function xe({solAccountResp:n,tokenAccountResp:e}){let t=[],r=[];for(let{pubkey:o,account:i}of e.value){if(i.data.length!==A.span)throw it.error("invalid token account layout length","publicKey",o.toBase58()),new Error("invalid token account layout length");let s=A.decode(i.data),{mint:p,amount:m}=s;t.push({publicKey:o,mint:p,amount:m,isNative:!1}),r.push({pubkey:o,accountInfo:s})}return n&&t.push({mint:rt.default,amount:new ot(n.lamports),isNative:!0}),{tokenAccounts:t,tokenAccountRawInfos:r}}var Z=class extends L{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._ataCache=new Map;this._accountListener=[];this._clientOwnedToken=!1;let{tokenAccounts:r,tokenAccountRawInfos:o}=t;this._tokenAccounts=r||[],this._tokenAccountRawInfos=o||[],this._clientOwnedToken=!!(r||o)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:r}){return t&&(this._tokenAccounts=t),r&&(this._tokenAccountRawInfos=r),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(r=>r!==t),this}async getAssociatedTokenAccount(t){this.scope.checkOwner();let r=`${this.scope.ownerPubKey.toBase58()}_${t.toBase58()}`;if(this._ataCache.has(r))return this._ataCache.get(r);let o=await we(t,this.scope.ownerPubKey,!0);return this._ataCache.set(r,o),o}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let o=x(x({},{}),t),i=await this.scope.connection.getAccountInfo(this.scope.ownerPubKey,o.commitment),s=await this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:st},o.commitment),{tokenAccounts:p,tokenAccountRawInfos:m}=xe({solAccountResp:i,tokenAccountResp:s});return this._tokenAccounts=p,this._tokenAccountRawInfos=m,this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),"confirmed"),{tokenAccounts:p,tokenAccountRawInfos:m}}async getCreatedTokenAccount({mint:t,associatedOnly:r=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:s})=>s==null?void 0:s.equals(t)).sort((s,p)=>s.amount.lt(p.amount)?1:-1),i=await this.getAssociatedTokenAccount(t);for(let s of o){let{publicKey:p}=s;if(p)return r&&i.equals(p),p}}async checkOrCreateAta({mint:t,autoUnwrapWSOLToSOL:r}){var p;await this.fetchWalletTokenAccounts();let o=(p=this.scope.account.tokenAccounts.find(({mint:m})=>(m==null?void 0:m.toBase58())===t.toBase58()))==null?void 0:p.publicKey,i=this.scope.ownerPubKey,s={};if(!o){let m=await this.getAssociatedTokenAccount(t),b=await Te(i,m,i,t);s.instructions=[b],o=m}return r&&g.mint===t.toBase58()&&(s.endInstructions=[X({owner:i,payer:i,tokenAccount:o})]),{pubKey:o,newInstructions:s}}async handleTokenAccount(t){let{side:r,amount:o,mint:i,tokenAccount:s,payer:p=this.scope.ownerPubKey,bypassAssociatedCheck:m,skipCloseAccount:b}=t,w=this.createTxBuilder(),h=await we(i,this.scope.ownerPubKey,!0);if(new at(g.mint).equals(i)){let T=await Pe({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:p,amount:o,skipCloseAccount:b});return w.addInstruction(T),x({tokenAccount:T.signers[0].publicKey},T)}else if(!s||r==="out"&&!h.equals(s)&&!m)return{tokenAccount:h,instructions:[Te(this.scope.ownerPubKey,h,this.scope.ownerPubKey,i)]};return{tokenAccount:s}}};export{Z as default};
//# sourceMappingURL=account.mjs.map