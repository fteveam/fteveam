var _n=Object.create;var be=Object.defineProperty,Bn=Object.defineProperties,Nn=Object.getOwnPropertyDescriptor,qn=Object.getOwnPropertyDescriptors,Mn=Object.getOwnPropertyNames,Se=Object.getOwnPropertySymbols,Dn=Object.getPrototypeOf,ve=Object.prototype.hasOwnProperty,xt=Object.prototype.propertyIsEnumerable;var Pt=(e,t,n)=>t in e?be(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,V=(e,t)=>{for(var n in t||(t={}))ve.call(t,n)&&Pt(e,n,t[n]);if(Se)for(var n of Se(t))xt.call(t,n)&&Pt(e,n,t[n]);return e},Z=(e,t)=>Bn(e,qn(t));var v=(e,t)=>{var n={};for(var o in e)ve.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(e!=null&&Se)for(var o of Se(e))t.indexOf(o)<0&&xt.call(e,o)&&(n[o]=e[o]);return n};var On=(e,t)=>{for(var n in t)be(e,n,{get:t[n],enumerable:!0})},kt=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Mn(t))!ve.call(e,r)&&r!==n&&be(e,r,{get:()=>t[r],enumerable:!(o=Nn(t,r))||o.enumerable});return e};var R=(e,t,n)=>(n=e!=null?_n(Dn(e)):{},kt(t||!e||!e.__esModule?be(n,"default",{value:e,enumerable:!0}):n,e)),En=e=>kt(be({},"__esModule",{value:!0}),e);var wo={};On(wo,{default:()=>We});module.exports=En(wo);var xn=require("@solana/web3.js"),G=R(require("bn.js"));var A=R(require("bn.js"));var _t=R(require("big.js")),ke=R(require("bn.js"));var ye=require("lodash"),Tt=R(require("pino")),It=R(require("pino-pretty")),wt={},Rn={},Wn=(0,It.default)({colorize:!0,levelFirst:!0,translateTime:"SYS:yyyymmdd HH:MM:ss.l"}),vn=(0,Tt.default)({base:null,level:"silent"},Wn);function I(e){let t=(0,ye.get)(wt,e);if(!t){let n=(0,ye.get)(Rn,e);t=vn.child({name:e},{level:n}),(0,ye.set)(wt,e,t)}return t.logWithError=(...n)=>{let o=n.map(r=>typeof r=="object"?JSON.stringify(r):r).join(", ");throw new Error(o)},t}var At=R(require("toformat")),Kn=At.default,ge=Kn;var he=R(require("big.js")),St=R(require("decimal.js-light"));var Le=I("module/fraction"),Ke=ge(he.default),Pe=ge(St.default),Cn={[0]:Pe.ROUND_DOWN,[1]:Pe.ROUND_HALF_UP,[2]:Pe.ROUND_UP},Fn={[0]:he.default.roundDown,[1]:he.default.roundHalfUp,[2]:he.default.roundUp},h=class{constructor(t,n=xe){this.numerator=T(t),this.denominator=T(n)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new h(this.denominator,this.numerator)}add(t){let n=t instanceof h?t:new h(T(t));return this.denominator.eq(n.denominator)?new h(this.numerator.add(n.numerator),this.denominator):new h(this.numerator.mul(n.denominator).add(n.numerator.mul(this.denominator)),this.denominator.mul(n.denominator))}sub(t){let n=t instanceof h?t:new h(T(t));return this.denominator.eq(n.denominator)?new h(this.numerator.sub(n.numerator),this.denominator):new h(this.numerator.mul(n.denominator).sub(n.numerator.mul(this.denominator)),this.denominator.mul(n.denominator))}mul(t){let n=t instanceof h?t:new h(T(t));return new h(this.numerator.mul(n.numerator),this.denominator.mul(n.denominator))}div(t){let n=t instanceof h?t:new h(T(t));return new h(this.numerator.mul(n.denominator),this.denominator.mul(n.numerator))}toSignificant(t,n={groupSeparator:""},o=1){Number.isInteger(t)||Le.logWithError(`${t} is not an integer.`),t<=0&&Le.logWithError(`${t} is not positive.`),Pe.set({precision:t+1,rounding:Cn[o]});let r=new Pe(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(t);return r.toFormat(r.decimalPlaces(),n)}toFixed(t,n={groupSeparator:""},o=1){return Number.isInteger(t)||Le.logWithError(`${t} is not an integer.`),t<0&&Le.logWithError(`${t} is negative.`),Ke.DP=t,Ke.RM=Fn[o]||1,new Ke(this.numerator.toString()).div(this.denominator.toString()).toFormat(t,n)}isZero(){return this.numerator.isZero()}};var Vn=I("Raydium_amount"),Lt=ge(_t.default);function Yn(e,t){let n="0",o="0";if(e.includes(".")){let r=e.split(".");r.length===2?([n,o]=r,o=o.padEnd(t,"0")):Vn.logWithError(`invalid number string, num: ${e}`)}else n=e;return[n,o.slice(0,t)||o]}var B=class extends h{constructor(n,o,r=!0,s){let i=new ke.default(0),a=ue.pow(new ke.default(n.decimals));if(r)i=T(o);else{let m=new ke.default(0),l=new ke.default(0);if(typeof o=="string"||typeof o=="number"||typeof o=="bigint"){let[p,f]=Yn(o.toString(),n.decimals);m=T(p),l=T(f)}m=m.mul(a),i=m.add(l)}super(i,a);this.logger=I(s||"Amount"),this.token=n}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(n){return this.token.equals(n.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(n.raw)}lt(n){return this.token.equals(n.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(n.raw)}add(n){return this.token.equals(n.token)||this.logger.logWithError("add token not equals"),new B(this.token,this.raw.add(n.raw))}subtract(n){return this.token.equals(n.token)||this.logger.logWithError("sub token not equals"),new B(this.token,this.raw.sub(n.raw))}toSignificant(n=this.token.decimals,o,r=0){return super.toSignificant(n,o,r)}toFixed(n=this.token.decimals,o,r=0){return n>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(n,o,r)}toExact(n={groupSeparator:""}){return Lt.DP=this.token.decimals,new Lt(this.numerator.toString()).div(this.denominator.toString()).toFormat(n)}};var Bt=require("@solana/web3.js"),Nt={symbol:"SOL",name:"Solana",decimals:9},X={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},Uo={isQuantumSOL:!0,isLp:!1,official:!0,mint:new Bt.PublicKey(X.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};var Be=require("@solana/web3.js");var qt=require("@solana/spl-token"),S=require("@solana/web3.js");function u({pubkey:e,isSigner:t=!1,isWritable:n=!0}){return{pubkey:e,isWritable:n,isSigner:t}}var Ce=[u({pubkey:qt.TOKEN_PROGRAM_ID,isWritable:!1}),u({pubkey:S.SystemProgram.programId,isWritable:!1}),u({pubkey:S.SYSVAR_RENT_PUBKEY,isWritable:!1})];function K({publicKey:e,transformSol:t}){if(e instanceof S.PublicKey)return t&&e.equals(ne)?_e:e;if(t&&e===ne.toBase58())return _e;if(typeof e=="string")try{return new S.PublicKey(e)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}function Mt(e){try{return new S.PublicKey(e)}catch{return e}}var Qo=new S.PublicKey("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),jo=new S.PublicKey("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),$o=new S.PublicKey("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Go=new S.PublicKey("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),zo=new S.PublicKey("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Jo=new S.PublicKey("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Zo=new S.PublicKey("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Ho=new S.PublicKey("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Xo=new S.PublicKey("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),er=new S.PublicKey("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),tr=new S.PublicKey("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),_e=new S.PublicKey("So11111111111111111111111111111111111111112"),ne=S.PublicKey.default;var Fe=class{constructor({mint:t,decimals:n,symbol:o="UNKNOWN",name:r="UNKNOWN",skipMint:s=!1}){if(t===ne.toBase58()||t instanceof Be.PublicKey&&ne.equals(t)){this.decimals=X.decimals,this.symbol=X.symbol,this.name=X.name,this.mint=new Be.PublicKey(X.mint);return}this.decimals=n,this.symbol=o,this.name=r,this.mint=s?Be.PublicKey.default:K({publicKey:t})}equals(t){return this===t?!0:this.mint.equals(t.mint)}},O=Fe;O.WSOL=new Fe(X);var Ve=class{constructor({decimals:t,symbol:n="UNKNOWN",name:o="UNKNOWN"}){this.decimals=t,this.symbol=n,this.name=o}equals(t){return this===t}},Ue=Ve;Ue.SOL=new Ve(Nt);var Dt=new h(Ot),Q=class extends h{toSignificant(t=5,n,o){return this.mul(Dt).toSignificant(t,n,o)}toFixed(t=2,n,o){return this.mul(Dt).toFixed(t,n,o)}};var Qn=I("Raydium_price"),M=class extends h{constructor(n){let{baseToken:o,quoteToken:r,numerator:s,denominator:i}=n;super(s,i);this.baseToken=o,this.quoteToken=r,this.scalar=new h(Ye(o.decimals),Ye(r.decimals))}get raw(){return new h(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new M({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(n){this.quoteToken!==n.baseToken&&Qn.logWithError("mul token not equals");let o=super.mul(n);return new M({baseToken:this.baseToken,quoteToken:n.quoteToken,denominator:o.denominator,numerator:o.numerator})}toSignificant(n=this.quoteToken.decimals,o,r){return this.adjusted.toSignificant(n,o,r)}toFixed(n=this.quoteToken.decimals,o,r){return this.adjusted.toFixed(n,o,r)}};var Ne=I("Raydium_bignumber");var ce=new A.default(0),xe=new A.default(1),Nr=new A.default(2),qr=new A.default(3),Mr=new A.default(5),ue=new A.default(10),Ot=new A.default(100),Dr=new A.default(1e3),Or=new A.default(1e4),Et=9007199254740991;function T(e){if(e instanceof A.default)return e;if(typeof e=="string"){if(e.match(/^-?[0-9]+$/))return new A.default(e);Ne.logWithError(`invalid BigNumberish string: ${e}`)}return typeof e=="number"?(e%1&&Ne.logWithError(`BigNumberish number underflow: ${e}`),(e>=Et||e<=-Et)&&Ne.logWithError(`BigNumberish number overflow: ${e}`),new A.default(String(e))):typeof e=="bigint"?new A.default(e.toString()):(Ne.logWithError(`invalid BigNumberish value: ${e}`),new A.default(0))}function Ye(e){return ue.pow(T(e))}function we(e){var a;if(e===void 0)return{denominator:"1",numerator:"0"};if(e instanceof A.default)return{numerator:e.toString(),denominator:"1"};if(e instanceof h)return{denominator:e.denominator.toString(),numerator:e.numerator.toString()};let t=String(e),[,n="",o="",r=""]=(a=t.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?a:[],s="1"+"0".repeat(r.length),i=n+(o==="0"?"":o)+r||"0";return{denominator:s,numerator:i,sign:n,int:o,dec:r}}function Qe(e,t){let n=e.divmod(t);return n.mod.isZero()?n.div:n.div.negative!==0?n.div.isubn(1):n.div.iaddn(1)}function jn(e){var o;let[,t="",n=""]=(o=e.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?o:[];return`${t}${n}`}function Rt(e,t=0){return e instanceof A.default?e:new A.default(jn(Wt(e).mul(ue.pow(new A.default(String(t))))))}function Wt(e){if(e instanceof Q)return new h(e.numerator,e.denominator);if(e instanceof M)return e.adjusted;if(e instanceof B)try{return Wt(e.toExact())}catch{return new h(ce)}if(e instanceof h)return e;let t=String(e),n=we(t);return new h(n.numerator,n.denominator)}function vt(e){let{token:t,numberPrice:n,decimalDone:o}=e,r=new O({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),{numerator:s,denominator:i}=we(n),a=o?new A.default(s).mul(ue.pow(new A.default(t.decimals))):s,m=new A.default(i).mul(ue.pow(new A.default(r.decimals)));return new M({baseToken:r,denominator:m.toString(),quoteToken:new O(Z(V({},t),{skipMint:!0,mint:""})),numerator:a.toString()})}var Kt=require("@solana/web3.js"),Ct=R(require("bn.js"));var $n=[O,B,Kt.PublicKey,h,Ct.default,M,Q];function Gn(e){return typeof e=="object"&&e!==null&&!$n.some(t=>typeof t=="object"&&e instanceof t)}function me(e){return typeof e=="string"?Mt(e):Array.isArray(e)?e.map(t=>me(t)):Gn(e)?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,me(n)])):e}var Ie=require("@solana/spl-token"),He=require("@solana/web3.js"),Hn=R(require("bn.js"));var C=require("@solana/web3.js");var ee=I("Raydium_txTool"),qe=class{constructor(t){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=t.connection,this.feePayer=t.feePayer,this.signAllTransactions=t.signAllTransactions,this.owner=t.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:t=[],endInstructions:n=[],signers:o=[]}){return this.instructions.push(...t),this.endInstructions.push(...n),this.signers.push(...o),this}build(t){let n=new C.Transaction;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,{transaction:n,signers:this.signers,execute:async()=>{var r;let o=await Ft(this.connection);if(n.recentBlockhash=o,(r=this.owner)!=null&&r.isKeyPair)return(0,C.sendAndConfirmTransaction)(this.connection,n,this.signers);if(this.signAllTransactions){this.signers.length&&n.partialSign(...this.signers);let s=await this.signAllTransactions([n]);return await this.connection.sendRawTransaction(s[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:t||{}}}buildMultiTx(t){let{extraPreBuildData:n=[],extInfo:o}=t,{transaction:r}=this.build(o),s=n.filter(m=>m.transaction.instructions.length>0),i=[...s.map(m=>m.transaction),r],a=[...s.map(m=>m.signers),this.signers];return{transactions:i,signers:a,execute:async()=>{var l;let m=await Ft(this.connection);if((l=this.owner)!=null&&l.isKeyPair)return await Promise.all(i.map(async(p,f)=>(p.recentBlockhash=m,await(0,C.sendAndConfirmTransaction)(this.connection,p,a[f]))));if(this.signAllTransactions){let p=i.map((d,g)=>(d.recentBlockhash=m,a[g].length&&d.partialSign(...a[g]),d)),f=await this.signAllTransactions(p),b=[];for(let d=0;d<f.length;d+=1){let g=await this.connection.sendRawTransaction(f[d].serialize(),{skipPreflight:!0});b.push(g)}return b}throw new Error("please connect wallet first")},extInfo:o||{}}}};async function Ft(e){var t,n;try{return((n=await((t=e.getLatestBlockhash)==null?void 0:t.call(e)))==null?void 0:n.blockhash)||(await e.getRecentBlockhash()).blockhash}catch{return(await e.getRecentBlockhash()).blockhash}}function zn(e,t){e.length<1&&ee.logWithError(`no instructions provided: ${e.toString()}`),t.length<1&&ee.logWithError(`no signers provided:, ${t.toString()}`);let n=new C.Transaction;n.recentBlockhash="11111111111111111111111111111111",n.feePayer=t[0],n.add(...e);let o=n.compileMessage().serialize();return t.length+t.length*64+o.length}async function Ut(e,t,n){let o=new C.PublicKey("RaydiumSimuLateTransaction11111111111111111"),r=[],s=new C.Transaction;s.feePayer=o;for(let m of t)zn([...s.instructions,m],[o])>C.PACKET_DATA_SIZE&&(r.push(s),s=new C.Transaction,s.feePayer=o),s.add(m);s.instructions.length>0&&r.push(s);let i=[];try{i=await Promise.all(r.map(m=>e.simulateTransaction(m)))}catch(m){m instanceof Error&&ee.logWithError(`failed to simulate for instructions, RPC_ERROR, ${m.message}`)}let a=[];for(let m of i){let{value:l}=m;if(ee.debug(`simulate result: ${JSON.stringify(m)}`),l.logs){let p=l.logs.filter(f=>f&&f.includes(n));ee.debug(`filteredLog: ${JSON.stringify(a)}`),p.length||ee.logWithError(` "simulate log not match keyword, keyword: ${n}`),a.push(...p)}}return a}function Vt(e,t){let n=e.match(/{["\w:,]+}/g);return!n||n.length!==1?ee.logWithError(`simulate log fail to match json, keyword: ${t}`):n[0]}function H(e,t){let o=new RegExp(`"${t}":(\\d+)`,"g").exec(e);return!o||o.length!==2?ee.logWithError(`simulate log fail to match key", key: ${t}`):o[1]}async function je(e,t){let[n,o]=await C.PublicKey.findProgramAddress(e,t);return{publicKey:n,nonce:o}}var Jn=require("@solana/web3.js");var ei=I("Raydium_accountInfo_util");var jt=require("@solana/web3.js"),le=R(require("bn.js"));var y=require("@solana/buffer-layout"),$e=y.Layout,Yt=y.Structure;var Ge=y.UInt;var Qt=y.seq;var ze=y.blob;var Me=class extends $e{constructor(n,o,r){super(n,r);this.blob=ze(n),this.signed=o}decode(n,o=0){let r=new le.default(this.blob.decode(n,o),10,"le");return this.signed?r.fromTwos(this.span*8).clone():r}encode(n,o,r=0){return typeof n=="number"&&(n=new le.default(n)),this.signed&&(n=n.toTwos(this.span*8)),this.blob.encode(n.toArrayLike(Buffer,"le",this.span),o,r)}};function W(e){return new Ge(1,e)}function De(e){return new Ge(4,e)}function c(e){return new Me(8,!1,e)}function j(e){return new Me(16,!1,e)}var Je=class extends $e{constructor(n,o,r,s){super(n.span,s);this.layout=n,this.decoder=o,this.encoder=r}decode(n,o){return this.decoder(this.layout.decode(n,o))}encode(n,o,r){return this.layout.encode(this.encoder(n),o,r)}getSpan(n,o){return this.layout.getSpan(n,o)}};function x(e){return new Je(ze(32),t=>new jt.PublicKey(t),t=>t.toBuffer(),e)}var Ze=class extends Yt{decode(t,n){return super.decode(t,n)}};function D(e,t,n){return new Ze(e,t,n)}function Te(e,t,n){let o,r=typeof t=="number"?t:(0,le.isBN)(t)?t.toNumber():new Proxy(t,{get(s,i){if(!o){let a=Reflect.get(s,"count");o=(0,le.isBN)(a)?a.toNumber():a,Reflect.set(s,"count",o)}return Reflect.get(s,i)},set(s,i,a){return i==="count"&&(o=a),Reflect.set(s,i,a)}});return Qt(e,r,n)}var Zn=D([x("mint"),x("owner"),c("amount"),De("delegateOption"),x("delegate"),W("state"),De("isNativeOption"),c("isNative"),c("delegatedAmount"),De("closeAuthorityOption"),x("closeAuthority")]);function Xe({source:e,destination:t,owner:n,amount:o,multiSigners:r=[]}){return(0,Ie.createTransferInstruction)(e,t,n,T(o).toNumber(),r)}var et=(...e)=>e.map(t=>{try{return typeof t=="object"?JSON.stringify(t):t}catch{return t}}).join(", "),Ae=class{constructor({scope:t,moduleName:n}){this.disabled=!1;this.scope=t,this.logger=I(n)}createTxBuilder(t){return this.scope.checkOwner(),new qe({connection:this.scope.connection,feePayer:t||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...t){this.logger.debug(et(t))}logInfo(...t){this.logger.info(et(t))}logAndCreateError(...t){let n=et(t);throw new Error(n)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};var tt=require("@solana/web3.js"),nt=R(require("bn.js"));var $t=new nt.default(25),Gt=new nt.default(1e4),zt="675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8",Xn=new tt.PublicKey(zt),Jt="5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h",eo=new tt.PublicKey(Jt),Vi={[zt]:4,[Jt]:5},Zt={4:Xn,5:eo},Ht={4:3,5:3};var Re=require("@solana/spl-token"),Y=require("@solana/web3.js");var ot=D([W("instruction"),c("amountIn"),c("minAmountOut")]),rt=D([W("instruction"),c("maxAmountIn"),c("amountOut")]),it=D([W("instruction"),W("nonce")]),st=D([W("instruction"),W("nonce"),c("startTime")]),to=D([c("status"),c("nonce"),c("maxOrder"),c("depth"),c("baseDecimal"),c("quoteDecimal"),c("state"),c("resetFlag"),c("minSize"),c("volMaxCutRatio"),c("amountWaveRatio"),c("baseLotSize"),c("quoteLotSize"),c("minPriceMultiplier"),c("maxPriceMultiplier"),c("systemDecimalValue"),c("minSeparateNumerator"),c("minSeparateDenominator"),c("tradeFeeNumerator"),c("tradeFeeDenominator"),c("pnlNumerator"),c("pnlDenominator"),c("swapFeeNumerator"),c("swapFeeDenominator"),c("baseNeedTakePnl"),c("quoteNeedTakePnl"),c("quoteTotalPnl"),c("baseTotalPnl"),j("quoteTotalDeposited"),j("baseTotalDeposited"),j("swapBaseInAmount"),j("swapQuoteOutAmount"),c("swapBase2QuoteFee"),j("swapQuoteInAmount"),j("swapBaseOutAmount"),c("swapQuote2BaseFee"),x("baseVault"),x("quoteVault"),x("baseMint"),x("quoteMint"),x("lpMint"),x("openOrders"),x("marketId"),x("marketProgramId"),x("targetOrders"),x("withdrawQueue"),x("lpVault"),x("owner"),c("lpReserve"),Te(c(),3,"padding")]),$i=D([c("accountType"),c("status"),c("nonce"),c("maxOrder"),c("depth"),c("baseDecimal"),c("quoteDecimal"),c("state"),c("resetFlag"),c("minSize"),c("volMaxCutRatio"),c("amountWaveRatio"),c("baseLotSize"),c("quoteLotSize"),c("minPriceMultiplier"),c("maxPriceMultiplier"),c("systemDecimalsValue"),c("abortTradeFactor"),c("priceTickMultiplier"),c("priceTick"),c("minSeparateNumerator"),c("minSeparateDenominator"),c("tradeFeeNumerator"),c("tradeFeeDenominator"),c("pnlNumerator"),c("pnlDenominator"),c("swapFeeNumerator"),c("swapFeeDenominator"),c("baseNeedTakePnl"),c("quoteNeedTakePnl"),c("quoteTotalPnl"),c("baseTotalPnl"),c("poolOpenTime"),c("punishPcAmount"),c("punishCoinAmount"),c("orderbookToInitTime"),j("swapBaseInAmount"),j("swapQuoteOutAmount"),j("swapQuoteInAmount"),j("swapBaseOutAmount"),c("swapQuote2BaseFee"),c("swapBase2QuoteFee"),x("baseVault"),x("quoteVault"),x("baseMint"),x("quoteMint"),x("lpMint"),x("modelDataAccount"),x("openOrders"),x("marketId"),x("marketProgramId"),x("targetOrders"),x("owner"),Te(c(),64,"padding")]),at=D([W("instruction"),c("baseAmountIn"),c("quoteAmountIn"),c("fixedSide")]),ut=D([W("instruction"),c("amountIn")]);var Xt=require("@solana/web3.js");var pe=new Xt.PublicKey("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),re=5e4,no=D([c("x"),c("y"),c("price")]),oo=D([c("accountType"),c("status"),c("multiplier"),c("validDataCount"),Te(no,re,"DataElement")]);function ro(e,t){return[0,re-2]}function io(e){return[0,re-2]}function so(e){return[0,re-2]}function ao(e,t,n){let[o,r]=ro(t,n),s=o,i=r,a=0,m=t*e.multiplier/n;for(;s<=i;){if(a=Math.floor((i+s)/2),a===0||a>=re-2)return[a,a,!1];let l=e.DataElement[a].x*e.multiplier/e.DataElement[a].y,p=e.DataElement[a-1].x*e.multiplier/e.DataElement[a-1].y,f=e.DataElement[a+1].x*e.multiplier/e.DataElement[a+1].y;if(m===l)return[a,a,!0];if(m===p)return[a-1,a-1,!0];if(m===f)return[a+1,a+1,!0];if(m<p)i=a-1;else{if(m>p&&m<l)return[a-1,a,!0];if(m>l&&m<f)return[a,a+1,!0];s=a+1}}return[a,a,!1]}function ct(e,t,n){let[o,r,s]=ao(e,t,n);if(!s)return 0;if(o===r){let i=e.DataElement[o].x;return t*e.multiplier/i}else{let i=e.DataElement[o].x,a=e.DataElement[o].y,m=e.DataElement[r].x,l=e.DataElement[r].y,p=n*(m*a-i*l),f=i*p,b=(m-i)*(t*a-i*n)*l,d=f+b;return t*e.multiplier*p/d}}function oe(e,t,n){return t*e.multiplier/n}function en(e,t,n){return t*n/e.multiplier}function uo(e,t){let[n,o]=io(t),r=n,s=o,i=0,a=t;for(;r<s;){if(i=Math.floor((s+r)/2),i<=0||i>re-2)return[i,i,!1];let m=e.DataElement[i].x,l=e.DataElement[i-1].x,p=e.DataElement[i+1].x;if(a===m)return[i,i,!0];if(a===l)return[i-1,i-1,!0];if(a===p)return[i+1,i+1,!0];if(a<l)s=i-1;else{if(a>l&&a<m)return[i-1,i,!0];if(a>m&&a<p)return[i,i+1,!0];r=i+1}}return[i,i,!1]}function co(e,t){let[n,o]=so(t),r=n,s=o,i=0,a=t;for(;r<=s;){if(i=Math.floor((s+r)/2),i<=0||i>=re-2)return[i,i,!1];let m=e.DataElement[i].y,l=e.DataElement[i-1].y,p=e.DataElement[i+1].y;if(a===m)return[i,i,!0];if(a===l)return[i-1,i-1,!0];if(a===p)return[i+1,i+1,!0];if(a<p)r=i+1;else{if(a<l&&a>m)return[i-1,i,!0];if(a<m&&a>p)return[i,i+1,!0];s=i-1}}return[i,i,!1]}function tn(e,t,n,o){let r=o?t+n:t-n,[s,i,a]=uo(e,r);if(!a)return[0,0,!1,a];if(s===i)return[e.DataElement[i].price,e.DataElement[i].y,!1,a];{let m=e.DataElement[s].x,l=e.DataElement[i].x,p=e.DataElement[s].price,f=e.DataElement[i].price,b=e.DataElement[s].y,d=e.DataElement[i].y;if(t>=m&&t<=l)return o?[f,d,!0,a]:[p,b,!0,a];{let g,k;return o?(g=p+(f-p)*(t-m)/(l-m),k=b-(r-m)*e.multiplier/f):(g=p+(f-p)*(t-m)/(l-m),k=d+(l-r)*e.multiplier/p),[g,k,!1,a]}}}function mo(e,t,n,o){let r=o?t-n:t+n,[s,i,a]=co(e,r);if(!a)return[0,0,!1,a];if(s===i)return[e.DataElement[i].price,e.DataElement[i].x,!1,a];{let m=e.DataElement[s].x,l=e.DataElement[i].x,p=e.DataElement[s].price,f=e.DataElement[i].price,b=e.DataElement[s].y,d=e.DataElement[i].y;if(t>=d&&t<=b)return o?[f,l,!0,a]:[p,m,!0,a];{let g,k;return o?(g=p+(f-p)*(b-t)/(b-d),k=m+f*(b-r)/e.multiplier):(g=p+(f-p)*(b-t)/(b-d),k=l-p*(r-d)/e.multiplier),[g,k,!1,a]}}}function lo(e,t){let n=tn(e,t,0,!1);return n[3]?n[0]:0}function nn(e,t,n,o){let r=ct(e,t,n),s=oe(e,t,r),i=oe(e,n,r),a=oe(e,o,r),m=!0,[l,p,f,b]=tn(e,s,a,m);if(!b)return 0;if(f)return o*e.multiplier/l;{let d=i-p;return en(e,d,r)}}function on(e,t,n,o){let r=ct(e,t,n),s=oe(e,t,r),i=oe(e,n,r),a=oe(e,o,r),m=!1,[l,p,f,b]=mo(e,i,a,m);if(!b)return 0;if(f)return o*l/e.multiplier;{let d=s-p;return en(e,d,r)}}function po(e){let t=oo.decode(e);return{accountType:t.accountType.toNumber(),status:t.status.toNumber(),multiplier:t.multiplier.toNumber(),validDataCount:t.validDataCount.toNumber(),DataElement:t.DataElement.map(n=>({x:n.x.toNumber(),y:n.y.toNumber(),price:n.price.toNumber()}))}}function rn(e,t,n,o){let r=lo(e,oe(e,t,ct(e,t,n)))/e.multiplier;return o?r:1/r}var Oe=class{constructor({connection:t}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=t}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let t=await this.connection.getAccountInfo(pe);t&&(this._layoutData=po(t==null?void 0:t.data))}}};var Ee=I("Raydium_liquidity_instruction");function sn(e){let{poolKeys:t,userKeys:n,amountIn:o,amountOut:r,fixedSide:s}=e,{version:i}=t;if(i===4||i===5){let a={poolKeys:t,userKeys:n};if(s==="in")return fo(Z(V({},a),{amountIn:o,minAmountOut:r}),i);if(s==="out")return bo(Z(V({},a),{maxAmountIn:o,amountOut:r}),i);Ee.logWithError("invalid params","params",e)}throw Ee.logWithError("invalid version","poolKeys.version",i),new Error("invalid version")}function an(e){let t=D([W("instruction"),W("simulateType")]),n=Buffer.alloc(t.span);t.encode({instruction:12,simulateType:0},n);let o=[u({pubkey:e.id,isWritable:!1}),u({pubkey:e.authority,isWritable:!1}),u({pubkey:e.openOrders,isWritable:!1}),u({pubkey:e.baseVault,isWritable:!1}),u({pubkey:e.quoteVault,isWritable:!1}),u({pubkey:e.lpMint,isWritable:!1}),u({pubkey:e.marketId,isWritable:!1})];return new Y.TransactionInstruction({programId:e.programId,keys:o,data:n})}function fo({poolKeys:e,userKeys:t,amountIn:n,minAmountOut:o},r){let s=Buffer.alloc(ot.span);ot.encode({instruction:9,amountIn:T(n),minAmountOut:T(o)},s);let i=[u({pubkey:Re.TOKEN_PROGRAM_ID,isWritable:!1}),u({pubkey:e.id}),u({pubkey:e.authority,isWritable:!1}),u({pubkey:e.openOrders})];return r===4&&i.push(u({pubkey:e.targetOrders})),i.push(u({pubkey:e.baseVault}),u({pubkey:e.quoteVault})),r===5&&i.push(u({pubkey:pe})),i.push(u({pubkey:e.marketProgramId,isWritable:!1}),u({pubkey:e.marketId}),u({pubkey:e.marketBids}),u({pubkey:e.marketAsks}),u({pubkey:e.marketEventQueue}),u({pubkey:e.marketBaseVault}),u({pubkey:e.marketQuoteVault}),u({pubkey:e.marketAuthority,isWritable:!1}),u({pubkey:t.tokenAccountIn}),u({pubkey:t.tokenAccountOut}),u({pubkey:t.owner,isWritable:!1})),new Y.TransactionInstruction({programId:e.programId,keys:i,data:s})}function bo({poolKeys:e,userKeys:t,maxAmountIn:n,amountOut:o},r){let s=Buffer.alloc(rt.span);rt.encode({instruction:11,maxAmountIn:T(n),amountOut:T(o)},s);let i=[u({pubkey:Y.SystemProgram.programId,isWritable:!1}),u({pubkey:e.id}),u({pubkey:e.authority,isWritable:!1}),u({pubkey:e.openOrders}),u({pubkey:e.targetOrders}),u({pubkey:e.baseVault}),u({pubkey:e.quoteVault})];return r===5&&i.push(u({pubkey:pe})),i.push(u({pubkey:e.marketProgramId,isWritable:!1}),u({pubkey:e.marketId}),u({pubkey:e.marketBids}),u({pubkey:e.marketAsks}),u({pubkey:e.marketEventQueue}),u({pubkey:e.marketBaseVault}),u({pubkey:e.marketQuoteVault}),u({pubkey:e.marketAuthority,isWritable:!1}),u({pubkey:t.tokenAccountIn}),u({pubkey:t.tokenAccountOut}),u({pubkey:t.owner,isWritable:!1,isSigner:!0})),new Y.TransactionInstruction({programId:e.programId,keys:i,data:s})}function un(e){let s=e,{owner:t}=s,n=v(s,["owner"]),o=Buffer.alloc(it.span);it.encode({instruction:10,nonce:n.nonce},o);let r=[...Ce,u({pubkey:n.targetOrders}),u({pubkey:n.withdrawQueue}),u({pubkey:n.authority,isWritable:!1}),u({pubkey:n.lpMint}),u({pubkey:n.baseMint,isWritable:!1}),u({pubkey:n.quoteMint,isWritable:!1}),u({pubkey:n.baseVault}),u({pubkey:n.quoteVault}),u({pubkey:n.lpVault}),u({pubkey:n.marketId,isWritable:!1}),u({pubkey:t,isSigner:!0})];return new Y.TransactionInstruction({programId:n.programId,keys:r,data:o})}function cn(e){let{poolKeys:t,userKeys:n,startTime:o}=e,r=Buffer.alloc(st.span);st.encode({instruction:0,nonce:t.nonce,startTime:T(o)},r);let s=[...Ce,u({pubkey:t.id}),u({pubkey:t.authority,isWritable:!1}),u({pubkey:t.openOrders}),u({pubkey:t.lpMint}),u({pubkey:t.baseMint,isWritable:!1}),u({pubkey:t.quoteMint,isWritable:!1}),u({pubkey:t.baseVault,isWritable:!1}),u({pubkey:t.quoteVault,isWritable:!1}),u({pubkey:t.withdrawQueue}),u({pubkey:t.targetOrders}),u({pubkey:n.lpTokenAccount}),u({pubkey:t.lpVault,isWritable:!1}),u({pubkey:t.marketProgramId,isWritable:!1}),u({pubkey:t.marketId,isWritable:!1}),u({pubkey:n.payer,isSigner:!0})];return new Y.TransactionInstruction({programId:t.programId,keys:s,data:r})}function mn(e){let{poolKeys:t,userKeys:n,baseAmountIn:o,quoteAmountIn:r,fixedSide:s}=e,{version:i}=t;if(i===4||i===5){let a=Buffer.alloc(at.span);at.encode({instruction:3,baseAmountIn:T(o),quoteAmountIn:T(r),fixedSide:T(s==="base"?0:1)},a);let m=[u({pubkey:Re.TOKEN_PROGRAM_ID,isWritable:!1}),u({pubkey:t.id}),u({pubkey:t.authority,isWritable:!1}),u({pubkey:t.openOrders,isWritable:!1}),u({pubkey:t.targetOrders}),u({pubkey:t.lpMint}),u({pubkey:t.baseVault}),u({pubkey:t.quoteVault})];return i===5&&m.push(u({pubkey:pe})),m.push(u({pubkey:t.marketId,isWritable:!1}),u({pubkey:n.baseTokenAccount}),u({pubkey:n.quoteTokenAccount}),u({pubkey:n.lpTokenAccount}),u({pubkey:n.owner,isWritable:!1,isSigner:!0})),new Y.TransactionInstruction({programId:t.programId,keys:m,data:a})}return Ee.logWithError("invalid version","poolKeys.version",i),new Y.TransactionInstruction({programId:t.programId,keys:[]})}function ln(e){let{poolKeys:t,userKeys:n,amountIn:o}=e,{version:r}=t;if(r===4||r===5){let s=Buffer.alloc(ut.span);ut.encode({instruction:4,amountIn:T(o)},s);let i=[u({pubkey:Re.TOKEN_PROGRAM_ID,isWritable:!1}),u({pubkey:t.id}),u({pubkey:t.authority,isWritable:!1}),u({pubkey:t.openOrders}),u({pubkey:t.targetOrders}),u({pubkey:t.lpMint}),u({pubkey:t.baseVault}),u({pubkey:t.quoteVault})];return r===5?i.push(u({pubkey:pe})):i.push(u({pubkey:t.withdrawQueue}),u({pubkey:t.lpVault})),i.push(u({pubkey:t.marketProgramId,isWritable:!1}),u({pubkey:t.marketId}),u({pubkey:t.marketBaseVault}),u({pubkey:t.marketQuoteVault}),u({pubkey:t.marketAuthority,isWritable:!1}),u({pubkey:n.lpTokenAccount}),u({pubkey:n.baseTokenAccount}),u({pubkey:n.quoteTokenAccount}),u({pubkey:n.owner,isWritable:!1,isSigner:!0}),u({pubkey:t.marketEventQueue}),u({pubkey:t.marketBids}),u({pubkey:t.marketAsks})),new Y.TransactionInstruction({programId:t.programId,keys:i,data:s})}return Ee.logWithError("invalid version","poolKeys.version",r),new Y.TransactionInstruction({programId:t.programId,keys:[]})}var ho=require("@project-serum/serum"),de=R(require("bn.js"));var mt=require("@solana/web3.js");var lt=I("Raydium_liquidity_serum"),pn="9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin",yo=new mt.PublicKey(pn),us={[pn]:3},go={3:yo};function dn(e){let t=Ht[e];return t||lt.logWithError("invalid version","version",e),t}function fn(e){let t=go[e];return t||lt.logWithError("invalid version","version",e),t}async function bn({programId:e,marketId:t}){let n=[t.toBuffer()],o=0,r;for(;o<100;){try{let s=n.concat(Buffer.from([o]),Buffer.alloc(7));r=await mt.PublicKey.createProgramAddress(s,e)}catch(s){if(s instanceof TypeError)throw s;o++;continue}return{publicKey:r,nonce:o}}throw lt.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),new Error("unable to find a viable program address nonce")}var pt=I("Raydium_liquidity_util");function dt(e,t){let n=e instanceof B?e.token:O.WSOL,{baseMint:o,quoteMint:r}=t;if(n.mint.equals(o))return"base";if(n.mint.equals(r))return"quote";let s=`liquidity getTokenSide - token not match with pool, params: ${JSON.stringify({token:n.mint,baseMint:o,quoteMint:r})}`;throw console.error(s),new Error(s)}function ft(e,t){let{baseMint:n,quoteMint:o}=t;return e.mint.equals(n)||e.mint.equals(o)}function Po(e){let t=Zt[e];return t||pt.logWithError("invalid version","version",e),t}async function te({name:e,programId:t,marketId:n}){let{publicKey:o}=await je([t.toBuffer(),n.toBuffer(),Buffer.from(e,"utf-8")],t);return o}async function xo({programId:e}){return je([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],e)}async function bt({version:e,marketId:t,baseMint:n,quoteMint:o}){let r=Po(e),[s,i,a]=[K({publicKey:t}),K({publicKey:n,transformSol:!0}),K({publicKey:o,transformSol:!0})],m=await te({name:"amm_associated_seed",programId:r,marketId:s}),l=await te({name:"lp_mint_associated_seed",programId:r,marketId:s}),{publicKey:p,nonce:f}=await xo({programId:r}),b=await te({name:"coin_vault_associated_seed",programId:r,marketId:s}),d=await te({name:"pc_vault_associated_seed",programId:r,marketId:s}),g=await te({name:"temp_lp_token_associated_seed",programId:r,marketId:s}),k=await te({name:"open_order_associated_seed",programId:r,marketId:s}),N=await te({name:"target_associated_seed",programId:r,marketId:s}),w=await te({name:"withdraw_associated_seed",programId:r,marketId:s}),L=dn(e),_=fn(L),{publicKey:q}=await bn({programId:_,marketId:s});return{id:m,baseMint:i,quoteMint:a,lpMint:l,version:e,programId:r,authority:p,nonce:f,baseVault:b,quoteVault:d,lpVault:g,openOrders:k,targetOrders:N,withdrawQueue:w,marketVersion:L,marketProgramId:_,marketId:s,marketAuthority:q}}async function gn({connection:e,pools:t}){let n=t.map(r=>an(r));return(await Ut(e,n,"GetPoolData")).map(r=>{let s=Vt(r,"GetPoolData"),i=new de.default(H(s,"status")),a=Number(H(s,"coin_decimals")),m=Number(H(s,"pc_decimals")),l=Number(H(s,"lp_decimals")),p=new de.default(H(s,"pool_coin_amount")),f=new de.default(H(s,"pool_pc_amount")),b=new de.default(H(s,"pool_lp_supply")),d="0";try{d=H(s,"pool_open_time")}catch{d="0"}return{status:i,baseDecimals:a,quoteDecimals:m,lpDecimals:l,baseReserve:p,quoteReserve:f,lpSupply:b,startTime:new de.default(d)}})}function hn(e,t,n){return ko(e.token,t.token,n)}function ko(e,t,n){let{baseMint:o,quoteMint:r}=n,s=yn(e,n),i=yn(t,n);return s===i&&pt.logWithError("tokens not match with pool","params",{tokenA:e.mint,tokenB:t.mint,baseMint:o,quoteMint:r}),[s,i]}function yn(e,t){let{baseMint:n,quoteMint:o}=t;return e.mint.equals(n)?"base":e.mint.equals(o)?"quote":(pt.logWithError("token not match with pool","params",{token:e.mint,baseMint:n,quoteMint:o}),"base")}var Pn=e=>e==="a"||e==="b";var We=class extends Ae{constructor(n){super(n);this._poolInfos=[];this._poolInfoMap=new Map;this._pairsInfo=[];this._pairsInfoMap=new Map;this._lpTokenMap=new Map;this._lpPriceMap=new Map;this._officialIds=new Set;this._unOfficialIds=new Set;this._sdkParseInfoCache=new Map;this._stableLayout=new Oe({connection:this.scope.connection})}async load(n){if(await this.scope.fetchLiquidity(n==null?void 0:n.forceUpdate),!this.scope.apiData.liquidityPools)return;let{data:o}=this.scope.apiData.liquidityPools,[r,s]=[o.official||[],o.unOfficial||[]];this._poolInfos=[...r,...s],this._officialIds=new Set(r.map(i=>{var m,l;let a=`${(m=this.scope.token.allTokenMap.get(i.baseMint))==null?void 0:m.symbol} - ${(l=this.scope.token.allTokenMap.get(i.quoteMint))==null?void 0:l.symbol}`;return this._poolInfoMap.set(i.id,i),this._lpTokenMap.set(i.lpMint,new O({mint:i.lpMint,decimals:i.lpDecimals,symbol:a,name:`${a} LP`})),i.id})),this._unOfficialIds=new Set(s.map(i=>{var m,l;let a=`${(m=this.scope.token.allTokenMap.get(i.baseMint))==null?void 0:m.symbol} - ${(l=this.scope.token.allTokenMap.get(i.quoteMint))==null?void 0:l.symbol}`;return this._poolInfoMap.set(i.id,i),this._lpTokenMap.set(i.lpMint,new O({mint:i.lpMint,decimals:i.lpDecimals,symbol:a,name:`${a} LP`})),i.id}))}async loadPairs(n){var o;return await this.scope.fetchPairs(n==null?void 0:n.forceUpdate),this._pairsInfo=((o=this.scope.apiData.liquidityPairsInfo)==null?void 0:o.data)||[],this._pairsInfoMap=new Map(this._pairsInfo.map(r=>{let s=this._lpTokenMap.get(r.lpMint),i=s&&r.lpPrice?vt({token:s,numberPrice:r.lpPrice,decimalDone:!0}):null;return i&&this._lpPriceMap.set(r.lpMint,i),[r.ammId,r]})),this._pairsInfo}get allPools(){return this._poolInfos}get allPoolIdSet(){return{official:this._officialIds,unOfficial:this._unOfficialIds}}get allPoolMap(){return this._poolInfoMap}get allPairs(){return this._pairsInfo}get allPairsMap(){return this._pairsInfoMap}get lpTokenMap(){return this._lpTokenMap}get lpPriceMap(){return this._lpPriceMap}async fetchMultipleInfo(n){return await this._stableLayout.initStableModelLayout(),await gn(Z(V({},n),{connection:this.scope.connection}))}async sdkParseJsonLiquidityInfo(n){if(!n.length)return[];let o=n.map(r=>r.id).join("-");if(this._sdkParseInfoCache.has(o))return this._sdkParseInfoCache.get(o);try{let s=(await this.fetchMultipleInfo({pools:n.map(me)})).map((i,a)=>V(V({jsonInfo:n[a]},me(n[a])),i));return this._sdkParseInfoCache.set(o,s),s}catch(r){return console.error(r),[]}}computeAmountOut({poolKeys:n,poolInfo:o,amountIn:r,outputToken:s,slippage:i}){this.checkDisabled();let a=I("Raydium_computeAmountOut"),m=r.token,l=s;(!ft(m,n)||!ft(l,n))&&a.logWithError("token not match with pool","poolKeys",n);let{baseReserve:p,quoteReserve:f}=o;this.logDebug("baseReserve:",p.toString(),"quoteReserve:",f.toString());let b=r.token;this.logDebug("inputToken:",b),this.logDebug("amountIn:",r.toFixed()),this.logDebug("outputToken:",s),this.logDebug("slippage:",`${i.toSignificant()}%`);let d=[p,f],g=dt(r,n);g==="quote"&&d.reverse(),this.logDebug("input side:",g);let[k,N]=d,w;if(n.version===4)w=new M({baseToken:b,denominator:k,quoteToken:s,numerator:N});else{let $=rn(this._stableLayout.stableModelData,p.toNumber(),f.toNumber(),!1);w=new M({baseToken:b,denominator:g==="quote"?new G.default($*1e6):new G.default(1e6),quoteToken:s,numerator:g==="quote"?new G.default(1e6):new G.default($*1e6)})}this.logDebug("currentPrice:",`1 ${b.symbol} \u2248 ${w.toFixed()} ${s.symbol}`),this.logDebug("currentPrice invert:",`1 ${s.symbol} \u2248 ${w.invert().toFixed()} ${b.symbol}`);let L=r.raw,_=ce,q=ce;if(!L.isZero())if(n.version===4){q=L.mul($t).div(Gt);let $=L.sub(q),ae=k.add($);_=N.mul($).div(ae)}else{q=L.mul(new G.default(2)).div(new G.default(1e4));let $=L.sub(q),ae=g==="quote"?nn:on;_=new G.default(ae(this._stableLayout.stableModelData,f.toNumber(),p.toNumber(),$.toNumber()))}let F=new Q(xe).add(i).invert().mul(_).quotient,E=new B(s,_),J=new B(s,F);this.logDebug("amountOut:",E.toFixed(),"minAmountOut:",J.toFixed());let U=new M({baseToken:b,denominator:L.sub(q),quoteToken:s,numerator:_});!L.isZero()&&!_.isZero()&&(U=new M({baseToken:b,denominator:L.sub(q),quoteToken:s,numerator:_}),this.logDebug("executionPrice:",`1 ${b.symbol} \u2248 ${U.toFixed()} ${s.symbol}`),this.logDebug("executionPrice invert:",`1 ${s.symbol} \u2248 ${U.invert().toFixed()} ${b.symbol}`));let ie=new Q(parseInt(String(Math.abs(parseFloat(U.toFixed())-parseFloat(w.toFixed()))*1e9)),parseInt(String(parseFloat(w.toFixed())*1e9))),se=new B(b,q);return{amountOut:E,minAmountOut:J,currentPrice:w,executionPrice:U,priceImpact:ie,fee:se}}async computePairAmount({poolId:n,amount:o,anotherToken:r,slippage:s}){let i=K({publicKey:n}),a=this._poolInfoMap.get(i.toBase58());a||this.logAndCreateError("pool not found",i.toBase58());let m=(await this.sdkParseJsonLiquidityInfo([a]))[0];m||this.logAndCreateError("pool parseInfo not found",i.toBase58());let{baseReserve:l,quoteReserve:p}=m;this.logDebug("baseReserve:",l.toString(),"quoteReserve:",p.toString());let f=o.token;this.logDebug("tokenIn:",f,"amount:",o.toFixed(),"anotherToken:",r,"slippage:",`${s.toSignificant()}%`);let b=dt(o,me(a));this.logDebug("input side:",b);let d=ce;o.isZero()||(d=b==="base"?Qe(o.raw.mul(p),l):Qe(o.raw.mul(l),p));let k=new Q(xe).add(s).mul(d).quotient,N=new B(r,d),w=new B(r,k);return this.logDebug("anotherAmount:",N.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:N,maxAnotherAmount:w}}async swapWithAMM(n){let{poolKeys:o,payer:r,amountIn:s,amountOut:i,fixedSide:a,config:m}=n;this.logDebug("amountIn:",s),this.logDebug("amountOut:",i),(s.isZero()||i.isZero())&&this.logAndCreateError("amounts must greater than zero","amounts",{amountIn:s.toFixed(),amountOut:i.toFixed()});let{account:l}=this.scope,p=this.createTxBuilder(),{bypassAssociatedCheck:f=!1}=m||{},[b,d]=[s.token,i.token],g=await l.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1}),k=await l.getCreatedTokenAccount({mint:d.mint}),[N,w]=[s.raw,i.raw],F=await l.handleTokenAccount({side:"in",amount:N,mint:b.mint,tokenAccount:g,bypassAssociatedCheck:f}),{tokenAccount:L}=F,_=v(F,["tokenAccount"]);p.addInstruction(_);let E=await l.handleTokenAccount({side:"out",amount:0,mint:d.mint,tokenAccount:k,payer:r,bypassAssociatedCheck:f}),{tokenAccount:q}=E,z=v(E,["tokenAccount"]);return p.addInstruction(z),p.addInstruction({instructions:[sn({poolKeys:o,userKeys:{tokenAccountIn:L,tokenAccountOut:q,owner:this.scope.ownerPubKey},amountIn:N,amountOut:w,fixedSide:a})]}),p.buildMultiTx({extInfo:{amountOut:i}})}async createPool(n){this.checkDisabled(),this.scope.checkOwner(),n.version!==4&&this.logAndCreateError("invalid version","poolKeys.version",n.version);let o=this.createTxBuilder(),r=await bt(n);return await o.addInstruction({instructions:[un(Z(V({},r),{owner:this.scope.ownerPubKey}))]}).build()}async initPool(n){n.version!==4&&this.logAndCreateError("invalid version","poolKeys.version",n.version);let{baseAmount:o,quoteAmount:r,startTime:s=0,config:i}=n,a=await bt(n),{baseMint:m,quoteMint:l,lpMint:p,baseVault:f,quoteVault:b}=a,d=this.createTxBuilder(),{account:g}=this.scope,k=!!(i!=null&&i.bypassAssociatedCheck),N=await g.getCreatedTokenAccount({mint:m,associatedOnly:!1}),w=await g.getCreatedTokenAccount({mint:l,associatedOnly:!1});!N&&!w&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",g.tokenAccounts);let L=await g.getCreatedTokenAccount({mint:p,associatedOnly:!1}),U=await g.handleTokenAccount({side:"in",amount:o.raw,mint:m,tokenAccount:N,bypassAssociatedCheck:k}),{tokenAccount:_}=U,q=v(U,["tokenAccount"]);d.addInstruction(q);let ie=await g.handleTokenAccount({side:"in",amount:r.raw,mint:l,tokenAccount:w,bypassAssociatedCheck:k}),{tokenAccount:z}=ie,F=v(ie,["tokenAccount"]);d.addInstruction(F);let se=await g.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:L,bypassAssociatedCheck:k}),{tokenAccount:E}=se,J=v(se,["tokenAccount"]);return d.addInstruction(J),d.addInstruction({instructions:[Xe({source:_,destination:f,owner:this.scope.ownerPubKey,amount:o.raw}),Xe({source:z,destination:b,owner:this.scope.ownerPubKey,amount:r.raw}),cn({poolKeys:a,userKeys:{lpTokenAccount:E,payer:this.scope.ownerPubKey},startTime:s})]}),await d.build()}async addLiquidity(n){let{poolId:o,amountInA:r,amountInB:s,fixedSide:i,config:a}=n,m=K({publicKey:o}),l=this.allPools.find(Ln=>Ln.id===m.toBase58());l||this.logAndCreateError("pool not found",o);let f=(await this.sdkParseJsonLiquidityInfo([l]))[0];f||this.logAndCreateError("pool parse error",f),this.logDebug("amountInA:",r,"amountInB:",s),(r.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:s.toFixed()});let{account:b}=this.scope,d=(a==null?void 0:a.bypassAssociatedCheck)||!1,[g,k]=[r.token,s.token],N=await b.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1}),w=await b.getCreatedTokenAccount({mint:k.mint,associatedOnly:!1});!N&&!w&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",b.tokenAccounts);let L=await b.getCreatedTokenAccount({mint:f.lpMint}),_=[g,k],q=[N,w],z=[r.raw,s.raw],[F]=hn(r,s,f),E="base";(!["quote","base"].includes(F)||!Pn(i))&&this.logAndCreateError("invalid fixedSide","fixedSide",i),F==="quote"?(_.reverse(),q.reverse(),z.reverse(),E=i==="a"?"quote":"base"):F==="base"&&(E=i==="a"?"base":"quote");let[J,U]=_,[ie,se]=q,[$,ae]=z,fe=this.createTxBuilder(),yt=await b.handleTokenAccount({side:"in",amount:$,mint:J.mint,tokenAccount:ie,bypassAssociatedCheck:d}),{tokenAccount:kn}=yt,wn=v(yt,["tokenAccount"]);fe.addInstruction(wn);let gt=await b.handleTokenAccount({side:"in",amount:ae,mint:U.mint,tokenAccount:se,bypassAssociatedCheck:d}),{tokenAccount:Tn}=gt,In=v(gt,["tokenAccount"]);fe.addInstruction(In);let ht=await b.handleTokenAccount({side:"out",amount:0,mint:f.lpMint,tokenAccount:L,bypassAssociatedCheck:d}),{tokenAccount:An}=ht,Sn=v(ht,["tokenAccount"]);return fe.addInstruction(Sn),fe.addInstruction({instructions:[mn({poolKeys:f,userKeys:{baseTokenAccount:kn,quoteTokenAccount:Tn,lpTokenAccount:An,owner:this.scope.ownerPubKey},baseAmountIn:$,quoteAmountIn:ae,fixedSide:E})]}),await fe.build()}async removeLiquidity(n){let{poolId:o,amountIn:r,config:s}=n,i=K({publicKey:o}),a=this.allPools.find(U=>U.id===i.toBase58());a||this.logAndCreateError("pool not found",o);let l=(await this.sdkParseJsonLiquidityInfo([a]))[0];l||this.logAndCreateError("pool pass error",l);let{baseMint:p,quoteMint:f,lpMint:b}=l;this.logDebug("amountIn:",r),r.isZero()&&this.logAndCreateError("amount must greater than zero","amountIn",r.toFixed()),r.token.mint.equals(b)||this.logAndCreateError("amountIn's token not match lpMint","amountIn",r);let{account:d}=this.scope,g=await d.getCreatedTokenAccount({mint:b,associatedOnly:!1});g||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",d.tokenAccounts);let k=await d.getCreatedTokenAccount({mint:p}),N=await d.getCreatedTokenAccount({mint:f}),w=this.createTxBuilder(),L=(s==null?void 0:s.bypassAssociatedCheck)||!1,E=await d.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:k,bypassAssociatedCheck:L}),{tokenAccount:_}=E,q=v(E,["tokenAccount"]);w.addInstruction(q);let J=await d.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:N,bypassAssociatedCheck:L}),{tokenAccount:z}=J,F=v(J,["tokenAccount"]);return w.addInstruction(F),w.addInstruction({instructions:[xn.ComputeBudgetProgram.requestUnits({units:4e5,additionalFee:0}),ln({poolKeys:l,userKeys:{lpTokenAccount:g,baseTokenAccount:_,quoteTokenAccount:z,owner:this.scope.ownerPubKey},amountIn:r.raw})]}),await w.build()}lpMintToTokenAmount({poolId:n,amount:o,decimalDone:r}){let s=K({publicKey:n});s||this.logAndCreateError("pool not found");let i=this._poolInfoMap.get(s.toBase58()),a=we(o),m=new O({mint:i.lpMint,decimals:i.lpDecimals}),l=r?new h(a.numerator,a.denominator):new h(a.numerator,a.denominator).mul(new G.default(10).pow(new G.default(m.decimals)));return new B(m,Rt(l))}getFixedSide({poolId:n,inputMint:o}){let[r,s]=[K({publicKey:n}),K({publicKey:o})],i=this._poolInfoMap.get(r.toBase58());i||this.logAndCreateError("pool not found",r.toBase58());let a=i.baseMint===s.toBase58();return(s.equals(_e)||s.equals(ne))&&(a=!a),a?"a":"b"}};0&&(module.exports={});
//# sourceMappingURL=liquidity.js.map