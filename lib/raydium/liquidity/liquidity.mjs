var yn=Object.defineProperty,gn=Object.defineProperties;var hn=Object.getOwnPropertyDescriptors;var he=Object.getOwnPropertySymbols;var lt=Object.prototype.hasOwnProperty,pt=Object.prototype.propertyIsEnumerable;var mt=(t,e,n)=>e in t?yn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,F=(t,e)=>{for(var n in e||(e={}))lt.call(e,n)&&mt(t,n,e[n]);if(he)for(var n of he(e))pt.call(e,n)&&mt(t,n,e[n]);return t},$=(t,e)=>gn(t,hn(e));var W=(t,e)=>{var n={};for(var o in t)lt.call(t,o)&&e.indexOf(o)<0&&(n[o]=t[o]);if(t!=null&&he)for(var o of he(t))e.indexOf(o)<0&&pt.call(t,o)&&(n[o]=t[o]);return n};import{ComputeBudgetProgram as ko}from"@solana/web3.js";import z from"bn.js";import A from"bn.js";import _n from"big.js";import ke from"bn.js";import{get as dt,set as Pn}from"lodash";import bt from"dayjs";import xn from"dayjs/plugin/utc";bt.extend(xn);var Ne=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:3,this.name=e.name}set level(e){this.logLevel=e}get time(){return bt().utc().format("YYYY/MM/DD HH:mm:ss UTC")}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let n=e.map(o=>typeof o=="object"?JSON.stringify(o):o).join(", ");throw new Error(n)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},ft={},kn={};function I(t){let e=dt(ft,t);if(!e){let n=dt(kn,t);e=new Ne({name:t,logLevel:n}),Pn(ft,t,e)}return e}import wn from"toformat";var Tn=wn,le=Tn;import xe from"big.js";import In from"decimal.js-light";var Pe=I("module/fraction"),qe=le(xe),pe=le(In),An={[0]:pe.ROUND_DOWN,[1]:pe.ROUND_HALF_UP,[2]:pe.ROUND_UP},Ln={[0]:xe.roundDown,[1]:xe.roundHalfUp,[2]:xe.roundUp},g=class{constructor(e,n=de){this.numerator=T(e),this.denominator=T(n)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new g(this.denominator,this.numerator)}add(e){let n=e instanceof g?e:new g(T(e));return this.denominator.eq(n.denominator)?new g(this.numerator.add(n.numerator),this.denominator):new g(this.numerator.mul(n.denominator).add(n.numerator.mul(this.denominator)),this.denominator.mul(n.denominator))}sub(e){let n=e instanceof g?e:new g(T(e));return this.denominator.eq(n.denominator)?new g(this.numerator.sub(n.numerator),this.denominator):new g(this.numerator.mul(n.denominator).sub(n.numerator.mul(this.denominator)),this.denominator.mul(n.denominator))}mul(e){let n=e instanceof g?e:new g(T(e));return new g(this.numerator.mul(n.numerator),this.denominator.mul(n.denominator))}div(e){let n=e instanceof g?e:new g(T(e));return new g(this.numerator.mul(n.denominator),this.denominator.mul(n.numerator))}toSignificant(e,n={groupSeparator:""},o=1){Number.isInteger(e)||Pe.logWithError(`${e} is not an integer.`),e<=0&&Pe.logWithError(`${e} is not positive.`),pe.set({precision:e+1,rounding:An[o]});let i=new pe(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),n)}toFixed(e,n={groupSeparator:""},o=1){return Number.isInteger(e)||Pe.logWithError(`${e} is not an integer.`),e<0&&Pe.logWithError(`${e} is negative.`),qe.DP=e,qe.RM=Ln[o]||1,new qe(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,n)}isZero(){return this.numerator.isZero()}};var Bn=I("Raydium_amount"),yt=le(_n);function Nn(t,e){let n="0",o="0";if(t.includes(".")){let i=t.split(".");i.length===2?([n,o]=i,o=o.padEnd(e,"0")):Bn.logWithError(`invalid number string, num: ${t}`)}else n=t;return[n,o.slice(0,e)||o]}var _=class extends g{constructor(n,o,i=!0,s){let r=new ke(0),a=se.pow(new ke(n.decimals));if(i)r=T(o);else{let m=new ke(0),l=new ke(0);if(typeof o=="string"||typeof o=="number"||typeof o=="bigint"){let[p,f]=Nn(o.toString(),n.decimals);m=T(p),l=T(f)}m=m.mul(a),r=m.add(l)}super(r,a);this.logger=I(s||"Amount"),this.token=n}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(n){return this.token.equals(n.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(n.raw)}lt(n){return this.token.equals(n.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(n.raw)}add(n){return this.token.equals(n.token)||this.logger.logWithError("add token not equals"),new _(this.token,this.raw.add(n.raw))}subtract(n){return this.token.equals(n.token)||this.logger.logWithError("sub token not equals"),new _(this.token,this.raw.sub(n.raw))}toSignificant(n=this.token.decimals,o,i=0){return super.toSignificant(n,o,i)}toFixed(n=this.token.decimals,o,i=0){return n>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(n,o,i)}toExact(n={groupSeparator:""}){return yt.DP=this.token.decimals,new yt(this.numerator.toString()).div(this.denominator.toString()).toFormat(n)}};import{PublicKey as qn}from"@solana/web3.js";var gt={symbol:"SOL",name:"Solana",decimals:9},Z={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},Go={isQuantumSOL:!0,isLp:!1,official:!0,mint:new qn(Z.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};import{PublicKey as De}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Mn}from"@solana/spl-token";import{PublicKey as q,SystemProgram as Dn,SYSVAR_RENT_PUBKEY as En}from"@solana/web3.js";function u({pubkey:t,isSigner:e=!1,isWritable:n=!0}){return{pubkey:t,isWritable:n,isSigner:e}}var Me=[u({pubkey:Mn,isWritable:!1}),u({pubkey:Dn.programId,isWritable:!1}),u({pubkey:En,isWritable:!1})];function v({publicKey:t,transformSol:e}){if(t instanceof q)return e&&t.equals(ee)?we:t;if(e&&t===ee.toBase58())return we;if(typeof t=="string")try{return new q(t)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}function ht(t){try{return new q(t)}catch{return t}}var Xo=new q("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),er=new q("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),tr=new q("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),nr=new q("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),or=new q("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),rr=new q("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),ir=new q("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),sr=new q("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),ar=new q("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),ur=new q("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),cr=new q("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),we=new q("So11111111111111111111111111111111111111112"),ee=q.default;var Ee=class{constructor({mint:e,decimals:n,symbol:o="UNKNOWN",name:i="UNKNOWN",skipMint:s=!1}){if(e===ee.toBase58()||e instanceof De&&ee.equals(e)){this.decimals=Z.decimals,this.symbol=Z.symbol,this.name=Z.name,this.mint=new De(Z.mint);return}this.decimals=n,this.symbol=o,this.name=i,this.mint=s?De.default:v({publicKey:e})}equals(e){return this===e?!0:this.mint.equals(e.mint)}},E=Ee;E.WSOL=new Ee(Z);var Re=class{constructor({decimals:e,symbol:n="UNKNOWN",name:o="UNKNOWN"}){this.decimals=e,this.symbol=n,this.name=o}equals(e){return this===e}},Oe=Re;Oe.SOL=new Re(gt);var Pt=new g(xt),U=class extends g{toSignificant(e=5,n,o){return this.mul(Pt).toSignificant(e,n,o)}toFixed(e=2,n,o){return this.mul(Pt).toFixed(e,n,o)}};var On=I("Raydium_price"),M=class extends g{constructor(n){let{baseToken:o,quoteToken:i,numerator:s,denominator:r}=n;super(s,r);this.baseToken=o,this.quoteToken=i,this.scalar=new g(We(o.decimals),We(i.decimals))}get raw(){return new g(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new M({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(n){this.quoteToken!==n.baseToken&&On.logWithError("mul token not equals");let o=super.mul(n);return new M({baseToken:this.baseToken,quoteToken:n.quoteToken,denominator:o.denominator,numerator:o.numerator})}toSignificant(n=this.quoteToken.decimals,o,i){return this.adjusted.toSignificant(n,o,i)}toFixed(n=this.quoteToken.decimals,o,i){return this.adjusted.toFixed(n,o,i)}};var Te=I("Raydium_bignumber");var ae=new A(0),de=new A(1),Cr=new A(2),Fr=new A(3),Ur=new A(5),se=new A(10),xt=new A(100),Vr=new A(1e3),Yr=new A(1e4),kt=9007199254740991;function T(t){if(t instanceof A)return t;if(typeof t=="string"){if(t.match(/^-?[0-9]+$/))return new A(t);Te.logWithError(`invalid BigNumberish string: ${t}`)}return typeof t=="number"?(t%1&&Te.logWithError(`BigNumberish number underflow: ${t}`),(t>=kt||t<=-kt)&&Te.logWithError(`BigNumberish number overflow: ${t}`),new A(String(t))):typeof t=="bigint"?new A(t.toString()):(Te.logWithError(`invalid BigNumberish value: ${t}`),new A(0))}function We(t){return se.pow(T(t))}function fe(t){var a;if(t===void 0)return{denominator:"1",numerator:"0"};if(t instanceof A)return{numerator:t.toString(),denominator:"1"};if(t instanceof g)return{denominator:t.denominator.toString(),numerator:t.numerator.toString()};let e=String(t),[,n="",o="",i=""]=(a=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?a:[],s="1"+"0".repeat(i.length),r=n+(o==="0"?"":o)+i||"0";return{denominator:s,numerator:r,sign:n,int:o,dec:i}}function ve(t,e){let n=t.divmod(e);return n.mod.isZero()?n.div:n.div.negative!==0?n.div.isubn(1):n.div.iaddn(1)}function Rn(t){var o;let[,e="",n=""]=(o=t.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?o:[];return`${e}${n}`}function wt(t,e=0){return t instanceof A?t:new A(Rn(Tt(t).mul(se.pow(new A(String(e))))))}function Tt(t){if(t instanceof U)return new g(t.numerator,t.denominator);if(t instanceof M)return t.adjusted;if(t instanceof _)try{return Tt(t.toExact())}catch{return new g(ae)}if(t instanceof g)return t;let e=String(t),n=fe(e);return new g(n.numerator,n.denominator)}function It(t){let{token:e,numberPrice:n,decimalDone:o}=t,i=new E({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),{numerator:s,denominator:r}=fe(n),a=o?new A(s).mul(se.pow(new A(e.decimals))):s,m=new A(r).mul(se.pow(new A(i.decimals)));return new M({baseToken:i,denominator:m.toString(),quoteToken:new E($(F({},e),{skipMint:!0,mint:""})),numerator:a.toString()})}import{PublicKey as Wn}from"@solana/web3.js";import vn from"bn.js";var Kn=[E,_,Wn,g,vn,M,U];function Cn(t){return typeof t=="object"&&t!==null&&!Kn.some(e=>typeof e=="object"&&t instanceof e)}function ue(t){return typeof t=="string"?ht(t):Array.isArray(t)?t.map(e=>ue(e)):Cn(t)?Object.fromEntries(Object.entries(t).map(([e,n])=>[e,ue(n)])):t}import{createInitializeAccountInstruction as Ws,createCloseAccountInstruction as vs,createTransferInstruction as zn,TOKEN_PROGRAM_ID as Ks}from"@solana/spl-token";import{Keypair as Vs,PublicKey as Ys,SystemProgram as Qs}from"@solana/web3.js";import Js from"bn.js";import{PACKET_DATA_SIZE as Fn,PublicKey as St,sendAndConfirmTransaction as At,Transaction as Ie}from"@solana/web3.js";var H=I("Raydium_txTool"),Ae=class{constructor(e){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:e=[],endInstructions:n=[],signers:o=[]}){return this.instructions.push(...e),this.endInstructions.push(...n),this.signers.push(...o),this}build(e){let n=new Ie;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,{transaction:n,signers:this.signers,execute:async()=>{var i;let o=await Lt(this.connection);if(n.recentBlockhash=o,(i=this.owner)!=null&&i.isKeyPair)return At(this.connection,n,this.signers);if(this.signAllTransactions){this.signers.length&&n.partialSign(...this.signers);let s=await this.signAllTransactions([n]);return await this.connection.sendRawTransaction(s[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:n=[],extInfo:o}=e,{transaction:i}=this.build(o),s=n.filter(m=>m.transaction.instructions.length>0),r=[...s.map(m=>m.transaction),i],a=[...s.map(m=>m.signers),this.signers];return{transactions:r,signers:a,execute:async()=>{var l;let m=await Lt(this.connection);if((l=this.owner)!=null&&l.isKeyPair)return await Promise.all(r.map(async(p,f)=>(p.recentBlockhash=m,await At(this.connection,p,a[f]))));if(this.signAllTransactions){let p=r.map((d,y)=>(d.recentBlockhash=m,a[y].length&&d.partialSign(...a[y]),d)),f=await this.signAllTransactions(p),b=[];for(let d=0;d<f.length;d+=1){let y=await this.connection.sendRawTransaction(f[d].serialize(),{skipPreflight:!0});b.push(y)}return b}throw new Error("please connect wallet first")},extInfo:o||{}}}};async function Lt(t){var e,n;try{return((n=await((e=t.getLatestBlockhash)==null?void 0:e.call(t)))==null?void 0:n.blockhash)||(await t.getRecentBlockhash()).blockhash}catch{return(await t.getRecentBlockhash()).blockhash}}function Un(t,e){t.length<1&&H.logWithError(`no instructions provided: ${t.toString()}`),e.length<1&&H.logWithError(`no signers provided:, ${e.toString()}`);let n=new Ie;n.recentBlockhash="11111111111111111111111111111111",n.feePayer=e[0],n.add(...t);let o=n.compileMessage().serialize();return e.length+e.length*64+o.length}async function _t(t,e,n){let o=new St("RaydiumSimuLateTransaction11111111111111111"),i=[],s=new Ie;s.feePayer=o;for(let m of e)Un([...s.instructions,m],[o])>Fn&&(i.push(s),s=new Ie,s.feePayer=o),s.add(m);s.instructions.length>0&&i.push(s);let r=[];try{r=await Promise.all(i.map(m=>t.simulateTransaction(m)))}catch(m){m instanceof Error&&H.logWithError(`failed to simulate for instructions, RPC_ERROR, ${m.message}`)}let a=[];for(let m of r){let{value:l}=m;if(H.debug(`simulate result: ${JSON.stringify(m)}`),l.logs){let p=l.logs.filter(f=>f&&f.includes(n));H.debug(`filteredLog: ${JSON.stringify(a)}`),p.length||H.logWithError(` "simulate log not match keyword, keyword: ${n}`),a.push(...p)}}return a}function Bt(t,e){let n=t.match(/{["\w:,]+}/g);return!n||n.length!==1?H.logWithError(`simulate log fail to match json, keyword: ${e}`):n[0]}function G(t,e){let o=new RegExp(`"${e}":(\\d+)`,"g").exec(t);return!o||o.length!==2?H.logWithError(`simulate log fail to match key", key: ${e}`):o[1]}async function Ke(t,e){let[n,o]=await St.findProgramAddress(t,e);return{publicKey:n,nonce:o}}import{PublicKey as pi}from"@solana/web3.js";var bi=I("Raydium_accountInfo_util");import{PublicKey as Gn}from"@solana/web3.js";import Mt,{isBN as Dt}from"bn.js";import{bits as Ei,BitStructure as Oi,blob as Vn,Blob as Ri,cstr as Wi,f32 as vi,f32be as Ki,f64 as Ci,f64be as Fi,greedy as Ui,Layout as Yn,ns64 as Vi,ns64be as Yi,nu64 as ji,nu64be as Qi,offset as $i,s16 as Gi,s16be as Ji,s24 as zi,s24be as Zi,s32 as Hi,s32be as Xi,s40 as es,s40be as ts,s48 as ns,s48be as os,s8 as rs,seq as jn,struct as is,Structure as Qn,u16 as ss,u16be as as,u24 as us,u24be as cs,u32 as ms,u32be as ls,u40 as ps,u40be as ds,u48 as fs,u48be as bs,u8 as ys,UInt as $n,union as gs,Union as hs,unionLayoutDiscriminator as Ps,utf8 as xs}from"@solana/buffer-layout";var Ce=Yn,Nt=Qn;var Fe=$n;var qt=jn;var Ue=Vn;var Le=class extends Ce{constructor(n,o,i){super(n,i);this.blob=Ue(n),this.signed=o}decode(n,o=0){let i=new Mt(this.blob.decode(n,o),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(n,o,i=0){return typeof n=="number"&&(n=new Mt(n)),this.signed&&(n=n.toTwos(this.span*8)),this.blob.encode(n.toArrayLike(Buffer,"le",this.span),o,i)}};function R(t){return new Fe(1,t)}function Se(t){return new Fe(4,t)}function c(t){return new Le(8,!1,t)}function V(t){return new Le(16,!1,t)}var Ve=class extends Ce{constructor(n,o,i,s){super(n.span,s);this.layout=n,this.decoder=o,this.encoder=i}decode(n,o){return this.decoder(this.layout.decode(n,o))}encode(n,o,i){return this.layout.encode(this.encoder(n),o,i)}getSpan(n,o){return this.layout.getSpan(n,o)}};function x(t){return new Ve(Ue(32),e=>new Gn(e),e=>e.toBuffer(),t)}var Ye=class extends Nt{decode(e,n){return super.decode(e,n)}};function D(t,e,n){return new Ye(t,e,n)}function be(t,e,n){let o,i=typeof e=="number"?e:Dt(e)?e.toNumber():new Proxy(e,{get(s,r){if(!o){let a=Reflect.get(s,"count");o=Dt(a)?a.toNumber():a,Reflect.set(s,"count",o)}return Reflect.get(s,r)},set(s,r,a){return r==="count"&&(o=a),Reflect.set(s,r,a)}});return qt(t,i,n)}var Jn=D([x("mint"),x("owner"),c("amount"),Se("delegateOption"),x("delegate"),R("state"),Se("isNativeOption"),c("isNative"),c("delegatedAmount"),Se("closeAuthorityOption"),x("closeAuthority")]);function je({source:t,destination:e,owner:n,amount:o,multiSigners:i=[]}){return zn(t,e,n,T(o).toNumber(),i)}var Qe=(...t)=>t.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),ye=class{constructor({scope:e,moduleName:n}){this.disabled=!1;this.scope=e,this.logger=I(n)}createTxBuilder(e){return this.scope.checkOwner(),new Ae({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Qe(e))}logInfo(...e){this.logger.info(Qe(e))}logAndCreateError(...e){let n=Qe(e);throw new Error(n)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as Et}from"@solana/web3.js";import Ot from"bn.js";var Rt=new Ot(25),Wt=new Ot(1e4),vt="675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8",Zn=new Et(vt),Kt="5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h",Hn=new Et(Kt),aa={[vt]:4,[Kt]:5},Ct={4:Zn,5:Hn},Ft={4:3,5:3};import{TOKEN_PROGRAM_ID as et}from"@solana/spl-token";import{SystemProgram as po,TransactionInstruction as J}from"@solana/web3.js";var $e=D([R("instruction"),c("amountIn"),c("minAmountOut")]),Ge=D([R("instruction"),c("maxAmountIn"),c("amountOut")]),Je=D([R("instruction"),R("nonce")]),ze=D([R("instruction"),R("nonce"),c("startTime")]),Xn=D([c("status"),c("nonce"),c("maxOrder"),c("depth"),c("baseDecimal"),c("quoteDecimal"),c("state"),c("resetFlag"),c("minSize"),c("volMaxCutRatio"),c("amountWaveRatio"),c("baseLotSize"),c("quoteLotSize"),c("minPriceMultiplier"),c("maxPriceMultiplier"),c("systemDecimalValue"),c("minSeparateNumerator"),c("minSeparateDenominator"),c("tradeFeeNumerator"),c("tradeFeeDenominator"),c("pnlNumerator"),c("pnlDenominator"),c("swapFeeNumerator"),c("swapFeeDenominator"),c("baseNeedTakePnl"),c("quoteNeedTakePnl"),c("quoteTotalPnl"),c("baseTotalPnl"),V("quoteTotalDeposited"),V("baseTotalDeposited"),V("swapBaseInAmount"),V("swapQuoteOutAmount"),c("swapBase2QuoteFee"),V("swapQuoteInAmount"),V("swapBaseOutAmount"),c("swapQuote2BaseFee"),x("baseVault"),x("quoteVault"),x("baseMint"),x("quoteMint"),x("lpMint"),x("openOrders"),x("marketId"),x("marketProgramId"),x("targetOrders"),x("withdrawQueue"),x("lpVault"),x("owner"),c("lpReserve"),be(c(),3,"padding")]),la=D([c("accountType"),c("status"),c("nonce"),c("maxOrder"),c("depth"),c("baseDecimal"),c("quoteDecimal"),c("state"),c("resetFlag"),c("minSize"),c("volMaxCutRatio"),c("amountWaveRatio"),c("baseLotSize"),c("quoteLotSize"),c("minPriceMultiplier"),c("maxPriceMultiplier"),c("systemDecimalsValue"),c("abortTradeFactor"),c("priceTickMultiplier"),c("priceTick"),c("minSeparateNumerator"),c("minSeparateDenominator"),c("tradeFeeNumerator"),c("tradeFeeDenominator"),c("pnlNumerator"),c("pnlDenominator"),c("swapFeeNumerator"),c("swapFeeDenominator"),c("baseNeedTakePnl"),c("quoteNeedTakePnl"),c("quoteTotalPnl"),c("baseTotalPnl"),c("poolOpenTime"),c("punishPcAmount"),c("punishCoinAmount"),c("orderbookToInitTime"),V("swapBaseInAmount"),V("swapQuoteOutAmount"),V("swapQuoteInAmount"),V("swapBaseOutAmount"),c("swapQuote2BaseFee"),c("swapBase2QuoteFee"),x("baseVault"),x("quoteVault"),x("baseMint"),x("quoteMint"),x("lpMint"),x("modelDataAccount"),x("openOrders"),x("marketId"),x("marketProgramId"),x("targetOrders"),x("owner"),be(c(),64,"padding")]),Ze=D([R("instruction"),c("baseAmountIn"),c("quoteAmountIn"),c("fixedSide")]),He=D([R("instruction"),c("amountIn")]);import{PublicKey as eo}from"@solana/web3.js";var ce=new eo("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),ne=5e4,to=D([c("x"),c("y"),c("price")]),no=D([c("accountType"),c("status"),c("multiplier"),c("validDataCount"),be(to,ne,"DataElement")]);function oo(t,e){return[0,ne-2]}function ro(t){return[0,ne-2]}function io(t){return[0,ne-2]}function so(t,e,n){let[o,i]=oo(e,n),s=o,r=i,a=0,m=e*t.multiplier/n;for(;s<=r;){if(a=Math.floor((r+s)/2),a===0||a>=ne-2)return[a,a,!1];let l=t.DataElement[a].x*t.multiplier/t.DataElement[a].y,p=t.DataElement[a-1].x*t.multiplier/t.DataElement[a-1].y,f=t.DataElement[a+1].x*t.multiplier/t.DataElement[a+1].y;if(m===l)return[a,a,!0];if(m===p)return[a-1,a-1,!0];if(m===f)return[a+1,a+1,!0];if(m<p)r=a-1;else{if(m>p&&m<l)return[a-1,a,!0];if(m>l&&m<f)return[a,a+1,!0];s=a+1}}return[a,a,!1]}function Xe(t,e,n){let[o,i,s]=so(t,e,n);if(!s)return 0;if(o===i){let r=t.DataElement[o].x;return e*t.multiplier/r}else{let r=t.DataElement[o].x,a=t.DataElement[o].y,m=t.DataElement[i].x,l=t.DataElement[i].y,p=n*(m*a-r*l),f=r*p,b=(m-r)*(e*a-r*n)*l,d=f+b;return e*t.multiplier*p/d}}function te(t,e,n){return e*t.multiplier/n}function Ut(t,e,n){return e*n/t.multiplier}function ao(t,e){let[n,o]=ro(e),i=n,s=o,r=0,a=e;for(;i<s;){if(r=Math.floor((s+i)/2),r<=0||r>ne-2)return[r,r,!1];let m=t.DataElement[r].x,l=t.DataElement[r-1].x,p=t.DataElement[r+1].x;if(a===m)return[r,r,!0];if(a===l)return[r-1,r-1,!0];if(a===p)return[r+1,r+1,!0];if(a<l)s=r-1;else{if(a>l&&a<m)return[r-1,r,!0];if(a>m&&a<p)return[r,r+1,!0];i=r+1}}return[r,r,!1]}function uo(t,e){let[n,o]=io(e),i=n,s=o,r=0,a=e;for(;i<=s;){if(r=Math.floor((s+i)/2),r<=0||r>=ne-2)return[r,r,!1];let m=t.DataElement[r].y,l=t.DataElement[r-1].y,p=t.DataElement[r+1].y;if(a===m)return[r,r,!0];if(a===l)return[r-1,r-1,!0];if(a===p)return[r+1,r+1,!0];if(a<p)i=r+1;else{if(a<l&&a>m)return[r-1,r,!0];if(a<m&&a>p)return[r,r+1,!0];s=r-1}}return[r,r,!1]}function Vt(t,e,n,o){let i=o?e+n:e-n,[s,r,a]=ao(t,i);if(!a)return[0,0,!1,a];if(s===r)return[t.DataElement[r].price,t.DataElement[r].y,!1,a];{let m=t.DataElement[s].x,l=t.DataElement[r].x,p=t.DataElement[s].price,f=t.DataElement[r].price,b=t.DataElement[s].y,d=t.DataElement[r].y;if(e>=m&&e<=l)return o?[f,d,!0,a]:[p,b,!0,a];{let y,k;return o?(y=p+(f-p)*(e-m)/(l-m),k=b-(i-m)*t.multiplier/f):(y=p+(f-p)*(e-m)/(l-m),k=d+(l-i)*t.multiplier/p),[y,k,!1,a]}}}function co(t,e,n,o){let i=o?e-n:e+n,[s,r,a]=uo(t,i);if(!a)return[0,0,!1,a];if(s===r)return[t.DataElement[r].price,t.DataElement[r].x,!1,a];{let m=t.DataElement[s].x,l=t.DataElement[r].x,p=t.DataElement[s].price,f=t.DataElement[r].price,b=t.DataElement[s].y,d=t.DataElement[r].y;if(e>=d&&e<=b)return o?[f,l,!0,a]:[p,m,!0,a];{let y,k;return o?(y=p+(f-p)*(b-e)/(b-d),k=m+f*(b-i)/t.multiplier):(y=p+(f-p)*(b-e)/(b-d),k=l-p*(i-d)/t.multiplier),[y,k,!1,a]}}}function mo(t,e){let n=Vt(t,e,0,!1);return n[3]?n[0]:0}function Yt(t,e,n,o){let i=Xe(t,e,n),s=te(t,e,i),r=te(t,n,i),a=te(t,o,i),m=!0,[l,p,f,b]=Vt(t,s,a,m);if(!b)return 0;if(f)return o*t.multiplier/l;{let d=r-p;return Ut(t,d,i)}}function jt(t,e,n,o){let i=Xe(t,e,n),s=te(t,e,i),r=te(t,n,i),a=te(t,o,i),m=!1,[l,p,f,b]=co(t,r,a,m);if(!b)return 0;if(f)return o*l/t.multiplier;{let d=s-p;return Ut(t,d,i)}}function lo(t){let e=no.decode(t);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(n=>({x:n.x.toNumber(),y:n.y.toNumber(),price:n.price.toNumber()}))}}function Qt(t,e,n,o){let i=mo(t,te(t,e,Xe(t,e,n)))/t.multiplier;return o?i:1/i}var _e=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(ce);e&&(this._layoutData=lo(e==null?void 0:e.data))}}};var Be=I("Raydium_liquidity_instruction");function $t(t){let{poolKeys:e,userKeys:n,amountIn:o,amountOut:i,fixedSide:s}=t,{version:r}=e;if(r===4||r===5){let a={poolKeys:e,userKeys:n};if(s==="in")return fo($(F({},a),{amountIn:o,minAmountOut:i}),r);if(s==="out")return bo($(F({},a),{maxAmountIn:o,amountOut:i}),r);Be.logWithError("invalid params","params",t)}throw Be.logWithError("invalid version","poolKeys.version",r),new Error("invalid version")}function Gt(t){let e=D([R("instruction"),R("simulateType")]),n=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},n);let o=[u({pubkey:t.id,isWritable:!1}),u({pubkey:t.authority,isWritable:!1}),u({pubkey:t.openOrders,isWritable:!1}),u({pubkey:t.baseVault,isWritable:!1}),u({pubkey:t.quoteVault,isWritable:!1}),u({pubkey:t.lpMint,isWritable:!1}),u({pubkey:t.marketId,isWritable:!1})];return new J({programId:t.programId,keys:o,data:n})}function fo({poolKeys:t,userKeys:e,amountIn:n,minAmountOut:o},i){let s=Buffer.alloc($e.span);$e.encode({instruction:9,amountIn:T(n),minAmountOut:T(o)},s);let r=[u({pubkey:et,isWritable:!1}),u({pubkey:t.id}),u({pubkey:t.authority,isWritable:!1}),u({pubkey:t.openOrders})];return i===4&&r.push(u({pubkey:t.targetOrders})),r.push(u({pubkey:t.baseVault}),u({pubkey:t.quoteVault})),i===5&&r.push(u({pubkey:ce})),r.push(u({pubkey:t.marketProgramId,isWritable:!1}),u({pubkey:t.marketId}),u({pubkey:t.marketBids}),u({pubkey:t.marketAsks}),u({pubkey:t.marketEventQueue}),u({pubkey:t.marketBaseVault}),u({pubkey:t.marketQuoteVault}),u({pubkey:t.marketAuthority,isWritable:!1}),u({pubkey:e.tokenAccountIn}),u({pubkey:e.tokenAccountOut}),u({pubkey:e.owner,isWritable:!1})),new J({programId:t.programId,keys:r,data:s})}function bo({poolKeys:t,userKeys:e,maxAmountIn:n,amountOut:o},i){let s=Buffer.alloc(Ge.span);Ge.encode({instruction:11,maxAmountIn:T(n),amountOut:T(o)},s);let r=[u({pubkey:po.programId,isWritable:!1}),u({pubkey:t.id}),u({pubkey:t.authority,isWritable:!1}),u({pubkey:t.openOrders}),u({pubkey:t.targetOrders}),u({pubkey:t.baseVault}),u({pubkey:t.quoteVault})];return i===5&&r.push(u({pubkey:ce})),r.push(u({pubkey:t.marketProgramId,isWritable:!1}),u({pubkey:t.marketId}),u({pubkey:t.marketBids}),u({pubkey:t.marketAsks}),u({pubkey:t.marketEventQueue}),u({pubkey:t.marketBaseVault}),u({pubkey:t.marketQuoteVault}),u({pubkey:t.marketAuthority,isWritable:!1}),u({pubkey:e.tokenAccountIn}),u({pubkey:e.tokenAccountOut}),u({pubkey:e.owner,isWritable:!1,isSigner:!0})),new J({programId:t.programId,keys:r,data:s})}function Jt(t){let s=t,{owner:e}=s,n=W(s,["owner"]),o=Buffer.alloc(Je.span);Je.encode({instruction:10,nonce:n.nonce},o);let i=[...Me,u({pubkey:n.targetOrders}),u({pubkey:n.withdrawQueue}),u({pubkey:n.authority,isWritable:!1}),u({pubkey:n.lpMint}),u({pubkey:n.baseMint,isWritable:!1}),u({pubkey:n.quoteMint,isWritable:!1}),u({pubkey:n.baseVault}),u({pubkey:n.quoteVault}),u({pubkey:n.lpVault}),u({pubkey:n.marketId,isWritable:!1}),u({pubkey:e,isSigner:!0})];return new J({programId:n.programId,keys:i,data:o})}function zt(t){let{poolKeys:e,userKeys:n,startTime:o}=t,i=Buffer.alloc(ze.span);ze.encode({instruction:0,nonce:e.nonce,startTime:T(o)},i);let s=[...Me,u({pubkey:e.id}),u({pubkey:e.authority,isWritable:!1}),u({pubkey:e.openOrders}),u({pubkey:e.lpMint}),u({pubkey:e.baseMint,isWritable:!1}),u({pubkey:e.quoteMint,isWritable:!1}),u({pubkey:e.baseVault,isWritable:!1}),u({pubkey:e.quoteVault,isWritable:!1}),u({pubkey:e.withdrawQueue}),u({pubkey:e.targetOrders}),u({pubkey:n.lpTokenAccount}),u({pubkey:e.lpVault,isWritable:!1}),u({pubkey:e.marketProgramId,isWritable:!1}),u({pubkey:e.marketId,isWritable:!1}),u({pubkey:n.payer,isSigner:!0})];return new J({programId:e.programId,keys:s,data:i})}function Zt(t){let{poolKeys:e,userKeys:n,baseAmountIn:o,quoteAmountIn:i,fixedSide:s}=t,{version:r}=e;if(r===4||r===5){let a=Buffer.alloc(Ze.span);Ze.encode({instruction:3,baseAmountIn:T(o),quoteAmountIn:T(i),fixedSide:T(s==="base"?0:1)},a);let m=[u({pubkey:et,isWritable:!1}),u({pubkey:e.id}),u({pubkey:e.authority,isWritable:!1}),u({pubkey:e.openOrders,isWritable:!1}),u({pubkey:e.targetOrders}),u({pubkey:e.lpMint}),u({pubkey:e.baseVault}),u({pubkey:e.quoteVault})];return r===5&&m.push(u({pubkey:ce})),m.push(u({pubkey:e.marketId,isWritable:!1}),u({pubkey:n.baseTokenAccount}),u({pubkey:n.quoteTokenAccount}),u({pubkey:n.lpTokenAccount}),u({pubkey:n.owner,isWritable:!1,isSigner:!0})),new J({programId:e.programId,keys:m,data:a})}return Be.logWithError("invalid version","poolKeys.version",r),new J({programId:e.programId,keys:[]})}function Ht(t){let{poolKeys:e,userKeys:n,amountIn:o}=t,{version:i}=e;if(i===4||i===5){let s=Buffer.alloc(He.span);He.encode({instruction:4,amountIn:T(o)},s);let r=[u({pubkey:et,isWritable:!1}),u({pubkey:e.id}),u({pubkey:e.authority,isWritable:!1}),u({pubkey:e.openOrders}),u({pubkey:e.targetOrders}),u({pubkey:e.lpMint}),u({pubkey:e.baseVault}),u({pubkey:e.quoteVault})];return i===5?r.push(u({pubkey:ce})):r.push(u({pubkey:e.withdrawQueue}),u({pubkey:e.lpVault})),r.push(u({pubkey:e.marketProgramId,isWritable:!1}),u({pubkey:e.marketId}),u({pubkey:e.marketBaseVault}),u({pubkey:e.marketQuoteVault}),u({pubkey:e.marketAuthority,isWritable:!1}),u({pubkey:n.lpTokenAccount}),u({pubkey:n.baseTokenAccount}),u({pubkey:n.quoteTokenAccount}),u({pubkey:n.owner,isWritable:!1,isSigner:!0}),u({pubkey:e.marketEventQueue}),u({pubkey:e.marketBids}),u({pubkey:e.marketAsks})),new J({programId:e.programId,keys:r,data:s})}return Be.logWithError("invalid version","poolKeys.version",i),new J({programId:e.programId,keys:[]})}import{OpenOrders as Oa}from"@project-serum/serum";import ge from"bn.js";import{PublicKey as Xt}from"@solana/web3.js";var tt=I("Raydium_liquidity_serum"),en="9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin",yo=new Xt(en),Na={[en]:3},go={3:yo};function tn(t){let e=Ft[t];return e||tt.logWithError("invalid version","version",t),e}function nn(t){let e=go[t];return e||tt.logWithError("invalid version","version",t),e}async function on({programId:t,marketId:e}){let n=[e.toBuffer()],o=0,i;for(;o<100;){try{let s=n.concat(Buffer.from([o]),Buffer.alloc(7));i=await Xt.createProgramAddress(s,t)}catch(s){if(s instanceof TypeError)throw s;o++;continue}return{publicKey:i,nonce:o}}throw tt.logWithError("unable to find a viable program address nonce","params",{programId:t,marketId:e}),new Error("unable to find a viable program address nonce")}var nt=I("Raydium_liquidity_util");function ot(t,e){let n=t instanceof _?t.token:E.WSOL,{baseMint:o,quoteMint:i}=e;if(n.mint.equals(o))return"base";if(n.mint.equals(i))return"quote";let s=`liquidity getTokenSide - token not match with pool, params: ${JSON.stringify({token:n.mint,baseMint:o,quoteMint:i})}`;throw console.error(s),new Error(s)}function rt(t,e){let{baseMint:n,quoteMint:o}=e;return t.mint.equals(n)||t.mint.equals(o)}function ho(t){let e=Ct[t];return e||nt.logWithError("invalid version","version",t),e}async function X({name:t,programId:e,marketId:n}){let{publicKey:o}=await Ke([e.toBuffer(),n.toBuffer(),Buffer.from(t,"utf-8")],e);return o}async function Po({programId:t}){return Ke([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],t)}async function it({version:t,marketId:e,baseMint:n,quoteMint:o}){let i=ho(t),[s,r,a]=[v({publicKey:e}),v({publicKey:n,transformSol:!0}),v({publicKey:o,transformSol:!0})],m=await X({name:"amm_associated_seed",programId:i,marketId:s}),l=await X({name:"lp_mint_associated_seed",programId:i,marketId:s}),{publicKey:p,nonce:f}=await Po({programId:i}),b=await X({name:"coin_vault_associated_seed",programId:i,marketId:s}),d=await X({name:"pc_vault_associated_seed",programId:i,marketId:s}),y=await X({name:"temp_lp_token_associated_seed",programId:i,marketId:s}),k=await X({name:"open_order_associated_seed",programId:i,marketId:s}),B=await X({name:"target_associated_seed",programId:i,marketId:s}),w=await X({name:"withdraw_associated_seed",programId:i,marketId:s}),L=tn(t),S=nn(L),{publicKey:N}=await on({programId:S,marketId:s});return{id:m,baseMint:r,quoteMint:a,lpMint:l,version:t,programId:i,authority:p,nonce:f,baseVault:b,quoteVault:d,lpVault:y,openOrders:k,targetOrders:B,withdrawQueue:w,marketVersion:L,marketProgramId:S,marketId:s,marketAuthority:N}}async function sn({connection:t,pools:e}){let n=e.map(i=>Gt(i));return(await _t(t,n,"GetPoolData")).map(i=>{let s=Bt(i,"GetPoolData"),r=new ge(G(s,"status")),a=Number(G(s,"coin_decimals")),m=Number(G(s,"pc_decimals")),l=Number(G(s,"lp_decimals")),p=new ge(G(s,"pool_coin_amount")),f=new ge(G(s,"pool_pc_amount")),b=new ge(G(s,"pool_lp_supply")),d="0";try{d=G(s,"pool_open_time")}catch{d="0"}return{status:r,baseDecimals:a,quoteDecimals:m,lpDecimals:l,baseReserve:p,quoteReserve:f,lpSupply:b,startTime:new ge(d)}})}function an(t,e,n){return xo(t.token,e.token,n)}function xo(t,e,n){let{baseMint:o,quoteMint:i}=n,s=rn(t,n),r=rn(e,n);return s===r&&nt.logWithError("tokens not match with pool","params",{tokenA:t.mint,tokenB:e.mint,baseMint:o,quoteMint:i}),[s,r]}function rn(t,e){let{baseMint:n,quoteMint:o}=e;return t.mint.equals(n)?"base":t.mint.equals(o)?"quote":(nt.logWithError("token not match with pool","params",{token:t.mint,baseMint:n,quoteMint:o}),"base")}var un=t=>t==="a"||t==="b";var st=class extends ye{constructor(n){super(n);this._poolInfos=[];this._poolInfoMap=new Map;this._pairsInfo=[];this._pairsInfoMap=new Map;this._lpTokenMap=new Map;this._lpPriceMap=new Map;this._officialIds=new Set;this._unOfficialIds=new Set;this._sdkParseInfoCache=new Map;this._stableLayout=new _e({connection:this.scope.connection})}async load(n){if(await this.scope.fetchLiquidity(n==null?void 0:n.forceUpdate),!this.scope.apiData.liquidityPools)return;let{data:o}=this.scope.apiData.liquidityPools,[i,s]=[o.official||[],o.unOfficial||[]];this._poolInfos=[...i,...s],this._officialIds=new Set(i.map(r=>{var m,l;let a=`${(m=this.scope.token.allTokenMap.get(r.baseMint))==null?void 0:m.symbol} - ${(l=this.scope.token.allTokenMap.get(r.quoteMint))==null?void 0:l.symbol}`;return this._poolInfoMap.set(r.id,r),this._lpTokenMap.set(r.lpMint,new E({mint:r.lpMint,decimals:r.lpDecimals,symbol:a,name:`${a} LP`})),r.id})),this._unOfficialIds=new Set(s.map(r=>{var m,l;let a=`${(m=this.scope.token.allTokenMap.get(r.baseMint))==null?void 0:m.symbol} - ${(l=this.scope.token.allTokenMap.get(r.quoteMint))==null?void 0:l.symbol}`;return this._poolInfoMap.set(r.id,r),this._lpTokenMap.set(r.lpMint,new E({mint:r.lpMint,decimals:r.lpDecimals,symbol:a,name:`${a} LP`})),r.id}))}async loadPairs(n){var o;return await this.scope.fetchPairs(n==null?void 0:n.forceUpdate),this._pairsInfo=((o=this.scope.apiData.liquidityPairsInfo)==null?void 0:o.data)||[],this._pairsInfoMap=new Map(this._pairsInfo.map(i=>{let s=this._lpTokenMap.get(i.lpMint),r=s&&i.lpPrice?It({token:s,numberPrice:i.lpPrice,decimalDone:!0}):null;return r&&this._lpPriceMap.set(i.lpMint,r),[i.ammId,i]})),this._pairsInfo}get allPools(){return this._poolInfos}get allPoolIdSet(){return{official:this._officialIds,unOfficial:this._unOfficialIds}}get allPoolMap(){return this._poolInfoMap}get allPairs(){return this._pairsInfo}get allPairsMap(){return this._pairsInfoMap}get lpTokenMap(){return this._lpTokenMap}get lpPriceMap(){return this._lpPriceMap}async fetchMultipleInfo(n){return await this._stableLayout.initStableModelLayout(),await sn($(F({},n),{connection:this.scope.connection}))}async sdkParseJsonLiquidityInfo(n){if(!n.length)return[];let o=n.map(i=>i.id).join("-");if(this._sdkParseInfoCache.has(o))return this._sdkParseInfoCache.get(o);try{let s=(await this.fetchMultipleInfo({pools:n.map(ue)})).map((r,a)=>F(F({jsonInfo:n[a]},ue(n[a])),r));return this._sdkParseInfoCache.set(o,s),s}catch(i){return console.error(i),[]}}computeAmountOut({poolKeys:n,poolInfo:o,amountIn:i,outputToken:s,slippage:r}){this.checkDisabled();let a=I("Raydium_computeAmountOut"),m=i.token,l=s;(!rt(m,n)||!rt(l,n))&&a.logWithError("token not match with pool","poolKeys",n);let{baseReserve:p,quoteReserve:f}=o;this.logDebug("baseReserve:",p.toString(),"quoteReserve:",f.toString());let b=i.token;this.logDebug("inputToken:",b),this.logDebug("amountIn:",i.toFixed()),this.logDebug("outputToken:",s),this.logDebug("slippage:",`${r.toSignificant()}%`);let d=[p,f],y=ot(i,n);y==="quote"&&d.reverse(),this.logDebug("input side:",y);let[k,B]=d,w;if(n.version===4)w=new M({baseToken:b,denominator:k,quoteToken:s,numerator:B});else{let Y=Qt(this._stableLayout.stableModelData,p.toNumber(),f.toNumber(),!1);w=new M({baseToken:b,denominator:y==="quote"?new z(Y*1e6):new z(1e6),quoteToken:s,numerator:y==="quote"?new z(1e6):new z(Y*1e6)})}this.logDebug("currentPrice:",`1 ${b.symbol} \u2248 ${w.toFixed()} ${s.symbol}`),this.logDebug("currentPrice invert:",`1 ${s.symbol} \u2248 ${w.invert().toFixed()} ${b.symbol}`);let L=i.raw,S=ae,N=ae;if(!L.isZero())if(n.version===4){N=L.mul(Rt).div(Wt);let Y=L.sub(N),ie=k.add(Y);S=B.mul(Y).div(ie)}else{N=L.mul(new z(2)).div(new z(1e4));let Y=L.sub(N),ie=y==="quote"?Yt:jt;S=new z(ie(this._stableLayout.stableModelData,f.toNumber(),p.toNumber(),Y.toNumber()))}let K=new U(de).add(r).invert().mul(S).quotient,O=new _(s,S),Q=new _(s,K);this.logDebug("amountOut:",O.toFixed(),"minAmountOut:",Q.toFixed());let C=new M({baseToken:b,denominator:L.sub(N),quoteToken:s,numerator:S});!L.isZero()&&!S.isZero()&&(C=new M({baseToken:b,denominator:L.sub(N),quoteToken:s,numerator:S}),this.logDebug("executionPrice:",`1 ${b.symbol} \u2248 ${C.toFixed()} ${s.symbol}`),this.logDebug("executionPrice invert:",`1 ${s.symbol} \u2248 ${C.invert().toFixed()} ${b.symbol}`));let oe=new U(parseInt(String(Math.abs(parseFloat(C.toFixed())-parseFloat(w.toFixed()))*1e9)),parseInt(String(parseFloat(w.toFixed())*1e9))),re=new _(b,N);return{amountOut:O,minAmountOut:Q,currentPrice:w,executionPrice:C,priceImpact:oe,fee:re}}async computePairAmount({poolId:n,amount:o,anotherToken:i,slippage:s}){let r=v({publicKey:n}),a=this._poolInfoMap.get(r.toBase58());a||this.logAndCreateError("pool not found",r.toBase58());let m=(await this.sdkParseJsonLiquidityInfo([a]))[0];m||this.logAndCreateError("pool parseInfo not found",r.toBase58());let{baseReserve:l,quoteReserve:p}=m;this.logDebug("baseReserve:",l.toString(),"quoteReserve:",p.toString());let f=o.token;this.logDebug("tokenIn:",f,"amount:",o.toFixed(),"anotherToken:",i,"slippage:",`${s.toSignificant()}%`);let b=ot(o,ue(a));this.logDebug("input side:",b);let d=ae;o.isZero()||(d=b==="base"?ve(o.raw.mul(p),l):ve(o.raw.mul(l),p));let k=new U(de).add(s).mul(d).quotient,B=new _(i,d),w=new _(i,k);return this.logDebug("anotherAmount:",B.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:B,maxAnotherAmount:w}}async swapWithAMM(n){let{poolKeys:o,payer:i,amountIn:s,amountOut:r,fixedSide:a,config:m}=n;this.logDebug("amountIn:",s),this.logDebug("amountOut:",r),(s.isZero()||r.isZero())&&this.logAndCreateError("amounts must greater than zero","amounts",{amountIn:s.toFixed(),amountOut:r.toFixed()});let{account:l}=this.scope,p=this.createTxBuilder(),{bypassAssociatedCheck:f=!1}=m||{},[b,d]=[s.token,r.token],y=await l.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1}),k=await l.getCreatedTokenAccount({mint:d.mint}),[B,w]=[s.raw,r.raw],K=await l.handleTokenAccount({side:"in",amount:B,mint:b.mint,tokenAccount:y,bypassAssociatedCheck:f}),{tokenAccount:L}=K,S=W(K,["tokenAccount"]);p.addInstruction(S);let O=await l.handleTokenAccount({side:"out",amount:0,mint:d.mint,tokenAccount:k,payer:i,bypassAssociatedCheck:f}),{tokenAccount:N}=O,j=W(O,["tokenAccount"]);return p.addInstruction(j),p.addInstruction({instructions:[$t({poolKeys:o,userKeys:{tokenAccountIn:L,tokenAccountOut:N,owner:this.scope.ownerPubKey},amountIn:B,amountOut:w,fixedSide:a})]}),p.buildMultiTx({extInfo:{amountOut:r}})}async createPool(n){this.checkDisabled(),this.scope.checkOwner(),n.version!==4&&this.logAndCreateError("invalid version","poolKeys.version",n.version);let o=this.createTxBuilder(),i=await it(n);return await o.addInstruction({instructions:[Jt($(F({},i),{owner:this.scope.ownerPubKey}))]}).build()}async initPool(n){n.version!==4&&this.logAndCreateError("invalid version","poolKeys.version",n.version);let{baseAmount:o,quoteAmount:i,startTime:s=0,config:r}=n,a=await it(n),{baseMint:m,quoteMint:l,lpMint:p,baseVault:f,quoteVault:b}=a,d=this.createTxBuilder(),{account:y}=this.scope,k=!!(r!=null&&r.bypassAssociatedCheck),B=await y.getCreatedTokenAccount({mint:m,associatedOnly:!1}),w=await y.getCreatedTokenAccount({mint:l,associatedOnly:!1});!B&&!w&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",y.tokenAccounts);let L=await y.getCreatedTokenAccount({mint:p,associatedOnly:!1}),C=await y.handleTokenAccount({side:"in",amount:o.raw,mint:m,tokenAccount:B,bypassAssociatedCheck:k}),{tokenAccount:S}=C,N=W(C,["tokenAccount"]);d.addInstruction(N);let oe=await y.handleTokenAccount({side:"in",amount:i.raw,mint:l,tokenAccount:w,bypassAssociatedCheck:k}),{tokenAccount:j}=oe,K=W(oe,["tokenAccount"]);d.addInstruction(K);let re=await y.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:L,bypassAssociatedCheck:k}),{tokenAccount:O}=re,Q=W(re,["tokenAccount"]);return d.addInstruction(Q),d.addInstruction({instructions:[je({source:S,destination:f,owner:this.scope.ownerPubKey,amount:o.raw}),je({source:j,destination:b,owner:this.scope.ownerPubKey,amount:i.raw}),zt({poolKeys:a,userKeys:{lpTokenAccount:O,payer:this.scope.ownerPubKey},startTime:s})]}),await d.build()}async addLiquidity(n){let{poolId:o,amountInA:i,amountInB:s,fixedSide:r,config:a}=n,m=v({publicKey:o}),l=this.allPools.find(bn=>bn.id===m.toBase58());l||this.logAndCreateError("pool not found",o);let f=(await this.sdkParseJsonLiquidityInfo([l]))[0];f||this.logAndCreateError("pool parse error",f),this.logDebug("amountInA:",i,"amountInB:",s),(i.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:i.toFixed(),amountInB:s.toFixed()});let{account:b}=this.scope,d=(a==null?void 0:a.bypassAssociatedCheck)||!1,[y,k]=[i.token,s.token],B=await b.getCreatedTokenAccount({mint:y.mint,associatedOnly:!1}),w=await b.getCreatedTokenAccount({mint:k.mint,associatedOnly:!1});!B&&!w&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",b.tokenAccounts);let L=await b.getCreatedTokenAccount({mint:f.lpMint}),S=[y,k],N=[B,w],j=[i.raw,s.raw],[K]=an(i,s,f),O="base";(!["quote","base"].includes(K)||!un(r))&&this.logAndCreateError("invalid fixedSide","fixedSide",r),K==="quote"?(S.reverse(),N.reverse(),j.reverse(),O=r==="a"?"quote":"base"):K==="base"&&(O=r==="a"?"base":"quote");let[Q,C]=S,[oe,re]=N,[Y,ie]=j,me=this.createTxBuilder(),at=await b.handleTokenAccount({side:"in",amount:Y,mint:Q.mint,tokenAccount:oe,bypassAssociatedCheck:d}),{tokenAccount:cn}=at,mn=W(at,["tokenAccount"]);me.addInstruction(mn);let ut=await b.handleTokenAccount({side:"in",amount:ie,mint:C.mint,tokenAccount:re,bypassAssociatedCheck:d}),{tokenAccount:ln}=ut,pn=W(ut,["tokenAccount"]);me.addInstruction(pn);let ct=await b.handleTokenAccount({side:"out",amount:0,mint:f.lpMint,tokenAccount:L,bypassAssociatedCheck:d}),{tokenAccount:dn}=ct,fn=W(ct,["tokenAccount"]);return me.addInstruction(fn),me.addInstruction({instructions:[Zt({poolKeys:f,userKeys:{baseTokenAccount:cn,quoteTokenAccount:ln,lpTokenAccount:dn,owner:this.scope.ownerPubKey},baseAmountIn:Y,quoteAmountIn:ie,fixedSide:O})]}),await me.build()}async removeLiquidity(n){let{poolId:o,amountIn:i,config:s}=n,r=v({publicKey:o}),a=this.allPools.find(C=>C.id===r.toBase58());a||this.logAndCreateError("pool not found",o);let l=(await this.sdkParseJsonLiquidityInfo([a]))[0];l||this.logAndCreateError("pool pass error",l);let{baseMint:p,quoteMint:f,lpMint:b}=l;this.logDebug("amountIn:",i),i.isZero()&&this.logAndCreateError("amount must greater than zero","amountIn",i.toFixed()),i.token.mint.equals(b)||this.logAndCreateError("amountIn's token not match lpMint","amountIn",i);let{account:d}=this.scope,y=await d.getCreatedTokenAccount({mint:b,associatedOnly:!1});y||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",d.tokenAccounts);let k=await d.getCreatedTokenAccount({mint:p}),B=await d.getCreatedTokenAccount({mint:f}),w=this.createTxBuilder(),L=(s==null?void 0:s.bypassAssociatedCheck)||!1,O=await d.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:k,bypassAssociatedCheck:L}),{tokenAccount:S}=O,N=W(O,["tokenAccount"]);w.addInstruction(N);let Q=await d.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:B,bypassAssociatedCheck:L}),{tokenAccount:j}=Q,K=W(Q,["tokenAccount"]);return w.addInstruction(K),w.addInstruction({instructions:[ko.requestUnits({units:4e5,additionalFee:0}),Ht({poolKeys:l,userKeys:{lpTokenAccount:y,baseTokenAccount:S,quoteTokenAccount:j,owner:this.scope.ownerPubKey},amountIn:i.raw})]}),await w.build()}lpMintToTokenAmount({poolId:n,amount:o,decimalDone:i}){let s=v({publicKey:n});s||this.logAndCreateError("pool not found");let r=this._poolInfoMap.get(s.toBase58()),a=fe(o),m=new E({mint:r.lpMint,decimals:r.lpDecimals}),l=i?new g(a.numerator,a.denominator):new g(a.numerator,a.denominator).mul(new z(10).pow(new z(m.decimals)));return new _(m,wt(l))}getFixedSide({poolId:n,inputMint:o}){let[i,s]=[v({publicKey:n}),v({publicKey:o})],r=this._poolInfoMap.get(i.toBase58());r||this.logAndCreateError("pool not found",i.toBase58());let a=r.baseMint===s.toBase58();return(s.equals(we)||s.equals(ee))&&(a=!a),a?"a":"b"}};export{st as default};
//# sourceMappingURL=liquidity.mjs.map