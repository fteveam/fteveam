var fn=Object.defineProperty,bn=Object.defineProperties;var yn=Object.getOwnPropertyDescriptors;var he=Object.getOwnPropertySymbols;var mt=Object.prototype.hasOwnProperty,lt=Object.prototype.propertyIsEnumerable;var ct=(e,t,n)=>t in e?fn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,F=(e,t)=>{for(var n in t||(t={}))mt.call(t,n)&&ct(e,n,t[n]);if(he)for(var n of he(t))lt.call(t,n)&&ct(e,n,t[n]);return e},$=(e,t)=>bn(e,yn(t));var W=(e,t)=>{var n={};for(var o in e)mt.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(e!=null&&he)for(var o of he(e))t.indexOf(o)<0&&lt.call(e,o)&&(n[o]=e[o]);return n};import{ComputeBudgetProgram as wo}from"@solana/web3.js";import J from"bn.js";import A from"bn.js";import Bn from"big.js";import ke from"bn.js";import{get as pt,set as gn}from"lodash";import hn from"pino";import Pn from"pino-pretty";var dt={},xn={},kn=Pn({colorize:!0,levelFirst:!0,translateTime:"SYS:yyyymmdd HH:MM:ss.l"}),wn=hn({base:null,level:"silent"},kn);function I(e){let t=pt(dt,e);if(!t){let n=pt(xn,e);t=wn.child({name:e},{level:n}),gn(dt,e,t)}return t.logWithError=(...n)=>{let o=n.map(r=>typeof r=="object"?JSON.stringify(r):r).join(", ");throw new Error(o)},t}import Tn from"toformat";var In=Tn,le=In;import xe from"big.js";import An from"decimal.js-light";var Pe=I("module/fraction"),Ne=le(xe),pe=le(An),Sn={[0]:pe.ROUND_DOWN,[1]:pe.ROUND_HALF_UP,[2]:pe.ROUND_UP},Ln={[0]:xe.roundDown,[1]:xe.roundHalfUp,[2]:xe.roundUp},g=class{constructor(t,n=de){this.numerator=T(t),this.denominator=T(n)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new g(this.denominator,this.numerator)}add(t){let n=t instanceof g?t:new g(T(t));return this.denominator.eq(n.denominator)?new g(this.numerator.add(n.numerator),this.denominator):new g(this.numerator.mul(n.denominator).add(n.numerator.mul(this.denominator)),this.denominator.mul(n.denominator))}sub(t){let n=t instanceof g?t:new g(T(t));return this.denominator.eq(n.denominator)?new g(this.numerator.sub(n.numerator),this.denominator):new g(this.numerator.mul(n.denominator).sub(n.numerator.mul(this.denominator)),this.denominator.mul(n.denominator))}mul(t){let n=t instanceof g?t:new g(T(t));return new g(this.numerator.mul(n.numerator),this.denominator.mul(n.denominator))}div(t){let n=t instanceof g?t:new g(T(t));return new g(this.numerator.mul(n.denominator),this.denominator.mul(n.numerator))}toSignificant(t,n={groupSeparator:""},o=1){Number.isInteger(t)||Pe.logWithError(`${t} is not an integer.`),t<=0&&Pe.logWithError(`${t} is not positive.`),pe.set({precision:t+1,rounding:Sn[o]});let r=new pe(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(t);return r.toFormat(r.decimalPlaces(),n)}toFixed(t,n={groupSeparator:""},o=1){return Number.isInteger(t)||Pe.logWithError(`${t} is not an integer.`),t<0&&Pe.logWithError(`${t} is negative.`),Ne.DP=t,Ne.RM=Ln[o]||1,new Ne(this.numerator.toString()).div(this.denominator.toString()).toFormat(t,n)}isZero(){return this.numerator.isZero()}};var Nn=I("Raydium_amount"),ft=le(Bn);function qn(e,t){let n="0",o="0";if(e.includes(".")){let r=e.split(".");r.length===2?([n,o]=r,o=o.padEnd(t,"0")):Nn.logWithError(`invalid number string, num: ${e}`)}else n=e;return[n,o.slice(0,t)||o]}var _=class extends g{constructor(n,o,r=!0,s){let i=new ke(0),a=se.pow(new ke(n.decimals));if(r)i=T(o);else{let m=new ke(0),l=new ke(0);if(typeof o=="string"||typeof o=="number"||typeof o=="bigint"){let[p,f]=qn(o.toString(),n.decimals);m=T(p),l=T(f)}m=m.mul(a),i=m.add(l)}super(i,a);this.logger=I(s||"Amount"),this.token=n}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(n){return this.token.equals(n.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(n.raw)}lt(n){return this.token.equals(n.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(n.raw)}add(n){return this.token.equals(n.token)||this.logger.logWithError("add token not equals"),new _(this.token,this.raw.add(n.raw))}subtract(n){return this.token.equals(n.token)||this.logger.logWithError("sub token not equals"),new _(this.token,this.raw.sub(n.raw))}toSignificant(n=this.token.decimals,o,r=0){return super.toSignificant(n,o,r)}toFixed(n=this.token.decimals,o,r=0){return n>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(n,o,r)}toExact(n={groupSeparator:""}){return ft.DP=this.token.decimals,new ft(this.numerator.toString()).div(this.denominator.toString()).toFormat(n)}};import{PublicKey as Mn}from"@solana/web3.js";var bt={symbol:"SOL",name:"Solana",decimals:9},Z={symbol:"WSOL",name:"Wrapped SOL",mint:"So11111111111111111111111111111111111111112",decimals:9,extensions:{coingeckoId:"solana"}},Zo={isQuantumSOL:!0,isLp:!1,official:!0,mint:new Mn(Z.mint),decimals:9,symbol:"SOL",id:"sol",name:"solana",icon:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",extensions:{coingeckoId:"solana"}};import{PublicKey as Me}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Dn}from"@solana/spl-token";import{PublicKey as q,SystemProgram as On,SYSVAR_RENT_PUBKEY as En}from"@solana/web3.js";function u({pubkey:e,isSigner:t=!1,isWritable:n=!0}){return{pubkey:e,isWritable:n,isSigner:t}}var qe=[u({pubkey:Dn,isWritable:!1}),u({pubkey:On.programId,isWritable:!1}),u({pubkey:En,isWritable:!1})];function v({publicKey:e,transformSol:t}){if(e instanceof q)return t&&e.equals(ee)?we:e;if(t&&e===ee.toBase58())return we;if(typeof e=="string")try{return new q(e)}catch{throw new Error("invalid public key")}throw new Error("invalid public key")}function yt(e){try{return new q(e)}catch{return e}}var nr=new q("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),or=new q("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),rr=new q("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),ir=new q("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),sr=new q("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),ar=new q("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),ur=new q("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),cr=new q("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),mr=new q("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),lr=new q("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),pr=new q("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),we=new q("So11111111111111111111111111111111111111112"),ee=q.default;var De=class{constructor({mint:t,decimals:n,symbol:o="UNKNOWN",name:r="UNKNOWN",skipMint:s=!1}){if(t===ee.toBase58()||t instanceof Me&&ee.equals(t)){this.decimals=Z.decimals,this.symbol=Z.symbol,this.name=Z.name,this.mint=new Me(Z.mint);return}this.decimals=n,this.symbol=o,this.name=r,this.mint=s?Me.default:v({publicKey:t})}equals(t){return this===t?!0:this.mint.equals(t.mint)}},O=De;O.WSOL=new De(Z);var Ee=class{constructor({decimals:t,symbol:n="UNKNOWN",name:o="UNKNOWN"}){this.decimals=t,this.symbol=n,this.name=o}equals(t){return this===t}},Oe=Ee;Oe.SOL=new Ee(bt);var gt=new g(ht),U=class extends g{toSignificant(t=5,n,o){return this.mul(gt).toSignificant(t,n,o)}toFixed(t=2,n,o){return this.mul(gt).toFixed(t,n,o)}};var Rn=I("Raydium_price"),M=class extends g{constructor(n){let{baseToken:o,quoteToken:r,numerator:s,denominator:i}=n;super(s,i);this.baseToken=o,this.quoteToken=r,this.scalar=new g(Re(o.decimals),Re(r.decimals))}get raw(){return new g(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new M({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(n){this.quoteToken!==n.baseToken&&Rn.logWithError("mul token not equals");let o=super.mul(n);return new M({baseToken:this.baseToken,quoteToken:n.quoteToken,denominator:o.denominator,numerator:o.numerator})}toSignificant(n=this.quoteToken.decimals,o,r){return this.adjusted.toSignificant(n,o,r)}toFixed(n=this.quoteToken.decimals,o,r){return this.adjusted.toFixed(n,o,r)}};var Te=I("Raydium_bignumber");var ae=new A(0),de=new A(1),Vr=new A(2),Yr=new A(3),Qr=new A(5),se=new A(10),ht=new A(100),jr=new A(1e3),$r=new A(1e4),Pt=9007199254740991;function T(e){if(e instanceof A)return e;if(typeof e=="string"){if(e.match(/^-?[0-9]+$/))return new A(e);Te.logWithError(`invalid BigNumberish string: ${e}`)}return typeof e=="number"?(e%1&&Te.logWithError(`BigNumberish number underflow: ${e}`),(e>=Pt||e<=-Pt)&&Te.logWithError(`BigNumberish number overflow: ${e}`),new A(String(e))):typeof e=="bigint"?new A(e.toString()):(Te.logWithError(`invalid BigNumberish value: ${e}`),new A(0))}function Re(e){return se.pow(T(e))}function fe(e){var a;if(e===void 0)return{denominator:"1",numerator:"0"};if(e instanceof A)return{numerator:e.toString(),denominator:"1"};if(e instanceof g)return{denominator:e.denominator.toString(),numerator:e.numerator.toString()};let t=String(e),[,n="",o="",r=""]=(a=t.replace(",","").match(/(-?)(\d*)\.?(\d*)/))!=null?a:[],s="1"+"0".repeat(r.length),i=n+(o==="0"?"":o)+r||"0";return{denominator:s,numerator:i,sign:n,int:o,dec:r}}function We(e,t){let n=e.divmod(t);return n.mod.isZero()?n.div:n.div.negative!==0?n.div.isubn(1):n.div.iaddn(1)}function Wn(e){var o;let[,t="",n=""]=(o=e.toFixed(2).match(/(-?)(\d*)\.?(\d*)/))!=null?o:[];return`${t}${n}`}function xt(e,t=0){return e instanceof A?e:new A(Wn(kt(e).mul(se.pow(new A(String(t))))))}function kt(e){if(e instanceof U)return new g(e.numerator,e.denominator);if(e instanceof M)return e.adjusted;if(e instanceof _)try{return kt(e.toExact())}catch{return new g(ae)}if(e instanceof g)return e;let t=String(e),n=fe(t);return new g(n.numerator,n.denominator)}function wt(e){let{token:t,numberPrice:n,decimalDone:o}=e,r=new O({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),{numerator:s,denominator:i}=fe(n),a=o?new A(s).mul(se.pow(new A(t.decimals))):s,m=new A(i).mul(se.pow(new A(r.decimals)));return new M({baseToken:r,denominator:m.toString(),quoteToken:new O($(F({},t),{skipMint:!0,mint:""})),numerator:a.toString()})}import{PublicKey as vn}from"@solana/web3.js";import Kn from"bn.js";var Cn=[O,_,vn,g,Kn,M,U];function Fn(e){return typeof e=="object"&&e!==null&&!Cn.some(t=>typeof t=="object"&&e instanceof t)}function ue(e){return typeof e=="string"?yt(e):Array.isArray(e)?e.map(t=>ue(t)):Fn(e)?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,ue(n)])):e}import{createInitializeAccountInstruction as Cs,createCloseAccountInstruction as Fs,createTransferInstruction as Zn,TOKEN_PROGRAM_ID as Us}from"@solana/spl-token";import{Keypair as js,PublicKey as $s,SystemProgram as zs}from"@solana/web3.js";import Hs from"bn.js";import{PACKET_DATA_SIZE as Un,PublicKey as At,sendAndConfirmTransaction as Tt,Transaction as Ie}from"@solana/web3.js";var H=I("Raydium_txTool"),Ae=class{constructor(t){this.instructions=[];this.endInstructions=[];this.signers=[];this.connection=t.connection,this.feePayer=t.feePayer,this.signAllTransactions=t.signAllTransactions,this.owner=t.owner}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers}}get allInstructions(){return[...this.instructions,...this.endInstructions]}addInstruction({instructions:t=[],endInstructions:n=[],signers:o=[]}){return this.instructions.push(...t),this.endInstructions.push(...n),this.signers.push(...o),this}build(t){let n=new Ie;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,{transaction:n,signers:this.signers,execute:async()=>{var r;let o=await It(this.connection);if(n.recentBlockhash=o,(r=this.owner)!=null&&r.isKeyPair)return Tt(this.connection,n,this.signers);if(this.signAllTransactions){this.signers.length&&n.partialSign(...this.signers);let s=await this.signAllTransactions([n]);return await this.connection.sendRawTransaction(s[0].serialize(),{skipPreflight:!0})}throw new Error("please connect wallet first")},extInfo:t||{}}}buildMultiTx(t){let{extraPreBuildData:n=[],extInfo:o}=t,{transaction:r}=this.build(o),s=n.filter(m=>m.transaction.instructions.length>0),i=[...s.map(m=>m.transaction),r],a=[...s.map(m=>m.signers),this.signers];return{transactions:i,signers:a,execute:async()=>{var l;let m=await It(this.connection);if((l=this.owner)!=null&&l.isKeyPair)return await Promise.all(i.map(async(p,f)=>(p.recentBlockhash=m,await Tt(this.connection,p,a[f]))));if(this.signAllTransactions){let p=i.map((d,y)=>(d.recentBlockhash=m,a[y].length&&d.partialSign(...a[y]),d)),f=await this.signAllTransactions(p),b=[];for(let d=0;d<f.length;d+=1){let y=await this.connection.sendRawTransaction(f[d].serialize(),{skipPreflight:!0});b.push(y)}return b}throw new Error("please connect wallet first")},extInfo:o||{}}}};async function It(e){var t,n;try{return((n=await((t=e.getLatestBlockhash)==null?void 0:t.call(e)))==null?void 0:n.blockhash)||(await e.getRecentBlockhash()).blockhash}catch{return(await e.getRecentBlockhash()).blockhash}}function Vn(e,t){e.length<1&&H.logWithError(`no instructions provided: ${e.toString()}`),t.length<1&&H.logWithError(`no signers provided:, ${t.toString()}`);let n=new Ie;n.recentBlockhash="11111111111111111111111111111111",n.feePayer=t[0],n.add(...e);let o=n.compileMessage().serialize();return t.length+t.length*64+o.length}async function St(e,t,n){let o=new At("RaydiumSimuLateTransaction11111111111111111"),r=[],s=new Ie;s.feePayer=o;for(let m of t)Vn([...s.instructions,m],[o])>Un&&(r.push(s),s=new Ie,s.feePayer=o),s.add(m);s.instructions.length>0&&r.push(s);let i=[];try{i=await Promise.all(r.map(m=>e.simulateTransaction(m)))}catch(m){m instanceof Error&&H.logWithError(`failed to simulate for instructions, RPC_ERROR, ${m.message}`)}let a=[];for(let m of i){let{value:l}=m;if(H.debug(`simulate result: ${JSON.stringify(m)}`),l.logs){let p=l.logs.filter(f=>f&&f.includes(n));H.debug(`filteredLog: ${JSON.stringify(a)}`),p.length||H.logWithError(` "simulate log not match keyword, keyword: ${n}`),a.push(...p)}}return a}function Lt(e,t){let n=e.match(/{["\w:,]+}/g);return!n||n.length!==1?H.logWithError(`simulate log fail to match json, keyword: ${t}`):n[0]}function G(e,t){let o=new RegExp(`"${t}":(\\d+)`,"g").exec(e);return!o||o.length!==2?H.logWithError(`simulate log fail to match key", key: ${t}`):o[1]}async function ve(e,t){let[n,o]=await At.findProgramAddress(e,t);return{publicKey:n,nonce:o}}import{PublicKey as bi}from"@solana/web3.js";var hi=I("Raydium_accountInfo_util");import{PublicKey as zn}from"@solana/web3.js";import Nt,{isBN as qt}from"bn.js";import{bits as Wi,BitStructure as vi,blob as Yn,Blob as Ki,cstr as Ci,f32 as Fi,f32be as Ui,f64 as Vi,f64be as Yi,greedy as Qi,Layout as Qn,ns64 as ji,ns64be as $i,nu64 as Gi,nu64be as zi,offset as Ji,s16 as Zi,s16be as Hi,s24 as Xi,s24be as es,s32 as ts,s32be as ns,s40 as os,s40be as rs,s48 as is,s48be as ss,s8 as as,seq as jn,struct as us,Structure as $n,u16 as cs,u16be as ms,u24 as ls,u24be as ps,u32 as ds,u32be as fs,u40 as bs,u40be as ys,u48 as gs,u48be as hs,u8 as Ps,UInt as Gn,union as xs,Union as ks,unionLayoutDiscriminator as ws,utf8 as Ts}from"@solana/buffer-layout";var Ke=Qn,_t=$n;var Ce=Gn;var Bt=jn;var Fe=Yn;var Se=class extends Ke{constructor(n,o,r){super(n,r);this.blob=Fe(n),this.signed=o}decode(n,o=0){let r=new Nt(this.blob.decode(n,o),10,"le");return this.signed?r.fromTwos(this.span*8).clone():r}encode(n,o,r=0){return typeof n=="number"&&(n=new Nt(n)),this.signed&&(n=n.toTwos(this.span*8)),this.blob.encode(n.toArrayLike(Buffer,"le",this.span),o,r)}};function R(e){return new Ce(1,e)}function Le(e){return new Ce(4,e)}function c(e){return new Se(8,!1,e)}function V(e){return new Se(16,!1,e)}var Ue=class extends Ke{constructor(n,o,r,s){super(n.span,s);this.layout=n,this.decoder=o,this.encoder=r}decode(n,o){return this.decoder(this.layout.decode(n,o))}encode(n,o,r){return this.layout.encode(this.encoder(n),o,r)}getSpan(n,o){return this.layout.getSpan(n,o)}};function x(e){return new Ue(Fe(32),t=>new zn(t),t=>t.toBuffer(),e)}var Ve=class extends _t{decode(t,n){return super.decode(t,n)}};function D(e,t,n){return new Ve(e,t,n)}function be(e,t,n){let o,r=typeof t=="number"?t:qt(t)?t.toNumber():new Proxy(t,{get(s,i){if(!o){let a=Reflect.get(s,"count");o=qt(a)?a.toNumber():a,Reflect.set(s,"count",o)}return Reflect.get(s,i)},set(s,i,a){return i==="count"&&(o=a),Reflect.set(s,i,a)}});return Bt(e,r,n)}var Jn=D([x("mint"),x("owner"),c("amount"),Le("delegateOption"),x("delegate"),R("state"),Le("isNativeOption"),c("isNative"),c("delegatedAmount"),Le("closeAuthorityOption"),x("closeAuthority")]);function Ye({source:e,destination:t,owner:n,amount:o,multiSigners:r=[]}){return Zn(e,t,n,T(o).toNumber(),r)}var Qe=(...e)=>e.map(t=>{try{return typeof t=="object"?JSON.stringify(t):t}catch{return t}}).join(", "),ye=class{constructor({scope:t,moduleName:n}){this.disabled=!1;this.scope=t,this.logger=I(n)}createTxBuilder(t){return this.scope.checkOwner(),new Ae({connection:this.scope.connection,feePayer:t||this.scope.ownerPubKey,owner:this.scope.owner,signAllTransactions:this.scope.signAllTransactions})}logDebug(...t){this.logger.debug(Qe(t))}logInfo(...t){this.logger.info(Qe(t))}logAndCreateError(...t){let n=Qe(t);throw new Error(n)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as Mt}from"@solana/web3.js";import Dt from"bn.js";var Ot=new Dt(25),Et=new Dt(1e4),Rt="675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8",Hn=new Mt(Rt),Wt="5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h",Xn=new Mt(Wt),ca={[Rt]:4,[Wt]:5},vt={4:Hn,5:Xn},Kt={4:3,5:3};import{TOKEN_PROGRAM_ID as Xe}from"@solana/spl-token";import{SystemProgram as fo,TransactionInstruction as z}from"@solana/web3.js";var je=D([R("instruction"),c("amountIn"),c("minAmountOut")]),$e=D([R("instruction"),c("maxAmountIn"),c("amountOut")]),Ge=D([R("instruction"),R("nonce")]),ze=D([R("instruction"),R("nonce"),c("startTime")]),eo=D([c("status"),c("nonce"),c("maxOrder"),c("depth"),c("baseDecimal"),c("quoteDecimal"),c("state"),c("resetFlag"),c("minSize"),c("volMaxCutRatio"),c("amountWaveRatio"),c("baseLotSize"),c("quoteLotSize"),c("minPriceMultiplier"),c("maxPriceMultiplier"),c("systemDecimalValue"),c("minSeparateNumerator"),c("minSeparateDenominator"),c("tradeFeeNumerator"),c("tradeFeeDenominator"),c("pnlNumerator"),c("pnlDenominator"),c("swapFeeNumerator"),c("swapFeeDenominator"),c("baseNeedTakePnl"),c("quoteNeedTakePnl"),c("quoteTotalPnl"),c("baseTotalPnl"),V("quoteTotalDeposited"),V("baseTotalDeposited"),V("swapBaseInAmount"),V("swapQuoteOutAmount"),c("swapBase2QuoteFee"),V("swapQuoteInAmount"),V("swapBaseOutAmount"),c("swapQuote2BaseFee"),x("baseVault"),x("quoteVault"),x("baseMint"),x("quoteMint"),x("lpMint"),x("openOrders"),x("marketId"),x("marketProgramId"),x("targetOrders"),x("withdrawQueue"),x("lpVault"),x("owner"),c("lpReserve"),be(c(),3,"padding")]),da=D([c("accountType"),c("status"),c("nonce"),c("maxOrder"),c("depth"),c("baseDecimal"),c("quoteDecimal"),c("state"),c("resetFlag"),c("minSize"),c("volMaxCutRatio"),c("amountWaveRatio"),c("baseLotSize"),c("quoteLotSize"),c("minPriceMultiplier"),c("maxPriceMultiplier"),c("systemDecimalsValue"),c("abortTradeFactor"),c("priceTickMultiplier"),c("priceTick"),c("minSeparateNumerator"),c("minSeparateDenominator"),c("tradeFeeNumerator"),c("tradeFeeDenominator"),c("pnlNumerator"),c("pnlDenominator"),c("swapFeeNumerator"),c("swapFeeDenominator"),c("baseNeedTakePnl"),c("quoteNeedTakePnl"),c("quoteTotalPnl"),c("baseTotalPnl"),c("poolOpenTime"),c("punishPcAmount"),c("punishCoinAmount"),c("orderbookToInitTime"),V("swapBaseInAmount"),V("swapQuoteOutAmount"),V("swapQuoteInAmount"),V("swapBaseOutAmount"),c("swapQuote2BaseFee"),c("swapBase2QuoteFee"),x("baseVault"),x("quoteVault"),x("baseMint"),x("quoteMint"),x("lpMint"),x("modelDataAccount"),x("openOrders"),x("marketId"),x("marketProgramId"),x("targetOrders"),x("owner"),be(c(),64,"padding")]),Je=D([R("instruction"),c("baseAmountIn"),c("quoteAmountIn"),c("fixedSide")]),Ze=D([R("instruction"),c("amountIn")]);import{PublicKey as to}from"@solana/web3.js";var ce=new to("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),ne=5e4,no=D([c("x"),c("y"),c("price")]),oo=D([c("accountType"),c("status"),c("multiplier"),c("validDataCount"),be(no,ne,"DataElement")]);function ro(e,t){return[0,ne-2]}function io(e){return[0,ne-2]}function so(e){return[0,ne-2]}function ao(e,t,n){let[o,r]=ro(t,n),s=o,i=r,a=0,m=t*e.multiplier/n;for(;s<=i;){if(a=Math.floor((i+s)/2),a===0||a>=ne-2)return[a,a,!1];let l=e.DataElement[a].x*e.multiplier/e.DataElement[a].y,p=e.DataElement[a-1].x*e.multiplier/e.DataElement[a-1].y,f=e.DataElement[a+1].x*e.multiplier/e.DataElement[a+1].y;if(m===l)return[a,a,!0];if(m===p)return[a-1,a-1,!0];if(m===f)return[a+1,a+1,!0];if(m<p)i=a-1;else{if(m>p&&m<l)return[a-1,a,!0];if(m>l&&m<f)return[a,a+1,!0];s=a+1}}return[a,a,!1]}function He(e,t,n){let[o,r,s]=ao(e,t,n);if(!s)return 0;if(o===r){let i=e.DataElement[o].x;return t*e.multiplier/i}else{let i=e.DataElement[o].x,a=e.DataElement[o].y,m=e.DataElement[r].x,l=e.DataElement[r].y,p=n*(m*a-i*l),f=i*p,b=(m-i)*(t*a-i*n)*l,d=f+b;return t*e.multiplier*p/d}}function te(e,t,n){return t*e.multiplier/n}function Ct(e,t,n){return t*n/e.multiplier}function uo(e,t){let[n,o]=io(t),r=n,s=o,i=0,a=t;for(;r<s;){if(i=Math.floor((s+r)/2),i<=0||i>ne-2)return[i,i,!1];let m=e.DataElement[i].x,l=e.DataElement[i-1].x,p=e.DataElement[i+1].x;if(a===m)return[i,i,!0];if(a===l)return[i-1,i-1,!0];if(a===p)return[i+1,i+1,!0];if(a<l)s=i-1;else{if(a>l&&a<m)return[i-1,i,!0];if(a>m&&a<p)return[i,i+1,!0];r=i+1}}return[i,i,!1]}function co(e,t){let[n,o]=so(t),r=n,s=o,i=0,a=t;for(;r<=s;){if(i=Math.floor((s+r)/2),i<=0||i>=ne-2)return[i,i,!1];let m=e.DataElement[i].y,l=e.DataElement[i-1].y,p=e.DataElement[i+1].y;if(a===m)return[i,i,!0];if(a===l)return[i-1,i-1,!0];if(a===p)return[i+1,i+1,!0];if(a<p)r=i+1;else{if(a<l&&a>m)return[i-1,i,!0];if(a<m&&a>p)return[i,i+1,!0];s=i-1}}return[i,i,!1]}function Ft(e,t,n,o){let r=o?t+n:t-n,[s,i,a]=uo(e,r);if(!a)return[0,0,!1,a];if(s===i)return[e.DataElement[i].price,e.DataElement[i].y,!1,a];{let m=e.DataElement[s].x,l=e.DataElement[i].x,p=e.DataElement[s].price,f=e.DataElement[i].price,b=e.DataElement[s].y,d=e.DataElement[i].y;if(t>=m&&t<=l)return o?[f,d,!0,a]:[p,b,!0,a];{let y,k;return o?(y=p+(f-p)*(t-m)/(l-m),k=b-(r-m)*e.multiplier/f):(y=p+(f-p)*(t-m)/(l-m),k=d+(l-r)*e.multiplier/p),[y,k,!1,a]}}}function mo(e,t,n,o){let r=o?t-n:t+n,[s,i,a]=co(e,r);if(!a)return[0,0,!1,a];if(s===i)return[e.DataElement[i].price,e.DataElement[i].x,!1,a];{let m=e.DataElement[s].x,l=e.DataElement[i].x,p=e.DataElement[s].price,f=e.DataElement[i].price,b=e.DataElement[s].y,d=e.DataElement[i].y;if(t>=d&&t<=b)return o?[f,l,!0,a]:[p,m,!0,a];{let y,k;return o?(y=p+(f-p)*(b-t)/(b-d),k=m+f*(b-r)/e.multiplier):(y=p+(f-p)*(b-t)/(b-d),k=l-p*(r-d)/e.multiplier),[y,k,!1,a]}}}function lo(e,t){let n=Ft(e,t,0,!1);return n[3]?n[0]:0}function Ut(e,t,n,o){let r=He(e,t,n),s=te(e,t,r),i=te(e,n,r),a=te(e,o,r),m=!0,[l,p,f,b]=Ft(e,s,a,m);if(!b)return 0;if(f)return o*e.multiplier/l;{let d=i-p;return Ct(e,d,r)}}function Vt(e,t,n,o){let r=He(e,t,n),s=te(e,t,r),i=te(e,n,r),a=te(e,o,r),m=!1,[l,p,f,b]=mo(e,i,a,m);if(!b)return 0;if(f)return o*l/e.multiplier;{let d=s-p;return Ct(e,d,r)}}function po(e){let t=oo.decode(e);return{accountType:t.accountType.toNumber(),status:t.status.toNumber(),multiplier:t.multiplier.toNumber(),validDataCount:t.validDataCount.toNumber(),DataElement:t.DataElement.map(n=>({x:n.x.toNumber(),y:n.y.toNumber(),price:n.price.toNumber()}))}}function Yt(e,t,n,o){let r=lo(e,te(e,t,He(e,t,n)))/e.multiplier;return o?r:1/r}var _e=class{constructor({connection:t}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=t}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let t=await this.connection.getAccountInfo(ce);t&&(this._layoutData=po(t==null?void 0:t.data))}}};var Be=I("Raydium_liquidity_instruction");function Qt(e){let{poolKeys:t,userKeys:n,amountIn:o,amountOut:r,fixedSide:s}=e,{version:i}=t;if(i===4||i===5){let a={poolKeys:t,userKeys:n};if(s==="in")return bo($(F({},a),{amountIn:o,minAmountOut:r}),i);if(s==="out")return yo($(F({},a),{maxAmountIn:o,amountOut:r}),i);Be.logWithError("invalid params","params",e)}throw Be.logWithError("invalid version","poolKeys.version",i),new Error("invalid version")}function jt(e){let t=D([R("instruction"),R("simulateType")]),n=Buffer.alloc(t.span);t.encode({instruction:12,simulateType:0},n);let o=[u({pubkey:e.id,isWritable:!1}),u({pubkey:e.authority,isWritable:!1}),u({pubkey:e.openOrders,isWritable:!1}),u({pubkey:e.baseVault,isWritable:!1}),u({pubkey:e.quoteVault,isWritable:!1}),u({pubkey:e.lpMint,isWritable:!1}),u({pubkey:e.marketId,isWritable:!1})];return new z({programId:e.programId,keys:o,data:n})}function bo({poolKeys:e,userKeys:t,amountIn:n,minAmountOut:o},r){let s=Buffer.alloc(je.span);je.encode({instruction:9,amountIn:T(n),minAmountOut:T(o)},s);let i=[u({pubkey:Xe,isWritable:!1}),u({pubkey:e.id}),u({pubkey:e.authority,isWritable:!1}),u({pubkey:e.openOrders})];return r===4&&i.push(u({pubkey:e.targetOrders})),i.push(u({pubkey:e.baseVault}),u({pubkey:e.quoteVault})),r===5&&i.push(u({pubkey:ce})),i.push(u({pubkey:e.marketProgramId,isWritable:!1}),u({pubkey:e.marketId}),u({pubkey:e.marketBids}),u({pubkey:e.marketAsks}),u({pubkey:e.marketEventQueue}),u({pubkey:e.marketBaseVault}),u({pubkey:e.marketQuoteVault}),u({pubkey:e.marketAuthority,isWritable:!1}),u({pubkey:t.tokenAccountIn}),u({pubkey:t.tokenAccountOut}),u({pubkey:t.owner,isWritable:!1})),new z({programId:e.programId,keys:i,data:s})}function yo({poolKeys:e,userKeys:t,maxAmountIn:n,amountOut:o},r){let s=Buffer.alloc($e.span);$e.encode({instruction:11,maxAmountIn:T(n),amountOut:T(o)},s);let i=[u({pubkey:fo.programId,isWritable:!1}),u({pubkey:e.id}),u({pubkey:e.authority,isWritable:!1}),u({pubkey:e.openOrders}),u({pubkey:e.targetOrders}),u({pubkey:e.baseVault}),u({pubkey:e.quoteVault})];return r===5&&i.push(u({pubkey:ce})),i.push(u({pubkey:e.marketProgramId,isWritable:!1}),u({pubkey:e.marketId}),u({pubkey:e.marketBids}),u({pubkey:e.marketAsks}),u({pubkey:e.marketEventQueue}),u({pubkey:e.marketBaseVault}),u({pubkey:e.marketQuoteVault}),u({pubkey:e.marketAuthority,isWritable:!1}),u({pubkey:t.tokenAccountIn}),u({pubkey:t.tokenAccountOut}),u({pubkey:t.owner,isWritable:!1,isSigner:!0})),new z({programId:e.programId,keys:i,data:s})}function $t(e){let s=e,{owner:t}=s,n=W(s,["owner"]),o=Buffer.alloc(Ge.span);Ge.encode({instruction:10,nonce:n.nonce},o);let r=[...qe,u({pubkey:n.targetOrders}),u({pubkey:n.withdrawQueue}),u({pubkey:n.authority,isWritable:!1}),u({pubkey:n.lpMint}),u({pubkey:n.baseMint,isWritable:!1}),u({pubkey:n.quoteMint,isWritable:!1}),u({pubkey:n.baseVault}),u({pubkey:n.quoteVault}),u({pubkey:n.lpVault}),u({pubkey:n.marketId,isWritable:!1}),u({pubkey:t,isSigner:!0})];return new z({programId:n.programId,keys:r,data:o})}function Gt(e){let{poolKeys:t,userKeys:n,startTime:o}=e,r=Buffer.alloc(ze.span);ze.encode({instruction:0,nonce:t.nonce,startTime:T(o)},r);let s=[...qe,u({pubkey:t.id}),u({pubkey:t.authority,isWritable:!1}),u({pubkey:t.openOrders}),u({pubkey:t.lpMint}),u({pubkey:t.baseMint,isWritable:!1}),u({pubkey:t.quoteMint,isWritable:!1}),u({pubkey:t.baseVault,isWritable:!1}),u({pubkey:t.quoteVault,isWritable:!1}),u({pubkey:t.withdrawQueue}),u({pubkey:t.targetOrders}),u({pubkey:n.lpTokenAccount}),u({pubkey:t.lpVault,isWritable:!1}),u({pubkey:t.marketProgramId,isWritable:!1}),u({pubkey:t.marketId,isWritable:!1}),u({pubkey:n.payer,isSigner:!0})];return new z({programId:t.programId,keys:s,data:r})}function zt(e){let{poolKeys:t,userKeys:n,baseAmountIn:o,quoteAmountIn:r,fixedSide:s}=e,{version:i}=t;if(i===4||i===5){let a=Buffer.alloc(Je.span);Je.encode({instruction:3,baseAmountIn:T(o),quoteAmountIn:T(r),fixedSide:T(s==="base"?0:1)},a);let m=[u({pubkey:Xe,isWritable:!1}),u({pubkey:t.id}),u({pubkey:t.authority,isWritable:!1}),u({pubkey:t.openOrders,isWritable:!1}),u({pubkey:t.targetOrders}),u({pubkey:t.lpMint}),u({pubkey:t.baseVault}),u({pubkey:t.quoteVault})];return i===5&&m.push(u({pubkey:ce})),m.push(u({pubkey:t.marketId,isWritable:!1}),u({pubkey:n.baseTokenAccount}),u({pubkey:n.quoteTokenAccount}),u({pubkey:n.lpTokenAccount}),u({pubkey:n.owner,isWritable:!1,isSigner:!0})),new z({programId:t.programId,keys:m,data:a})}return Be.logWithError("invalid version","poolKeys.version",i),new z({programId:t.programId,keys:[]})}function Jt(e){let{poolKeys:t,userKeys:n,amountIn:o}=e,{version:r}=t;if(r===4||r===5){let s=Buffer.alloc(Ze.span);Ze.encode({instruction:4,amountIn:T(o)},s);let i=[u({pubkey:Xe,isWritable:!1}),u({pubkey:t.id}),u({pubkey:t.authority,isWritable:!1}),u({pubkey:t.openOrders}),u({pubkey:t.targetOrders}),u({pubkey:t.lpMint}),u({pubkey:t.baseVault}),u({pubkey:t.quoteVault})];return r===5?i.push(u({pubkey:ce})):i.push(u({pubkey:t.withdrawQueue}),u({pubkey:t.lpVault})),i.push(u({pubkey:t.marketProgramId,isWritable:!1}),u({pubkey:t.marketId}),u({pubkey:t.marketBaseVault}),u({pubkey:t.marketQuoteVault}),u({pubkey:t.marketAuthority,isWritable:!1}),u({pubkey:n.lpTokenAccount}),u({pubkey:n.baseTokenAccount}),u({pubkey:n.quoteTokenAccount}),u({pubkey:n.owner,isWritable:!1,isSigner:!0}),u({pubkey:t.marketEventQueue}),u({pubkey:t.marketBids}),u({pubkey:t.marketAsks})),new z({programId:t.programId,keys:i,data:s})}return Be.logWithError("invalid version","poolKeys.version",r),new z({programId:t.programId,keys:[]})}import{OpenOrders as Wa}from"@project-serum/serum";import ge from"bn.js";import{PublicKey as Zt}from"@solana/web3.js";var et=I("Raydium_liquidity_serum"),Ht="9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin",go=new Zt(Ht),Ma={[Ht]:3},ho={3:go};function Xt(e){let t=Kt[e];return t||et.logWithError("invalid version","version",e),t}function en(e){let t=ho[e];return t||et.logWithError("invalid version","version",e),t}async function tn({programId:e,marketId:t}){let n=[t.toBuffer()],o=0,r;for(;o<100;){try{let s=n.concat(Buffer.from([o]),Buffer.alloc(7));r=await Zt.createProgramAddress(s,e)}catch(s){if(s instanceof TypeError)throw s;o++;continue}return{publicKey:r,nonce:o}}throw et.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),new Error("unable to find a viable program address nonce")}var tt=I("Raydium_liquidity_util");function nt(e,t){let n=e instanceof _?e.token:O.WSOL,{baseMint:o,quoteMint:r}=t;if(n.mint.equals(o))return"base";if(n.mint.equals(r))return"quote";let s=`liquidity getTokenSide - token not match with pool, params: ${JSON.stringify({token:n.mint,baseMint:o,quoteMint:r})}`;throw console.error(s),new Error(s)}function ot(e,t){let{baseMint:n,quoteMint:o}=t;return e.mint.equals(n)||e.mint.equals(o)}function Po(e){let t=vt[e];return t||tt.logWithError("invalid version","version",e),t}async function X({name:e,programId:t,marketId:n}){let{publicKey:o}=await ve([t.toBuffer(),n.toBuffer(),Buffer.from(e,"utf-8")],t);return o}async function xo({programId:e}){return ve([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],e)}async function rt({version:e,marketId:t,baseMint:n,quoteMint:o}){let r=Po(e),[s,i,a]=[v({publicKey:t}),v({publicKey:n,transformSol:!0}),v({publicKey:o,transformSol:!0})],m=await X({name:"amm_associated_seed",programId:r,marketId:s}),l=await X({name:"lp_mint_associated_seed",programId:r,marketId:s}),{publicKey:p,nonce:f}=await xo({programId:r}),b=await X({name:"coin_vault_associated_seed",programId:r,marketId:s}),d=await X({name:"pc_vault_associated_seed",programId:r,marketId:s}),y=await X({name:"temp_lp_token_associated_seed",programId:r,marketId:s}),k=await X({name:"open_order_associated_seed",programId:r,marketId:s}),B=await X({name:"target_associated_seed",programId:r,marketId:s}),w=await X({name:"withdraw_associated_seed",programId:r,marketId:s}),S=Xt(e),L=en(S),{publicKey:N}=await tn({programId:L,marketId:s});return{id:m,baseMint:i,quoteMint:a,lpMint:l,version:e,programId:r,authority:p,nonce:f,baseVault:b,quoteVault:d,lpVault:y,openOrders:k,targetOrders:B,withdrawQueue:w,marketVersion:S,marketProgramId:L,marketId:s,marketAuthority:N}}async function on({connection:e,pools:t}){let n=t.map(r=>jt(r));return(await St(e,n,"GetPoolData")).map(r=>{let s=Lt(r,"GetPoolData"),i=new ge(G(s,"status")),a=Number(G(s,"coin_decimals")),m=Number(G(s,"pc_decimals")),l=Number(G(s,"lp_decimals")),p=new ge(G(s,"pool_coin_amount")),f=new ge(G(s,"pool_pc_amount")),b=new ge(G(s,"pool_lp_supply")),d="0";try{d=G(s,"pool_open_time")}catch{d="0"}return{status:i,baseDecimals:a,quoteDecimals:m,lpDecimals:l,baseReserve:p,quoteReserve:f,lpSupply:b,startTime:new ge(d)}})}function rn(e,t,n){return ko(e.token,t.token,n)}function ko(e,t,n){let{baseMint:o,quoteMint:r}=n,s=nn(e,n),i=nn(t,n);return s===i&&tt.logWithError("tokens not match with pool","params",{tokenA:e.mint,tokenB:t.mint,baseMint:o,quoteMint:r}),[s,i]}function nn(e,t){let{baseMint:n,quoteMint:o}=t;return e.mint.equals(n)?"base":e.mint.equals(o)?"quote":(tt.logWithError("token not match with pool","params",{token:e.mint,baseMint:n,quoteMint:o}),"base")}var sn=e=>e==="a"||e==="b";var it=class extends ye{constructor(n){super(n);this._poolInfos=[];this._poolInfoMap=new Map;this._pairsInfo=[];this._pairsInfoMap=new Map;this._lpTokenMap=new Map;this._lpPriceMap=new Map;this._officialIds=new Set;this._unOfficialIds=new Set;this._sdkParseInfoCache=new Map;this._stableLayout=new _e({connection:this.scope.connection})}async load(n){if(await this.scope.fetchLiquidity(n==null?void 0:n.forceUpdate),!this.scope.apiData.liquidityPools)return;let{data:o}=this.scope.apiData.liquidityPools,[r,s]=[o.official||[],o.unOfficial||[]];this._poolInfos=[...r,...s],this._officialIds=new Set(r.map(i=>{var m,l;let a=`${(m=this.scope.token.allTokenMap.get(i.baseMint))==null?void 0:m.symbol} - ${(l=this.scope.token.allTokenMap.get(i.quoteMint))==null?void 0:l.symbol}`;return this._poolInfoMap.set(i.id,i),this._lpTokenMap.set(i.lpMint,new O({mint:i.lpMint,decimals:i.lpDecimals,symbol:a,name:`${a} LP`})),i.id})),this._unOfficialIds=new Set(s.map(i=>{var m,l;let a=`${(m=this.scope.token.allTokenMap.get(i.baseMint))==null?void 0:m.symbol} - ${(l=this.scope.token.allTokenMap.get(i.quoteMint))==null?void 0:l.symbol}`;return this._poolInfoMap.set(i.id,i),this._lpTokenMap.set(i.lpMint,new O({mint:i.lpMint,decimals:i.lpDecimals,symbol:a,name:`${a} LP`})),i.id}))}async loadPairs(n){var o;return await this.scope.fetchPairs(n==null?void 0:n.forceUpdate),this._pairsInfo=((o=this.scope.apiData.liquidityPairsInfo)==null?void 0:o.data)||[],this._pairsInfoMap=new Map(this._pairsInfo.map(r=>{let s=this._lpTokenMap.get(r.lpMint),i=s&&r.lpPrice?wt({token:s,numberPrice:r.lpPrice,decimalDone:!0}):null;return i&&this._lpPriceMap.set(r.lpMint,i),[r.ammId,r]})),this._pairsInfo}get allPools(){return this._poolInfos}get allPoolIdSet(){return{official:this._officialIds,unOfficial:this._unOfficialIds}}get allPoolMap(){return this._poolInfoMap}get allPairs(){return this._pairsInfo}get allPairsMap(){return this._pairsInfoMap}get lpTokenMap(){return this._lpTokenMap}get lpPriceMap(){return this._lpPriceMap}async fetchMultipleInfo(n){return await this._stableLayout.initStableModelLayout(),await on($(F({},n),{connection:this.scope.connection}))}async sdkParseJsonLiquidityInfo(n){if(!n.length)return[];let o=n.map(r=>r.id).join("-");if(this._sdkParseInfoCache.has(o))return this._sdkParseInfoCache.get(o);try{let s=(await this.fetchMultipleInfo({pools:n.map(ue)})).map((i,a)=>F(F({jsonInfo:n[a]},ue(n[a])),i));return this._sdkParseInfoCache.set(o,s),s}catch(r){return console.error(r),[]}}computeAmountOut({poolKeys:n,poolInfo:o,amountIn:r,outputToken:s,slippage:i}){this.checkDisabled();let a=I("Raydium_computeAmountOut"),m=r.token,l=s;(!ot(m,n)||!ot(l,n))&&a.logWithError("token not match with pool","poolKeys",n);let{baseReserve:p,quoteReserve:f}=o;this.logDebug("baseReserve:",p.toString(),"quoteReserve:",f.toString());let b=r.token;this.logDebug("inputToken:",b),this.logDebug("amountIn:",r.toFixed()),this.logDebug("outputToken:",s),this.logDebug("slippage:",`${i.toSignificant()}%`);let d=[p,f],y=nt(r,n);y==="quote"&&d.reverse(),this.logDebug("input side:",y);let[k,B]=d,w;if(n.version===4)w=new M({baseToken:b,denominator:k,quoteToken:s,numerator:B});else{let Y=Yt(this._stableLayout.stableModelData,p.toNumber(),f.toNumber(),!1);w=new M({baseToken:b,denominator:y==="quote"?new J(Y*1e6):new J(1e6),quoteToken:s,numerator:y==="quote"?new J(1e6):new J(Y*1e6)})}this.logDebug("currentPrice:",`1 ${b.symbol} \u2248 ${w.toFixed()} ${s.symbol}`),this.logDebug("currentPrice invert:",`1 ${s.symbol} \u2248 ${w.invert().toFixed()} ${b.symbol}`);let S=r.raw,L=ae,N=ae;if(!S.isZero())if(n.version===4){N=S.mul(Ot).div(Et);let Y=S.sub(N),ie=k.add(Y);L=B.mul(Y).div(ie)}else{N=S.mul(new J(2)).div(new J(1e4));let Y=S.sub(N),ie=y==="quote"?Ut:Vt;L=new J(ie(this._stableLayout.stableModelData,f.toNumber(),p.toNumber(),Y.toNumber()))}let K=new U(de).add(i).invert().mul(L).quotient,E=new _(s,L),j=new _(s,K);this.logDebug("amountOut:",E.toFixed(),"minAmountOut:",j.toFixed());let C=new M({baseToken:b,denominator:S.sub(N),quoteToken:s,numerator:L});!S.isZero()&&!L.isZero()&&(C=new M({baseToken:b,denominator:S.sub(N),quoteToken:s,numerator:L}),this.logDebug("executionPrice:",`1 ${b.symbol} \u2248 ${C.toFixed()} ${s.symbol}`),this.logDebug("executionPrice invert:",`1 ${s.symbol} \u2248 ${C.invert().toFixed()} ${b.symbol}`));let oe=new U(parseInt(String(Math.abs(parseFloat(C.toFixed())-parseFloat(w.toFixed()))*1e9)),parseInt(String(parseFloat(w.toFixed())*1e9))),re=new _(b,N);return{amountOut:E,minAmountOut:j,currentPrice:w,executionPrice:C,priceImpact:oe,fee:re}}async computePairAmount({poolId:n,amount:o,anotherToken:r,slippage:s}){let i=v({publicKey:n}),a=this._poolInfoMap.get(i.toBase58());a||this.logAndCreateError("pool not found",i.toBase58());let m=(await this.sdkParseJsonLiquidityInfo([a]))[0];m||this.logAndCreateError("pool parseInfo not found",i.toBase58());let{baseReserve:l,quoteReserve:p}=m;this.logDebug("baseReserve:",l.toString(),"quoteReserve:",p.toString());let f=o.token;this.logDebug("tokenIn:",f,"amount:",o.toFixed(),"anotherToken:",r,"slippage:",`${s.toSignificant()}%`);let b=nt(o,ue(a));this.logDebug("input side:",b);let d=ae;o.isZero()||(d=b==="base"?We(o.raw.mul(p),l):We(o.raw.mul(l),p));let k=new U(de).add(s).mul(d).quotient,B=new _(r,d),w=new _(r,k);return this.logDebug("anotherAmount:",B.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:B,maxAnotherAmount:w}}async swapWithAMM(n){let{poolKeys:o,payer:r,amountIn:s,amountOut:i,fixedSide:a,config:m}=n;this.logDebug("amountIn:",s),this.logDebug("amountOut:",i),(s.isZero()||i.isZero())&&this.logAndCreateError("amounts must greater than zero","amounts",{amountIn:s.toFixed(),amountOut:i.toFixed()});let{account:l}=this.scope,p=this.createTxBuilder(),{bypassAssociatedCheck:f=!1}=m||{},[b,d]=[s.token,i.token],y=await l.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1}),k=await l.getCreatedTokenAccount({mint:d.mint}),[B,w]=[s.raw,i.raw],K=await l.handleTokenAccount({side:"in",amount:B,mint:b.mint,tokenAccount:y,bypassAssociatedCheck:f}),{tokenAccount:S}=K,L=W(K,["tokenAccount"]);p.addInstruction(L);let E=await l.handleTokenAccount({side:"out",amount:0,mint:d.mint,tokenAccount:k,payer:r,bypassAssociatedCheck:f}),{tokenAccount:N}=E,Q=W(E,["tokenAccount"]);return p.addInstruction(Q),p.addInstruction({instructions:[Qt({poolKeys:o,userKeys:{tokenAccountIn:S,tokenAccountOut:N,owner:this.scope.ownerPubKey},amountIn:B,amountOut:w,fixedSide:a})]}),p.buildMultiTx({extInfo:{amountOut:i}})}async createPool(n){this.checkDisabled(),this.scope.checkOwner(),n.version!==4&&this.logAndCreateError("invalid version","poolKeys.version",n.version);let o=this.createTxBuilder(),r=await rt(n);return await o.addInstruction({instructions:[$t($(F({},r),{owner:this.scope.ownerPubKey}))]}).build()}async initPool(n){n.version!==4&&this.logAndCreateError("invalid version","poolKeys.version",n.version);let{baseAmount:o,quoteAmount:r,startTime:s=0,config:i}=n,a=await rt(n),{baseMint:m,quoteMint:l,lpMint:p,baseVault:f,quoteVault:b}=a,d=this.createTxBuilder(),{account:y}=this.scope,k=!!(i!=null&&i.bypassAssociatedCheck),B=await y.getCreatedTokenAccount({mint:m,associatedOnly:!1}),w=await y.getCreatedTokenAccount({mint:l,associatedOnly:!1});!B&&!w&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",y.tokenAccounts);let S=await y.getCreatedTokenAccount({mint:p,associatedOnly:!1}),C=await y.handleTokenAccount({side:"in",amount:o.raw,mint:m,tokenAccount:B,bypassAssociatedCheck:k}),{tokenAccount:L}=C,N=W(C,["tokenAccount"]);d.addInstruction(N);let oe=await y.handleTokenAccount({side:"in",amount:r.raw,mint:l,tokenAccount:w,bypassAssociatedCheck:k}),{tokenAccount:Q}=oe,K=W(oe,["tokenAccount"]);d.addInstruction(K);let re=await y.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:S,bypassAssociatedCheck:k}),{tokenAccount:E}=re,j=W(re,["tokenAccount"]);return d.addInstruction(j),d.addInstruction({instructions:[Ye({source:L,destination:f,owner:this.scope.ownerPubKey,amount:o.raw}),Ye({source:Q,destination:b,owner:this.scope.ownerPubKey,amount:r.raw}),Gt({poolKeys:a,userKeys:{lpTokenAccount:E,payer:this.scope.ownerPubKey},startTime:s})]}),await d.build()}async addLiquidity(n){let{poolId:o,amountInA:r,amountInB:s,fixedSide:i,config:a}=n,m=v({publicKey:o}),l=this.allPools.find(dn=>dn.id===m.toBase58());l||this.logAndCreateError("pool not found",o);let f=(await this.sdkParseJsonLiquidityInfo([l]))[0];f||this.logAndCreateError("pool parse error",f),this.logDebug("amountInA:",r,"amountInB:",s),(r.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:s.toFixed()});let{account:b}=this.scope,d=(a==null?void 0:a.bypassAssociatedCheck)||!1,[y,k]=[r.token,s.token],B=await b.getCreatedTokenAccount({mint:y.mint,associatedOnly:!1}),w=await b.getCreatedTokenAccount({mint:k.mint,associatedOnly:!1});!B&&!w&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",b.tokenAccounts);let S=await b.getCreatedTokenAccount({mint:f.lpMint}),L=[y,k],N=[B,w],Q=[r.raw,s.raw],[K]=rn(r,s,f),E="base";(!["quote","base"].includes(K)||!sn(i))&&this.logAndCreateError("invalid fixedSide","fixedSide",i),K==="quote"?(L.reverse(),N.reverse(),Q.reverse(),E=i==="a"?"quote":"base"):K==="base"&&(E=i==="a"?"base":"quote");let[j,C]=L,[oe,re]=N,[Y,ie]=Q,me=this.createTxBuilder(),st=await b.handleTokenAccount({side:"in",amount:Y,mint:j.mint,tokenAccount:oe,bypassAssociatedCheck:d}),{tokenAccount:an}=st,un=W(st,["tokenAccount"]);me.addInstruction(un);let at=await b.handleTokenAccount({side:"in",amount:ie,mint:C.mint,tokenAccount:re,bypassAssociatedCheck:d}),{tokenAccount:cn}=at,mn=W(at,["tokenAccount"]);me.addInstruction(mn);let ut=await b.handleTokenAccount({side:"out",amount:0,mint:f.lpMint,tokenAccount:S,bypassAssociatedCheck:d}),{tokenAccount:ln}=ut,pn=W(ut,["tokenAccount"]);return me.addInstruction(pn),me.addInstruction({instructions:[zt({poolKeys:f,userKeys:{baseTokenAccount:an,quoteTokenAccount:cn,lpTokenAccount:ln,owner:this.scope.ownerPubKey},baseAmountIn:Y,quoteAmountIn:ie,fixedSide:E})]}),await me.build()}async removeLiquidity(n){let{poolId:o,amountIn:r,config:s}=n,i=v({publicKey:o}),a=this.allPools.find(C=>C.id===i.toBase58());a||this.logAndCreateError("pool not found",o);let l=(await this.sdkParseJsonLiquidityInfo([a]))[0];l||this.logAndCreateError("pool pass error",l);let{baseMint:p,quoteMint:f,lpMint:b}=l;this.logDebug("amountIn:",r),r.isZero()&&this.logAndCreateError("amount must greater than zero","amountIn",r.toFixed()),r.token.mint.equals(b)||this.logAndCreateError("amountIn's token not match lpMint","amountIn",r);let{account:d}=this.scope,y=await d.getCreatedTokenAccount({mint:b,associatedOnly:!1});y||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",d.tokenAccounts);let k=await d.getCreatedTokenAccount({mint:p}),B=await d.getCreatedTokenAccount({mint:f}),w=this.createTxBuilder(),S=(s==null?void 0:s.bypassAssociatedCheck)||!1,E=await d.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:k,bypassAssociatedCheck:S}),{tokenAccount:L}=E,N=W(E,["tokenAccount"]);w.addInstruction(N);let j=await d.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:B,bypassAssociatedCheck:S}),{tokenAccount:Q}=j,K=W(j,["tokenAccount"]);return w.addInstruction(K),w.addInstruction({instructions:[wo.requestUnits({units:4e5,additionalFee:0}),Jt({poolKeys:l,userKeys:{lpTokenAccount:y,baseTokenAccount:L,quoteTokenAccount:Q,owner:this.scope.ownerPubKey},amountIn:r.raw})]}),await w.build()}lpMintToTokenAmount({poolId:n,amount:o,decimalDone:r}){let s=v({publicKey:n});s||this.logAndCreateError("pool not found");let i=this._poolInfoMap.get(s.toBase58()),a=fe(o),m=new O({mint:i.lpMint,decimals:i.lpDecimals}),l=r?new g(a.numerator,a.denominator):new g(a.numerator,a.denominator).mul(new J(10).pow(new J(m.decimals)));return new _(m,xt(l))}getFixedSide({poolId:n,inputMint:o}){let[r,s]=[v({publicKey:n}),v({publicKey:o})],i=this._poolInfoMap.get(r.toBase58());i||this.logAndCreateError("pool not found",r.toBase58());let a=i.baseMint===s.toBase58();return(s.equals(we)||s.equals(ee))&&(a=!a),a?"a":"b"}};export{it as default};
//# sourceMappingURL=liquidity.mjs.map